{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {},
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "resources": [
    {
      "name": "pid-c831fa37-c174-4c50-a094-e820557d868e-partnercenter",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring('CiscoUmbrellaDataConnector')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "The Cisco Umbrella data connector provides the capability to ingest [Cisco Umbrella](https://docs.umbrella.com/) events stored in Amazon S3 into Microsoft Sentinel using the Amazon S3 REST API. Refer to [Cisco Umbrella log management documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management) for more information.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/','CiscoUmbrellaDataConnector')]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "CiscoUmbrellaDataConnector",
                  "title": "Cisco Umbrella (using Azure Functions)",
                  "publisher": "Cisco",
                  "descriptionMarkdown": "The Cisco Umbrella data connector provides the capability to ingest [Cisco Umbrella](https://docs.umbrella.com/) events stored in Amazon S3 into Microsoft Sentinel using the Amazon S3 REST API. Refer to [Cisco Umbrella log management documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management) for more information.",
                  "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. Follow the steps to use this Kusto functions alias **Cisco_Umbrella** in queries and workbooks. [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-ciscoumbrella-function) ",
                  "graphQueries": [
                    {
                      "metricName": "Cisco Umbrella DNS Logs",
                      "legend": "Cisco_Umbrella_dns_CL",
                      "baseQuery": "Cisco_Umbrella_dns_CL"
                    },
                    {
                      "metricName": "Cisco Umbrella Proxy Logs",
                      "legend": "Cisco_Umbrella_proxy_CL",
                      "baseQuery": "Cisco_Umbrella_proxy_CL"
                    },
                    {
                      "metricName": "Cisco Umbrella IP Logs",
                      "legend": "Cisco_Umbrella_ip_CL",
                      "baseQuery": "Cisco_Umbrella_ip_CL"
                    },
                    {
                      "metricName": "Cisco Umbrella Cloud Firewall Logs",
                      "legend": "Cisco_Umbrella_cloudfirewall_CL",
                      "baseQuery": "Cisco_Umbrella_cloudfirewall_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All Cisco Umbrella Logs",
                      "query": "Cisco_Umbrella\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella DNS Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'dnslogs'\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella Proxy Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'proxylogs'\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella IP Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'iplogs'\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "Cisco Umbrella Cloud Firewall Logs",
                      "query": "Cisco_Umbrella\n | where EventType == 'cloudfirewalllogs'\n| sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "Cisco_Umbrella_dns_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_dns_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Cisco_Umbrella_proxy_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_proxy_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Cisco_Umbrella_ip_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_ip_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Cisco_Umbrella_cloudfirewall_CL",
                      "lastDataReceivedQuery": "Cisco_Umbrella_cloudfirewall_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "Cisco_Umbrella_dns_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                        "Cisco_Umbrella_proxy_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                        "Cisco_Umbrella_ip_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                        "Cisco_Umbrella_cloudfirewall_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Amazon S3 REST API Credentials/permissions",
                        "description": "**AWS Access Key Id**, **AWS Secret Access Key**, **AWS S3 Bucket Name** are required for Amazon S3 REST API."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the Amazon S3 REST API to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**NOTE:** This connector has been updated to support [cisco umbrella version 5 and version 6.](https://docs.umbrella.com/deployment-umbrella/docs/log-formats-and-versioning)"
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Functions App."
                    },
                    {
                      "description": ">**NOTE:** This connector uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**."
                    },
                    {
                      "description": "**STEP 1 - Configuration of the Cisco Umbrella logs collection**\n\n[See documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management#section-logging-to-amazon-s-3) and follow the instructions for set up logging and obtain credentials."
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Functions**\n\n>**IMPORTANT:** Before deploying the Cisco Umbrella data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Amazon S3 REST API Authorization credentials, readily available.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "instructions": [
                        {
                          "parameters": {
                            "instructionSteps": [
                              {
                                "title": "Option 1 - Azure Resource Manager (ARM) Template",
                                "description": "Use this method for automated deployment of the Cisco Umbrella data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelciscoumbrellaazuredeploy) [![Deploy to Azure Gov](https://aka.ms/deploytoazuregovbutton)](https://aka.ms/sentinelciscoumbrellaazuredeploy-gov)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **S3Bucket**, **AWSAccessKeyId**, **AWSSecretAccessKey**\n**Note:** For the S3Bucket use the value that Cisco referrs to as the _S3 Bucket Data Path_ and add a / (forward slash) to the end of the value\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy."
                              },
                              {
                                "title": "Option 2 - Manual Deployment of Azure Functions",
                                "description": "Use the following step-by-step instructions to deploy the Cisco Umbrella data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                                "instructions": [
                                  {
                                    "parameters": {
                                      "instructionSteps": [
                                        {
                                          "title": "Step 1 - Deploy a Function App",
                                          "description": "**NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure Functions development.\n\n1. Download the [Azure Functions App](https://aka.ms/sentinel-CiscoUmbrellaConn-functionapp) file. Extract archive to your local development computer.\n2. Follow the [function app manual deployment instructions](https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/AzureFunctionsManualDeploymentWithPythonVersion3.9.md#function-app-manual-deployment-instructions) to deploy the Azure Functions app using VSCode.\n3. After successful deployment of the function app, follow next steps for configuring it."
                                        },
                                        {
                                          "title": "Step 2 - Configure the Function App",
                                          "description": "1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tS3Bucket\n\t\tAWSAccessKeyId\n\t\tAWSSecretAccessKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
                                        }
                                      ]
                                    },
                                    "type": "InstructionStepsGroup"
                                  }
                                ]
                              }
                            ]
                          },
                          "type": "InstructionStepsGroup"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'CiscoUmbrellaDataConnector'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'CiscoUmbrellaDataConnector')]",
                "contentId": "CiscoUmbrellaDataConnector",
                "kind": "DataConnector",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrellaDataConnector",
        "contentKind": "DataConnector",
        "displayName": "Cisco Umbrella (using Azure Functions)",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-dc-j6usytmioyjzm",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-dc-j6usytmioyjzm",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'CiscoUmbrellaDataConnector'),'/'))))]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'CiscoUmbrellaDataConnector')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'CiscoUmbrellaDataConnector')]",
        "contentId": "CiscoUmbrellaDataConnector",
        "kind": "DataConnector",
        "version": "1.0.0",
        "source": {
          "kind": "Solution",
          "name": "CiscoUmbrella",
          "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
        },
        "author": {
          "name": "Microsoft",
          "email": "support@microsoft.com"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/','CiscoUmbrellaDataConnector')]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cisco Umbrella (using Azure Functions)",
          "publisher": "Cisco",
          "descriptionMarkdown": "The Cisco Umbrella data connector provides the capability to ingest [Cisco Umbrella](https://docs.umbrella.com/) events stored in Amazon S3 into Microsoft Sentinel using the Amazon S3 REST API. Refer to [Cisco Umbrella log management documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management) for more information.",
          "graphQueries": [
            {
              "metricName": "Cisco Umbrella DNS Logs",
              "legend": "Cisco_Umbrella_dns_CL",
              "baseQuery": "Cisco_Umbrella_dns_CL"
            },
            {
              "metricName": "Cisco Umbrella Proxy Logs",
              "legend": "Cisco_Umbrella_proxy_CL",
              "baseQuery": "Cisco_Umbrella_proxy_CL"
            },
            {
              "metricName": "Cisco Umbrella IP Logs",
              "legend": "Cisco_Umbrella_ip_CL",
              "baseQuery": "Cisco_Umbrella_ip_CL"
            },
            {
              "metricName": "Cisco Umbrella Cloud Firewall Logs",
              "legend": "Cisco_Umbrella_cloudfirewall_CL",
              "baseQuery": "Cisco_Umbrella_cloudfirewall_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "Cisco_Umbrella_dns_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_dns_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Cisco_Umbrella_proxy_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_proxy_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Cisco_Umbrella_ip_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_ip_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Cisco_Umbrella_cloudfirewall_CL",
              "lastDataReceivedQuery": "Cisco_Umbrella_cloudfirewall_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "Cisco_Umbrella_dns_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                "Cisco_Umbrella_proxy_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                "Cisco_Umbrella_ip_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)",
                "Cisco_Umbrella_cloudfirewall_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "All Cisco Umbrella Logs",
              "query": "Cisco_Umbrella\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella DNS Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'dnslogs'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella Proxy Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'proxylogs'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella IP Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'iplogs'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Cisco Umbrella Cloud Firewall Logs",
              "query": "Cisco_Umbrella\n | where EventType == 'cloudfirewalllogs'\n| sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Amazon S3 REST API Credentials/permissions",
                "description": "**AWS Access Key Id**, **AWS Secret Access Key**, **AWS S3 Bucket Name** are required for Amazon S3 REST API."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Amazon S3 REST API to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**NOTE:** This connector has been updated to support [cisco umbrella version 5 and version 6.](https://docs.umbrella.com/deployment-umbrella/docs/log-formats-and-versioning)"
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Functions App."
            },
            {
              "description": ">**NOTE:** This connector uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**."
            },
            {
              "description": "**STEP 1 - Configuration of the Cisco Umbrella logs collection**\n\n[See documentation](https://docs.umbrella.com/deployment-umbrella/docs/log-management#section-logging-to-amazon-s-3) and follow the instructions for set up logging and obtain credentials."
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Functions**\n\n>**IMPORTANT:** Before deploying the Cisco Umbrella data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Amazon S3 REST API Authorization credentials, readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "instructions": [
                {
                  "parameters": {
                    "instructionSteps": [
                      {
                        "title": "Option 1 - Azure Resource Manager (ARM) Template",
                        "description": "Use this method for automated deployment of the Cisco Umbrella data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelciscoumbrellaazuredeploy) [![Deploy to Azure Gov](https://aka.ms/deploytoazuregovbutton)](https://aka.ms/sentinelciscoumbrellaazuredeploy-gov)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **S3Bucket**, **AWSAccessKeyId**, **AWSSecretAccessKey**\n**Note:** For the S3Bucket use the value that Cisco referrs to as the _S3 Bucket Data Path_ and add a / (forward slash) to the end of the value\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy."
                      },
                      {
                        "title": "Option 2 - Manual Deployment of Azure Functions",
                        "description": "Use the following step-by-step instructions to deploy the Cisco Umbrella data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                        "instructions": [
                          {
                            "parameters": {
                              "instructionSteps": [
                                {
                                  "title": "Step 1 - Deploy a Function App",
                                  "description": "**NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure Functions development.\n\n1. Download the [Azure Functions App](https://aka.ms/sentinel-CiscoUmbrellaConn-functionapp) file. Extract archive to your local development computer.\n2. Follow the [function app manual deployment instructions](https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/AzureFunctionsManualDeploymentWithPythonVersion3.9.md#function-app-manual-deployment-instructions) to deploy the Azure Functions app using VSCode.\n3. After successful deployment of the function app, follow next steps for configuring it."
                                },
                                {
                                  "title": "Step 2 - Configure the Function App",
                                  "description": "1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tS3Bucket\n\t\tAWSAccessKeyId\n\t\tAWSSecretAccessKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
                                }
                              ]
                            },
                            "type": "InstructionStepsGroup"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ]
            }
          ],
          "id": "CiscoUmbrellaDataConnector",
          "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. Follow the steps to use this Kusto functions alias **Cisco_Umbrella** in queries and workbooks. [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-ciscoumbrella-function) "
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring('CiscoUmbrellaWorkbook')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Gain insights into Cisco Umbrella activities, including the DNS, Proxy and Cloud Firewall data. Workbook shows general information along with threat landscape including categories, blocked destinations and URLs.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "CiscoUmbrellaWorkbook",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into Cisco Umbrella activities, including the DNS, Proxy and Cloud Firewall data. Workbook shows general information along with threat landscape including categories, blocked destinations and URLs."
              },
              "properties": {
                "displayName": "Cisco Umbrella",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\">**NOTE:** This workbook uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**.\"},\"name\":\"Text\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"464b6899-a8de-4f01-84a6-d4e3ecc7f282\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Main Dashboard\",\"subTarget\":\"cisco_umbrella_main_dashboard\",\"preText\":\"Cisco Umbrella Main Dashboard\",\"style\":\"link\"},{\"id\":\"a3798d8a-a610-475c-9cbf-7252301dab7e\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Dns Dashboard\",\"subTarget\":\"cisco_umbrella_dns_dashboard\",\"style\":\"link\"},{\"id\":\"80bcf252-bcf6-4736-993d-59da0a8e4c76\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Proxy Dashboard\",\"subTarget\":\"cisco_umbrella_proxy_dashboard\",\"style\":\"link\"},{\"id\":\"f536a1e9-362e-4d98-bdd1-0f7dfb23901a\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Firewall Dashboard\",\"subTarget\":\"cisco_umbrella_firewall_dashboard\",\"style\":\"link\"}]},\"name\":\"Links\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"37b91baf-6272-4709-a028-1370823249d4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| summarize Count=count() by EventType\\n| render barchart\",\"size\":3,\"title\":\"Events Count by EventType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"EventType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"EventType\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"EventsCountByEventType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventType;\",\"size\":0,\"title\":\"Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"70\",\"name\":\"EventsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where DvcAction contains \\\"block\\\"\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Blocks over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"70\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CU_Total_Requests =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| summarize count()\\n| extend evttype=\\\"Total Requests\\\";\\n\\nlet CU_Total_Blocked =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where DvcAction contains \\\"block\\\"\\n| summarize count()\\n| extend evttype=\\\"Total Blocked\\\";\\n\\nlet CU_Security_Blocked =\\nCisco_Umbrella \\n| where TimeGenerated {TimeRange} \\n| where DvcAction contains \\\"block\\\"\\n| where isnotempty(ThreatCategory)\\n| summarize count()\\n| extend evttype=\\\"Security Blocked\\\";\\n\\nunion CU_Security_Blocked,CU_Total_Blocked,CU_Total_Requests\",\"size\":3,\"title\":\"Network Breakdown Statistic\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"evttype\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"NetworkBreakdownStatistic\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"DNS - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DvcAction\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"30\",\"name\":\"DNSEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| summarize Count=count() by DnsQueryTypeName | sort by Count\",\"size\":0,\"title\":\"DNS - Events count by QueryType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"70\",\"name\":\"DNSEventsCountByQueryType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where EventType == \\\"dnslogs\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| summarize Count=count() by tostring(Threat_Category)\\n| sort by Count \\n| join kind = inner (\\nCisco_Umbrella\\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(ThreatCategory)\\n| where TimeGenerated {TimeRange} \\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Threat_Category))\\n on Threat_Category\\n | project-away Threat_Category1, TimeGenerated\\n | project Threat_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"DNS - Events by Threat Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"30\",\"name\":\"DNSEventsByThreatCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| summarize Count=count() by tostring(Url_Category)\\n| sort by Count\\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Url_Category))\\n on Url_Category\\n | project-away Url_Category1, TimeGenerated\\n | project Url_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"DNS - Events by Url Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"35\",\"name\":\"DNSEventsByUrlCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_IP = Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n|summarize Count=count() by SrcIpAddr | top 10 by Count\\n| summarize makelist(SrcIpAddr);\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n|summarize Count=count() by SrcIpAddr \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n| where SrcIpAddr in (list_IP)\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcIpAddr)\\n on SrcIpAddr\\n |  project-away SrcIpAddr1, TimeGenerated\\n | project SrcIpAddr, Count, Trend\\n | order by Count\\n| take 10\\n\\n\",\"size\":0,\"title\":\"DNS - Top 10 SrcIp with Blocked Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"35\",\"name\":\"DNSTop10SrcIpBlockedAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange}\\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n| summarize Count=count() by DnsQueryName, UrlCategory \\n| top 10 by Count\\n\",\"size\":0,\"title\":\"DNS - Top 10 Blocked Url \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"name\":\"DNSTop10BlockedUrl \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"Proxy - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"30\",\"name\":\"ProxyEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CU_proxy_outcoming_traffic =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| extend TrafficType = \\\"Outcoming\\\", Bytes = SrcBytes\\n| project TrafficType, Bytes, TimeGenerated;\\n\\nlet CU_proxy_incoming_traffic =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| extend TrafficType = \\\"Incoming\\\", Bytes = DstBytes\\n| project TrafficType, Bytes, TimeGenerated;\\n\\n\\nunion CU_proxy_outcoming_traffic, CU_proxy_incoming_traffic\\n| make-series TotalGbytes = round(sum(Bytes/(1024*1024*1024)),2) on TimeGenerated  from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by TrafficType\\n\",\"size\":0,\"title\":\"Proxy - Traffic timechart, GB\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"70\",\"name\":\"ProxyTrafficTimechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| summarize Count=count() by tostring(Url_Category)\\n| sort by Count\\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Url_Category))\\n on Url_Category\\n | project-away Url_Category1, TimeGenerated\\n | project Url_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"Proxy - Events by Url Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"30\",\"name\":\"ProxyEventsByUrlCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_IP = Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n|summarize Count=count() by SrcIpAddr | top 10 by Count\\n| summarize makelist(SrcIpAddr);\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n|summarize Count=count() by SrcIpAddr \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n| where SrcIpAddr in (list_IP)\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcIpAddr)\\n on SrcIpAddr\\n |  project-away SrcIpAddr1, TimeGenerated\\n | project SrcIpAddr, Count, Trend\\n | order by Count\\n| take 10\\n\\n\",\"size\":0,\"title\":\"Proxy - Top 10 Source IP with Blocked Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"35\",\"name\":\"ProxyTop10SourceIPBlockedAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| summarize Count=count() by tostring(Threat_Category)\\n| sort by Count \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Threat_Category))\\n on Threat_Category\\n | project-away Threat_Category1, TimeGenerated\\n | project Threat_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"Proxy - Events by Threat Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"35\",\"name\":\"ProxyEventsByThreatCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange}\\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n| summarize Count=count() by UrlOriginal, UrlCategory \\n| top 10 by Count\\n\",\"size\":0,\"title\":\"Proxy - Top 10 Blocked Url \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"name\":\"ProxyTop10BlockedUrl \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"cloudfirewalllogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"Firewall - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DvcAction\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"30\",\"name\":\"FirewallEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"cloudfirewalllogs\\\"\\n| make-series Packets = sum(toint(NetworkPackets)) on TimeGenerated  from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by NetworkDirection\",\"size\":0,\"title\":\"Firewall - Traffic over time, Packets\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"70\",\"name\":\"FirewallTrafficOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n|where EventType == \\\"cloudfirewalllogs\\\"\\n| where DvcAction contains \\\"BLOCK\\\"\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Firewall - Block Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"50\",\"name\":\"query - 19\"}],\"fromTemplateId\":\"sentinel-CiscoUmbrella\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(resourceId('Microsoft.Insights/workbooks', 'CiscoUmbrellaWorkbook'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=CiscoUmbrellaWorkbook; logoFileName=cisco_logo.svg; description=Gain insights into Cisco Umbrella activities, including the DNS, Proxy and Cloud Firewall data. Workbook shows general information along with threat landscape including categories, blocked destinations and URLs.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Cisco Umbrella; templateRelativePath=CiscoUmbrella.json; subtitle=; provider=Cisco}.description",
                "parentId": "[resourceId('Microsoft.Insights/workbooks', 'CiscoUmbrellaWorkbook')]",
                "contentId": "CiscoUmbrellaWorkbook",
                "kind": "Workbook",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "Cisco_Umbrella_dns_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Cisco_Umbrella_proxy_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Cisco_Umbrella_ip_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "Cisco_Umbrella_cloudfirewall_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CiscoUmbrellaDataConnector",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrellaWorkbook",
        "contentKind": "Workbook",
        "displayName": "Cisco Umbrella",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-wb-fjrbjekl55t5a",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-wb-fjrbjekl55t5a",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c9b6d281-b96b-4763-b728-9a04b9fe1246')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "IP addresses of broadband links that usually indicates users attempting to access their home network, for example for a remote session to a home computer.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "c9b6d281-b96b-4763-b728-9a04b9fe1246",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "IP addresses of broadband links that usually indicates users attempting to access their home network, for example for a remote session to a home computer.",
                "displayName": "Cisco Umbrella - Connection to non-corporate private network",
                "enabled": false,
                "query": "Cisco_Umbrella\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory has_any ('Dynamic and Residential', 'Personal VPN')\n| project TimeGenerated, SrcIpAddr, DstIpAddr, Identities \n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "techniques": [
                  "T1573",
                  "T1041"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c9b6d281-b96b-4763-b728-9a04b9fe1246'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 1",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c9b6d281-b96b-4763-b728-9a04b9fe1246')]",
                "contentId": "c9b6d281-b96b-4763-b728-9a04b9fe1246",
                "kind": "AnalyticsRule",
                "version": "1.0.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "c9b6d281-b96b-4763-b728-9a04b9fe1246",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Connection to non-corporate private network",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-k6dulmhiozcss",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-k6dulmhiozcss",
        "version": "1.0.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('75297f62-10a8-4fc1-9b2a-12f25c6f05a7')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Detects first connection to an unpopular website (possible malicious payload delivery).",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "75297f62-10a8-4fc1-9b2a-12f25c6f05a7",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects first connection to an unpopular website (possible malicious payload delivery).",
                "displayName": "Cisco Umbrella - Connection to Unpopular Website Detected",
                "enabled": false,
                "query": "let top_million_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| summarize count() by tostring(Hostname)\n| top 1000000 by count_\n| summarize make_list(Hostname);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| where Hostname !in (top_million_list)\n| extend Message = \"Connect to unpopular website (possible malicious payload delivery)\"\n| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal \n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "subTechniques": [
                  "T1071.001"
                ],
                "techniques": [
                  "T1071",
                  "T1041"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '75297f62-10a8-4fc1-9b2a-12f25c6f05a7'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 2",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '75297f62-10a8-4fc1-9b2a-12f25c6f05a7')]",
                "contentId": "75297f62-10a8-4fc1-9b2a-12f25c6f05a7",
                "kind": "AnalyticsRule",
                "version": "1.1.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "75297f62-10a8-4fc1-9b2a-12f25c6f05a7",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Connection to Unpopular Website Detected",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-5kv3vjgefq4ge",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-5kv3vjgefq4ge",
        "version": "1.1.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b619d1f1-7f39-4c7e-bf9e-afbb46457997')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Detects suspicious user agent strings used by crypto miners in proxy logs.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "b619d1f1-7f39-4c7e-bf9e-afbb46457997",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects suspicious user agent strings used by crypto miners in proxy logs.",
                "displayName": "Cisco Umbrella - Crypto Miner User-Agent Detected",
                "enabled": false,
                "query": "Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where HttpUserAgentOriginal contains \"XMRig\" or HttpUserAgentOriginal contains \"ccminer\"\n| extend Message = \"Crypto Miner User Agent\"\n| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "Impact",
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "subTechniques": [
                  "T1071.001"
                ],
                "techniques": [
                  "T1496",
                  "T1071",
                  "T1041"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b619d1f1-7f39-4c7e-bf9e-afbb46457997'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 3",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b619d1f1-7f39-4c7e-bf9e-afbb46457997')]",
                "contentId": "b619d1f1-7f39-4c7e-bf9e-afbb46457997",
                "kind": "AnalyticsRule",
                "version": "1.1.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "b619d1f1-7f39-4c7e-bf9e-afbb46457997",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Crypto Miner User-Agent Detected",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-dhslikqvubalm",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-dhslikqvubalm",
        "version": "1.1.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2b328487-162d-4034-b472-59f1d53684a1')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "2b328487-162d-4034-b472-59f1d53684a1",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.",
                "displayName": "Cisco Umbrella - Empty User Agent Detected",
                "enabled": false,
                "query": "Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where HttpUserAgentOriginal == ''\n| extend Message = \"Empty User Agent\"\n| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal \n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "subTechniques": [
                  "T1001.003"
                ],
                "techniques": [
                  "T1001"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2b328487-162d-4034-b472-59f1d53684a1'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 4",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2b328487-162d-4034-b472-59f1d53684a1')]",
                "contentId": "2b328487-162d-4034-b472-59f1d53684a1",
                "kind": "AnalyticsRule",
                "version": "1.1.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "2b328487-162d-4034-b472-59f1d53684a1",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Empty User Agent Detected",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-uqu3h4jygivxo",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-uqu3h4jygivxo",
        "version": "1.1.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8d537f3c-094f-430c-a588-8a87da36ee3a')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Detects suspicious user agent strings used by known hack tools",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "8d537f3c-094f-430c-a588-8a87da36ee3a",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects suspicious user agent strings used by known hack tools",
                "displayName": "Cisco Umbrella - Hack Tool User-Agent Detected",
                "enabled": false,
                "query": "let user_agents=dynamic([\n                          '(hydra)',\n                          ' arachni/',\n                          ' BFAC ',\n                          ' brutus ',\n                          ' cgichk ',\n                          'core-project/1.0',\n                          ' crimscanner/',\n                          'datacha0s',\n                          'dirbuster',\n                          'domino hunter',\n                          'dotdotpwn',\n                          'FHScan Core',\n                          'floodgate',\n                          'get-minimal',\n                          'gootkit auto-rooter scanner',\n                          'grendel-scan',\n                          ' inspath ',\n                          'internet ninja',\n                          'jaascois',\n                          ' zmeu ',\n                          'masscan',\n                          ' metis ',\n                          'morfeus fucking scanner',\n                          'n-stealth',\n                          'nsauditor',\n                          'pmafind',\n                          'security scan',\n                          'springenwerk',\n                          'teh forest lobster',\n                          'toata dragostea',\n                          ' vega/',\n                          'voideye',\n                          'webshag',\n                          'webvulnscan',\n                          ' whcc/',\n                          ' Havij',\n                          'absinthe',\n                          'bsqlbf',\n                          'mysqloit',\n                          'pangolin',\n                          'sql power injector',\n                          'sqlmap',\n                          'sqlninja',\n                          'uil2pn',\n                          'ruler',\n                          'Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-PT; rv:1.9.1.2) Gecko/20090729 Firefox/3.5.2 (.NET CLR 3.5.30729)'\n                          ]);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where HttpUserAgentOriginal has_any (user_agents)\n| extend Message = \"Hack Tool User Agent\"\n| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "Execution",
                  "Discovery",
                  "LateralMovement",
                  "Collection",
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "techniques": [
                  "T1059",
                  "T1046",
                  "T1021",
                  "T1557",
                  "T1102",
                  "T1020"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8d537f3c-094f-430c-a588-8a87da36ee3a'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 5",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8d537f3c-094f-430c-a588-8a87da36ee3a')]",
                "contentId": "8d537f3c-094f-430c-a588-8a87da36ee3a",
                "kind": "AnalyticsRule",
                "version": "1.1.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "8d537f3c-094f-430c-a588-8a87da36ee3a",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Hack Tool User-Agent Detected",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-ux4zo62zzt3qe",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-ux4zo62zzt3qe",
        "version": "1.1.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b12b3dab-d973-45af-b07e-e29bb34d8db9')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Rule helps to detect Powershell user-agent activity by an unusual process other than a web browser.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "b12b3dab-d973-45af-b07e-e29bb34d8db9",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Rule helps to detect Powershell user-agent activity by an unusual process other than a web browser.",
                "displayName": "Cisco Umbrella - Windows PowerShell User-Agent Detected",
                "enabled": false,
                "query": "Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where HttpUserAgentOriginal contains \"WindowsPowerShell\"\n| extend Message = \"Windows PowerShell User Agent\"\n| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "DefenseEvasion",
                  "Execution"
                ],
                "subTechniques": [
                  "T1059.001"
                ],
                "techniques": [
                  "T1132",
                  "T1027",
                  "T1059"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b12b3dab-d973-45af-b07e-e29bb34d8db9'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 6",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b12b3dab-d973-45af-b07e-e29bb34d8db9')]",
                "contentId": "b12b3dab-d973-45af-b07e-e29bb34d8db9",
                "kind": "AnalyticsRule",
                "version": "1.1.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "b12b3dab-d973-45af-b07e-e29bb34d8db9",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Windows PowerShell User-Agent Detected",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-tzrvi6kwoi33q",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-tzrvi6kwoi33q",
        "version": "1.1.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8c8de3fa-6425-4623-9cd9-45de1dd0569a')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Rule helps to detect a rare user-agents indicating web browsing activity by an unusual process other than a web browser.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.2",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "8c8de3fa-6425-4623-9cd9-45de1dd0569a",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Rule helps to detect a rare user-agents indicating web browsing activity by an unusual process other than a web browser.",
                "displayName": "Cisco Umbrella - Rare User Agent Detected",
                "enabled": false,
                "query": "let user_agents_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| summarize count() by HttpUserAgentOriginal\n| summarize make_list(HttpUserAgentOriginal);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where HttpUserAgentOriginal !in (user_agents_list)\n| extend Message = \"Rare User Agent\"\n| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "subTechniques": [
                  "T1071.001"
                ],
                "techniques": [
                  "T1071",
                  "T1041"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8c8de3fa-6425-4623-9cd9-45de1dd0569a'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 7",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8c8de3fa-6425-4623-9cd9-45de1dd0569a')]",
                "contentId": "8c8de3fa-6425-4623-9cd9-45de1dd0569a",
                "kind": "AnalyticsRule",
                "version": "1.1.2",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "8c8de3fa-6425-4623-9cd9-45de1dd0569a",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Rare User Agent Detected",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-tc3ik22liywiq",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-tc3ik22liywiq",
        "version": "1.1.2",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d6bf1931-b1eb-448d-90b2-de118559c7ce')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "It is reccomended that these Categories shoud be blocked by policies because they provide harmful/malicious content..",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.1",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "d6bf1931-b1eb-448d-90b2-de118559c7ce",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "It is reccomended that these Categories shoud be blocked by policies because they provide harmful/malicious content..",
                "displayName": "Cisco Umbrella - Request Allowed to harmful/malicious URI category",
                "enabled": false,
                "query": "Cisco_Umbrella\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, DstIpAddr, UrlOriginal, Identities\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "subTechniques": [
                  "T1071.001"
                ],
                "techniques": [
                  "T1071",
                  "T1041"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd6bf1931-b1eb-448d-90b2-de118559c7ce'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 8",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd6bf1931-b1eb-448d-90b2-de118559c7ce')]",
                "contentId": "d6bf1931-b1eb-448d-90b2-de118559c7ce",
                "kind": "AnalyticsRule",
                "version": "1.1.1",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "d6bf1931-b1eb-448d-90b2-de118559c7ce",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Request Allowed to harmful/malicious URI category",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-qfpbpm4encyoy",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-qfpbpm4encyoy",
        "version": "1.1.1",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('de58ee9e-b229-4252-8537-41a4c2f4045e')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.1",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "de58ee9e-b229-4252-8537-41a4c2f4045e",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).",
                "displayName": "Cisco Umbrella - Request to blocklisted file type",
                "enabled": false,
                "query": "let file_ext_blocklist = dynamic(['.ps1', '.vbs', '.bat', '.scr']);\nCisco_Umbrella\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| extend file_ext = extract(@'.*(\\.\\w+)$', 1, UrlOriginal)\n| extend Filename = extract(@'.*\\/*\\/(.*\\.\\w+)$', 1, UrlOriginal)\n| where file_ext in (file_ext_blocklist)\n| project TimeGenerated, SrcIpAddr, DstIpAddr, Identities, Filename, UrlOriginal \n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess",
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1189",
                  "T1105"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'de58ee9e-b229-4252-8537-41a4c2f4045e'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 9",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'de58ee9e-b229-4252-8537-41a4c2f4045e')]",
                "contentId": "de58ee9e-b229-4252-8537-41a4c2f4045e",
                "kind": "AnalyticsRule",
                "version": "1.0.1",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "de58ee9e-b229-4252-8537-41a4c2f4045e",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - Request to blocklisted file type",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-dkxovvch3wsbs",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-dkxovvch3wsbs",
        "version": "1.0.1",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ee1818ec-5f65-4991-b711-bcf2ab7e36c3')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Malware can use IP address to communicate with C2.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.1.1",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "ee1818ec-5f65-4991-b711-bcf2ab7e36c3",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Malware can use IP address to communicate with C2.",
                "displayName": "Cisco Umbrella - URI contains IP address",
                "enabled": false,
                "query": "Cisco_Umbrella\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlOriginal matches regex @'\\Ahttp:\\/\\/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*'\n| project TimeGenerated, SrcIpAddr, DstIpAddr, UrlOriginal, Identities\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cisco_Umbrella_proxy_CL"
                    ],
                    "connectorId": "CiscoUmbrellaDataConnector"
                  }
                ],
                "tactics": [
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "techniques": [
                  "T1071",
                  "T1567"
                ],
                "entityMappings": [
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlOriginal",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ee1818ec-5f65-4991-b711-bcf2ab7e36c3'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Analytics Rule 10",
                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ee1818ec-5f65-4991-b711-bcf2ab7e36c3')]",
                "contentId": "ee1818ec-5f65-4991-b711-bcf2ab7e36c3",
                "kind": "AnalyticsRule",
                "version": "1.1.1",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "ee1818ec-5f65-4991-b711-bcf2ab7e36c3",
        "contentKind": "AnalyticsRule",
        "displayName": "Cisco Umbrella - URI contains IP address",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-ycf45vwr4qb7o",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-ar-ycf45vwr4qb7o",
        "version": "1.1.1",
        "isDeprecated": false,
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "contentKind": "DataType",
              "contentId": "Cisco_Umbrella_proxy_CL"
            },
            {
              "contentKind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c92741e6-8454-40bb-8830-069cb86946c6')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Large number of FQDNs for domain may be indicator of suspicious domain.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Anomalous FQDNs for domain",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| extend replaced = replace(@'\\.$', @'', DnsQueryName)\n| extend Domain = extract(@'.*\\.(.*\\.[a-z]+)', 1, replaced)\n| extend fqdn = extract(@'(.*)\\..*\\.[a-z]+', 1, replaced)\n| summarize FQDNs = dcount(fqdn) by Domain\n| sort by FQDNs\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Large number of FQDNs for domain may be indicator of suspicious domain."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', 'c92741e6-8454-40bb-8830-069cb86946c6'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 1",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', 'c92741e6-8454-40bb-8830-069cb86946c6')]",
                "contentId": "c92741e6-8454-40bb-8830-069cb86946c6",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "c92741e6-8454-40bb-8830-069cb86946c6",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - Anomalous FQDNs for domain",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-iujww4idksy5o",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-iujww4idksy5o",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('22e5e573-409b-433f-91de-50d6f0ad5a9e')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Shows User-Agent values which requests were blocked",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - 'Blocked' User-Agents.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Blocked'\n| summarize count() by HttpUserAgentOriginal\n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows User-Agent values which requests were blocked"
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  },
                  {
                    "name": "techniques",
                    "value": "T1020"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', '22e5e573-409b-433f-91de-50d6f0ad5a9e'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 2",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', '22e5e573-409b-433f-91de-50d6f0ad5a9e')]",
                "contentId": "22e5e573-409b-433f-91de-50d6f0ad5a9e",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "22e5e573-409b-433f-91de-50d6f0ad5a9e",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - 'Blocked' User-Agents.",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-coclx3pn7wuzo",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-coclx3pn7wuzo",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('26aebe0d-9a4f-456d-bbb9-9f4c9c5d28ca')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Shows error DNS requests.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - DNS Errors.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where DnsResponseCodeName != 'NOERROR'\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows error DNS requests."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1189"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', '26aebe0d-9a4f-456d-bbb9-9f4c9c5d28ca'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 3",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', '26aebe0d-9a4f-456d-bbb9-9f4c9c5d28ca')]",
                "contentId": "26aebe0d-9a4f-456d-bbb9-9f4c9c5d28ca",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "26aebe0d-9a4f-456d-bbb9-9f4c9c5d28ca",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - DNS Errors.",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-3dcg4swyystx2",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-3dcg4swyystx2",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bd1457df-3e81-4218-a079-0963200c8d67')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Shows requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - DNS requests to unreliable categories.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'Allowed'\n| summarize TotalEvents = count() by DnsQueryName, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by DnsQueryName\n| extend URLCustomEntity = DnsQueryName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1189"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', 'bd1457df-3e81-4218-a079-0963200c8d67'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 4",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', 'bd1457df-3e81-4218-a079-0963200c8d67')]",
                "contentId": "bd1457df-3e81-4218-a079-0963200c8d67",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "bd1457df-3e81-4218-a079-0963200c8d67",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - DNS requests to unreliable categories.",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-yntymlw2qgkry",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-yntymlw2qgkry",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('55393e5b-3f7e-4d40-85e5-38ef9ecd8484')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Calculate the count of BytesIn per Source-Destination pair over 24 hours. Higher values may indicate beaconing.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Higher values of count of the Same BytesIn size",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr,DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| project Message, SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Calculate the count of BytesIn per Source-Destination pair over 24 hours. Higher values may indicate beaconing."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', '55393e5b-3f7e-4d40-85e5-38ef9ecd8484'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 5",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', '55393e5b-3f7e-4d40-85e5-38ef9ecd8484')]",
                "contentId": "55393e5b-3f7e-4d40-85e5-38ef9ecd8484",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "55393e5b-3f7e-4d40-85e5-38ef9ecd8484",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - Higher values of count of the Same BytesIn size",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-wxek6zybvfkkc",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-wxek6zybvfkkc",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('975419eb-7041-419c-b8f0-c4bf513cf2b2')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - High values of Uploaded Data",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(SrcBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_SrcBytes desc\n| project SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  },
                  {
                    "name": "techniques",
                    "value": "T1020"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', '975419eb-7041-419c-b8f0-c4bf513cf2b2'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 6",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', '975419eb-7041-419c-b8f0-c4bf513cf2b2')]",
                "contentId": "975419eb-7041-419c-b8f0-c4bf513cf2b2",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "975419eb-7041-419c-b8f0-c4bf513cf2b2",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - High values of Uploaded Data",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-4datnuibsk7ey",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-4datnuibsk7ey",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('85421f18-2de4-42ff-9ef4-058924dcb1bf')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Calculate the count of BytesIn per Source-Destination pair over 12/24 hours. Higher values may indicate beaconing. C2 servers reply with the same data, making BytesIn value the same.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Possible connection to C2.",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr, DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Calculate the count of BytesIn per Source-Destination pair over 12/24 hours. Higher values may indicate beaconing. C2 servers reply with the same data, making BytesIn value the same."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', '85421f18-2de4-42ff-9ef4-058924dcb1bf'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 7",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', '85421f18-2de4-42ff-9ef4-058924dcb1bf')]",
                "contentId": "85421f18-2de4-42ff-9ef4-058924dcb1bf",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "85421f18-2de4-42ff-9ef4-058924dcb1bf",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - Possible connection to C2.",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-iea32klenb6ao",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-iea32klenb6ao",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('497d7250-87e1-49b1-a096-94f61c7ade9c')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Possible data exfiltration",
                "category": "Hunting Queries",
                "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| extend Message = \"Possible data exfiltration\"\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  },
                  {
                    "name": "techniques",
                    "value": "T1020"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', '497d7250-87e1-49b1-a096-94f61c7ade9c'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 8",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', '497d7250-87e1-49b1-a096-94f61c7ade9c')]",
                "contentId": "497d7250-87e1-49b1-a096-94f61c7ade9c",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "497d7250-87e1-49b1-a096-94f61c7ade9c",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - Possible data exfiltration",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-fp5jjwrknouje",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-fp5jjwrknouje",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('daf2f3cf-0f0d-45c1-b428-3c23d643859b')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Shows allowed requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Proxy 'Allowed' to unreliable categories.",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'proxylogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'ALLOWED'\n| summarize TotalEvents = count() by UrlOriginal, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by UrlOriginal\n| extend URLCustomEntity = UrlOriginal\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows allowed requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1189"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', 'daf2f3cf-0f0d-45c1-b428-3c23d643859b'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 9",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', 'daf2f3cf-0f0d-45c1-b428-3c23d643859b')]",
                "contentId": "daf2f3cf-0f0d-45c1-b428-3c23d643859b",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "daf2f3cf-0f0d-45c1-b428-3c23d643859b",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - Proxy 'Allowed' to unreliable categories.",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-zxd5gnshpdmle",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-zxd5gnshpdmle",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('de2ec986-ee24-465f-adf2-b718997074c1')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "Shows requests to URL where UrlCategory is not set.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "CiscoUmbrella_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Umbrella - Requests to uncategorized resources",
                "category": "Hunting Queries",
                "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Allowed'\n| where UrlCategory == ''\n| project UrlOriginal, Identities\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Shows requests to URL where UrlCategory is not set."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', 'de2ec986-ee24-465f-adf2-b718997074c1'),'/'))))]",
              "properties": {
                "description": "CiscoUmbrella Hunting Query 10",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', 'de2ec986-ee24-465f-adf2-b718997074c1')]",
                "contentId": "de2ec986-ee24-465f-adf2-b718997074c1",
                "kind": "HuntingQuery",
                "version": "1.0.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "de2ec986-ee24-465f-adf2-b718997074c1",
        "contentKind": "HuntingQuery",
        "displayName": "Cisco Umbrella - Requests to uncategorized resources",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-vcicql3nbwlwq",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-hq-vcicql3nbwlwq",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('Cisco_Umbrella-Parser')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/','CiscoUmbrella Data Parser')]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "CiscoUmbrella Data Parser",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "Cisco_Umbrella",
                "query": "let Cisco_Umbrella_dns_view = view () { \n    Cisco_Umbrella_dns_CL\n    | extend \n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        SrcIpAddr=column_ifexists('InternalIp_s', ''),\n        SrcNatIpAddr=column_ifexists('ExternalIp_s', ''),\n        DvcAction=column_ifexists('Action_s', ''),\n        DnsQueryName=column_ifexists('Domain_s', ''),\n        UrlCategory=column_ifexists('Categories_s', ''),\n        ThreatCategory=column_ifexists('Blocked_Categories_s', ''),\n        Identities=column_ifexists('Identities_s', ''),\n        DnsQueryTypeName=column_ifexists('QueryType_s', ''),\n        DnsResponseCodeName=column_ifexists('ResponseCode_s', ''),\n        IdentityTypes=column_ifexists('Identity_Types_s', ''),\n        EventType=column_ifexists('EventType_s', ''),\n        PolicyIdentity=column_ifexists('Policy_Identity_s', ''),\n        PolicyIdentityType=column_ifexists('Policy_Identity_Type_s', '')\n    | project \n        TimeGenerated,\n        EventEndTime,\n        SrcIpAddr,\n        SrcNatIpAddr,\n        DvcAction,\n        DnsQueryName,\n        UrlCategory,\n        ThreatCategory,\n        Identities,\n        DnsQueryTypeName,\n        DnsResponseCodeName,\n        IdentityTypes,\n        EventType,\n        PolicyIdentity,\n        PolicyIdentityType\n};\nlet Cisco_Umbrella_proxy_view = view () { \n    Cisco_Umbrella_proxy_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        Identities=column_ifexists('Identities_s', ''),\n        SrcIpAddr=column_ifexists('Internal_IP_s', ''),\n        SrcNatIpAddr=column_ifexists('External_IP_s', ''),\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\n        HttpContentType=column_ifexists('Content_Type_s', ''),\n        DvcAction=column_ifexists('Verdict_s', ''),\n        UrlOriginal=column_ifexists('URL_s', ''),\n        HttpReferrerOriginal=column_ifexists('Referer_s', ''),\n        HttpUserAgentOriginal=column_ifexists('userAgent_s', ''),\n        HttpStatusCode=column_ifexists('statusCode_s', ''),\n        SrcBytes=column_ifexists('requestSize_d', ''),\n        DstBytes=column_ifexists('responseSize_d', ''),\n        HttpResponseBodyBytes=column_ifexists('responseBodySize_d', ''),\n        HashSha256=column_ifexists('SHA-SHA256_s', ''),\n        UrlCategory=column_ifexists('Categories_s', ''),\n        AvDetections=column_ifexists('AVDetections_s', ''),\n        Puas=column_ifexists('PUAs_s', ''),\n        AmpDisposition=column_ifexists('AMP_Disposition_s', ''), \n        ThreatName=column_ifexists('AMP_Malware_Name_s', ''),\n        AmpScore=column_ifexists('AMP_Score_s', ''),\n        IdentityType=column_ifexists('Identity_Type_s', ''),\n        ThreatCategory=column_ifexists('Blocked_Categories_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        Identities,\n        SrcIpAddr,\n        SrcNatIpAddr,\n        DstIpAddr,\n        HttpContentType,\n        DvcAction,\n        UrlOriginal,\n        HttpReferrerOriginal,\n        HttpUserAgentOriginal,\n        HttpStatusCode,\n        SrcBytes,\n        DstBytes,\n        HttpResponseBodyBytes,\n        HashSha256,\n        UrlCategory,\n        AvDetections,\n        Puas,\n        AmpDisposition,\n        ThreatName,\n        AmpScore,\n        IdentityType,\n        ThreatCategory\n};\nlet Cisco_Umbrella_ip_view = view () { \n    Cisco_Umbrella_ip_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        Identities=column_ifexists('Identity_s', ''),\n        SrcIpAddr=column_ifexists('Source_IP_s', ''),\n        SrcPortNumber=column_ifexists('Source_Port_s', ''),\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\n        DstPortNumber=column_ifexists('Destination_Port_s', ''),\n        UrlCategory=column_ifexists('Categories_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        Identities,\n        SrcIpAddr,\n        SrcPortNumber,\n        DstIpAddr,\n        DstPortNumber,\n        UrlCategory\n};\nlet Cisco_Umbrella_cloudfirewall_view = view () { \n    Cisco_Umbrella_cloudfirewall_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        NetworkSessionId=column_ifexists('originId_s', ''),\n        NetworkRuleName=column_ifexists('Identity_s', ''),\n        IdentityType=column_ifexists('Identity_Type_s', ''),\n        NetworkDirection=column_ifexists('Direction_s', ''),\n        NetworkProtocol=column_ifexists('ipProtocol_s', ''),\n        NetworkPackets=column_ifexists('packetSize_s', ''),\n        SrcIpAddr=column_ifexists('SourceIP', ''),\n        SrcPortNumber=column_ifexists('sourcePort_s', ''),\n        DstIpAddr=column_ifexists('destinationIp_s', ''),\n        DstPortNumber=column_ifexists('destinationPort_s', ''),\n        DvcHostname=column_ifexists('dataCenter_s', ''),\n        NetworkRuleNumber=column_ifexists('ruleId_s', ''),\n        DvcAction=column_ifexists('verdict_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        NetworkSessionId,\n        NetworkRuleName,\n        IdentityType,\n        NetworkDirection,\n        NetworkProtocol,\n        NetworkPackets,\n        SrcIpAddr,\n        SrcPortNumber,\n        DstIpAddr,\n        DstPortNumber,\n        DvcHostname,\n        NetworkRuleNumber,\n        DvcAction\n};\nunion isfuzzy=true Cisco_Umbrella_dns_view, Cisco_Umbrella_proxy_view, Cisco_Umbrella_ip_view, Cisco_Umbrella_cloudfirewall_view\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'CiscoUmbrella Data Parser'),'/'))))]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'CiscoUmbrella Data Parser')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'CiscoUmbrella Data Parser')]",
                "contentId": "Cisco_Umbrella-Parser",
                "kind": "Parser",
                "version": "1.0.0",
                "source": {
                  "name": "CiscoUmbrella",
                  "kind": "Solution",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "Cisco_Umbrella-Parser",
        "contentKind": "Parser",
        "displayName": "CiscoUmbrella Data Parser",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pr-gdmhuilb4nn42",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pr-gdmhuilb4nn42",
        "version": "1.0.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('workspace'),'/','CiscoUmbrella Data Parser')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "CiscoUmbrella Data Parser",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "Cisco_Umbrella",
        "query": "let Cisco_Umbrella_dns_view = view () { \n    Cisco_Umbrella_dns_CL\n    | extend \n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        SrcIpAddr=column_ifexists('InternalIp_s', ''),\n        SrcNatIpAddr=column_ifexists('ExternalIp_s', ''),\n        DvcAction=column_ifexists('Action_s', ''),\n        DnsQueryName=column_ifexists('Domain_s', ''),\n        UrlCategory=column_ifexists('Categories_s', ''),\n        ThreatCategory=column_ifexists('Blocked_Categories_s', ''),\n        Identities=column_ifexists('Identities_s', ''),\n        DnsQueryTypeName=column_ifexists('QueryType_s', ''),\n        DnsResponseCodeName=column_ifexists('ResponseCode_s', ''),\n        IdentityTypes=column_ifexists('Identity_Types_s', ''),\n        EventType=column_ifexists('EventType_s', ''),\n        PolicyIdentity=column_ifexists('Policy_Identity_s', ''),\n        PolicyIdentityType=column_ifexists('Policy_Identity_Type_s', '')\n    | project \n        TimeGenerated,\n        EventEndTime,\n        SrcIpAddr,\n        SrcNatIpAddr,\n        DvcAction,\n        DnsQueryName,\n        UrlCategory,\n        ThreatCategory,\n        Identities,\n        DnsQueryTypeName,\n        DnsResponseCodeName,\n        IdentityTypes,\n        EventType,\n        PolicyIdentity,\n        PolicyIdentityType\n};\nlet Cisco_Umbrella_proxy_view = view () { \n    Cisco_Umbrella_proxy_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        Identities=column_ifexists('Identities_s', ''),\n        SrcIpAddr=column_ifexists('Internal_IP_s', ''),\n        SrcNatIpAddr=column_ifexists('External_IP_s', ''),\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\n        HttpContentType=column_ifexists('Content_Type_s', ''),\n        DvcAction=column_ifexists('Verdict_s', ''),\n        UrlOriginal=column_ifexists('URL_s', ''),\n        HttpReferrerOriginal=column_ifexists('Referer_s', ''),\n        HttpUserAgentOriginal=column_ifexists('userAgent_s', ''),\n        HttpStatusCode=column_ifexists('statusCode_s', ''),\n        SrcBytes=column_ifexists('requestSize_d', ''),\n        DstBytes=column_ifexists('responseSize_d', ''),\n        HttpResponseBodyBytes=column_ifexists('responseBodySize_d', ''),\n        HashSha256=column_ifexists('SHA-SHA256_s', ''),\n        UrlCategory=column_ifexists('Categories_s', ''),\n        AvDetections=column_ifexists('AVDetections_s', ''),\n        Puas=column_ifexists('PUAs_s', ''),\n        AmpDisposition=column_ifexists('AMP_Disposition_s', ''), \n        ThreatName=column_ifexists('AMP_Malware_Name_s', ''),\n        AmpScore=column_ifexists('AMP_Score_s', ''),\n        IdentityType=column_ifexists('Identity_Type_s', ''),\n        ThreatCategory=column_ifexists('Blocked_Categories_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        Identities,\n        SrcIpAddr,\n        SrcNatIpAddr,\n        DstIpAddr,\n        HttpContentType,\n        DvcAction,\n        UrlOriginal,\n        HttpReferrerOriginal,\n        HttpUserAgentOriginal,\n        HttpStatusCode,\n        SrcBytes,\n        DstBytes,\n        HttpResponseBodyBytes,\n        HashSha256,\n        UrlCategory,\n        AvDetections,\n        Puas,\n        AmpDisposition,\n        ThreatName,\n        AmpScore,\n        IdentityType,\n        ThreatCategory\n};\nlet Cisco_Umbrella_ip_view = view () { \n    Cisco_Umbrella_ip_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        Identities=column_ifexists('Identity_s', ''),\n        SrcIpAddr=column_ifexists('Source_IP_s', ''),\n        SrcPortNumber=column_ifexists('Source_Port_s', ''),\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\n        DstPortNumber=column_ifexists('Destination_Port_s', ''),\n        UrlCategory=column_ifexists('Categories_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        Identities,\n        SrcIpAddr,\n        SrcPortNumber,\n        DstIpAddr,\n        DstPortNumber,\n        UrlCategory\n};\nlet Cisco_Umbrella_cloudfirewall_view = view () { \n    Cisco_Umbrella_cloudfirewall_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        NetworkSessionId=column_ifexists('originId_s', ''),\n        NetworkRuleName=column_ifexists('Identity_s', ''),\n        IdentityType=column_ifexists('Identity_Type_s', ''),\n        NetworkDirection=column_ifexists('Direction_s', ''),\n        NetworkProtocol=column_ifexists('ipProtocol_s', ''),\n        NetworkPackets=column_ifexists('packetSize_s', ''),\n        SrcIpAddr=column_ifexists('SourceIP', ''),\n        SrcPortNumber=column_ifexists('sourcePort_s', ''),\n        DstIpAddr=column_ifexists('destinationIp_s', ''),\n        DstPortNumber=column_ifexists('destinationPort_s', ''),\n        DvcHostname=column_ifexists('dataCenter_s', ''),\n        NetworkRuleNumber=column_ifexists('ruleId_s', ''),\n        DvcAction=column_ifexists('verdict_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        NetworkSessionId,\n        NetworkRuleName,\n        IdentityType,\n        NetworkDirection,\n        NetworkProtocol,\n        NetworkPackets,\n        SrcIpAddr,\n        SrcPortNumber,\n        DstIpAddr,\n        DstPortNumber,\n        DvcHostname,\n        NetworkRuleNumber,\n        DvcAction\n};\nunion isfuzzy=true Cisco_Umbrella_dns_view, Cisco_Umbrella_proxy_view, Cisco_Umbrella_ip_view, Cisco_Umbrella_cloudfirewall_view\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'CiscoUmbrella Data Parser'),'/'))))]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'CiscoUmbrella Data Parser')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'CiscoUmbrella Data Parser')]",
        "contentId": "Cisco_Umbrella-Parser",
        "kind": "Parser",
        "version": "1.0.0",
        "source": {
          "kind": "Solution",
          "name": "CiscoUmbrella",
          "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
        },
        "author": {
          "name": "Microsoft",
          "email": "support@microsoft.com"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring('CiscoUmbrellaEnforcementAPIConnector')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "customApis_CiscoUmbrellaEnforcementAPI_name": {
              "defaultValue": "CiscoUmbrellaEnforcementAPI",
              "type": "String"
            }
          },
          "variables": {
            "operationId-BlockDomains": "BlockDomains",
            "_operationId-BlockDomains": "[[variables('operationId-BlockDomains')]",
            "operationId-GetDomains": "GetDomains",
            "_operationId-GetDomains": "[[variables('operationId-GetDomains')]",
            "operationId-DeleteDomainByName": "DeleteDomainByName",
            "_operationId-DeleteDomainByName": "[[variables('operationId-DeleteDomainByName')]",
            "operationId-DeleteDomainById": "DeleteDomainById",
            "_operationId-DeleteDomainById": "[[variables('operationId-DeleteDomainById')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "CiscoUmbrellaEnforcementAPIConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('customApis_CiscoUmbrellaEnforcementAPI_name'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('customApis_CiscoUmbrellaEnforcementAPI_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Cisco Umbrella Enforcement API customerKey",
                      "description": "Cisco Umbrella Enforcement API customerKey",
                      "tooltip": "Provide your Cisco Umbrella Enforcement API customerKey",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "Connector for Cisco Umbrella Enforcment API",
                "displayName": "[[parameters('customApis_CiscoUmbrellaEnforcementAPI_name')]",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
                "backendService": {
                  "serviceUrl": "https://s-platform.api.opendns.com"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "CiscoUmbrellaEnforcementAPIConnector",
                    "version": "1.0",
                    "description": "Connector for Cisco Umbrella Enforcment API"
                  },
                  "host": "s-platform.api.opendns.com",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "paths": {
                    "/1.0/events": {
                      "post": {
                        "summary": "Block domains",
                        "parameters": [
                          {
                            "name": "Accept",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-visibility": "internal"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "schema": {
                              "$ref": "#/definitions/events_array"
                            }
                          }
                        ],
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "string",
                                  "description": "id"
                                }
                              }
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-BlockDomains')]",
                        "description": "Posts a Malware event to the API for processing and optionally adding to a customer's domain lists"
                      }
                    },
                    "/1.0/domains": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "meta": {
                                  "type": "object",
                                  "properties": {
                                    "page": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "page"
                                    },
                                    "limit": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "limit"
                                    },
                                    "prev": {
                                      "type": "string",
                                      "description": "prev"
                                    },
                                    "next": {
                                      "type": "string",
                                      "description": "next"
                                    }
                                  },
                                  "description": "meta"
                                },
                                "data": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "domain id",
                                        "title": "id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "domain name",
                                        "title": "name"
                                      }
                                    }
                                  },
                                  "description": "data"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get domains",
                        "operationId": "[[variables('_operationId-GetDomains')]",
                        "description": "Get the list of domains added to the shared customer’s domain list.",
                        "parameters": [
                          {
                            "name": "page",
                            "in": "query",
                            "required": false,
                            "type": "integer",
                            "default": 1
                          },
                          {
                            "name": "limit",
                            "in": "query",
                            "required": false,
                            "type": "integer",
                            "default": 200,
                            "description": "[replace('b', 'b', '')]"
                          }
                        ]
                      },
                      "delete": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "summary": "Delete domain by name",
                        "description": "Delete a domain from the shared customer’s domain list by domain name.",
                        "operationId": "[[variables('_operationId-DeleteDomainByName')]",
                        "parameters": [
                          {
                            "name": "where[name]",
                            "in": "query",
                            "required": true,
                            "type": "string",
                            "x-ms-summary": "Domain name"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-visibility": "internal"
                          }
                        ]
                      }
                    },
                    "/1.0/domains/{DomainId}": {
                      "delete": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "summary": "Delete domain by id",
                        "operationId": "[[variables('_operationId-DeleteDomainById')]",
                        "parameters": [
                          {
                            "name": "DomainId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-visibility": "internal"
                          }
                        ],
                        "description": "Delete a domain from the shared customer’s domain list by Id."
                      }
                    }
                  },
                  "definitions": {
                    "events_array": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "required": [
                          "alertTime",
                          "deviceId",
                          "deviceVersion",
                          "dstDomain",
                          "dstUrl",
                          "eventTime",
                          "protocolVersion",
                          "providerName"
                        ],
                        "properties": {
                          "alertTime": {
                            "type": "string"
                          },
                          "deviceId": {
                            "type": "string",
                            "title": "deviceId",
                            "x-ms-visibility": "internal",
                            "default": "azuresentinel"
                          },
                          "deviceVersion": {
                            "type": "string",
                            "title": "deviceVersion",
                            "x-ms-visibility": "internal",
                            "default": "13.7a"
                          },
                          "dstDomain": {
                            "type": "string"
                          },
                          "dstUrl": {
                            "type": "string"
                          },
                          "eventTime": {
                            "type": "string"
                          },
                          "protocolVersion": {
                            "type": "string",
                            "default": "1.0a",
                            "title": "protocolVersion",
                            "x-ms-visibility": "internal"
                          },
                          "providerName": {
                            "type": "string",
                            "default": "Security Platform",
                            "title": "providerName",
                            "x-ms-visibility": "internal"
                          }
                        }
                      }
                    }
                  },
                  "securityDefinitions": {
                    "API Key": {
                      "type": "apiKey",
                      "in": "query",
                      "name": "customerKey"
                    }
                  },
                  "security": [
                    {
                      "API Key": "[json('[]')]"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "CiscoUmbrellaEnforcementAPIConnector",
                "kind": "LogicAppsCustomConnector",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrellaEnforcementAPIConnector",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "CiscoUmbrellaEnforcementAPIConnector",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-ldg2lm5zfrccw",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-ldg2lm5zfrccw",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring('CiscoUmbrellaInvestigateAPIConnector')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "customApis_CiscoUmbrellaInvestigateAPIConnector_name": {
              "defaultValue": "CiscoUmbrellaInvestigateAPI",
              "type": "String"
            }
          },
          "variables": {
            "operationId-GetDomainSecurityData": "GetDomainSecurityData",
            "_operationId-GetDomainSecurityData": "[[variables('operationId-GetDomainSecurityData')]",
            "operationId-GetDomainRiskScore": "GetDomainRiskScore",
            "_operationId-GetDomainRiskScore": "[[variables('operationId-GetDomainRiskScore')]",
            "operationId-GetDomainStatusAndCategorization": "GetDomainStatusAndCategorization",
            "_operationId-GetDomainStatusAndCategorization": "[[variables('operationId-GetDomainStatusAndCategorization')]",
            "operationId-GetCoOccurrencesForDomain": "GetCoOccurrencesForDomain",
            "_operationId-GetCoOccurrencesForDomain": "[[variables('operationId-GetCoOccurrencesForDomain')]",
            "operationId-GetRelatedDomains": "GetRelatedDomains",
            "_operationId-GetRelatedDomains": "[[variables('operationId-GetRelatedDomains')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId2": "CiscoUmbrellaInvestigateAPIConnector",
            "playbookId2": "[[resourceId('Microsoft.Web/customApis', parameters('customApis_CiscoUmbrellaInvestigateAPIConnector_name'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('customApis_CiscoUmbrellaInvestigateAPIConnector_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "API Key",
                      "description": "The API Key for this api",
                      "tooltip": "Provide your API Key in format: Bearer YOUR_API_KEY",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "Connector for Cisco Umbrella Investigate API",
                "displayName": "[[parameters('customApis_CiscoUmbrellaInvestigateAPIConnector_name')]",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
                "backendService": {
                  "serviceUrl": "https://investigate.api.umbrella.com"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Default title",
                    "description": "Connector for Cisco Umbrella Investigate API",
                    "version": "1.0"
                  },
                  "host": "investigate.api.umbrella.com",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[json('[]')]",
                  "produces": "[json('[]')]",
                  "paths": {
                    "/security/name/{Domain}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "dga_score": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Domain Generation Algorithm. This score is generated based on the likeliness of the domain name being generated by an algorithm rather than a human. This algorithm is designed to identify domains which have been created using an automated randomization strategy, which is a common evasion technique in malware kits or botnets. This score ranges from -100 (suspicious) to 0 (benign)."
                                },
                                "perplexity": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "A second score on the likeliness of the name to be algorithmically generated, on a scale from 0 to 100. This score is to be used in conjunction with DGA."
                                },
                                "entropy": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "The number of bits required to encode the domain name, as a score. This score is to be used in conjunction with DGA and Perplexity."
                                },
                                "securerank2": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "Suspicious rank for a domain that reviews based on the lookup behavior of client IP for the domain. Securerank is designed to identify hostnames requested by known infected clients but never requested by clean clients, assuming these domains are more likely to be bad. Scores returned range from -100 (suspicious) to 100 (benign)."
                                },
                                "pagerank": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "Popularity according to Google's pagerank algorithm"
                                },
                                "asn_score": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "ASN reputation score, ranges from -100 to 0 with -100 being very suspicious."
                                },
                                "prefix_score": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "Prefix ranks domains given their IP prefixes (an IP prefix is the first three octets in an IP address) and the reputation score of these prefixes. Ranges from -100 to 0, -100 being very suspicious."
                                },
                                "rip_score": {
                                  "type": "number",
                                  "format": "float",
                                  "description": "RIP ranks domains given their IP addresses and the reputation score of these IP addresses. Ranges from -100 to 0, -100 being very suspicious."
                                },
                                "popularity": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "The number of unique client IPs visiting this site, relative to the all requests to all sites. A score of how many different client/unique IPs go to this domain compared to others."
                                },
                                "fastflux": {
                                  "type": "boolean",
                                  "description": "fastflux",
                                  "x-ms-visibility": "internal"
                                },
                                "geodiversity": {
                                  "type": "array",
                                  "description": "array of geodiversity tuples",
                                  "x-ms-summary": "geodiversity array",
                                  "items": {
                                    "x-ms-summary": "geodiversity tuple",
                                    "description": "Tuple [\"country code\", \"score\"]. A score representing the number of queries from clients visiting the domain, broken down by country. Score is a non-normalized ratio between 0 and 1.",
                                    "type": "array"
                                  }
                                },
                                "geodiversity_normalized": {
                                  "type": "array",
                                  "description": "array of geodiversity_normalized tuples",
                                  "x-ms-summary": "geodiversity_normalized array",
                                  "items": {
                                    "x-ms-summary": "geodiversity_normalized tuple",
                                    "description": "Tuple [\"country code\", \"score\"]. A score representing the amount of queries for clients visiting the domain, broken down by country. Score is a normalized ratio between 0 and 1.",
                                    "type": "array"
                                  }
                                },
                                "tld_geodiversity": {
                                  "type": "array",
                                  "description": "array of tld_geodiversity tuples",
                                  "x-ms-summary": "tld_geodiversity array",
                                  "items": {
                                    "x-ms-summary": "tld_geodiversity tuple",
                                    "description": "Tuple [\"country code\", \"score\"]. A score that represents the TLD country code geodiversity as a percentage of clients visiting the domain. Occurs most often with domains that have a ccTLD. Score is normalized ratio between 0 and 1.",
                                    "type": "array"
                                  }
                                },
                                "geoscore": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "A score that represents how far the different physical locations serving this name are from each other."
                                },
                                "ks_test": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Kolmogorov–Smirnov test on geodiversity. 0 means that the client traffic matches what is expected for this TLD."
                                },
                                "attack": {
                                  "type": "string",
                                  "description": "The name of any known attacks associated with this domain. Returns blank if no known threat associated with domain."
                                },
                                "threat_type": {
                                  "type": "string",
                                  "description": "The type of the known attack, such as botnet or APT. Returns blank if no known threat associated with domain."
                                },
                                "found": {
                                  "type": "boolean",
                                  "description": "Returns true if results available. Returns blank if no known threat associated with domain."
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get domain security data",
                        "description": "Security Information for a Domain",
                        "operationId": "[[variables('_operationId-GetDomainSecurityData')]",
                        "parameters": [
                          {
                            "name": "Domain",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "/domains/risk-score/{DomainName}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "indicators": {
                                  "type": "array",
                                  "x-ms-summary": "indicators",
                                  "description": "array of indicator objects",
                                  "items": {
                                    "x-ms-summary": "indicator",
                                    "description": "indicator object",
                                    "type": "object",
                                    "properties": {
                                      "indicator": {
                                        "type": "string",
                                        "description": "indicator name",
                                        "title": "name"
                                      },
                                      "normalized_score": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "indicator normalized score"
                                      },
                                      "score": {
                                        "type": "boolean",
                                        "description": "indicator score"
                                      }
                                    }
                                  }
                                },
                                "risk_score": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "risk score"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Risk score for a domain",
                        "description": "Get Risk score for a domain",
                        "operationId": "[[variables('_operationId-GetDomainRiskScore')]",
                        "parameters": [
                          {
                            "name": "DomainName",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "/domains/categorization/{Domain}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "additionalProperties": {
                                "type": "object",
                                "description": "Domain object",
                                "title": "Domain object",
                                "x-ms-summary": "Domain object",
                                "properties": {
                                  "status": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "The status will be \"-1\" if the domain is believed to be malicious, \"1\" if the domain is believed to be benign, \"0\" if it hasn't been classified yet."
                                  },
                                  "security_categories": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "description": "The Umbrella security category, or categories, that match this domain or that this domain is associated with. If none match, the return will be blank."
                                  },
                                  "content_categories": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "description": "The Umbrella content category or categories that match this domain. If none match, the return will be blank."
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Domain Status and Categorization",
                        "description": "Get Domain Status and Categorization",
                        "operationId": "[[variables('_operationId-GetDomainStatusAndCategorization')]",
                        "parameters": [
                          {
                            "name": "Domain",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "showLabels",
                            "in": "query",
                            "required": true,
                            "type": "string",
                            "default": 1,
                            "x-ms-visibility": "internal"
                          }
                        ]
                      }
                    },
                    "/recommendations/name/{Domain}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "pfs2": {
                                  "type": "array",
                                  "x-ms-summary": "pfs2 array",
                                  "description": "Array of [domain name, scores] tuples. The values range between 0 and 1 and should not exceed 1. All co-occurences of requests from client IPs are returned for the previous seven days whether the co-occurence is suspicious or not.",
                                  "items": {
                                    "x-ms-summary": "pfs2 tuple",
                                    "description": "[[domain name, scores] tuple. The values range between 0 and 1 and should not exceed 1. All co-occurences of requests from client IPs are returned for the previous seven days whether the co-occurence is suspicious or not.",
                                    "type": "array"
                                  }
                                },
                                "found": {
                                  "type": "boolean",
                                  "description": "Returns true if results available. Nothing is returned if no results available."
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Co-Occurrences for a Domain",
                        "description": "Get Co-Occurrences for a Domain",
                        "operationId": "[[variables('_operationId-GetCoOccurrencesForDomain')]",
                        "parameters": [
                          {
                            "name": "Domain",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "/links/name/{Domain}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "tb1": {
                                  "type": "array",
                                  "x-ms-summary": "tb1 array",
                                  "description": "Array of [domain name, scores] tuples where score is the number of client IP requests to the site around the same time as the site being looked up. This is a score reflecting the number of client IPs looking up related sites within 60 seconds of the original request.",
                                  "items": {
                                    "x-ms-summary": "tb1 tuple",
                                    "description": "[[domain name, scores] tuples where score is the number of client IP requests to the site around the same time as the site being looked up. This is a score reflecting the number of client IPs looking up related sites within 60 seconds of the original request.",
                                    "type": "array"
                                  }
                                },
                                "found": {
                                  "type": "boolean",
                                  "description": "Returns true if results available. Nothing is returned if no results available."
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get a list of domain names requested the same time as a specified domain",
                        "description": "Get a list of domain names requested the same time as a specified domain",
                        "operationId": "[[variables('_operationId-GetRelatedDomains')]",
                        "parameters": [
                          {
                            "name": "Domain",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "API Key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "Authorization"
                    }
                  },
                  "security": [
                    {
                      "API Key": "[json('[]')]"
                    }
                  ],
                  "tags": "[json('[]')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId2')]",
                "contentId": "CiscoUmbrellaInvestigateAPIConnector",
                "kind": "LogicAppsCustomConnector",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrellaInvestigateAPIConnector",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "CiscoUmbrellaInvestigateAPIConnector",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-gveuxiyn2liho",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-gveuxiyn2liho",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring('CiscoUmbrellaManagementAPIConnector')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "customApis_CiscoUmbrellaManagementAPI_name": {
              "defaultValue": "CiscoUmbrellaManagementAPI",
              "type": "String"
            }
          },
          "variables": {
            "operationId-RetrieveAllDestinationLists": "RetrieveAllDestinationLists",
            "_operationId-RetrieveAllDestinationLists": "[[variables('operationId-RetrieveAllDestinationLists')]",
            "operationId-CreateDestinationList": "CreateDestinationList",
            "_operationId-CreateDestinationList": "[[variables('operationId-CreateDestinationList')]",
            "operationId-GetDestinationList": "GetDestinationList",
            "_operationId-GetDestinationList": "[[variables('operationId-GetDestinationList')]",
            "operationId-GetDestinationsList": "GetDestinationsList",
            "_operationId-GetDestinationsList": "[[variables('operationId-GetDestinationsList')]",
            "operationId-AddDestinations": "AddDestinations",
            "_operationId-AddDestinations": "[[variables('operationId-AddDestinations')]",
            "operationId-DeleteDestinations": "DeleteDestinations",
            "_operationId-DeleteDestinations": "[[variables('operationId-DeleteDestinations')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId3": "CiscoUmbrellaManagementAPIConnector",
            "playbookId3": "[[resourceId('Microsoft.Web/customApis', parameters('customApis_CiscoUmbrellaManagementAPI_name'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('customApis_CiscoUmbrellaManagementAPI_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "username": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Key",
                      "description": "The Key for this api",
                      "tooltip": "Provide the Key",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": true,
                        "required": "true"
                      }
                    }
                  },
                  "password": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Secret",
                      "description": "The Secret for this api",
                      "tooltip": "Provide the Secret",
                      "constraints": {
                        "tabIndex": 3,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "Connector for Cisco Umbrella Management API",
                "displayName": "[[parameters('customApis_CiscoUmbrellaManagementAPI_name')]",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
                "backendService": {
                  "serviceUrl": "https://management.api.umbrella.com"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Default title",
                    "description": "Connector for Cisco Umbrella Management API",
                    "version": "1.0"
                  },
                  "host": "management.api.umbrella.com",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[json('[]')]",
                  "produces": "[json('[]')]",
                  "paths": {
                    "/v1/organizations/{organizationId}/destinationlists": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "status": {
                                  "type": "object",
                                  "x-ms-summary": "Response status",
                                  "x-ms-visibility": "internal",
                                  "description": "Response status object",
                                  "properties": {
                                    "code": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "code"
                                    },
                                    "text": {
                                      "type": "string",
                                      "description": "text"
                                    }
                                  }
                                },
                                "meta": {
                                  "type": "object",
                                  "x-ms-visibility": "internal",
                                  "properties": {
                                    "page": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "page"
                                    },
                                    "limit": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "limit"
                                    },
                                    "total": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "total"
                                    }
                                  },
                                  "description": "meta"
                                },
                                "data": {
                                  "x-ms-summary": "Array of Destionation list objects",
                                  "description": "Array of Destionation list objects",
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Destionation list",
                                    "description": "Destionation list object",
                                    "properties": {
                                      "id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "Unique id of the destination list."
                                      },
                                      "organizationId": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "organizationId"
                                      },
                                      "access": {
                                        "type": "string",
                                        "description": "Access can be allow or block. It defines destinationlist type."
                                      },
                                      "isGlobal": {
                                        "type": "boolean",
                                        "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization."
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Name of the destination list."
                                      },
                                      "thirdpartyCategoryId": {
                                        "type": "string",
                                        "description": "Destionation list thirdpartyCategoryId"
                                      },
                                      "createdAt": {
                                        "type": "string",
                                        "description": "Creation date."
                                      },
                                      "modifiedAt": {
                                        "type": "string",
                                        "description": "Last modified date."
                                      },
                                      "isMspDefault": {
                                        "type": "boolean",
                                        "description": "Destionation list isMspDefault"
                                      },
                                      "markedForDeletion": {
                                        "type": "boolean",
                                        "description": "Destionation list markedForDeletion"
                                      },
                                      "bundleTypeId": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "Destionation list bundleTypeId"
                                      },
                                      "meta": {
                                        "type": "object",
                                        "description": "Destionation list meta info object",
                                        "properties": {
                                          "destinationCount": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "Total number of destinations in a destination list."
                                          },
                                          "domainCount": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "Total number of domains in a destination list. Domains are part of total destinations in a destination lists."
                                          },
                                          "urlCount": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "Total number of Urls in a destination list. Urls are part of total destinations in a destination lists."
                                          },
                                          "ipv4Count": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "Total number of Ip's in a destination list. Ip's are part of total destinations in a destination lists."
                                          },
                                          "applicationCount": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "Total number of applications in a destination list."
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Retrieve all destination lists",
                        "operationId": "[[variables('_operationId-RetrieveAllDestinationLists')]",
                        "description": "Retrieve all destination lists of organization",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "integer",
                            "description": "[replace('b', 'b', '')]",
                            "format": "int32"
                          }
                        ]
                      },
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Unique id of the destination list."
                                },
                                "organizationId": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "organizationId"
                                },
                                "access": {
                                  "type": "string",
                                  "description": "Access can be allow or block. It defines destinationlist type."
                                },
                                "isGlobal": {
                                  "type": "boolean",
                                  "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization."
                                },
                                "name": {
                                  "type": "string",
                                  "description": "Name of the destination list."
                                },
                                "thirdpartyCategoryId": {
                                  "type": "string",
                                  "description": "Destionation list thirdpartyCategoryId"
                                },
                                "createdAt": {
                                  "type": "string",
                                  "description": "Creation date."
                                },
                                "modifiedAt": {
                                  "type": "string",
                                  "description": "Last modified date."
                                },
                                "isMspDefault": {
                                  "type": "boolean",
                                  "description": "Destionation list isMspDefault"
                                },
                                "markedForDeletion": {
                                  "type": "boolean",
                                  "description": "Destionation list markedForDeletion"
                                },
                                "bundleTypeId": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Destionation list bundleTypeId"
                                },
                                "meta": {
                                  "type": "object",
                                  "description": "Destionation list meta info object",
                                  "properties": {
                                    "destinationCount": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Total number of destinations in a destination list."
                                    },
                                    "domainCount": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Total number of domains in a destination list. Domains are part of total destinations in a destination lists."
                                    },
                                    "urlCount": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Total number of Urls in a destination list. Urls are part of total destinations in a destination lists."
                                    },
                                    "ipv4Count": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Total number of Ip's in a destination list. Ip's are part of total destinations in a destination lists."
                                    },
                                    "applicationCount": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Total number of applications in a destination list."
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Create destination list",
                        "operationId": "[[variables('_operationId-CreateDestinationList')]",
                        "description": "Create destination list",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "destinations": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "type": {
                                        "type": "string",
                                        "description": "Type can be DOMAIN, URL, IPV4",
                                        "title": "type",
                                        "enum": [
                                          "DOMAIN",
                                          "URL",
                                          "IPV4"
                                        ]
                                      },
                                      "destination": {
                                        "type": "string",
                                        "description": "Destination can be domain, url, ip",
                                        "title": "destination"
                                      },
                                      "comment": {
                                        "type": "string",
                                        "description": "[replace('b', 'b', '')]",
                                        "title": "comment"
                                      }
                                    },
                                    "required": [
                                      "destination",
                                      "type"
                                    ]
                                  },
                                  "description": "destinations"
                                },
                                "access": {
                                  "type": "string",
                                  "description": "Access can be allow or block. It defines destinationlist type.",
                                  "title": "access",
                                  "enum": [
                                    "allow",
                                    "block"
                                  ]
                                },
                                "isGlobal": {
                                  "type": "boolean",
                                  "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization.",
                                  "title": "isGlobal",
                                  "enum": [
                                    "",
                                    true,
                                    false
                                  ]
                                },
                                "name": {
                                  "type": "string",
                                  "description": "[replace('b', 'b', '')]",
                                  "title": "name"
                                }
                              },
                              "required": [
                                "access",
                                "destinations",
                                "isGlobal",
                                "name"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    "/v1/organizations/{organizationId}/destinationlists/{destinationListId}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "status": {
                                  "type": "object",
                                  "x-ms-summary": "Response status",
                                  "x-ms-visibility": "internal",
                                  "description": "Response status object",
                                  "properties": {
                                    "code": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "code"
                                    },
                                    "text": {
                                      "type": "string",
                                      "description": "text"
                                    }
                                  }
                                },
                                "data": {
                                  "type": "object",
                                  "x-ms-summary": "Destionation list",
                                  "description": "Destionation list object",
                                  "properties": {
                                    "id": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Unique id of the destination list."
                                    },
                                    "organizationId": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "organizationId"
                                    },
                                    "access": {
                                      "type": "string",
                                      "description": "Access can be allow or block. It defines destinationlist type."
                                    },
                                    "isGlobal": {
                                      "type": "boolean",
                                      "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization."
                                    },
                                    "name": {
                                      "type": "string",
                                      "description": "Name of the destination list."
                                    },
                                    "thirdpartyCategoryId": {
                                      "type": "string",
                                      "description": "Destionation list thirdpartyCategoryId"
                                    },
                                    "createdAt": {
                                      "type": "string",
                                      "description": "Creation date."
                                    },
                                    "modifiedAt": {
                                      "type": "string",
                                      "description": "Last modified date."
                                    },
                                    "isMspDefault": {
                                      "type": "boolean",
                                      "description": "Destionation list isMspDefault"
                                    },
                                    "markedForDeletion": {
                                      "type": "boolean",
                                      "description": "Destionation list markedForDeletion"
                                    },
                                    "bundleTypeId": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "Destionation list bundleTypeId"
                                    },
                                    "meta": {
                                      "type": "object",
                                      "description": "Destionation list meta info object",
                                      "properties": {
                                        "destinationCount": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "Total number of destinations in a destination list."
                                        },
                                        "domainCount": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "Total number of domains in a destination list. Domains are part of total destinations in a destination lists."
                                        },
                                        "urlCount": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "Total number of Urls in a destination list. Urls are part of total destinations in a destination lists."
                                        },
                                        "ipv4Count": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "Total number of Ip's in a destination list. Ip's are part of total destinations in a destination lists."
                                        },
                                        "applicationCount": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "Total number of applications in a destination list."
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get a destination list",
                        "operationId": "[[variables('_operationId-GetDestinationList')]",
                        "description": "Get a destination list by id",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "destinationListId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "/v1/organizations/{organizationId}/destinationlists/{destinationListId}/destinations": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "status": {
                                  "x-ms-visibility": "internal",
                                  "type": "object",
                                  "properties": {
                                    "code": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "code"
                                    },
                                    "text": {
                                      "type": "string",
                                      "description": "text"
                                    }
                                  },
                                  "description": "status"
                                },
                                "meta": {
                                  "type": "object",
                                  "x-ms-visibility": "internal",
                                  "properties": {
                                    "page": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "page"
                                    },
                                    "limit": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "limit"
                                    },
                                    "total": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "total"
                                    }
                                  },
                                  "description": "meta"
                                },
                                "data": {
                                  "type": "array",
                                  "x-ms-summary": "Destinations",
                                  "description": "array of Destination objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Destination",
                                    "description": "Destination object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Unique id of the destination"
                                      },
                                      "destination": {
                                        "type": "string",
                                        "x-ms-summary": "value",
                                        "description": "Destination value"
                                      },
                                      "type": {
                                        "type": "string",
                                        "description": "Type can be DOMAIN, URL, IPV4"
                                      },
                                      "comment": {
                                        "type": "string",
                                        "description": "Destination comment"
                                      },
                                      "createdAt": {
                                        "type": "string",
                                        "description": "Creation date of destination"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get list of destinations related to destination list",
                        "operationId": "[[variables('_operationId-GetDestinationsList')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "destinationListId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          }
                        ],
                        "description": "Get list of destinations related to destination list"
                      },
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "summary": "Add list of destinations to destination list",
                        "description": "Add list of destinations to destination list",
                        "operationId": "[[variables('_operationId-AddDestinations')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "destinationListId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "destination": {
                                    "type": "string",
                                    "description": "name of the destination",
                                    "title": "destination"
                                  },
                                  "comment": {
                                    "type": "string",
                                    "description": "comment for destination",
                                    "title": "comment"
                                  }
                                },
                                "required": [
                                  "destination"
                                ]
                              },
                              "required": [
                                "items"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    "/v1/organizations/{organizationId}/destinationlists/{destinationListId}/destinations/remove": {
                      "delete": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "summary": "Delete list of destinations from destination list",
                        "operationId": "[[variables('_operationId-DeleteDestinations')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "destinationListId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "integer",
                                "format": "int32",
                                "description": "Destination id"
                              }
                            }
                          }
                        ],
                        "description": "Delete list of destinations from destination list"
                      }
                    }
                  },
                  "securityDefinitions": {
                    "basic_auth": {
                      "type": "basic"
                    }
                  },
                  "security": [
                    {
                      "basic_auth": "[json('[]')]"
                    }
                  ],
                  "tags": "[json('[]')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId3')]",
                "contentId": "CiscoUmbrellaManagementAPIConnector",
                "kind": "LogicAppsCustomConnector",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrellaManagementAPIConnector",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "CiscoUmbrellaManagementAPIConnector",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-lq4hds42qu6f4",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-lq4hds42qu6f4",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring('CiscoUmbrellaNetworkDeviceManagementAPIConnector')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name": {
              "defaultValue": "CiscoUmbrellaNetworkDeviceManagementAPI",
              "type": "String"
            }
          },
          "variables": {
            "operationId-GetOrganizationId": "GetOrganizationId",
            "_operationId-GetOrganizationId": "[[variables('operationId-GetOrganizationId')]",
            "operationId-ListAllPoliciesOnDevice": "ListAllPoliciesOnDevice",
            "_operationId-ListAllPoliciesOnDevice": "[[variables('operationId-ListAllPoliciesOnDevice')]",
            "operationId-DeleteIdentityFromPolicy": "DeleteIdentityFromPolicy",
            "_operationId-DeleteIdentityFromPolicy": "[[variables('operationId-DeleteIdentityFromPolicy')]",
            "operationId-AssignPolicyToIdentity": "AssignPolicyToIdentity",
            "_operationId-AssignPolicyToIdentity": "[[variables('operationId-AssignPolicyToIdentity')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId4": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
            "playbookId4": "[[resourceId('Microsoft.Web/customApis', parameters('customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "username": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Key",
                      "description": "The Key for this api",
                      "tooltip": "Provide the Key",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": true,
                        "required": "true"
                      }
                    }
                  },
                  "password": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Secret",
                      "description": "The Secret for this api",
                      "tooltip": "Provide the Secret",
                      "constraints": {
                        "tabIndex": 3,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "Connector for Cisco Umbrella Network Device Management API",
                "displayName": "[[parameters('customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name')]",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
                "backendService": {
                  "serviceUrl": "https://management.api.umbrella.com"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
                    "version": "1.0",
                    "description": "Connector for Cisco Umbrella Network Device Management API"
                  },
                  "host": "management.api.umbrella.com",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "paths": {
                    "/v1/organizations": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "x-ms-summary": "Organization",
                                "description": "Organization object",
                                "properties": {
                                  "organizationId": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Organization Id",
                                    "title": "Id"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "Organization name",
                                    "title": "name"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get organization id",
                        "description": "Get organization id",
                        "operationId": "[[variables('_operationId-GetOrganizationId')]",
                        "parameters": "[json('[]')]"
                      }
                    },
                    "/v1/organizations/{organizationId}/networkdevices/{originId}/policies": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "x-ms-summary": "Policy",
                                "description": "Policy object",
                                "properties": {
                                  "policyId": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Policy Id",
                                    "title": "Id"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "Policy name",
                                    "title": "name"
                                  },
                                  "priority": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Policy priority"
                                  },
                                  "isAppliedDirectly": {
                                    "type": "boolean",
                                    "description": "Policy is Applied Directly"
                                  },
                                  "isDefault": {
                                    "type": "boolean",
                                    "description": "Policy is Default"
                                  },
                                  "createdAt": {
                                    "type": "string",
                                    "description": "Policy creation date"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "List all policies of a network device",
                        "description": "List all policies of a network device",
                        "operationId": "[[variables('_operationId-ListAllPoliciesOnDevice')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Id"
                          },
                          {
                            "name": "originId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Device Id"
                          }
                        ]
                      }
                    },
                    "/v1/organizations/{organizationId}/policies/{policyId}/identities/{originId}": {
                      "delete": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "summary": "Delete an identity from a policy",
                        "description": "Delete an identity from a policy",
                        "operationId": "[[variables('_operationId-DeleteIdentityFromPolicy')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Id"
                          },
                          {
                            "name": "policyId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Policy Id"
                          },
                          {
                            "name": "originId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Identity Id"
                          }
                        ]
                      },
                      "put": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "summary": "Assign a policy to an identity",
                        "description": "Assign a policy to an identity",
                        "operationId": "[[variables('_operationId-AssignPolicyToIdentity')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Id"
                          },
                          {
                            "name": "policyId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Policy Id"
                          },
                          {
                            "name": "originId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Identity Id"
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "basic_auth": {
                      "type": "basic"
                    }
                  },
                  "security": [
                    {
                      "basic_auth": "[json('[]')]"
                    }
                  ],
                  "tags": "[json('[]')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId4')]",
                "contentId": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
                "kind": "LogicAppsCustomConnector",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-ntbx7k735jvqa",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-lc-ntbx7k735jvqa",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('CiscoUmbrella-AddIpToDestinationList')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "CiscoUmbrella-AddIpToDestinationList",
              "type": "String"
            },
            "CiscoUmbrellaOrganizationId": {
              "type": "Int",
              "defaultValue": 0,
              "metadata": {
                "description": "Organization id in Cisco Umbrella."
              }
            },
            "TeamsGroupId": {
              "defaultValue": "TeamsGroupIds",
              "type": "String",
              "metadata": {
                "description": "Id of the Teams Group where the adaptive card will be posted."
              }
            },
            "TeamsChannelId": {
              "defaultValue": "TeamsChannelId",
              "type": "String",
              "metadata": {
                "description": "Id of the Teams Channel where the adaptive card will be posted."
              }
            },
            "customApis_ciscoumbrellamanagement_name": {
              "defaultValue": "CiscoUmbrellaManagementAPI",
              "type": "String"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
            "CiscoUmbrellaManagementAPIConnectionName": "[[concat('ciscoumbrellamanagement-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellamanagement_name'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CiscoUmbrellaManagementAPIConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('CiscoUmbrellaManagementAPIConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaManagementAPIConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "dest_lists_array",
                        "value": {
                          "title": "Ignore",
                          "value": 0
                        }
                      },
                      "runAfter": {
                        "Initialize_variable_dest_lists_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "AppendToArrayVariable"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Append_to_array_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP": {
                      "actions": {
                        "Add_IP_to_destination_list": {
                          "actions": {
                            "Add_list_of_destinations_to_destination_list": {
                              "inputs": {
                                "body": [
                                  {
                                    "destination": "@{outputs('Get_IP')}"
                                  }
                                ],
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ciscoumbrellamanagement']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/v1/organizations/@{encodeURIComponent(variables('organization_id'))}/destinationlists/@{encodeURIComponent(body('Post_adaptive_card_and_wait_for_a_response')['data']['action_choices'])}/destinations"
                              },
                              "type": "ApiConnection"
                            },
                            "Compose": {
                              "inputs": "@body('Filter_array')[0]['title']",
                              "runAfter": {
                                "Filter_array": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            },
                            "Filter_array": {
                              "inputs": {
                                "from": "@variables('dest_lists_array')",
                                "where": "@equals(string(item()['value']), body('Post_adaptive_card_and_wait_for_a_response')['data']['action_choices'])"
                              },
                              "runAfter": {
                                "Set_variable_3": [
                                  "Skipped"
                                ]
                              },
                              "type": "Query"
                            },
                            "Set_variable": {
                              "inputs": {
                                "name": "action_message",
                                "value": "IP @{outputs('Get_IP')} added to \"@{outputs('Compose')}\" destination list."
                              },
                              "runAfter": {
                                "Compose": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Set_variable_3": {
                              "inputs": {
                                "name": "action_message",
                                "value": "IP @{outputs('Get_IP')} was not added to \"\" destination lists due to Csico Umbrella API error."
                              },
                              "runAfter": {
                                "Add_list_of_destinations_to_destination_list": [
                                  "TimedOut",
                                  "Failed"
                                ]
                              },
                              "type": "SetVariable"
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@body('Post_adaptive_card_and_wait_for_a_response')?['data']",
                                    "@null"
                                  ]
                                }
                              },
                              {
                                "not": {
                                  "equals": [
                                    "@body('Post_adaptive_card_and_wait_for_a_response')?['data']?['action_choices']",
                                    "@'0'"
                                  ]
                                }
                              },
                              {
                                "contains": [
                                  "@body('Post_adaptive_card_and_wait_for_a_response')?['data']",
                                  "action_choices"
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "Post_adaptive_card_and_wait_for_a_response": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>@{outputs('Get_Cisco_logo')}<strong>CiscoUmbrella-AddIpToDestinationList</strong><br>\nActions taken:<br>\n@{variables('action_message')}<br>\n@{variables('status_message')}<br>\n@{variables('severity_message')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Get_Cisco_logo": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_body_for_adaptive_card": {
                          "inputs": {
                            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                            "actions": [
                              {
                                "id": "btnSubmit",
                                "title": "Submit",
                                "type": "Action.Submit"
                              },
                              {
                                "id": "btnIgnore",
                                "title": "Ignore",
                                "type": "Action.Submit"
                              }
                            ],
                            "body": [
                              {
                                "size": "large",
                                "text": "Suspicious IP - Microsoft Sentinel",
                                "type": "TextBlock",
                                "weight": "bolder",
                                "wrap": true
                              },
                              {
                                "text": " Incident No : @{triggerBody()?['object']?['properties']?['incidentNumber']}  ",
                                "type": "TextBlock",
                                "weight": "Bolder",
                                "wrap": true
                              },
                              {
                                "text": "@{triggerBody()?['object']?['properties']?['description']}",
                                "type": "TextBlock",
                                "wrap": true
                              },
                              {
                                "text": "For more details check the incident:",
                                "type": "TextBlock",
                                "weight": "Bolder",
                                "wrap": true
                              },
                              {
                                "text": "[[Click here to view the Incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})",
                                "type": "TextBlock",
                                "wrap": true
                              },
                              {
                                "id": "PollQuestionAction",
                                "text": "Select the Cisco Umbrella destination list to add IP @{item()['address']} to.",
                                "type": "TextBlock"
                              },
                              {
                                "choices": "@variables('dest_lists_array')",
                                "id": "action_choices",
                                "placeholder": "Select from these choices",
                                "style": "compact",
                                "type": "Input.ChoiceSet"
                              },
                              {
                                "id": "PollQuestionSeverity",
                                "text": "Select incident severity",
                                "type": "TextBlock"
                              },
                              {
                                "choices": [
                                  {
                                    "title": "High",
                                    "value": "high"
                                  },
                                  {
                                    "title": "Medium",
                                    "value": "medium"
                                  },
                                  {
                                    "title": "Low",
                                    "value": "low"
                                  },
                                  {
                                    "title": "Informational",
                                    "value": "informational"
                                  }
                                ],
                                "id": "severity_choices",
                                "placeholder": "Select from these choices",
                                "style": "compact",
                                "type": "Input.ChoiceSet"
                              },
                              {
                                "id": "PollQuestionStatus",
                                "text": "Select incident status",
                                "type": "TextBlock"
                              },
                              {
                                "choices": [
                                  {
                                    "title": "New",
                                    "value": "new"
                                  },
                                  {
                                    "title": "Active",
                                    "value": "active"
                                  },
                                  {
                                    "title": "Closed: True Positive - suspicious activity",
                                    "value": "close_tp"
                                  },
                                  {
                                    "title": "Closed: Benign Positive - suspicious but expected",
                                    "value": "close_bp"
                                  },
                                  {
                                    "title": "Closed: False Positive - incorrect alert logic",
                                    "value": "close_fp_incorrect_logic"
                                  },
                                  {
                                    "title": "Closed: False Positive - inaccurate data",
                                    "value": "close_fp_inaccurate_data"
                                  },
                                  {
                                    "title": "Closed: Undetermined",
                                    "value": "close_undetermined"
                                  }
                                ],
                                "id": "status_choices",
                                "placeholder": "Select from these choices",
                                "style": "compact",
                                "type": "Input.ChoiceSet"
                              }
                            ],
                            "type": "AdaptiveCard",
                            "version": "1.0"
                          },
                          "type": "Compose"
                        },
                        "Get_Cisco_logo": {
                          "inputs": "<img src=\"https://github.com/socprime/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
                          "runAfter": {
                            "Update_status": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose"
                        },
                        "Get_IP": {
                          "inputs": "@item()['address']",
                          "runAfter": {
                            "Set_variable_16": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose"
                        },
                        "Post_adaptive_card_and_wait_for_a_response": {
                          "inputs": {
                            "body": {
                              "body": {
                                "messageBody": "@{outputs('Create_body_for_adaptive_card')}",
                                "recipient": {
                                  "channelId": "@variables('TeamsChannelId')",
                                  "groupId": "@variables('TeamsGroupId')"
                                },
                                "updateMessage": "Thanks for your response!"
                              },
                              "notificationUrl": "@{listCallbackUrl()}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['teams']['connectionId']"
                              }
                            },
                            "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                          },
                          "runAfter": {
                            "Get_IP": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnectionWebhook"
                        },
                        "Set_variable_14": {
                          "inputs": {
                            "name": "action_message",
                            "value": "\"\""
                          },
                          "runAfter": {
                            "Create_body_for_adaptive_card": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Set_variable_15": {
                          "inputs": {
                            "name": "severity_message",
                            "value": "\"\""
                          },
                          "runAfter": {
                            "Set_variable_14": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Set_variable_16": {
                          "inputs": {
                            "name": "status_message",
                            "value": "\"\""
                          },
                          "runAfter": {
                            "Set_variable_15": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Update_severity": {
                          "actions": {
                            "Switch": {
                              "cases": {
                                "high_severity": {
                                  "actions": {
                                    "Set_variable_2": {
                                      "inputs": {
                                        "name": "severity_message",
                                        "value": "Incident severity was changed to \"High\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_high_severity": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_high_severity": {
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "severity": "High"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "high"
                                },
                                "informational_severity": {
                                  "actions": {
                                    "Set_variable_4": {
                                      "inputs": {
                                        "name": "severity_message",
                                        "value": "Incident severity was changed to \"Informational\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_informational_severity": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_informational_severity": {
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "severity": "Informational"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "informational"
                                },
                                "low_severity": {
                                  "actions": {
                                    "Set_variable_5": {
                                      "inputs": {
                                        "name": "severity_message",
                                        "value": "Incident severity was changed to \"Low\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_low_severity": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_low_severity": {
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "severity": "Low"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "low"
                                },
                                "medium_severity": {
                                  "actions": {
                                    "Set_variable_6": {
                                      "inputs": {
                                        "name": "severity_message",
                                        "value": "Incident severity was changed to \"Medium\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_medium_severity": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_medium_severity": {
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "severity": "Medium"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "medium"
                                }
                              },
                              "expression": "@body('Post_adaptive_card_and_wait_for_a_response')['data']['severity_choices']",
                              "type": "Switch"
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@body('Post_adaptive_card_and_wait_for_a_response')?['data']",
                                    "@null"
                                  ]
                                }
                              },
                              {
                                "contains": [
                                  "@body('Post_adaptive_card_and_wait_for_a_response')?['data']",
                                  "severity_choices"
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "Add_IP_to_destination_list": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "Update_status": {
                          "actions": {
                            "Switch_2": {
                              "cases": {
                                "Case": {
                                  "actions": {
                                    "Set_variable_7": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"New\"."
                                      },
                                      "runAfter": {
                                        "Update_incident": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident": {
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "New"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "new"
                                },
                                "Case_2": {
                                  "actions": {
                                    "Set_variable_8": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"Active\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_2": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_2": {
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Active"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "active"
                                },
                                "Case_3": {
                                  "actions": {
                                    "Set_variable_9": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"Closed: True Positive - suspicious activity\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_3": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_3": {
                                      "inputs": {
                                        "body": {
                                          "classification": {
                                            "ClassificationAndReason": "TruePositive - SuspiciousActivity"
                                          },
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Closed"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "close_tp"
                                },
                                "Case_4": {
                                  "actions": {
                                    "Set_variable_10": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"Closed: Benign Positive - suspicious but expected\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_4": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_4": {
                                      "inputs": {
                                        "body": {
                                          "classification": {
                                            "ClassificationAndReason": "BenignPositive - SuspiciousButExpected"
                                          },
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Closed"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "close_bp"
                                },
                                "Case_5": {
                                  "actions": {
                                    "Set_variable_11": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"Closed: False Positive - incorrect alert logic\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_5": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_5": {
                                      "inputs": {
                                        "body": {
                                          "classification": {
                                            "ClassificationAndReason": "FalsePositive - IncorrectAlertLogic"
                                          },
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Closed"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "close_fp_incorrect_logic"
                                },
                                "Case_6": {
                                  "actions": {
                                    "Set_variable_12": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"Closed: False Positive - inaccurate data\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_6": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_6": {
                                      "inputs": {
                                        "body": {
                                          "classification": {
                                            "ClassificationAndReason": "FalsePositive - InaccurateData"
                                          },
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Closed"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "close_fp_inaccurate_data"
                                },
                                "Case_7": {
                                  "actions": {
                                    "Set_variable_13": {
                                      "inputs": {
                                        "name": "status_message",
                                        "value": "Incident status was changed to \"Closed: Undetermined\"."
                                      },
                                      "runAfter": {
                                        "Update_incident_7": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable"
                                    },
                                    "Update_incident_7": {
                                      "inputs": {
                                        "body": {
                                          "classification": {
                                            "ClassificationAndReason": "Undetermined"
                                          },
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Closed"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      },
                                      "type": "ApiConnection"
                                    }
                                  },
                                  "case": "close_undetermined"
                                }
                              },
                              "expression": "@body('Post_adaptive_card_and_wait_for_a_response')['data']['status_choices']",
                              "type": "Switch"
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@body('Post_adaptive_card_and_wait_for_a_response')?['data']",
                                    "@null"
                                  ]
                                }
                              },
                              {
                                "contains": [
                                  "@body('Post_adaptive_card_and_wait_for_a_response')?['data']",
                                  "status_choices"
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "Update_severity": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Get_list_of_destinations_lists_for_Teams_adaptive_card": {
                      "inputs": {
                        "from": "@body('Retrieve_all_destination_lists')?['data']",
                        "select": {
                          "title": "@item()['name']",
                          "value": "@item()['id']"
                        }
                      },
                      "runAfter": {
                        "Retrieve_all_destination_lists": [
                          "Succeeded"
                        ]
                      },
                      "type": "Select"
                    },
                    "Initialize_variable_TeamsChannelId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "TeamsChannelId",
                            "type": "string",
                            "value": "[[parameters('TeamsChannelId')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_TeamsGroupId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_TeamsGroupId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "TeamsGroupId",
                            "type": "string",
                            "value": "[[parameters('TeamsGroupId')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_organization_id": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_action_message": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "action_message",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_TeamsChannelId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_dest_lists_array": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "dest_lists_array",
                            "type": "array",
                            "value": "@body('Get_list_of_destinations_lists_for_Teams_adaptive_card')"
                          }
                        ]
                      },
                      "runAfter": {
                        "Get_list_of_destinations_lists_for_Teams_adaptive_card": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_organization_id": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "organization_id",
                            "type": "integer",
                            "value": "[[parameters('CiscoUmbrellaOrganizationId')]"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_severity_message": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "severity_message",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_action_message": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_status_message": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "status_message",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_severity_message": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Retrieve_all_destination_lists": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['ciscoumbrellamanagement']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v1/organizations/@{encodeURIComponent(variables('organization_id'))}/destinationlists"
                      },
                      "runAfter": {
                        "Initialize_variable_status_message": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]"
                      },
                      "teams": {
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/teams')]"
                      },
                      "ciscoumbrellamanagement": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaManagementAPIConnectionName'))]",
                        "connectionName": "[[variables('CiscoUmbrellaManagementAPIConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellamanagement_name'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-AddIpToDestinationList'),'/'))))]",
              "properties": {
                "parentId": "[resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-AddIpToDestinationList')]",
                "contentId": "CiscoUmbrella-AddIpToDestinationList",
                "kind": "Playbook",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "CiscoUmbrellaManagementAPIConnector",
                      "version": "1.0"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "CiscoUmbrella-AddIpToDestinationList",
            "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
            "prerequisites": [
              "1. ServiceNow Instance URL, Username, and password.",
              "2. Access and authorization to enable API connectors",
              "3. Teams Group ID, Channel ID and Alert details where the messages are to be posted in."
            ],
            "lastUpdateTime": "2021-06-29T10:00:00Z",
            "entities": [
              "Account",
              "Url",
              "Host"
            ],
            "tags": [
              "Sync",
              "Notification",
              "Teams Response"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[replace('b', 'b', '')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrella-AddIpToDestinationList",
        "contentKind": "Playbook",
        "displayName": "CiscoUmbrella-AddIpToDestinationList",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-luypwal2ez3vw",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-luypwal2ez3vw",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('CiscoUmbrella-AssignPolicyToIdentity')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "CiscoUmbrella-AssignPolicyToIdentity",
              "type": "String"
            },
            "PolicyId": {
              "defaultValue": "",
              "type": "String"
            },
            "customApis_ciscoumbrellanetworkdevicemanagement_name": {
              "defaultValue": "CiscoUmbrellaNetworkDeviceManagementAPI",
              "type": "String"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "CiscoUmbrellaNetworkDeviceManagementAPIConnectionName": "[[concat('ciscoumbrellanetworkdevice-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellanetworkdevicemanagement_name'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CiscoUmbrellaNetworkDeviceManagementAPIConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('CiscoUmbrellaNetworkDeviceManagementAPIConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaNetworkDeviceManagementAPIConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p><strong></strong><strong>@{outputs('Create_logo')}</strong><strong> CiscoUmbrella-AssignPolicyToIdentity</strong><br>\nThe following origin ids were assigned to policy @{variables('policyId')} for organization @{variables('organizationId')}:<br>\n@{body('Create_HTML_table_with_updated_origin_IDs')}<br>\nThe following origin ids were not assigned because of errors:<br>\n@{body('Create_HTML_table_with_not_updated_origin_IDs')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_logo": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_HTML_table_with_not_updated_origin_IDs": {
                      "inputs": {
                        "columns": [
                          {
                            "header": "originId",
                            "value": "@item()"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('not_updated_oridinIds_array')"
                      },
                      "runAfter": {
                        "Create_HTML_table_with_updated_origin_IDs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Create_HTML_table_with_updated_origin_IDs": {
                      "inputs": {
                        "columns": [
                          {
                            "header": "originId",
                            "value": "@item()"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('updated_oridinIds_array')"
                      },
                      "runAfter": {
                        "For_each_originId_assign_policy_to_originId": [
                          "Succeeded",
                          "Failed",
                          "Skipped",
                          "TimedOut"
                        ]
                      },
                      "type": "Table"
                    },
                    "Create_logo": {
                      "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
                      "runAfter": {
                        "Create_HTML_table_with_not_updated_origin_IDs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "For_each_alert_in_incident": {
                      "actions": {
                        "For_each_originId": {
                          "actions": {
                            "Add_unique_originId_to_OriginId_array": {
                              "actions": {
                                "Append_to_array_variable": {
                                  "inputs": {
                                    "name": "originId_array",
                                    "value": "@items('For_each_originId')"
                                  },
                                  "type": "AppendToArrayVariable"
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "not": {
                                      "contains": [
                                        "@variables('originId_array')",
                                        "@items('For_each_originId')"
                                      ]
                                    }
                                  }
                                ]
                              },
                              "type": "If"
                            }
                          },
                          "foreach": "@body('Parse_alert_custom_details')?['originId']",
                          "runAfter": {
                            "Parse_alert_custom_details": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Parse_alert_custom_details": {
                          "inputs": {
                            "content": "@items('For_each_alert_in_incident')?['properties']?['additionalData']?['Custom Details']",
                            "schema": {
                              "properties": {
                                "originId": {
                                  "items": {
                                    "type": "string"
                                  },
                                  "type": "array"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        }
                      },
                      "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
                      "runAfter": {
                        "Set_value_for_organizationId_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_originId_assign_policy_to_originId": {
                      "actions": {
                        "Append_originId_to_not_updated_originIds_array_variable_in_case_of_error": {
                          "inputs": {
                            "name": "not_updated_oridinIds_array",
                            "value": "@items('For_each_originId_assign_policy_to_originId')"
                          },
                          "runAfter": {
                            "Assign_a_policy_to_an_identity": [
                              "Failed",
                              "TimedOut"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Append_originId_to_updated_originIds_array_variable": {
                          "inputs": {
                            "name": "updated_oridinIds_array",
                            "value": "@items('For_each_originId_assign_policy_to_originId')"
                          },
                          "runAfter": {
                            "Append_originId_to_not_updated_originIds_array_variable_in_case_of_error": [
                              "Skipped"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Assign_a_policy_to_an_identity": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ciscoumbrellanetworkdevicemanagement']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/v1/organizations/@{encodeURIComponent(variables('organizationId'))}/policies/@{encodeURIComponent(variables('policyId'))}/identities/@{encodeURIComponent(items('For_each_originId_assign_policy_to_originId'))}"
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@variables('originId_array')",
                      "runAfter": {
                        "For_each_alert_in_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Get_organization_id": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['ciscoumbrellanetworkdevicemanagement']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v1/organizations"
                      },
                      "runAfter": {
                        "Initialize_variable_not_updated_oridinIds_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Initialize_variable_not_updated_oridinIds_array": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "not_updated_oridinIds_array",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_updated_oridinIds_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_organizationId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "organizationId",
                            "type": "string"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_originId_array": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "originId_array",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_policyId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_policyId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "policyId",
                            "type": "string",
                            "value": "[[parameters('PolicyId')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_organizationId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_updated_oridinIds_array": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "updated_oridinIds_array",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_originId_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Set_value_for_organizationId_variable": {
                      "inputs": {
                        "name": "organizationId",
                        "value": "@{body('Get_organization_id')[0]['organizationId']}"
                      },
                      "runAfter": {
                        "Get_organization_id": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]"
                      },
                      "ciscoumbrellanetworkdevicemanagement": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaNetworkDeviceManagementAPIConnectionName'))]",
                        "connectionName": "[[variables('CiscoUmbrellaNetworkDeviceManagementAPIConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellanetworkdevicemanagement_name'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-AssignPolicyToIdentity'),'/'))))]",
              "properties": {
                "parentId": "[resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-AssignPolicyToIdentity')]",
                "contentId": "CiscoUmbrella-AssignPolicyToIdentity",
                "kind": "Playbook",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
                      "version": "1.0"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "CiscoUmbrella-AssignPolicyToIdentity",
            "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
            "prerequisites": [
              "1. ServiceNow Instance URL, Username, and password.",
              "2. Access and authorization to enable API connectors",
              "3. Teams Group ID, Channel ID and Alert details where the messages are to be posted in."
            ],
            "lastUpdateTime": "2021-06-29T10:00:00Z",
            "entities": [
              "Account",
              "Url",
              "Host"
            ],
            "tags": [
              "Sync",
              "Notification",
              "Teams Response"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[replace('b', 'b', '')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrella-AssignPolicyToIdentity",
        "contentKind": "Playbook",
        "displayName": "CiscoUmbrella-AssignPolicyToIdentity",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-vvpixf6ajlu6s",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-vvpixf6ajlu6s",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('CiscoUmbrella-BlockDomain')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "CiscoUmbrella-BlockDomain",
              "type": "String"
            },
            "customApis_ciscoumbrellaenforcement_name": {
              "defaultValue": "CiscoUmbrellaEnforcementAPI",
              "type": "String"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "CiscoUmbrellaEnforcementAPIConnectionName": "[[concat('ciscoumbrellaenforcement-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellaenforcement_name'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CiscoUmbrellaEnforcementAPIConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('CiscoUmbrellaEnforcementAPIConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaEnforcementAPIConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>@{outputs('Create_logo')}CiscoUmbrella-BlockDomain<br>\nThe following domains have been added to Cisco Umbrella block destination list:<br>\n@{body('Create_HTML_table')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_logo": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_HTML_table": {
                      "inputs": {
                        "columns": [
                          {
                            "header": "Domain",
                            "value": "@item()"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('blocked_domains')"
                      },
                      "runAfter": {
                        "For_each_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Create_logo": {
                      "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "Entities_-_Get_URLs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      },
                      "runAfter": {
                        "Initialize_variable_blocked_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_URL": {
                      "actions": {
                        "Append_domain_to_blocked_domains_variable": {
                          "inputs": {
                            "name": "blocked_domains",
                            "value": "@outputs('Get_Domain_from_URL')"
                          },
                          "runAfter": {
                            "Block_domain": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Block_domain": {
                          "inputs": {
                            "body": [
                              {
                                "alertTime": "@{utcNow()}",
                                "deviceId": "azuresentinel",
                                "deviceVersion": "13.7a",
                                "dstDomain": "@{outputs('Get_Domain_from_URL')}",
                                "dstUrl": "@{outputs('Get_Domain_from_URL')}",
                                "eventTime": "@{utcNow()}",
                                "protocolVersion": "1.0a",
                                "providerName": "Security Platform"
                              }
                            ],
                            "headers": {
                              "Accept": "application/json"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ciscoumbrellaenforcement']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/1.0/events"
                          },
                          "runAfter": {
                            "Get_Domain_from_URL": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_Domain_from_URL": {
                          "inputs": "@split(replace(replace(items('For_each_URL')?['Url'],'http://',''), 'https://', ''), '/')[0]",
                          "type": "Compose"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable_blocked_domains": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "blocked_domains",
                            "type": "array"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]"
                      },
                      "ciscoumbrellaenforcement": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaEnforcementAPIConnectionName'))]",
                        "connectionName": "[[variables('CiscoUmbrellaEnforcementAPIConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellaenforcement_name'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-BlockDomain'),'/'))))]",
              "properties": {
                "parentId": "[resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-BlockDomain')]",
                "contentId": "CiscoUmbrella-BlockDomain",
                "kind": "Playbook",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "CiscoUmbrellaEnforcementAPIConnector",
                      "version": "1.0"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "CiscoUmbrella-BlockDomain",
            "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
            "prerequisites": [
              "1. ServiceNow Instance URL, Username, and password.",
              "2. Access and authorization to enable API connectors",
              "3. Teams Group ID, Channel ID and Alert details where the messages are to be posted in."
            ],
            "lastUpdateTime": "2021-06-29T10:00:00Z",
            "entities": [
              "Account",
              "Url",
              "Host"
            ],
            "tags": [
              "Sync",
              "Notification",
              "Teams Response"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[replace('b', 'b', '')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrella-BlockDomain",
        "contentKind": "Playbook",
        "displayName": "CiscoUmbrella-BlockDomain",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-3q2h42r45ab2i",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-3q2h42r45ab2i",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('CiscoUmbrella-GetDomainInfo')))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
      ],
      "properties": {
        "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "CiscoUmbrella-GetDomainInfo",
              "type": "String"
            },
            "customApis_ciscoumbrellainvestigate_name": {
              "defaultValue": "CiscoUmbrellaInvestigateAPI",
              "type": "String"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "CiscoUmbrellaInvestigateAPIConnectionName": "[[concat('ciscoumbrellainvestigate-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellainvestigate_name'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CiscoUmbrellaInvestigateAPIConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('CiscoUmbrellaInvestigateAPIConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaInvestigateAPIConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_URLs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_URL": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p><strong></strong><strong>@{outputs('Get_logo')}</strong><strong> </strong><span style=\"font-size: 14px\"><strong>CiscoUmbrella-GetDomainInfo</strong></span><br>\nRisk score for domain @{outputs('Get_domain_from_URL')} is &nbsp;@{body('Get_Risk_score_for_a_domain')?['risk_score']}.<br>\n<span style=\"font-size: 12px\"><strong>Risk score indicators:</strong></span><br>\n@{body('Create_HTML_table_with_security_indicators')}<br>\n<br>\n</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_HTML_table_with_security_indicators": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>@{outputs('Get_logo')}<span style=\"font-size: 14px\"><strong> CiscoUmbrella-GetDomainInfo<br>\n</strong></span><span style=\"font-size: 12px\">Security data for </span><span style=\"font-size: 12px\">@{outputs('Get_domain_from_URL')}</span><span style=\"font-size: 12px\"> (part 1) :<br>\n</span><span style=\"font-size: 12px\"><strong>dga_score:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['dga_score']}</span><span style=\"font-size: 12px\"><br>\nDomain Generation Algorithm. This score is generated based on the likeliness of the domain name being generated by an algorithm rather than a human. This algorithm is designed to identify domains which have been created using an automated randomization strategy, which is a common evasion technique in malware kits or botnets. This score ranges from -100 (suspicious) to 0 (benign).<br>\n</span><span style=\"font-size: 12px\"><strong>perplexity:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['perplexity']}</span><span style=\"font-size: 12px\"><br>\nA second score on the likeliness of the name to be algorithmically generated, on a scale from 0 to 100. This score is to be used in conjunction with DGA.<br>\n</span><span style=\"font-size: 12px\"><strong>entropy:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['entropy']}</span><span style=\"font-size: 12px\"><br>\nThe number of bits required to encode the domain name, as a score. This score is to be used in conjunction with DGA and Perplexity.<br>\n</span><span style=\"font-size: 12px\"><strong>securerank2:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['securerank2']}</span><span style=\"font-size: 12px\"><br>\nSuspicious rank for a domain that reviews based on the lookup behavior of client IP for the domain. Securerank is designed to identify hostnames requested by known infected clients but never requested by clean clients, assuming these domains are more likely to be bad. Scores returned range from -100 (suspicious) to 100 (benign).<br>\n</span></p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Add_comment_to_incident_(V3)": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Add_comment_to_incident_(V3)_3": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>@{outputs('Get_logo')} CiscoUmbrella-GetDomainInfo<br>\nSecurity data for @{outputs('Get_domain_from_URL')} (part 2):<br>\n<strong>pagerank: </strong>@{body('Get_domain_security_data')?['pagerank']}<br>\nPopularity according to Google's pagerank algorithm.<br>\n<strong>asn_score: </strong>@{body('Get_domain_security_data')?['asn_score']}<br>\nASN reputation score, ranges from -100 to 0 with -100 being very suspicious.<br>\n<strong>prefix_score:</strong> @{body('Get_domain_security_data')?['prefix_score']}<br>\nPrefix ranks domains given their IP prefixes (first three octets in IP) and the reputation score of these prefixes. Ranges from -100 to 0, -100 being very suspicious.<br>\n<strong>rip_score: </strong>@{body('Get_domain_security_data')?['rip_score']}<br>\nRIP ranks domains given their IP addresses and the reputation score of these IP addresses. Ranges from -100 to 0, -100 being very suspicious.<br>\n<strong>popularity:</strong> @{body('Get_domain_security_data')?['popularity']}<br>\nThe number of unique client IPs visiting this site, relative to the all requests to all sites.<br>\n<strong>geoscore:</strong> @{body('Get_domain_security_data')?['geoscore']}<br>\nA score that represents how far the different physical locations serving this name are from each other.<br>\n<strong>ks_test:</strong> @{body('Get_domain_security_data')?['ks_test']}<br>\nKolmogorov–Smirnov test on geodiversity. 0 means that the client traffic matches what is expected for this TLD.<br>\n<strong>attack:</strong> @{body('Get_domain_security_data')?['attack']}<br>\nThe name of any known attacks associated with this domain.<br>\n<strong>threat_type: </strong>@{body('Get_domain_security_data')?['threat_type']}<br>\nThe type of the known attack.</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Add_comment_to_incident_(V3)_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_HTML_table_with_security_indicators": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@body('Get_Risk_score_for_a_domain')?['indicators']"
                          },
                          "runAfter": {
                            "Get_logo": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_Risk_score_for_a_domain": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ciscoumbrellainvestigate']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/domains/risk-score/@{encodeURIComponent(outputs('Get_domain_from_URL'))}"
                          },
                          "runAfter": {
                            "Get_domain_security_data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_domain_from_URL": {
                          "inputs": "@split(replace(replace(item()?['Url'],'http://',''), 'https://', ''), '/')[0]",
                          "type": "Compose"
                        },
                        "Get_domain_security_data": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ciscoumbrellainvestigate']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/security/name/@{encodeURIComponent(outputs('Get_domain_from_URL'))}"
                          },
                          "runAfter": {
                            "Get_domain_from_URL": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_logo": {
                          "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
                          "runAfter": {
                            "Get_Risk_score_for_a_domain": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]"
                      },
                      "ciscoumbrellainvestigate": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CiscoUmbrellaInvestigateAPIConnectionName'))]",
                        "connectionName": "[[variables('CiscoUmbrellaInvestigateAPIConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_ciscoumbrellainvestigate_name'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-GetDomainInfo'),'/'))))]",
              "properties": {
                "parentId": "[resourceId('Microsoft.Logic/workflows', 'CiscoUmbrella-GetDomainInfo')]",
                "contentId": "CiscoUmbrella-GetDomainInfo",
                "kind": "Playbook",
                "version": "1.0",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoUmbrella",
                  "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "support@microsoft.com"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "CiscoUmbrellaInvestigateAPIConnector",
                      "version": "1.0"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "CiscoUmbrella-GetDomainInfo",
            "description": "This playbook showcases an example of triggering an incident within a targeted Teams channel and opening up a ticket within Service Now. Additionally The playbook will also list playbooks that can be initiated from teams using an adaptive card and callbacks that will take action upon certain entities identified in the incident.",
            "prerequisites": [
              "1. ServiceNow Instance URL, Username, and password.",
              "2. Access and authorization to enable API connectors",
              "3. Teams Group ID, Channel ID and Alert details where the messages are to be posted in."
            ],
            "lastUpdateTime": "2021-06-29T10:00:00Z",
            "entities": [
              "Account",
              "Url",
              "Host"
            ],
            "tags": [
              "Sync",
              "Notification",
              "Teams Response"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[replace('b', 'b', '')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "3.0.2",
        "packageName": "CiscoUmbrella",
        "packageId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "contentSchemaVersion": "3.0.0",
        "contentId": "CiscoUmbrella-GetDomainInfo",
        "contentKind": "Playbook",
        "displayName": "CiscoUmbrella-GetDomainInfo",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-lwlnnoxcxdxak",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-pl-lwlnnoxcxdxak",
        "version": "1.0",
        "isDeprecated": false
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Cisco Umbrella",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p><p>• Review the solution <a target=\"_blank\" href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/CiscoUmbrella/ReleaseNotes.md\" rel=\"noopener\">Release Notes</a></p><p>The <a target=\"_blank\" href=\"https://umbrella.cisco.com/\" rel=\"noopener\">Cisco Umbrella</a> solution for Microsoft Sentinel enables you to ingest <a target=\"_blank\" href=\"https://docs.umbrella.com/deployment-umbrella/docs/log-formats-and-versioning\" rel=\"noopener\">Cisco Umbrella events</a> stored in Amazon S3 into Microsoft Sentinel using the Amazon S3 REST API.</p><p><strong>Underlying Microsoft Technologies used:</strong></p><p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a target=\"_blank\" href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\" rel=\"noopener\">Preview</a> state or might result in additional ingestion or operational costs:</p><p>a. <a target=\"_blank\" href=\"https://learn.microsoft.com/azure/azure-monitor/logs/data-collector-api?WT.mc_id=Portal-fx\" rel=\"noopener\">Azure Monitor HTTP Data Collector API</a></p><p>b. <a target=\"_blank\" href=\"https://azure.microsoft.com/services/functions/#overview\" rel=\"noopener\">Azure Functions</a></p><p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 10, <strong>Hunting Queries:</strong> 10, <strong>Custom Azure Logic Apps Connectors:</strong> 4, <strong>Playbooks:</strong> 4</p><p><a target=\"_blank\" href=\"https://aka.ms/azuresentinel\" rel=\"noopener\">Learn more about Microsoft Sentinel</a> | <a target=\"_blank\" href=\"https://aka.ms/azuresentinelsolutionsdoc\" rel=\"noopener\">Learn more about Solutions</a></p>",
        "contentKind": "Solution",
        "contentProductId": "azuresentinel.azure-sentinel-solution-ciscoumbrell-sl-djoeaxdtixwwe",
        "id": "azuresentinel.azure-sentinel-solution-ciscoumbrell-sl-djoeaxdtixwwe",
        "icon": "https://store-images.s-microsoft.com/image/apps.42346.c831fa37-c174-4c50-a094-e820557d868e.13af787a-9520-474b-bbf7-d020fdd33f9b.3d716b59-cd03-40a8-a4f3-132ad1c3fc25",
        "contentId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "parentId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
        "source": {
          "kind": "Solution",
          "name": "CiscoUmbrella",
          "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella"
        },
        "author": {
          "name": "Microsoft",
          "email": "support@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "CiscoUmbrellaDataConnector",
              "version": "1.0.0"
            },
            {
              "kind": "Workbook",
              "contentId": "CiscoUmbrellaWorkbook",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "c9b6d281-b96b-4763-b728-9a04b9fe1246",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "75297f62-10a8-4fc1-9b2a-12f25c6f05a7",
              "version": "1.1.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "b619d1f1-7f39-4c7e-bf9e-afbb46457997",
              "version": "1.1.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "2b328487-162d-4034-b472-59f1d53684a1",
              "version": "1.1.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "8d537f3c-094f-430c-a588-8a87da36ee3a",
              "version": "1.1.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "b12b3dab-d973-45af-b07e-e29bb34d8db9",
              "version": "1.1.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "8c8de3fa-6425-4623-9cd9-45de1dd0569a",
              "version": "1.1.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "d6bf1931-b1eb-448d-90b2-de118559c7ce",
              "version": "1.1.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "de58ee9e-b229-4252-8537-41a4c2f4045e",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "ee1818ec-5f65-4991-b711-bcf2ab7e36c3",
              "version": "1.1.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "c92741e6-8454-40bb-8830-069cb86946c6",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "22e5e573-409b-433f-91de-50d6f0ad5a9e",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "26aebe0d-9a4f-456d-bbb9-9f4c9c5d28ca",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "bd1457df-3e81-4218-a079-0963200c8d67",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "55393e5b-3f7e-4d40-85e5-38ef9ecd8484",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "975419eb-7041-419c-b8f0-c4bf513cf2b2",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "85421f18-2de4-42ff-9ef4-058924dcb1bf",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "497d7250-87e1-49b1-a096-94f61c7ade9c",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "daf2f3cf-0f0d-45c1-b428-3c23d643859b",
              "version": "1.0.0"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "de2ec986-ee24-465f-adf2-b718997074c1",
              "version": "1.0.0"
            },
            {
              "kind": "Parser",
              "contentId": "Cisco_Umbrella-Parser",
              "version": "1.0.0"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "CiscoUmbrellaEnforcementAPIConnector",
              "version": "1.0"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "CiscoUmbrellaInvestigateAPIConnector",
              "version": "1.0"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "CiscoUmbrellaManagementAPIConnector",
              "version": "1.0"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
              "version": "1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "CiscoUmbrella-AddIpToDestinationList",
              "version": "1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "CiscoUmbrella-AssignPolicyToIdentity",
              "version": "1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "CiscoUmbrella-BlockDomain",
              "version": "1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "CiscoUmbrella-GetDomainInfo",
              "version": "1.0"
            }
          ]
        },
        "firstPublishDate": "2022-04-01",
        "providers": [
          "Cisco"
        ],
        "categories": {
          "domains": [
            "Security - Cloud Security",
            "Security - Automation (SOAR)"
          ]
        },
        "isPreview": false,
        "isDeprecated": false,
        "migratedToPackageId": null
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'azuresentinel.azure-sentinel-solution-ciscoumbrella')]"
    }
  ],
  "variables": {}
}