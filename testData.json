{
    "searchName": "SAP applications",
    "solutionName": "SAP",
    "displayName": "SAP applications",
    "contentSource": "Solution",
    "sourceName": "SAP",
    "provider": "Microsoft",
    "author": "Microsoft",
    "bladeSupportName": "Microsoft",
    "supportName": "Microsoft Corporation",
    "category": "Identity, Security - Threat Protection",
    "version": "3.2.02",
    "bladeDescription": "SAP systemsand applications handle massive amounts of sensitive data over a complex and diverseecosystem, presenting challenges for security operations (SecOps) teams attemptingto effectively and efficiently protect it. The Microsoft Sentinel solution for SAP\u00ae applications allows you to monitor, detect, respond to suspicious activities, and guardyour business-critical data against sophisticated cyberattacks, for both onpremises and on (any) cloud infrastructure.The Microsoft Sentinel solution for SAP\u00ae applications is SAP\u00ae Certified for Integration with RISE with SAP, S/4HANA Cloud and SAP NetWeaver.Thesolution includes the following components:TheMicrosoft Sentinel for SAP NetWeaver & S/4HANA data connector is used fordata ingestion in any cloud or on-premises.Analyticsrules and watchlists for threat detection.Functions and parsers for simple data access and readability.Workbooksfor interactive data visualization, allowing top down and drill through scenarios.Watchlistsfor customization of the built-in solution parameters.Hunting queries to help in detecting suspicious activities, either beforeor during compromise.Pricing:The Microsoft Sentinel solution for SAP\u00ae applications will be billed as an add-on charge from May2023, at $2 per production SAP system ID (SID) per hour in additionto the existing Microsoft Sentinel consumption-billing model.Systemsconfigured for development and test usage will remain free of the additionalcharge.Visit our product page for more information.",
    "contentType": "66Analytics rule1Data connector58Parser3Playbook21Watchlist3Workbook",
    "contentCount": 131,
    "solutionIcon": "https://store-images.s-microsoft.com/image/apps.37546.ee2d31a6-a2e0-4211-aa4a-6c9256ad6fc3.6f2e173b-d2d4-4e34-9e50-f9bee1dcd1c1.1bab0cba-95f3-4785-89e1-fcd632333746",
    "versionIcon": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTAgMi42NTYyNUgxMS45ODc1VjkuNjA1NzRDMTEuOTg3NSA5LjcxNjI4IDExLjk0NTMgOS44MjIyOSAxMS44NzAxIDkuOTAwNDRDMTEuNzk1IDkuOTc4NiAxMS42OTMgMTAuMDIyNSAxMS41ODY4IDEwLjAyMjVIMC40MDA3NUMwLjI5NDQ2NCAxMC4wMjI1IDAuMTkyNTMyIDkuOTc4NiAwLjExNzM3NyA5LjkwMDQ0QzAuMDQyMjIxOCA5LjgyMjI5IDAgOS43MTYyOCAwIDkuNjA1NzRWMi42NTYyNVoiIGZpbGw9InVybCgjcGFpbnQwX2xpbmVhcikiLz4KPHBhdGggZD0iTTAuNDAyNSAzLjk3NDAzZS0wNkgxMS41ODI0QzExLjY4ODcgMy45NzQwM2UtMDYgMTEuNzkwNiAwLjA0MzkxMzUgMTEuODY1NyAwLjEyMjA3M0MxMS45NDA5IDAuMjAwMjMyIDExLjk4MzEgMC4zMDYyMzkgMTEuOTgzMSAwLjQxNjc3NFYyLjY1NjIzSDBWMC40MTY3NzRDLTUuMDMxNjdlLTA3IDAuMzYxODg5IDAuMDEwNDIyOSAwLjMwNzU0NSAwLjAzMDY3MTggMC4yNTY4NjFDMC4wNTA5MjA3IDAuMjA2MTc3IDAuMDgwNTk2NCAwLjE2MDE1MiAwLjExNzk5NSAwLjEyMTQyOEMwLjE1NTM5NCAwLjA4MjcwMzEgMC4xOTk3NzkgMC4wNTIwNDIyIDAuMjQ4NjAyIDAuMDMxMjA0OUMwLjI5NzQyNiAwLjAxMDM2NzYgMC4zNDk3MjYgLTAuMDAwMjM1Njk2IDAuNDAyNSAzLjk3NDAzZS0wNloiIGZpbGw9IiMwMDc4RDQiLz4KPHBhdGggZD0iTTIuMDEyNyA2LjYzMzc5SDE0LjAwMDJWMTMuNTgzM0MxNC4wMDAyIDEzLjY5MzggMTMuOTU4IDEzLjc5OTggMTMuODgyOCAxMy44NzhDMTMuODA3NyAxMy45NTYxIDEzLjcwNTcgMTQuMDAwMSAxMy41OTk0IDE0LjAwMDFIMi40MTUyQzIuMzA4OTEgMTQuMDAwMSAyLjIwNjk4IDEzLjk1NjEgMi4xMzE4MiAxMy44NzhDMi4wNTY2NyAxMy43OTk4IDIuMDE0NDUgMTMuNjkzOCAyLjAxNDQ1IDEzLjU4MzNWNi42MzM3OUgyLjAxMjdaIiBmaWxsPSJ1cmwoI3BhaW50MV9saW5lYXIpIi8+CjxwYXRoIGQ9Ik0yLjQxNzgyIDMuOTczNjZIMTMuNTk3N0MxMy42NTA0IDMuOTczNDIgMTMuNzAyNiAzLjk4Mzk5IDEzLjc1MTQgNC4wMDQ3N0MxMy44MDAyIDQuMDI1NTUgMTMuODQ0NSA0LjA1NjEzIDEzLjg4MTkgNC4wOTQ3NkMxMy45MTkzIDQuMTMzMzkgMTMuOTQ5IDQuMTc5MzEgMTMuOTY5MyA0LjIyOTg4QzEzLjk4OTYgNC4yODA0NiAxNC4wMDAxIDQuMzM0NzEgMTQuMDAwMiA0LjM4OTUyVjYuNjMzNTJIMi4wMTI3VjQuMzg5NTJDMi4wMTI4MSA0LjMzNDQ4IDIuMDIzNCA0LjI4MDAxIDIuMDQzODcgNC4yMjkyNUMyLjA2NDMzIDQuMTc4NDkgMi4wOTQyNiA0LjEzMjQ1IDIuMTMxOTMgNC4wOTM3OUMyLjE2OTU5IDQuMDU1MTIgMi4yMTQyNSA0LjAyNDYgMi4yNjMzMiA0LjAwMzk4QzIuMzEyMzkgMy45ODMzNiAyLjM2NDkgMy45NzMwNiAyLjQxNzgyIDMuOTczNjZaIiBmaWxsPSIjMTk4QUIzIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9InBhaW50MF9saW5lYXIiIHgxPSI1Ljk5Mjg4IiB5MT0iMTAuMDIxNiIgeDI9IjUuOTkyODgiIHkyPSIyLjY1NjI1IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiMwMDc4RDQiLz4KPHN0b3Agb2Zmc2V0PSIwLjUwMiIgc3RvcC1jb2xvcj0iIzQwOTNFNiIvPgo8c3RvcCBvZmZzZXQ9IjAuNzc1IiBzdG9wLWNvbG9yPSIjNUVBMEVGIi8+CjwvbGluZWFyR3JhZGllbnQ+CjxsaW5lYXJHcmFkaWVudCBpZD0icGFpbnQxX2xpbmVhciIgeDE9IjguMDA3MzIiIHkxPSIxMy45OTU1IiB4Mj0iOC4wMDczMiIgeTI9IjYuNjI5MjQiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzMyQkVERCIvPgo8c3RvcCBvZmZzZXQ9IjAuMTc1IiBzdG9wLWNvbG9yPSIjMzJDQUVBIi8+CjxzdG9wIG9mZnNldD0iMC40MSIgc3RvcC1jb2xvcj0iIzMyRDJGMiIvPgo8c3RvcCBvZmZzZXQ9IjAuNzc1IiBzdG9wLWNvbG9yPSIjMzJENEY1Ii8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+Cg==",
    "dataConnector": [
        {
            "searchKey": "SAP",
            "displayName": "Microsoft Sentinel for SAP",
            "dataConectorId": "SAP",
            "dataTypes": "SAPConnectorOverview --SAPAuditLog --SAPChangeDocsLog --SAPAppLog --SAPOS_Syslog --SAPSpoolLog --SAPSpoolOutputLog --SAPTableDataLog --SAPWorkflowLog --SAPJAVAFilesLogs --SAPFilesLogs --SAP_ADR6 --SAP_AGR_1251 --SAP_AGR_DEFINE --SAP_AGR_PROF --SAP_AGR_TCODES --SAP_AGR_USERS --SAP_DEVACCESS --SAP_PAHI --SAP_USR01 --SAP_USR02 --SAP_USR21 --SAP_UST04 --SAPCRLog --SAPJobLog --SAPOS_GW --SAPOS_ICM --SAPOS_WP --SAP_USGRP_USER --SAP_AGR_AGRS --SAP_USR05 --SAP_AGR_FLAGS --",
            "description": "SAP systems and applications handle massive volumes of business-critical data, hosted on cloud/on-premises infrastructure.      Due to the complexity of the SAP ecosystem, security operations (SecOps) teams face the challenge of effectively monitoring and protecting their organization against growing threats.      A breach of the SAP system could result in data loss, disruption to business processes, loss of revenue, and major reputation damage.      The Microsoft Sentinel SAP connector, part of the Microsoft Sentinel Solution for SAP, ingests SAP logs to Microsoft Sentinel workspaces.      You can access raw data using the built-in Microsoft Sentinel Solution for SAP content or using custom content.      The connector ingests SAP NetWeaver (RFC) application layer logs, including Security Auditlogs, Application logs, ChangeDocuments, Spool Logs, Change Request data, User masterdata, and more.      The Microsoft Sentinel solution for SAP will be billed as an add-on charge from May 2023 per production system ID (SID) per hour in addition to the existing Microsoft Sentinel consumption-billing model.      Please see offer page for more details.",
            "provider": "Microsoft",
            "version": "1.0.0"
        }
    ],
    "workbook": [
        {
            "searchKey": "SAP-AuditControls",
            "displayName": "SAP -Audit Controls",
            "description": "SAP -Audit Controls",
            "version": "2.0.4",
            "dataTypes": "SAPAuditLog --",
            "dataConnectorId": "SAP"
        },
        {
            "searchKey": "SAP-Monitors-AlertsandPerformance",
            "displayName": "SAP -Monitors- Alerts and Performance",
            "description": "SAP -Monitors- Alerts and Performance",
            "version": "2.0.1",
            "dataTypes": "SAPAuditLog --",
            "dataConnectorId": "SAP"
        },
        {
            "searchKey": "SAP-SecurityAuditlogandInitialAccess",
            "displayName": "SAP -Security Audit log and Initial Access",
            "description": "SAP -Security Audit log and Initial Access",
            "version": "2.0.1",
            "dataTypes": "SAPAuditLog --",
            "dataConnectorId": "SAP"
        }
    ],
    "analyticsRule": [
        {
            "searchKey": "6898699a-07c5-4cf5-bee5-a588d06df81a",
            "displayName": "SAP - (Preview) AS JAVA - Sensitive Privileged User Signed In",
            "description": "This rule identifies instances of dialog sign-in (UME) by sensitive privileged users within the SAP AS Java environment. You must maintain the list of privileged users in the \"SAP - Privileged Users\" Watchlist.Source Action: Sign in to the backend system using privileged users.Data Sources: SAPJAVAFilesLog",
            "version": "3.1.13",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP Java - Sensitive Privileged User Logged in// here you can exclude certain users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveLogOnOK'let excludeUsersTags= dynamic(['SensitiveLogOnOK']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by User2Exclude=SAPUser;let PrivilegedUsers = SAPUsersGetPrivileged()    | project User, SystemID;let SelectedSystemRoles = dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole;SAPJAVAFilesLogs()| where SourceName == \"/System/Security/Authentication\"| join kind= inner SelectedSystems on SystemID| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| join kind=inner PrivilegedUsers on User, SystemID| extend Login= tostring(column_ifexists(\"_Login\", \"\"))| extend IPAddress= column_ifexists(\"_IP_Address\", \"\")| where isnotempty( Login)| order by TimeGenerated asc| summarize Count=count(), Time=min(Time), IPAddresses=make_set_if(IPAddress, isnotempty( IPAddress)), LogonInfo=take_anyif(tostring(Text), isnotempty(Text))by SystemID, User, SystemRole, Login, Instance| extend AlertName= strcat(\"SAP AS JAVA - Privileged User \", User, \" Has \", iff(Login == \"OK\" , \"succeeded\", \"failed\"),\" logging in\" )| extend AlertDescription= strcat(\"SAP AS JAVA - Privileged User \", User, \" Has \", iff(Login == \"OK\" , \"succeeded\", \"failed\"),\" logging in to a \", SystemRole, \" System \", Count, iff(Count > 1, \" times. \", \"time. \"), \" \\n Login info: \", LogonInfo)| extend Severity= iff(Login == \"OK\", \"Low\", \"High\")| extend IPAddress= IPAddresses[0]| extend AlertRuleUniqueName = 'asjavasensitiveprivilegedusersignedin'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour5M",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access"
            ],
            "mitreAttackMultiple": "Initial Access",
            "techniques": [
                "T1078"
            ],
            "techniquesMultiple": "T1078",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "IPAddress",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPJAVAFilesLogs --SAPUsersGetVIP --SAPSystems --SAPUsersGetPrivileged --"
        },
        {
            "searchKey": "63562246-8abb-4e85-a7ae-0e5074ed161b",
            "displayName": "SAP - (Preview) AS JAVA - Sign-In from Unexpected Network",
            "description": "Identifies sign-ins from an unexpected network.Source Action:  Sign in to the backend system from an IP address that isn't assigned to one of the networks in the SAP - Networks watchlist.Data Sources: SAP JAVAFilesLogNetworks should be maintained in watchlist \"SAP - Networks\"",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "//SAP - AS JAVA - High - Login from unexpected networklet SelectedSystemRoles = dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole;// here you can exclude system users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of \"LoginUnExpectedOK\"let excludeUsersTags= dynamic([\"LoginUnExpectedOK\"]);// dynamic([\"LoginUnExpectedOK\",\"SAP_ALL\"]);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let Networks = _GetWatchlist(\"SAP - Networks\");SAPJAVAFilesLogs()| where SourceName == \"/System/Security/Authentication\"| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| join kind= inner SelectedSystems on SystemID| extend Login= tostring(column_ifexists(\"_Login\", \"\"))| extend IPAddress= column_ifexists(\"_IP_Address\", \"\")| where isnotempty( Login)| order by TimeGenerated asc| evaluate ipv4_lookup(Networks, IPAddress, Network, return_unmatched = true)| where isempty(Network) // Network is not expected// Details| summarize Count=count(), Time=min(Time), LogonInfo=take_anyif(tostring(Text), isnotempty(Text)), Login=take_any(Login)by SystemID, User, SystemRole, IPAddress, Instance| extend GeoLocation= iff(ipv4_is_private( IPAddress), dynamic({\"IsPrivate\": true}), geo_info_from_ip_address(IPAddress))| extend AlertName= strcat(\"SAP AS JAVA - Login from unexpected network \", IPAddress, \" by user \", User)| extend Action= iff(Login contains \"OK\", \" successfully logged in to a \",\" failed to log in to a \")| extend AlertDescription= strcat(\"User \", User, Action, SystemRole, \" System \", Count, iff(Count > 1, \" times. \", \"time. \"), \" \\nLogin info: \", LogonInfo)| extend Severity= iff(Login == \"OK\", \"Low\", \"High\")| extend AlertRuleUniqueName = \"signinfromunexpectednetwork\"",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour15M",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access",
                "Defense Evasion"
            ],
            "mitreAttackMultiple": "Initial Access1\ue946Defense Evasion",
            "techniques": [
                "T1599"
            ],
            "techniquesMultiple": "T1599",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "IPAddress",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPJAVAFilesLogs --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "0713fb84-1ddb-4441-bdc9-127fd979e37e",
            "displayName": "SAP - (Preview) AS JAVA - User Creates and Uses New User",
            "description": "This rule identifies the creation or manipulation of users by admins within the SAP AS Java environment.Source Action: Sign in to the backend system using users that you have created or manipulated.Data Sources: SAPJAVAFilesLog",
            "version": "3.0.4",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP Java - User created and then usedlet excludeUsersTags= dynamic(['CreateUsersAndUseOK']);// dynamic(['CreateUsersAndUseOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by User=SAPUser;let SelectedSystemRoles = dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole;let CreationLookBack= 1h;// lookback for user creations to be alerted onlet LogonsLookback= 1d; // further lookback for creator's logonslet Logs= SAPJAVAFilesLogs    | where TimeGenerated > ago(CreationLookBack + LogonsLookback)    | where SystemID in (SelectedSystems)    | where SourceName == \"/System/Security/Audit/PrincipalModification\" or SourceName == \"/System/Security/Authentication\"    | join kind=leftantisemi excludedUsers on User;// gather a list of IPs that are shared across more than half of the observed userslet UserIPInteractios= Logs| extend IP= column_ifexists(\"_IP_Address\", \"\")| where SourceName == \"/System/Security/Authentication\"| where isnotempty(IP)| summarize DistinctUsersPerIP=dcount(User) by IP;let DistinctUsersCount= toscalar(Logs| where SourceName == \"/System/Security/Authentication\"|summarize DistinctUsers= dcount(User));let IPsThatEveryoneUses= UserIPInteractios | where DistinctUsersPerIP > max_of(4, (DistinctUsersCount / 2)) | distinct IP;// get suspected activitieslet UserModifications=Logs    | where SourceName == \"/System/Security/Audit/PrincipalModification\"    | where TimeGenerated > ago(CreationLookBack)    | extend UserCreator= User    | distinct SystemID, SidGuid, Text= tostring(Text[0]), UserCreator, Time, Instance    | extend Text= split(Text, \"~| \")    | parse kind=regex Text[-1] with * @\"SET_ATTRIBUTE: uniquename=\\[\" UserCreated @\"\\]\" *    | parse kind=regex Text[-1] with * @\"ADD_VALUES: PRINCIPAL_RELATION_MEMBER_ATTRIBUTE=\\[USER.PRIVATE_DATASOURCE.un:\" UserModified  @\"\\]\" *    | extend Action= Text[0]    | extend UserModifiedCreated= coalesce(UserCreated, UserModified)    | where isnotempty(UserModifiedCreated);let KnownIPsPerUser= Logs | where SourceName == \"/System/Security/Authentication\"| where User in(UserModifications | distinct UserCreator) or User in (UserModifications | distinct UserModifiedCreated)| extend IP= column_ifexists(\"_IP_Address\", \"\")| where isnotempty(IP) and IP !in (IPsThatEveryoneUses)| summarize KnownIPs=make_set(IP, 100) by SystemID, SidGuid, User;UserModifications// get logon details for UserCreator| extend User= UserCreator| lookup KnownIPsPerUser on User| project-rename KnownIPsCreatorUser= KnownIPs// get logon details for UserCreated| extend User= UserModifiedCreated| lookup KnownIPsPerUser on User| project-rename KnownIPsCreatedUser= KnownIPs| extend IPsIntersected= set_intersect(KnownIPsCreatorUser, KnownIPsCreatedUser)| where array_length(IPsIntersected) > 0| project    UserCreator,    UserModifiedCreated,    TimeCreated=Time,    TextAction=  strcat_array(Text, \" \"),    Instance,    SystemID,    IPsIntersected,    Action| extend Action= case(Action== \"User created\", strcat(UserCreator, \" created user \", UserModifiedCreated), Action== \"Group modified\", strcat(UserCreator, \" added user \", UserModifiedCreated, \" to a group\"), Action== \"Role modified\", strcat(UserCreator, \" assigned user \", UserModifiedCreated, \" with a role\"), \"N/A\")| where Action!= \"N/A\"| mv-expand IPIntersected= IPsIntersected to typeof(string)| extend AlertName= strcat(\"SAP- User \", Action, \" and then used it\")| extend ExtendedDetails= bag_pack_columns(TimeCreated)| extend AlertDescription= strcat(AlertName, \".\\n \", TextAction)",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Persistence"
            ],
            "mitreAttackMultiple": "Persistence",
            "techniques": [
                "T1136",
                "T1078",
                "T0859"
            ],
            "techniquesMultiple": "T11362\ue946T1078T0859",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "IPIntersected",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPJAVAFilesLogs --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "7c2d366a-1cb8-41f3-9b0b-a5c469ad467e",
            "displayName": "SAP - (Preview) Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014]",
            "description": "SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format.This may be exploited by malicious users to obtain illegitimate access to the system.Read SAP note 3281854 - FAQ for Security Note 3089413 for more details. This alert rule helps to identify current risks for systems in the landscape.",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "//  a per SAP note https://launchpad.support.sap.com/#/notes/3089413// Systems without this parameter, or with values != \"no\" are vulnerable// both (default) - old method allowed as client and server// client - old method allowed as client// server - old method allowed as server// no - old method not allowed// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet TimeAgo= 7d;let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole, SystemUsage| extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown' );let Vulnerability= 'SAP - [CVE-2023-0014] Capture-replay vulnerability in a ';let Remediation= ' SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format. <br/> This may be exploited by malicious users to obtain illegitimate access to the system. <br/> Read SAP note 3281854 - FAQ for Security Note 3089413 for more details.';let SafeValues= dynamic(['no']);let MitigatedValues= dynamic(['client']);let ConfiguredSystems= SAP_PAHI| where TimeGenerated > ago(TimeAgo)| where PARNAME == 'rfc/allowoldticket4tt'| where PARSTATE == \"A\"| summarize arg_max(PARDATE, PARVALUE, TimeGenerated, SYSTEMID) by SystemID, Host= HOSTNAME, SYSTEMID| project-rename SystemNumber= SYSTEMID| extend LastChanged= todatetime(PARDATE);// ConfiguredSystemslet PotentialSystems= SAPAuditLog| where TimeGenerated > ago(TimeAgo)| project SystemID, Host, SystemNumber| summarize by SystemID, Host, SystemNumber| join kind= inner SelectedSystems on SystemID;PotentialSystems | join kind= inner ConfiguredSystems on SystemID, Host, SystemNumber| summarize SystemRole=any(SystemRole), Hosts= makeset(Host), SystemNumbers= makeset(SystemNumber) by SystemID, PARVALUE| extend BagODetails= case((PARVALUE in (MitigatedValues)),bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' system- mitigated' ),'AlertDescription', Remediation, 'IsVulnerable', true, 'Severity', 'Medium' ),(PARVALUE in (SafeValues)),bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' - system resolved' ),'AlertDescription', Remediation, 'IsVulnerable', false, 'Severity', 'Iformational' ),//  else:bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' system'),'AlertDescription', Remediation, 'IsVulnerable', true, 'Severity', 'High' ))| evaluate bag_unpack(BagODetails)| project Hosts, SystemNumbers, PARVALUE, AlertName= columnifexists('AlertName', Vulnerability), AlertDescription= columnifexists('AlertDescription', Remediation), SystemID, Severity= columnifexists('Severity', '')| extend ExtendedLink= 'https://www.cve.org/CVERecord?id=CVE-2023-0014', Dummy= ''| extend AlertRuleUniqueName = 'capture-replayvulnerabilityinsapnetweaver[cve-2023-0014]'",
            "ruleFrequency": "1 day",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access"
            ],
            "mitreAttackMultiple": "Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAP_PAHI --SAPSystems --"
        },
        {
            "searchKey": "6e60e742-aef0-47aa-95e5-36a100a4272d",
            "displayName": "SAP - (Preview) Critical authorizations assignment - New Authorization Value",
            "description": "Identifies assignment of a critical authorization object value to a new user.Source Action: Assign a new authorization object / update existing one in a role using PFCG.Critical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"Data Sources: SAPcon -  Change Documents LogData Sources: SAPcon -  User MD",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Medium - Critical authorizations assignment - New Authorization Value// time span for audit eventslet TimeAgo= 6h;// New Assigned Objectslet ObjectClassRoles = 'PFCG';let TableName = 'CD1251';let UsersRoles = 'AGR_USERS';let Insert = \"I\";let NotInUse = 'NOT_IN_USE';let logsThreshold = 3600; // 3600 seconds// Audit Log Classes - Authorizations for user changedlet AuditClasses = dynamic(['AUR','AUT']); // Authorization/Authorization Profile &B created / changed.// Roles Change Documents - Extract Auth Object and Obj Fieldlet allHistory = ago(0d);let alertSched = ago(6h); // Please maintain according to schedulelet ChangeDocs = SAPChangeDocsLog;let UsersEmails = SAPUsersHeader()| summarize by User, Email, SystemID, Client | project-rename ClientID = Client;let RolesAuthObject = ChangeDocs    | where TimeGenerated > ago(TimeAgo)    | where TimeGenerated >= alertSched    | where ObjectClass == ObjectClassRoles and TableName == TableName // Role-Obj-Profile-ObjField    | where TypeofChange_Item in ('J', 'I', 'U') //  Insert    | extend RoleObjProfileObjFieldVer = ChangedTableKey, Role = ObjectID    | extend ObjFieldValue = ValueNew    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))    | extend TimeGenRoleAuth = TimeGenerated;let ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');let SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');let usersinRole =    ChangeDocs    | where TimeGenerated > ago(TimeAgo)    | where TimeGenerated <= allHistory    | where ObjectClass == ObjectClassRoles // Roles        and TableName == UsersRoles // Users Roles        and TypeofChange_Item == Insert // Insert    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey)    | extend Role = ObjectID    | summarize by SystemID, Role, UserAssigned;let RolesAuthObjectCheck =        RolesAuthObject        | extend ObjFieldVal = ObjFieldValue        | lookup kind = leftouter            (RolesAuthObject            | extend ActivityVal = ObjFieldValue)            on Role, AuthObject;let complexScenario = ComplexAuth    | where ActivityField != NotInUse    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity    | lookup kind = inner (RolesAuthObjectCheck)        on $left.AuthorizationObject == $right.AuthObject        and $left.AuthorizationField == $right.ObjField        and $left.AuthorizationValue == $right.ObjFieldValue        and $left.ActivityField == $right.ObjField1        and $left.Activity == $right.ActivityVal;let simpleScenario = SimpleAuth    | where ActivityField == NotInUse    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity    | lookup  kind = inner (RolesAuthObject)        on $left.AuthorizationObject == $right.AuthObject        and $left.AuthorizationField == $right.ObjField        and $left.AuthorizationValue == $right.ObjFieldValue;let GetEntities =    SAPAuditLog    | where MessageID in (AuditClasses)    | where TimeGenerated > ago(TimeAgo)    | summarize by TimeGenerated, ClientID, TerminalIPv6, User, Host, Email    | extend TimeGenAudit = TimeGenerated;union complexScenario, simpleScenario| lookup kind = inner (usersinRole) on SystemID, Role| lookup kind = leftouter (GetEntities) on User| where abs(datetime_diff('second', TimeGenRoleAuth, TimeGenAudit)) <= logsThreshold orisnull(TimeGenAudit)| lookup UsersEmails on SystemID, ClientID, User| projectTimeGenRoleAuth, SystemID, ClientID, Role, User, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity, Email, TerminalIPv6, Host, UserAssignedEmail=Email1| extend AlertRuleUniqueName = 'criticalauthorizationsassignment-newauthorizationvalue'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Privilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "UserAssignedEmail",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPChangeDocsLog --SAPUsersHeader --"
        },
        {
            "searchKey": "4329c5d1-7062-4ec4-8ab8-29846e0e0d9a",
            "displayName": "SAP - (Preview) Data exported from a production system using a transport",
            "description": "Transports are like pull requests and are normally created in a developement system. This alert rule is triggered when a transport is released from a production system, with data coming from a sensitive table.",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// sensitive data was released using transport system// here you can exclude system users which are OK to export sensitive data using transport system// by adding those users in the SAP_User_Config watchlist with a tag of 'ExportSensitiveDataOK'// can also specify SAP Roles or SAP Profiles to excludelet excludeUsersTags= dynamic(['ExportSensitiveDataOK']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;let SensitiveTables = _GetWatchlist('SAP - Sensitive Tables') | summarize by TableName= Table | extend IsSensitive= true;let TransportReleaseTCODEs= dynamic([\"SE10\", \"SE01\"]);let TransportReleasePrograms= dynamic([\"RDDM0001\"]);let SensitiveDataExportViaCR= SAPCRLog| where SystemID in (SelectedSystems)| where isnotempty( SystemID)| where isnotempty(TableName)| lookup SensitiveTables on TableName| where Status == \"R\" // released| where Request startswith_cs SystemID| project-rename ExportDT= UpdatedOn| summarize Requests= make_set(Request,10), ExportDT= min(ExportDT) by Owner, RequestDescription= Description, TableName, SystemID, Instance, Host, IsSensitive;let TransportReleaseTransactions= SAPAuditLog| where  MessageID == \"AU3\"| where SystemID in (SelectedSystems)| where TransactionCode in(TransportReleaseTCODEs) or ABAPProgramName in (TransportReleasePrograms)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| project-rename TransactionStartDT= UpdatedOn_t| summarize TransactionCodes= make_set(TransactionCode, 3), ABAPProgramNames= make_set(ABAPProgramName, 3), Email= any(Email), TransactionStartDT= min(TransactionStartDT) by User, TerminalIPv6, Host, SystemID, ClientID, Instance;TransportReleaseTransactions| join kind= inner SensitiveDataExportViaCR on SystemID| extend TimePassed= datetime_diff( \"minute\", ExportDT, TransactionStartDT)| where TimePassed between (0 .. 60)| extend AlertDescription= strcat(\"User has exported \",iff(IsSensitive, \"sensitive\", \"tabular\") ,\" data from a productive system using a transport\")| extend ExtendedDetails= pack(\"TransactionStartDT\" , TransactionStartDT, \"Owner\", Owner, \"RequestDescription\", RequestDescription, 'TransactionCodes', TransactionCodes, 'ABAPProgramNames', ABAPProgramNames)| extend Severity= iff(IsSensitive, \"High\", \"Medium\"), Dummy= ''| project ExportedOn= ExportDT, User, TerminalIPv6, Host, SystemID, TransactionCode= TransactionCodes[0], ABAPProgramName= ABAPProgramNames[0], Email, ExtendedDetails, Requests, AlertDescription, TableName, IsSensitive, Severity, ClientID, Instance, Dummy| extend AlertRuleUniqueName = 'dataexportedfromaproductionsystemusingatransport'",
            "ruleFrequency": "4 hours",
            "rulePeriod": "5 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Exfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --SAPCRLog --"
        },
        {
            "searchKey": "6a028035-0967-4bbe-9229-0377a1f4e7df",
            "displayName": "SAP - (Preview) Developer key assigned in a production system",
            "description": "Identifies the assignment of a DEV access key in a production environment. These keys allow modification of runtime objects and therefore should only be assigned in a development environment.Source Action:  Create or delete a DEVAccess key in a production system.Data Sources: SAPcon -  Audit LogData Sources: SAPcon -  Table data log",
            "version": "3.2.01",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Developer access in production// !!!IMPORTANT!!!// Please keep \"Lookup data from the last\" to be >= 36 hours to allow reading of user authorization data// Actual lookback is set by setting TimeAgolet TimeAgo= 75m;let SelectedSystemRoles = dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole;// here you can exclude system users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of 'PRODDEVAccessOK'// can also specify relevant SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['PRODDEVAccessOK']);// dynamic(['PRODDEVAccessOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by UserMakingChanges=SAPUser;let ClosestLoginDetails= (T: (DevAccessUser: string, UserMakingChanges: string, UpdatedOn: datetime, SystemID: string, TransactionCode: string)) {    T    | join kind=leftouter  (SAPAuditLog        | where TimeGenerated> ago(TimeAgo+ 1h)        | where SystemID in (SelectedSystems)        | where Email has \"@\")        on $left.UserMakingChanges == $right.User, SystemID    | extend TimeDiff= abs(datetime_diff('second', UpdatedOn, UpdatedOn_t))    | summarize TransactionStartTime=arg_min(TimeDiff, *) by SystemID, DevAccessUser, UserMakingChanges, TransactionCode};SAPTableDataLog| where TimeGenerated> ago(TimeAgo)| where SystemID in (SelectedSystems)| where TableName contains \"DEVACCESS\"| order by LogKey, SystemID, UpdatedOn asc| summarize    UserMakingChanges=take_any(UserName),    TransactionCode=take_any(TransactionCode),    DevAccessUser=take_any(LogKey),    AccesKey=take_anyif(coalesce(NewValue, OldValue), TableField == \"ACCESSKEY\"),    Operations= make_list_with_nulls(OperationTypeSQL)    by SystemID, DBLogID, UpdatedOn| join kind=leftantisemi excludedUsers on UserMakingChanges| summarize    DeletedOn=take_anyif(UpdatedOn, tostring(Operations) == \"[\\\"D\\\",\\\"D\\\"]\"),    UpsertedOn=take_anyif(UpdatedOn, tostring(Operations) == \"[\\\"I\\\",\\\"I\\\"]\" or tostring(Operations) == \"[\\\"U\\\",\\\"U\\\"]\")    by SystemID, DevAccessUser, UserMakingChanges, TransactionCode| extend Action= case(                     isempty(DeletedOn) and isnotempty(UpsertedOn), \" created \",                     isnotempty(DeletedOn) and isempty(UpsertedOn), \" deleted \",                     isnotempty(DeletedOn) and isnotempty(UpsertedOn) and UpsertedOn > DeletedOn, \" replaced \",                     isnotempty(DeletedOn) and isnotempty(UpsertedOn) and UpsertedOn < DeletedOn, \" created and then deleted \",                     \" \")| extend Action= case(                     DevAccessUser == UserMakingChanges, strcat(DevAccessUser, Action, \"own DEV access key\"),                     DevAccessUser != UserMakingChanges, strcat(UserMakingChanges, Action, \" for user \", DevAccessUser),                     \"\")| lookup SelectedSystems on SystemID| extend UpdatedOn= min_of(UpsertedOn, DeletedOn)| invoke ClosestLoginDetails()| extend AlertName= strcat(\"SAP - user \", Action, \" in a \", tolower(SystemRole), \" system\")| project    SystemID,    DevAccessUser,    UserMakingChanges,    TransactionCode,    DeletedOn,    UpsertedOn,    Action,    SystemRole,    Instance,    ClientID,    TERM_IPV6,    Email,    SystemNumber,    Host,    Computer,    AlertName,    UpdatedOn| extend ExtendedDetails= bag_pack_columns(TransactionCode, DeletedOn, UpsertedOn, SystemNumber, UpdatedOn)",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 dayT12H",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Resource Development"
            ],
            "mitreAttackMultiple": "Resource Development",
            "techniques": [
                "T1608"
            ],
            "techniquesMultiple": "T1608",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "Computer",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TERM_IPV6",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --SAPTableDataLog --"
        },
        {
            "searchKey": "4d66b748-d415-43f6-ae03-e1bee011b670",
            "displayName": "SAP - (Preview) Dormant users detected",
            "description": "Lists all dialog users with valid credentials which have not logged in for the last 150 days (configurable).Data Sources: SAPcon - User master dataLists all dialog users with valid credentials which have not logged in for the last 150 days (configurable).Data Sources: SAPcon - User master data",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Dormant users detected// !!!IMPORTANT!!!// Please keep \"Lookup data from the last\" to be > = 36 hours to allow reading of user authorization datalet AlertOnUsersInactiveForOverDays= 150;let SelectedSystemRoles = dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;// here you can exclude system users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of 'DormantOK'// can also specify relevant SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['DormantOK']);// dynamic(['DormantOK']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User=SAPUser;SAPUsersHeader()| where SystemID  in ((SelectedSystems | distinct SystemID))| join kind=leftantisemi excludedUsers on User| where LastSeenDaysAgo> AlertOnUsersInactiveForOverDays and CreatedDaysAgo > AlertOnUsersInactiveForOverDays| where UserType == \"A\" // dialog users| where LockedStatus in (dynamic([0, 128])) // unlocked, locked by incorrect password// additional config options using SAP user groups// | where UserGroup !in (dynamic([\"USRGRP-BASIS\", \"USRGRP-TERM\"])) and UserGroup containscs \"USRGRP\"| where ValidityDate >= startofday(now())// if validity extended in the last X days, we are OK| where ValidFrom < startofday(now()) - AlertOnUsersInactiveForOverDays*1d| extend ValidFromDaysAgo= datetime_diff('day', startofday(now()), ValidFrom)| summarize  ValidFrom=min(ValidFrom), ValidFromDaysAgo=max(ValidFromDaysAgo), LastSeen=max(LastSeen), LastSeenDaysAgo= min(LastSeenDaysAgo), ValidityDate= max(ValidityDate), CreatedOn=take_any(CreatedOn), CreatedDaysAgo= take_any(CreatedDaysAgo) by User, SystemID, Client, LockedStatusDescription| extend UserRecord= bag_pack(\"User\", User, \"Status\", LockedStatusDescription, \"SeenXDaysAgo\", LastSeenDaysAgo, \"LastSeen\", LastSeen, \"ValidityDate\", ValidityDate, \"CreatedOn\", CreatedOn, \"CreatedDaysAgo\", CreatedDaysAgo, \"ValidFrom\", ValidFrom, \"ValidFromDaysAgo\", ValidFromDaysAgo)| summarize RecordCount= count(), Users= make_set(User, 1024), UserRecords= make_set(UserRecord, 1024) by SystemID, ClientID= Client| extend AlertName= strcat(\"System \" ,SystemID, \"-\", ClientID, \" contains \", RecordCount, \" users with unused valid credentials\")| extend Users=tostring(Users), UserRecords= tostring(UserRecords)",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 dayT12H",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access"
            ],
            "mitreAttackMultiple": "Credential Access",
            "techniques": [
                "T1212"
            ],
            "techniquesMultiple": "T1212",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPUsersHeader --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "49fd3399-67c5-47bf-bb61-8b6efa27a5fe",
            "displayName": "SAP - (Preview) Dynamic Anomaly based Audit Log Monitor Alerts",
            "description": "SAP Audit log events with message IDs preconfigured in Watchlist SAP_Dynamic_Audit_Log_Monitor_Configuration and with RuleType  = \"AnomaliesOnly\" will be shown here.See  Sentinel4SAP Dcoumentation for further information",
            "version": "3.1.1",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - (Preview) Dynamic Anomaly based Audit Log Monitor Alertslet SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do//let SelectedSeverities =  dynamic([\"All Severities\"])// let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);let SAPAuditAnomal = SAPAuditLogAnomalies(LearningTime = 14d, DetectingTime=1h, SelectedSystems= SelectedSystems,SelectedSystemRoles= SelectedSystemRoles, SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes);// Query// get the anomaliesSAPAuditAnomal// get the user privleged status| lookup (SAPUsersGetPrivileged() | extend IsPrivilegedUser = true) on$left.SystemID == $right.SystemID,$left.User == $right.User,$left.ClientID == $right.Client| extend DetailedDescription = iff(IsPrivilegedUser, strcat('User ', User,  ' is a privileged user! <br/>', DetailedDescription), DetailedDescription)| extend TimeGenerated = MaxTime// handle threshold per system (configurable via the SAPAuditLogConfigurator watchlist)//  apply the threshold criteria, consider that the watchlist describes hourly thresholds| extend MinutesSpan = datetime_diff('Minute', MaxTime, MinTime )| where EventCount > (Threshold * max_of(MinutesSpan, 10) / 60)| extend DetailedDescription = iff(EventCount > 1, strcat(' Event occured ', EventCount, ' times within ', MinutesSpan + 1, ' minutes.<br/> ', 'The predefined threshold of ', Threshold,  ' Events per hour was exceeded! <br/>', DetailedDescription), DetailedDescription)| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText)-1), MessageText)| project-keep SystemID, Instance, MessageText, MessageClass, MessageID, ClientID, User, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, Host, CategoryName, DestinationEmail, DetailedDescription, Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, IsPrivilegedUser, EventCount, Threshold, TimeGenerated| extend Source= 'SAPAuditAnom1 '| extend AlertRuleUniqueName = 'dynamicanomalybasedauditlogmonitoralerts'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [],
            "mitreAttackMultiple": [],
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "TransactionCode",
                            "identifier": "ProcessId"
                        },
                        {
                            "columnName": "ABAPProgramName",
                            "identifier": "CommandLine"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPAuditLogAnomalies --SAPUsersGetPrivileged --"
        },
        {
            "searchKey": "5f152aa1-f82c-4789-8dea-d63d7d6bf96b",
            "displayName": "SAP - (Preview) File Downloaded From a Malicious IP Address",
            "description": "User has downloaded a file from an SAP system using an IP address known to be malicious.Malicious IP addresses are obtained from threat intelligence services. For additional information visit the Connect your threat intelligence platform to Microsoft Sentinel how-to page.This Alert rule allows for a cross-workspace query to accommodate an architecture where the threat intelligence data resides in a different workspace than the one which holds the SAP data.",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let TimeAgo = 65m;let ioc_lookBack = 14d;// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])// let SelectedSystemRoles= dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;let MaliciousIPs= SAPThreatIntelligenceIndicator| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId| summarize ConfidenceScore= any(ConfidenceScore) by NetworkIP, EmailSourceIpAddress, NetworkDestinationIP, NetworkSourceIP, Active, Description, ThreatType| where Active == true// Picking up only IOC's that contain the entities we want| where isnotempty(NetworkIP)    or isnotempty(EmailSourceIpAddress)    or isnotempty(NetworkDestinationIP)    or isnotempty(NetworkSourceIP)// As there is potentially more than 1 indicator type for matching IP, taking NetworkIP first, then others if that is empty.// Taking the first non-empty value based on potential IOC match availability| extend TI_ipEntity = iff(isnotempty(NetworkIP), NetworkIP, NetworkDestinationIP)| extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(NetworkSourceIP), NetworkSourceIP, TI_ipEntity)| extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(EmailSourceIpAddress), EmailSourceIpAddress, TI_ipEntity)//Exclude local addresses, using the ipv4_is_private operator| where TI_ipEntity !startswith \"fe80\"    and TI_ipEntity !startswith \"::\"    and TI_ipEntity !startswith \"127.\"| summarize by TI_ipEntity, TIDescription= Description, ThreatType, ConfidenceScore| extend IsPrivate= ipv4_is_private(TI_ipEntity);// Get all downloadslet FileDownloads= SAPAuditLog    | where MessageID == \"AUY\"    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where SystemID in (SelectedSystems)    | join kind=inner (MaliciousIPs) on $left.TerminalIPv6 == $right.TI_ipEntity    | extend ByteCount= toint(replace_string(replace_string(Variable1, \".\",\"\"), \",\",\"\")), Code=Variable2, Path= Variable3    | summarize ConfidenceScore= any(ConfidenceScore), IsPrivate=any(IsPrivate), TIDescription=any(TIDescription), ThreatType= any(ThreatType), DownloadsByUser = count(), Paths= make_set(Variable3, 10), ByteCount=sum(ByteCount) by SystemID, ClientID, User, TerminalIPv6, Email, Host, TransactionCode, Instance;    FileDownloads    | extend PackedDetails= pack_all()    | extend Details= strcat(\"User \", User, \" has downloaded \", ByteCount, \" bytes data from a malicious \", iff(IsPrivate, \"private\",\"public\"),\" IP address \")    | extend AlertDetails= strcat(\"Threat Type: \", ThreatType, \", Threat Description: \", TIDescription), Dummy= ''| extend AlertRuleUniqueName = 'filedownloadedfromamaliciousipaddress'",
            "ruleFrequency": "2 hours",
            "rulePeriod": "14 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Exfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPThreatIntelligenceIndicator --SAPSystems --"
        },
        {
            "searchKey": "2d7cbb53-cb18-4c9e-8855-c5393aa91db0",
            "displayName": "SAP - (Preview) HANA DB - Assign Admin Authorizations",
            "description": "Identifies admin privileges/roles assignment.Source Action: Assign a user with any Admin role / privileges.Data Sources: Linux Agent - Syslog",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "SAPSyslog| where ProcessName startswith \"HDB\"| where SyslogMessage contains \"ADMIN\" and (SyslogMessage contains \"GRANT PRIVILEGE\" or SyslogMessage contains \"GRANT ROLE\")| extend AlertRuleUniqueName = 'hanadb-assignadminauthorizations'",
            "ruleFrequency": "3 hours",
            "rulePeriod": "3 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Privilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "HostName",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "ProcessID",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSyslog --"
        },
        {
            "searchKey": "fe14e4b9-8616-4741-bf6c-2936d30afa65",
            "displayName": "SAP - (Preview) HANA DB - Audit Trail Policy Changes",
            "description": "Identifies changes for HANA DB audit trail policies.Source Action: Create / update existing audit policy in security definitions.Data Sources: Linux Agent - Syslog",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "SAPSyslog| where ProcessName startswith \"HDB\"| where SyslogMessage contains \"AUDIT POLICY\"| extend AlertRuleUniqueName = 'hanadb-audittrailpolicychanges'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Lateral Movement",
                "Defense Evasion",
                "Persistence"
            ],
            "mitreAttackMultiple": "Lateral Movement2\ue946Defense EvasionPersistence",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "HostName",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "ProcessID",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSyslog --"
        },
        {
            "searchKey": "7e5e321a-f6df-434d-b1be-a8d74f696481",
            "displayName": "SAP - (Preview) HANA DB - Deactivation of Audit Trail",
            "description": "Identifies deactivation of HANA DB audit log.Source Action: Deactivate Audit Log in HANA DB security defnitions.Data Sources: Linux Agent - Syslog",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "SAPSyslog| where ProcessName startswith \"HDB\"| where SyslogMessage contains \"AUDIT CONFIGURATION\" and    SyslogMessage contains 'global_auditing_state' and    SyslogMessage contains 'False'| extend AlertRuleUniqueName = 'hanadb-deactivationofaudittrail'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Persistence",
                "Lateral Movement",
                "Defense Evasion"
            ],
            "mitreAttackMultiple": "Persistence2\ue946Lateral MovementDefense Evasion",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "HostName",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "ProcessID",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSyslog --"
        },
        {
            "searchKey": "3ba35622-3071-477e-9af9-5380bce25e1e",
            "displayName": "SAP - (Preview) HANA DB - User Admin actions",
            "description": "Identifies user administration actions.Souirce Action: Create/Update/Delete a DB User.Data Sources: Linux Agent - Syslog",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "SAPSyslog| where ProcessName startswith \"HDB\"| where SyslogMessage contains \"CREATE USER\" or    SyslogMessage contains 'ALTER USER' or    SyslogMessage contains 'DROP USER' or    SyslogMessage contains 'DROP SCHEMA'| extend AlertRuleUniqueName = 'hanadb-useradminactions'",
            "ruleFrequency": "3 hours",
            "rulePeriod": "3 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Privilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "HostName",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "ProcessID",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSyslog --"
        },
        {
            "searchKey": "bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e",
            "displayName": "SAP - (Preview) Sensitive Static Parameter Has Changed",
            "description": "Produces alerts on static parameter changes which are considered as risky",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Risky static parameter changes// IMPORTANT!!!!! Please set the alert lookback period for at least 7 days, to make sure that the activities of server restart and parameter historical changes are detected.// this is the actual lookback period for parameter changeslet LookBack4Changes= 2h;let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);// we need to look back in PAHI 1d as PAHI updates are full dialy + hourly deltaslet PAHILookBack= 36h;// get the alert relevant parameterslet GetSystemParams= materialize(SAPGetSystemParameter()| where EnableAlerts| project-away SearchKey, EnableAlerts, DummyJoinField, LastUpdatedTimeUTC);let ParameterSets= GetSystemParams |summarize RelevantParams= make_set(ParameterName, 1000);let StateDescriptions= dynamic({\"A\":\"Active\", \"C\": \"Changed\", \"O\": \"Original\", \"D\": \"<<parameter inactive>>\" });// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');let RiskyParameterChanges= materialize(SAP_PAHI| where SystemID in (SelectedSystems)| where PARNAME in (ParameterSets)| where TimeGenerated > ago(PAHILookBack) // PAHI is loaded in full mode daily with entire history| summarize LastObserved= max(TimeGenerated), FirstObserved= min(TimeGenerated) by PARNAME, PARTYPE, HOSTNAME, SYSTEMID, PARDATE, PARSTATE, PARVALUE, SystemID| extend ChangeDay= todatetime(PARDATE)| extend FirstObserved= iff(startofday(FirstObserved)== ChangeDay,FirstObserved, ChangeDay));// recently changedlet RecentlyChangedParameters= RiskyParameterChanges| where PARSTATE != \"C\" // latest state can't be \"Changed\"| where strcmp( PARDATE, format_datetime(ago(LookBack4Changes), \"yyyyMMdd\")) >= 0| where FirstObserved > ago(LookBack4Changes + 60m)| project-rename LastChangedOn= ChangeDay, LatestParValue= PARVALUE, LatestParState= PARSTATE;// look for application server starts, as the static parameters take effect after restartlet ApplicationServerRestarts= (SAPAuditLog| where SystemID in (SelectedSystems)| where MessageID == \"AUH\"| summarize by ServerStartTimeDT= UpdatedOn_t, SystemID) ;// look for executions of transaction which are used for parameter changeslet ParameterChangeActions= (SAPAuditLog| where SystemID in (SelectedSystems)| where MessageID == \"AU3\"| where (Variable1 == \"RZ10\" or Variable1 == \"RZ10\") or (TransactionCode == \"RZ10\" or TransactionCode == \"RZ10\"))| project ParameterChangeActionDT= UpdatedOn_t, User, SystemID, MessageText, TransactionCode= Variable1, Email;RecentlyChangedParameters// get all matching parameters so we can look for previous values| join kind= leftouter (RiskyParameterChanges | project PARNAME, PARVALUE, HOSTNAME, SystemID, PreviousChangeDate= ChangeDay, PARSTATE, SYSTEMID) on PARNAME, SystemID, SYSTEMID, HOSTNAME| project-away PARNAME1, HOSTNAME1, SystemID1| where LastChangedOn > PreviousChangeDate| where PARVALUE != LatestParValue or PARSTATE !=  LatestParState// keep the latest record from the PreviousChangeDate history| summarize FirstObserved= min(FirstObserved), PreviousChangeDate= arg_max(PreviousChangeDate, *) by ParameterName= PARNAME, SystemID, PARTYPE, LatestParState, SYSTEMID, LastObserved , LastChangedOn, HOSTNAME| summarize FirstObserved= min(FirstObserved) by ParameterName, LatestParValue, LatestParState, SystemID, PreviousChangeDate, PreviousParValue= PARVALUE, PreviousParState= PARSTATE, SystemNumber= SYSTEMID, Host= HOSTNAME| lookup GetSystemParams on SystemID, ParameterName| join kind= leftouter ApplicationServerRestarts on SystemID| where (FirstObserved > ServerStartTimeDT or isnull(ServerStartTimeDT))| join kind= leftouter ParameterChangeActions on SystemID| where (FirstObserved > ParameterChangeActionDT or isnull(ParameterChangeActionDT))| summarize ServerStartTimeDT= arg_max(ServerStartTimeDT, *) by ParameterName, SystemID, ParameterChangeActionDT, SystemNumber, Host| summarize ParameterChangeActionDT= arg_max(ParameterChangeActionDT, *) by ParameterName, SystemID, SystemNumber, Host| project-rename ParameterDescription= Comment| project-away SystemID1, SystemID2| extend LatestParState= tostring(StateDescriptions[LatestParState]), PreviousParState= tostring(StateDescriptions[PreviousParState])| extend ChangeScope= case((LatestParState == \"Active\" and PreviousParState == \"<<parameter inactive>>\"),strcat(\"activated\"),(LatestParValue == PreviousParValue and LatestParState == \"Active\" and PreviousParState == \"Changed\"),\"No changes detected\",(LatestParValue != PreviousParValue and LatestParState == \"Active\"),\"changed\", (LatestParState == \"<<parameter inactive>>\" and PreviousParState != \"<<parameter inactive>>\"),\"deactivated\", \"Not sure\")| where ChangeScope != \"No changes detected\"| extend LatestNumeric= extract(\"([0-9.]+)\", 1, replace(\",\",\".\", LatestParValue), typeof(real))| extend LatestAlpha= extract(\"([A-Z]+[a-z])\", 1, LatestParValue, typeof(string))| extend ValueComparison= case(ExpectedValue == LatestParValue and (Option in(dynamic([\"LE\", \"GE\", \"EQ\"])) or isempty( Option)), \"OK\", (Option == \"AlertOnAnyChange\" and LatestParValue != PreviousParValue), \"Not OK\", LatestAlpha != ExpectedAlpha, \"Cannot compare values of different units\", LatestNumeric >= ExpectedNumeric and Option in(dynamic([\"GT\", \"GE\"])), \"OK\", LatestNumeric <= ExpectedNumeric and Option in(dynamic([\"LT\", \"LE\"])), \"OK\", \"Not OK\")| extend ExpectedValue= iff(Option == \"AlertOnAnyChange\", \"alert on any value changes \",strcat(\"Expected value is \", Option, \" '\", ExpectedValue, \"'\"))| extend AlertName= strcat(\"SAP Parameter '\", ParameterName, \"' was  \", ChangeScope, iff(isnotempty( SystemRole),strcat(\" in a \", tolower(SystemRole), \" system\"), \"\"),\".\")| extend Details= strcat(AlertName, iff(ChangeScope == \"activated\", strcat(\", value set to '\", LatestParValue, \"'\"), iff(ChangeScope == \"deactivated\", strcat(\" Previous values was '\", PreviousParValue,\"'\"), iff(ChangeScope == \"changed\", strcat(\" Value changed from '\", PreviousParValue, \"'\", \" to '\", LatestParValue, \"'\"),\"'\"))),\".\")| extend ExtendedDetails= strcat(\"The parameter \", ParameterName, \" is described as '\", ParameterDescription,\"'. This parameter change is a static change. Parameter change was first observed on \", format_datetime(FirstObserved,\"yy-MM-dd [HH:mm:ss]\"), \" , and has likely taken effect after an application server start.\", iff(isnotnull(ServerStartTimeDT), strcat(\" A server restart was reported on \", format_datetime(ServerStartTimeDT,\"yy-MM-dd [HH:mm:ss]\"),\".\"),\"\"), iff(isnotnull(ParameterChangeActionDT), strcat(\" The last parameter change detected on the sytem was performed on \", format_datetime(ParameterChangeActionDT,\"yy-MM-dd [HH:mm:ss]\"), \" by user \", User,\".\"),\"\"),\". \", ExpectedValue)| project-reorder ValueComparison, ExpectedValue, ChangeScope, Details, LatestParValue, PreviousParValue, LatestParState, PreviousParState| where ValueComparison != \"OK\"| extend Dummy= \"\"| extend AlertRuleUniqueName = 'sensitivestaticparameterhaschanged'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Impact"
            ],
            "mitreAttackMultiple": "Impact",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAP_PAHI --SAPGetSystemParameter --SAPSystems --"
        },
        {
            "searchKey": "870d9ea0-cd99-4644-9c7a-d7256b0b37e0",
            "displayName": "SAP - (Preview) Sensitive data saved into a USB drive",
            "description": "SAP data exported via files and saved into a recently mounted USB drive in proximity to an execution of a sensitive transaction, a sensitive program or direct access to a sensitive table.",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Sensitive data saved into a USB drive// Data exported via files and saved into a recently mounted USB drive in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.// !!!IMPORTANT!!!// please keep \"Lookup data from the last\" to be 14 days to allow coverage of USB drive mount events// actual lookback is set by setting TimeAgolet TimeAgo= 4h;let TimeBetweenAccessAndDownload= 60m;let FilesDownloadedToUSB= DeviceFileEvents    | where ingestion_time() >= ago(TimeAgo)    | join kind=inner  (DeviceEvents    | where ActionType == \"UsbDriveMounted\"    | extend DriveLetter = tostring(AdditionalFields.DriveLetter)    | summarize MountedDriveLetters = make_set(DriveLetter, 26) by DeviceId, DeviceName)    on DeviceId| extend TargetDriveLetter = tostring(split(FolderPath, \"\\\\\")[0])| where set_has_element(MountedDriveLetters, TargetDriveLetter)| project USBFileSize= FileSize, USBFolderPath= FolderPath;// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])// let SelectedSystemRoles= dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;// Get sensitive Tables// CONFIGURATION OPTION- list sensitive tables in the 'SAP - Sensitive Tables' watchlistlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables') | summarize by Table;let TableAccessTcodes= dynamic([\"SE16\", \"SE16N\", \"SE11\", \"SE16H\", \"SM30\", \"SE12\", \"SM31\", \"SE16H\", \"SE14\", \"SE54\",\"SE17\", \"SE16T\", \"DB01\", \"DB02\"]);// CONFIGURATION OPTION- list sensitive transactions in the 'SAP - Sensitive Transactions' watchlistlet SensitiveTransWL= toscalar(_GetWatchlist('SAP - Sensitive Transactions') | summarize TransactionCodes= make_set(TransactionCode));// CONFIGURATION OPTION- exclude TCODEs which are not to be consideredlet ExcludedTcodes= dynamic([\"S000\", \"\"]);let SensitiveTcodes= (set_difference(set_union(SensitiveTransWL, TableAccessTcodes), ExcludedTcodes));// CONFIGURATION OPTION- list sensitive programs in the 'SAP - Sensitive ABAP Programs' watchlistlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');let fixedABAPReports = datatable(ABAPProgram:string) [\"RSPFLDOC\"];let UnionABAP = union isfuzzy=true SensitiveABAPReports, fixedABAPReports| summarize by ABAPProgram;// Get direct sensitive table accesslet SensitiveTableAccess= SAPAuditLog    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"DU9\"    | where SystemID in (SelectedSystems)    | where Variable1 in (SensitiveTables)    | project-rename Table = Variable1, Activity = Variable2    | summarize Activities= make_set(Activity, 3) by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName    , Table, SourceAction= strcat(\"after visiting transaction \", TransactionCode, \" and viewing sensitive table \", Table), TransactionCode, TableOrProgram= Table;// get sensitive program executionlet SensitiveProgramExec= SAPAuditLog    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"AUW\"    | where SystemID in (SelectedSystems)    | where ABAPProgramName in (UnionABAP)    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName    , SourceAction= strcat(\"after executing sensitive program \", ABAPProgramName), TransactionCode, TableOrProgram= ABAPProgramName ;// get sensitive transaction executionlet SensitiveTcodeExec= SAPAuditLog    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"AU3\"    | where SystemID in (SelectedSystems)    // make sure sensitive transactions do not contain the TableAccessTcodes which are checked for the specific table name    | where TransactionCode in (set_difference(SensitiveTcodes,TableAccessTcodes))    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, SourceAction= strcat(\"after executing sensitive transaction \", TransactionCode), TransactionCode, TableOrProgram= TransactionCode;// Get all downloadslet FileDownloads= SAPAuditLog    | where MessageID == \"AUY\"    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where SystemID in (SelectedSystems)    | where TransactionCode in (SensitiveTcodes) or ABAPProgramName in (UnionABAP)    | join kind= innerunique FilesDownloadedToUSB on $left.Variable3== $right.USBFolderPath    | extend ByteCount= toint(replace_string(replace_string(Variable1, \".\",\"\"), \",\",\"\")), Code=Variable2, Path= Variable3    | summarize DownloadsByUser = count(), Paths= make_set(Variable3, 10), ByteCount=sum(ByteCount) by TimeDownloaded= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, TerminalIPv6, Email, Host, TransactionCode, Instance;// Time window join to find dowloads after table accessFileDownloads | join kind=inner (SensitiveTableAccess | union SensitiveProgramExec, SensitiveTcodeExec) on User, SystemID    | where (TimeAccessed- TimeDownloaded) between (-(TimeBetweenAccessAndDownload*2) .. 0h)    | summarize Activities= tostring( make_set_if(Activities, tostring(Activities) != \"\")), DownloadsByUser= max(DownloadsByUser), ByteCount=max(ByteCount), TablesOrPrograms=make_set(TableOrProgram,10), SourceActions= make_set(SourceAction,10), TimeAccessed= any(TimeAccessed) by TimeDownloaded, User, SystemID, ClientID, Email, Host , TerminalIPv6, Paths= tostring(Paths), Instance    | extend PackedDetails= pack_all()    | extend Details= strcat(\"User \", User, \" has downloaded \", ByteCount, \" bytes of potentially sensitive data \")    | extend AlertDetails= strcat(Details , tostring(SourceActions)), Dummy= ''| extend AlertRuleUniqueName = 'sensitivedatasavedintoausbdrive'",
            "ruleFrequency": "4 hours",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Exfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "TablesOrPrograms",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPSystems --"
        },
        {
            "searchKey": "e35db198-2146-446c-8eb7-a77b6344f1d7",
            "displayName": "SAP - (Preview) Trusted RFC connection created or modified in SAP NetWeaver [CVE-2023-0014] ",
            "description": "SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format.This may be exploited by malicious users to obtain illegitimate access to the system.Read SAP note 3281854 - FAQ for Security Note 3089413 for more details. This alert rule helps to identify newly added trusted RFC relationships.",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "//  a per SAP note https://launchpad.support.sap.com/#/notes/3089413let TimeAgo= 1h;let Vulnerability= \"SAP - [CVE-2023-0014] Capture-replay vulnerability in a \";// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, \"Unknown (Production)\", \"Unknown\");SAPTableDataLog| where TimeGenerated > ago(TimeAgo * 2)| where ingestion_time() > ago(TimeAgo)// | where isempty(OldValue)| where TableName == \"RFCTRUST\" or TableName == \"RFCSYSACL\"| join kind = inner SelectedSystems on SystemID| extend ScopeOfChange= case(isempty(OldValue) and isnotempty( NewValue),\"created\", OldValue != NewValue and isnotempty( NewValue), \"changed\", isempty(NewValue) and isnotempty(OldValue), \"deleted\" ,\"none\")| extend Change= case(ScopeOfChange== \"created\", strcat(ScopeOfChange,\" \",TableField,\"= \",NewValue),ScopeOfChange== \"changed\", strcat(ScopeOfChange,\" \",TableField,\" from \", OldValue,\" to \",NewValue), ScopeOfChange== \"deleted\", strcat(ScopeOfChange,\" \",TableField,\"= \",OldValue), \"No changes\")| summarize    UserName= any(UserName), SystemChanges=make_set_if(replace_string(Change, \"No changes\", \"Modified\"), TableField == \"RFCSYSID\" or TableField == \"RFCTRUSTID\"),    Changes= make_set_if(Change, ScopeOfChange!=\"none\"),    TimeStarted= any(TimeGenerated),    SystemRole= any(SystemRole),    RFCSYSID= make_set_if(NewValue, TableField == \"RFCSYSID\" and isnotempty( NewValue) ),    RFCTRUSTID= make_set_if(NewValue, TableField == \"RFCTRUSTID\" and isnotempty( NewValue) ),    ScopeOfChanges= make_set_if(ScopeOfChange, ScopeOfChange != \"none\")    by SystemID, DBLogID, LogKey, TableName| extend    RFCSYSID= RFCSYSID[0], RFCTRUSTID= RFCTRUSTID[0], SystemChanges= SystemChanges[0]| where isnotempty(RFCSYSID) or isnotempty(RFCTRUSTID)| extend AlertName = strcat(\"SAP RFC \", iff(TableName == \"RFCTRUST\", \"trusting \", \"trusted \"), \"system \", SystemChanges, \" for a  \", tolower(SystemRole), \" system\")| extend AlertDescription= strcat(iff(TableName == \"RFCTRUST\", strcat(\"System \", RFCSYSID, \" is now trusting system \", RFCTRUSTID), strcat(\"System \", SystemID, \" is now being trusted by system \", RFCSYSID)), \". <br/> Scope of changes:  \",ScopeOfChanges , \". <br/> Changes:  \",Changes ,\". <br/> see  \", Vulnerability)| project-away Changes, ScopeOfChanges, SystemChanges, LogKey| extend OtherSystem= iff(TableName == \"RFCTRUST\", RFCTRUSTID, RFCSYSID)| extend ExtendedLink= \"https://www.cve.org/CVERecord?id=CVE-2023-0014\" , Dummy= \"\"| extend AlertRuleUniqueName = 'newtrustedrfcconnectioncapture-replayvulnerabilityinsapnetweaver[cve-2023-0014]'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "12 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access"
            ],
            "mitreAttackMultiple": "Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "OtherSystem",
                            "identifier": "Name"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSystems --SAPTableDataLog --"
        },
        {
            "searchKey": "e704b794-2f22-417a-b3ac-25e6037e2717",
            "displayName": "SAP - Activation or Deactivation of ICF Service",
            "description": "Identifies activation or deactivation of ICF Services.Source Action: Activate or deactivate a service using SICF.Data Sources: SAPcon - Table Data Log",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Activation or Deactivation of ICF Service// Materialize the data for self join to be esierlet TimeAgo= 2h;let ICFDataChanges = materialize(SAPTableDataLog| where TimeGenerated > ago(TimeAgo+ 1h)| where UpdatedOn> ago(TimeAgo)| where TableName == \"ICFSERVLOC\"| where NewValue == \"X\" or NewValue ==\"\" or isempty( NewValue)// X - Status is activated, \"\" Not activated now| where TableField == \"ICF_NAME\" or TableField == \"ICFACTIVE\"// Service name// Active status| project OldValue, NewValue, LogKey, DBLogID, SystemID, TimeGenerated, UserName, Host, Instance, UpdatedOn);let ActDeactICF =ICFDataChanges| where OldValue == NewValue and OldValue != \"\"| lookup ICFDataChanges onLogKey, DBLogID // Lookup for combining the data| extend ICFServiceStatus = iff(NewValue1 == \"X\", \"Activated\", iff(NewValue1 == \"\" or isempty( NewValue1) and OldValue1 == \"X\" ,\"Deactivated\",\"No Activity\"))| extend Service = split(LogKey,\" \")[0];ActDeactICF| lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User| extend AlertText= strcat(\"Service \", Service, \" \", ICFServiceStatus, \" by User \", UserName, \" in System \", SystemID)//{{Service}} {{ICFServiceStatus}} by User {{User}} in System {{SystemID}}| project UpdatedOn, Service, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance, ICFServiceStatus, AlertText| extend Dummy = ''| extend AlertRuleUniqueName = 'activationordeactivationoficfservice'",
            "ruleFrequency": "2 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Command And Control",
                "Lateral Movement",
                "Persistence"
            ],
            "mitreAttackMultiple": "Command And Control2\ue946Lateral MovementPersistence",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "PrimaryEmail",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "Client",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "LastKnownIP",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPUsersHeader --SAPTableDataLog --"
        },
        {
            "searchKey": "4e228f1a-55cc-4abc-8ef4-5e385b60f9c0",
            "displayName": "SAP - Assignment of a sensitive profile",
            "description": "Identifies new assignments of a sensitive profile to a user.Source Action: Assign a profile to a User using SU01.Sensitive profiles can be maintained using the \"SAP - Sensitive Profiles\" watchlistData Sources: SAPcon -  Change Documents Log",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define Variables// Audit Log Classes - Authorizations for user changed// the actual lookback period is 1h. The alert looks back further to allow for user master data to be built slowlylet TimeAgo= 12h;let Identity = 'IDENTITY';let ProfileChangeDoc = 'SUSR_UST04';let Insert = \"I\";let logsThreshold = 3600; // 3600 secondslet AuditClasses = dynamic(['AUB']); // Authorizations for user &A changed.// Maintain these if WatchList is not availablelet SensitiveProfiles =  _GetWatchlist('SAP - Sensitive Profiles');let fixedProfile = datatable(Profile:string)['SAP_ALL','SAP_NEW'];// Maintain these if System doesn't have CR's// here you can exclude system users which are OK to assign a Sensitive profile// by adding those users in the SAP_User_Config watchlist with a tag of 'AssignSensitiveProfileOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['AssignSensitiveProfileOK']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let fixedChangeDocs = datatable(User : string, ObjectClass : string, TableName : string, TypeofChange_Item : string , ChangedTableKey : string, ObjectID : string, TimeGenerated : datetime, ValueNew : string, SystemID : string, Instance: string, ClientID: string, UpdatedOn_t: datetime)[];let ChangeDocs =(union isfuzzy=true table(\"SAPChangeDocsLog\"), fixedChangeDocs)| where ingestion_time() > ago(TimeAgo)| project-rename ChangedOn= UpdatedOn_t;let IdentityChangeDocuments =// Identity Change documents which represents profiles assignment    ChangeDocs    | where ObjectClass == Identity // Identity    and TableName == ProfileChangeDoc // Profile Change Doc    and TypeofChange_Item == Insert // Insert    | extend Profile = ChangedTableKey    | extend UserAssigned = ObjectID;let UnitedProfiles =toscalar(union fixedProfile, SensitiveProfiles| summarize Profiles = make_list(Profile));// Query logicSAPAuditLog| where ingestion_time() > ago(TimeAgo)| where MessageID in (AuditClasses)| project-rename AuditedOn= UpdatedOn_t| summarize by AuditedOn, TerminalIPv6, User, Host, Email| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| lookup kind = leftouter (IdentityChangeDocuments) on User| where Profile in (UnitedProfiles)| where abs(datetime_diff('second',ChangedOn,AuditedOn)) <= logsThresholdor isnull(AuditedOn)| project// DetailsChangedOn, Instance , SystemID, ClientID, Profile, User,  UserAssigned,Email, TerminalIPv6, Host, AuditedOn| extend Dummy= '',  PackedDetails= pack_all()| extend AlertRuleUniqueName = 'assignmentofasensitiveprofile'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Privilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPChangeDocsLog --SAPUsersGetVIP --"
        },
        {
            "searchKey": "03b9a2cf-8434-44ad-b42f-9a35701f1c2a",
            "displayName": "SAP - Assignment of a sensitive role",
            "description": "Identifies new assignments of a sensitive role to a user, and can also be used to detect any assignment to any role. Allows to exclude users by tag, role and profile, to support a central user administration scenario. By default, this alert rule will trigger on production and UAT environments.Source Action: Assign a role to a User using SU01 / PFCG.Sensitive roles should be maintained in watchlist \"SAP -  Sensitive Roles\"Data Sources: SAPcon -  Change Documents Log, Audit Log",
            "version": "3.0.0",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": " // Assignment of a sensitive role // !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required// actual lookback is set by setting TimeAgolet TimeAgo= 2h;// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"];let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage;let Roles = 'PFCG';let UsersRoles = 'AGR_USERS';let Insert = \"I\";let logsThreshold = 180; // max time in seconds between audit record and change record// Audit Log Classes - Authorizations for user changedlet AuditClasses = dynamic(['AUB', 'AUD']); // Authorizations for user &A changed.// Maintain these if WatchList is not availablelet SensitiveRoles =  _GetWatchlist('SAP - Sensitive Roles');let fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];// here you can exclude system users which are OK to assign sensitive roles// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveRoleOK'let excludeUsersTags= dynamic(['SensitiveRoleOK']);let excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;let UnitedRoles = toscalar(union fixedRoles, SensitiveRoles| summarize Roles = make_list(Role));// get the assignments madelet ChangeCheck =SAPChangeDocsLog| where TimeGenerated > ago(TimeAgo+ 1h)| where UpdatedOn_t > ago(TimeAgo)| join kind=inner SelectedSystems on SystemID| where ObjectClass == Roles // Roles    and TableName == UsersRoles // Users Roles    and TypeofChange_Item == Insert // Insert| extend IsSensitive= ObjectID in (UnitedRoles)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| extend UserAssigned = trim_end(@\"[^\\w]+\" ,extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey))| project-rename Role=ObjectID, ChangedOn= UpdatedOn_t;// enrich with the host and IP address from the audit logSAPAuditLog| where TimeGenerated > ago(TimeAgo+ 1h)| where UpdatedOn_t > ago(TimeAgo)| join kind=inner SelectedSystems on SystemID| where MessageID in (AuditClasses)| summarize by UpdatedOn_t, TerminalIPv6, User, Host, Email, ClientID, SystemID| extend User= trim_end(@\"[^\\w]+\" , User)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| lookup kind = inner ChangeCheck on User, ClientID, SystemID| extend TimeDiff= abs(datetime_diff('second', ChangedOn, UpdatedOn_t))| where TimeDiff <= logsThreshold// determine severity- self assignment is high, sensitive role is medium, not sensitive is low| extend Severity= case(User == UserAssigned, \"High\", IsSensitive, \"Medium\",\"Low\")// remove this filter if you need to be informed on non-sensitive role assignment as well:| where Severity != \"Low\"| order by ChangeNumber, SystemID, ClientID, TimeDiff asc| extend RowRank= row_number(0, prev(ChangeNumber) != ChangeNumber)| where RowRank == 0 // only the closest audit record| project ChangedOn, UpdatedOn_t, Instance , SystemID, ClientID, Role, User, UserAssigned, Email, TerminalIPv6, Host, Severity, IsSensitive, SystemRole| extend PackedDetails= pack_all(), Dummy=' '| extend AlertDescription= iff(User == UserAssigned,strcat('User ', User, ' has self-assigned a ', iff(IsSensitive,'sensitive',''),' role '),strcat('User ', User, ' has Assigned a ',  iff(IsSensitive,'sensitive',''),' role to User ', UserAssigned))| extend AlertDescription= strcat(AlertDescription, \" in a \", tolower(SystemRole), \" system\")| lookup (SAPUsersEmail | project SystemID, ClientID, UserAssigned= User, UserAssignedEmail= Email) on UserAssigned, SystemID, ClientID| extend Tactics= \"Privilege Escalation\"",
            "ruleFrequency": "2 hours",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Privilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "UserAssignedEmail",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPChangeDocsLog --SAPSystems --SAPUsersEmail --"
        },
        {
            "searchKey": "c2cc3901-d6bd-4189-bb5f-ab464dcfd079",
            "displayName": "SAP - Brute Force (RFC)",
            "description": "Identifies brute force attacks on the SAP system using RFC logonsSource Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval using RFCData Sources: SAPcon -  Audit Log",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Brute Force (RFC)// Define constantslet TimeAgo= 60m;//time to look for brute forcinglet LearningTime= 3d;// history to learnlet Threshold= 0.5; // 0.1 is sensitive, 2 is indifferentlet PerIPPerMinute = 60; // number of calls permitted per minute from a single source// determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// here you can exclude system users which are OK to use RFC heavily// by adding those users in the SAP_User_Config watchlist with a tag of 'MultipleRFCOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['MultipleRFCOK', 'SAP_ROLE', 'SAPPROFILE']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by User2Exclude=SAPUser;// Can also exclude users by user classeslet UserClassesToExclude= dynamic([\"Class2Exclude\"]);let UsersByClass= (SAP_USR02| where CLASS in (UserClassesToExclude)| summarize arg_max(TimeGenerated, *) by GLTGB, SystemID, User=BNAME, ClientID= MANDT| summarize arg_max(GLTGB, CLASS) by SystemID, User, ClientID);// Query logiclet RFCLogons= SAPAuditLog| where MessageID == \"AU6\" // RFC Logon Failed| where SystemID in (SelectedSystems)| where TimeGenerated > ago (LearningTime)| join kind= leftantisemi UsersByClass on User, SystemID, ClientID| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude;// get current excessive callerslet PotentialExcessiveCallers= RFCLogons| where TimeGenerated > ago(TimeAgo + 1h)| where UpdatedOn_t > ago(TimeAgo)| extend IP= coalesce(TerminalIPv6, Computer, TERM_IPV6)| summarize CallCount= count(), StartTime = min(UpdatedOn_t), EndTime = max(UpdatedOn_t) by IP| where CallCount > PerIPPerMinute* TimeAgo/ (1m);// build series of logons from these addresseslet RFCLogonHistory= RFCLogons| project TerminalIPv6, Computer, TERM_IPV6, UpdatedOn_t| extend IP= coalesce(TerminalIPv6, Computer, TERM_IPV6)| where IP in ((PotentialExcessiveCallers | summarize IPs= makeset(IP,1000)))| make-series CallCount = count() on UpdatedOn_t from ago(LearningTime) to now() step TimeAgo by IP;// learn the history and perform judgementlet ExcessiveCallers= RFCLogonHistory| extend (CallCountAnome, score, baseline) = series_decompose_anomalies(CallCount, Threshold= Threshold, Test_points= 1)| where CallCountAnome[-1] > 0 // only excessive| summarize IPs= makeset(IP,1000);// get the actual call from these IPsRFCLogons| where TimeGenerated > ago(TimeAgo + 1h)| where UpdatedOn_t > ago(TimeAgo)| where TerminalIPv6 in ((ExcessiveCallers)) or Computer in ((ExcessiveCallers)) or TERM_IPV6 in((ExcessiveCallers))| extend IP= coalesce(TerminalIPv6, Computer, TERM_IPV6)| lookup PotentialExcessiveCallers on IP| summarize LoginAttemptsMadebyIP= any(CallCount), CallCountPerUserSystem= count(), StartTime= any(StartTime), EndTime=any(EndTime) by IP, Email, User, SystemID, ClientID, Host| extend ActivityDetailed= bag_pack(\"Email\", Email, \"User\", User, \"SystemID\", SystemID, \"ClientID\", ClientID, \"Host\", Host, \"CallCountPerUserSystem\", CallCountPerUserSystem)| summarize LoginAttemptsMadebyIP= any(LoginAttemptsMadebyIP), Activities= make_set(ActivityDetailed, 30), StartTime =any(StartTime), EndTime = any(EndTime), (CallCountPerUserSystem, User, Email, SystemID, ClientID, Host)= argmax(CallCountPerUserSystem, User, Email, SystemID, ClientID, Host) by IP| lookup SelectedSystems on SystemID| extend AlertName= strcat(\"SAP - Potential brute force attack (RFC) on a \", tolower(SystemRole), \" system, \", LoginAttemptsMadebyIP, \" calls within \", datetime_diff(\"minute\", EndTime, StartTime), \" minutes\")| extend AlertDescription= strcat(\"Source has produced \", LoginAttemptsMadebyIP, \" calls within \", datetime_diff(\"minute\", EndTime, StartTime),\" minutes, most of which were made to system \", SystemID, \". The permitted limit of calls per minute is \", PerIPPerMinute , \". \")| extend AlertRuleUniqueName = 'bruteforce(rfc)'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "3 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access"
            ],
            "mitreAttackMultiple": "Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "IP",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --SAP_USR02 --"
        },
        {
            "searchKey": "3eab4a41-1d7b-453d-8631-a7d74936973b",
            "displayName": "SAP - Change in a Sensitive Privileged User",
            "description": "Identifies changes of sensitive privileged users.Source Action: Change user details / authorizations using SU01.Users are considered as Privileged when one of these conditions apply:If they are named in the SAP - Privileged Users WatchlistIf they have a profile which is included in the SAP - Sensitive Profiles watchlistIf they have a role which is included in the SAP - Sensitive Roles watchlistThis Rule requires a fresh full reload of SAP user master data to be performed daily.Data Sources: SAPcon -  Audit LogData Sources: SAPcon -  User MD",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Change in a Sensitive Privileged User// time span for audit eventslet AuditTimeAgo= 75m;// Audit Log Classes - User Master Changeslet AuditClasses = dynamic(['AU7', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'BU2']);// here you can exclude system users which are OK to modify other users' master data// by adding those users in the SAP_User_Config watchlist with a tag of 'ChangeUserMasterDataOK'let excludeUsersTags= dynamic(['ChangeUserMasterDataOK']);let excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;let UsersEmails = SAPUsersHeader()| project-keep User, SystemID, Client, Email| project-rename ClientID= Client, ChangedEmail=Email, ChangedUser=User;SAPAuditLog| where TimeGenerated > ago(AuditTimeAgo)| where MessageID in (AuditClasses)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude// The user that we are making change in is a sensitive privileged user| extend ChangedUser = Variable1| join kind= inner (SAPUsersGetPrivileged())on $left.ClientID == $right.Client, $left.SystemID == $right.SystemID, $left.ChangedUser == $right.User| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText)-1), MessageText)| extend MessageTextDyna = replace_string(MessageText, \"User\", \"Privileged User\")| extend MessageTextDyna = replace_string(MessageTextDyna, \"user\", \"Privileged User\")| lookup UsersEmailson SystemID, ClientID, ChangedUser| project-keep TimeGenerated, Instance,  SystemID, ClientID, User, MessageText, MessageID, Email,  TerminalIPv6, Host, ChangedUser, ChangedEmail, MessageTextDyna| extend Email= iff(isempty(Email),User, Email), Host= iff(isempty(Host), TerminalIPv6, Host), Dummy= ''| extend ChangedEmail= iff(isempty(ChangedEmail),ChangedUser, ChangedEmail)| extend PackedDetails= pack_all()| extend AlertRuleUniqueName = 'changeinasensitiveprivilegeduser'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation",
                "Credential Access"
            ],
            "mitreAttackMultiple": "Privilege Escalation1\ue946Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "ChangedEmail",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersHeader --SAPUsersGetPrivileged --"
        },
        {
            "searchKey": "4258c51d-59db-4502-9b02-fb2ab20e97d4",
            "displayName": "SAP - Client Configuration Change",
            "description": "Identifies changes for client configuration such as: Client role, Changes recording mode.Source Action:  Perofrm client configurations changes using SCC4 transaction code.Data Sources: SAPcon -  Audit Log",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Audit Log Classes - Client Change Configurationlet AuditClasses = dynamic(['EU2']); // Relevent messagelet SelectedSystemRoles=dynamic([\"Production\", \"UAT\"]);let SelectedSystems= SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | summarize by SystemRole, SystemID= SearchKey;SAPAuditLog| where MessageID in (AuditClasses)| join kind=inner SelectedSystems on SystemID| project-rename ClientIDTemp = ClientID| project-rename ClientID= Variable1| parse Variable2 with Currency \"|\" ClientRole \"|\" RecordingChanges \"|\" CrossClientObjectChanges \"|\" ClientCopyProtectionLevel \"|\" ProtectionSAPUpgrade \"|\" CATTeCATT \"|\"  LockedforCopy // Parse every object before the | char| project TimeGenerated, Instance, SystemID, SystemRole, User, ClientID,Currency,ClientRole,RecordingChanges,CrossClientObjectChanges,ClientCopyProtectionLevel,CATTeCATT,LockedforCopy,ProtectionSAPUpgrade,MessageText, Email, TerminalIPv6, Host| extend Severity= iff(SystemRole==\"Production\",\"High\",\"Medium\"), Dummy= \"\"| extend AlertRuleUniqueName = 'clientconfigurationchange'",
            "ruleFrequency": "15 minutes",
            "rulePeriod": "25 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Defense Evasion",
                "Exfiltration",
                "Persistence"
            ],
            "mitreAttackMultiple": "Defense Evasion2\ue946ExfiltrationPersistence",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPSystems --"
        },
        {
            "searchKey": "8f9b9576-d0cd-43da-8ea2-d77366d4a70d",
            "displayName": "SAP - Critical authorizations assignment - New User Assignment",
            "description": "Identifies assignment of a critical authorization object value to a new user.Source Action: Assign a new user to a role which holds critical authorization values using SU01/PFCG.Critical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"Data Sources: SAPcon -  Change Documents Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// New Assigned Userslet ObjectClassRoles = 'PFCG';let TableName = 'CD1251';let UsersRoles = 'AGR_USERS';let Insert = \"I\";let NotInUse = 'NOT_IN_USE';let logsThreshold = 3600; // 3600 seconds// Audit Log Classes - Authorizations for user changedlet AuditClasses = dynamic(['AUB','AUD']); // Authorizations for user &A changed. User Master Record Changed// Roles Change Documents - Extract Auth Object and Obj Fieldlet allHistory = ago(0d);let alertSched = ago(6h); // Please maintain according to schedule// Maintain these if System doesn't have CR'slet fixedChangeDocs = datatable(User : string, ObjectClass : string, TableName : string, TypeofChange_Item : string , ChangedTableKey : string, ObjectID : string, TimeGenerated : datetime, ValueNew : string, SystemID : string)[];let ChangeDocs =union isfuzzy=true table(\"SAPChangeDocsLog\"), fixedChangeDocs;let RolesAuthObject = ChangeDocs    | where TimeGenerated <= allHistory    | where ObjectClass == ObjectClassRoles and TableName == TableName // Role-Obj-Profile-ObjField    | where TypeofChange_Item in ('J', 'I', 'U') //  Insert    | extend RoleObjProfileObjFieldVer = ChangedTableKey, Role = ObjectID    | extend ObjFieldValue = ValueNew    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))    | summarize by SystemID, Role, AuthObject, ObjField, ObjFieldValue;let ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');let SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');let fixedComplexAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)    ['S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '*',    'S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '02']; // Maintain these if WatchList is not availablelet fixedSimpleAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)    ['S_TCODE', 'TCD', '*', 'NOT_IN_USE', '',    'S_TZONE', 'ACTVT', '*', 'NOT_IN_USE', '']; // Maintain these if WatchList is not availablelet usersinRole =    ChangeDocs    | where TimeGenerated >= alertSched    | where ObjectClass == ObjectClassRoles // Roles        and TableName == UsersRoles // Users Roles        and TypeofChange_Item == Insert // Insert    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey)    | extend Role = ObjectID    | extend TimeGenUserinRole = TimeGenerated;    //| summarize by TimeGenerated, SystemID, ClientID, Role, UserAssigned, Userlet RolesAuthObjectCheck =        RolesAuthObject        | extend ObjFieldVal = ObjFieldValue        | lookup kind = leftouter            (RolesAuthObject            | extend ActivityVal = ObjFieldValue)            on Role, AuthObject;let complexScenario =    union ComplexAuth, fixedComplexAuth    | where ActivityField != NotInUse    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity    | lookup kind = inner (RolesAuthObjectCheck)        on $left.AuthorizationObject == $right.AuthObject        and $left.AuthorizationField == $right.ObjField        and $left.AuthorizationValue == $right.ObjFieldValue        and $left.ActivityField == $right.ObjField1        and $left.Activity == $right.ActivityVal;let simpleScenario =    union SimpleAuth, fixedSimpleAuth    | where ActivityField == NotInUse    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity    | lookup kind = inner (RolesAuthObject)        on $left.AuthorizationObject == $right.AuthObject        and $left.AuthorizationField == $right.ObjField        and $left.AuthorizationValue == $right.ObjFieldValue;let GetEntites =    SAPAuditLog    | where TimeGenerated >= alertSched    | where MessageID in (AuditClasses)    | summarize by TimeGenerated, TerminalIPv6, ClientID, User, Host, Email    | extend TimeGenAudit = TimeGenerated;union complexScenario, simpleScenario| lookup kind = inner (usersinRole) on SystemID, Role| lookup kind = leftouter (GetEntites) on User| where abs(datetime_diff('second', TimeGenUserinRole, TimeGenAudit)) <= logsThreshold orisnull(TimeGenAudit)| project    // DetailsTimeGenUserinRole , SystemID, ClientID, Role, User, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity, Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'criticalauthorizationsassignment-newuserassignment'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "6 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Privilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPChangeDocsLog --"
        },
        {
            "searchKey": "2af909e9-9c84-4198-b8c7-e80fe9f00ffb",
            "displayName": "SAP - Data collection health check",
            "description": "Produces insights on potential SAP agent connectivity issues.",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// ***IMPORTANT***- Lookback period is maintained in the KQL// please keep the Query scheduling parameter of \"Lookup data from the last\" to be 14 days so// the algorithm can detect anomalies across historylet LogLookBack= 14d;let StepSize= 1d;// handle the TimeGenerated -> ingestion gaplet Tolerance= 15m;let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// 0.1 is very sensitive and is required for low activity workspaces with under 1M events a day.// 0.5 can work better for high scale WSs (between 1M and 10M records a day). 1 can be used for WSs with over 10m records a daylet Threshold= 0.1;let SystemLevelIssues= SAPConnectorHealth()    | summarize arg_max(LastSeen, *) by SystemID // last status per SystemID    | where SystemID !in (dynamic([\"N/A\", \"AGE\", \"Agent Version Check\"])) // agents checks are not interesting    | where MessageCode != \"OKOK\" // only show problems    | where Status == \"Yellow\" or Status == \"Red\"    | extend Severity= case(Status == \"Yellow\", \"Medium\", Status == \"Red\", \"High\", \"Unknown\")    | extend Log= 'Entire system'    | extend Details= replace_string(Details, \"System\", strcat(\"SAP System \", SystemID));let LogContinuationTS=  SAPConnectorOverview()    | where TimeGenerated > ago(LogLookBack)    | project Type, TimeGenerated, SystemID= SystemID_s    | make-series RecordCount= count(), LastSeen= max(TimeGenerated) on TimeGenerated from ago(LogLookBack) to now() step StepSize by Log= Type, SystemID;// LogContinuationTSlet LogContinuationAnomal= LogContinuationTS    | extend (RecordCountAnomalies, score, baseline) = series_decompose_anomalies(RecordCount, Threshold= Threshold, Test_points= 1)    | where array_index_of(RecordCountAnomalies, -1, -1) > 0 // some log is missing in the last bucket    // to allow for some tolerance, check if last seen is in the previous bin    | extend LastSeen= (max_of(todatetime(LastSeen[-1]),todatetime(LastSeen[-2])))    | extend IsTolerable= now() < (LastSeen + Tolerance + 1d)    | extend Severity= iff(RecordCount[-1] == 0 and not(IsTolerable), \"Low\", \"Informational\") // determine severity according to certainty    | extend Details= strcat('SAP- Potential log loss for log ', Log, ' from System ', SystemID)    | extend ExtendedDetails= strcat('Log ', Log, ' from System ', SystemID, ' has produced ', RecordCount[-1], ' recods since ', format_datetime(todatetime(TimeGenerated[-1]), 'yy-MM-dd [hh:mm:ss tt]'), '. Expected number of records is ', round(toint(baseline[-1]), 0));(LogContinuationAnomal| join kind=leftantisemi (SystemLevelIssues    | where Status == \"Red\"    | summarize by SystemID)    on SystemID) // System-wide issues should overtake log level issues| union SystemLevelIssues| join kind= inner SelectedSystems on SystemID| where Severity != \"Informational\" and Severity != \"Low\" // optionally can have these cases produce alerts by deleting this filter| where not (SystemRole == \"Production\" and Log startswith(\"ABAPCR\")) // CR logs coming from production systems are unpredictable| project Log, SystemID, SystemRole, LastSeen, Severity, Details, ExtendedDetails    , Agent, MessageCode, AgentVersion| extend Dummy= ''| extend AlertRuleUniqueName = 'datacollectionhealthcheck'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "14 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Impact"
            ],
            "mitreAttackMultiple": "Impact",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPConnectorHealth --SAPSystems --SAPConnectorOverview --"
        },
        {
            "searchKey": "9a55136c-fa19-46d4-9376-17c8f96cc2b8",
            "displayName": "SAP - Data has Changed During Debugging Activity",
            "description": "Identifies changes for runtime data during a debugging activity.Source Action: Activate Debug (\"/h\"), Select a field for change and update it's value.Recommended for Production onlyData Sources: SAPcon -  Audit Log",
            "version": "3.1.6",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Data has Changed during Debugging Activitylet TimeAgo= 75m;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole, SystemUsage;// here you can exclude certain users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of 'ProdDebugOK'// can also specify relevant SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['ProdDebugOK']);// dynamic(['ProdDebugOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let AuditClasses = dynamic([\"CUL\", \"AU1\", \"AU5\"]); // Audit Log Classes - Debug Change and dialog logonslet SAPEvents= SAPAuditLog| where TimeGenerated> ago(TimeAgo)| where MessageID in (AuditClasses)| join kind= inner SelectedSystems on SystemID| extend TimeBin= bin(UpdatedOn_t, 10m);// get logon details for external debugging user:let SAPSignins= SAPEvents| where isnotempty(Email) and MessageID != \"CUL\"| summarize DebuggerEmail= take_anyif(Email, Email has \"@\") by User| extend Var1IsUser= true;let Debugs= materialize(SAPEvents| where MessageID == \"CUL\"| lookup SAPSignins on $left.Variable1 == $right.User| extend IsExternal= coalesce(Var1IsUser and User!=Variable1, false)| extend DebuggingUser= iff(IsExternal, Variable1, User )| join kind=leftantisemi excludedUsers on $left.DebuggingUser == $right.User2Exclude);let ExternalDebugs= Debugs| where IsExternal| summarize by DebuggedUser= User, ActualDebuggingUser= DebuggingUser, TimeBin| lookup SAPSignins on $left.ActualDebuggingUser == $right.User;Debugs| extend ChangeDetails = bag_pack(\"Time\", UpdatedOn_t, \"Changes\", strcat_delim(\" \", Variable1, Variable2, Variable3, Variable4))| order by UpdatedOn_t asc| lookup ExternalDebugson $left.User == $right.DebuggedUser, TimeBin| summarize ActivityCount= count(), ChangeDetails= make_list(ChangeDetails, 30), DebuggerEmail=take_anyif(DebuggerEmail, isnotempty( DebuggerEmail)), take_any(Host, ABAPProgramName, TransactionCode, Email, SystemRole, IsExternal, Instance)by SystemID,ClientID, TerminalIPv6, TERM_IPV6, DebuggedOn=TimeBin, User, ActualDebuggingUser= coalesce(ActualDebuggingUser, User)| extend AlertName= strcat_delim(\" \", \"SAP - Data has changed during debugging activity\", iff(isnotempty( SystemRole), strcat(\" in a \",tolower(SystemRole), \" system\"),\"\"))| extend AlertDescription= strcat_delim(\" \", \"SAP User\", ActualDebuggingUser, \"was observed changing data during a debugging session.\", iff(IsExternal,strcat(\"The debugging session was external and performed on a code execution initiated by user \", User, \".\"), \"\" ),\"Changes: \", tostring(ChangeDetails))| extend AlertRuleUniqueName = 'datahaschangedduringdebuggingactivity'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour15M",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Execution",
                "Lateral Movement"
            ],
            "mitreAttackMultiple": "Execution1\ue946Lateral Movement",
            "techniques": [
                "T0858",
                "T1203",
                "T0866",
                "T1210",
                "T1428"
            ],
            "techniquesMultiple": "T08584\ue946T1203T0866T1210T1428",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "DebuggerEmail",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TERM_IPV6",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "45fb7bf5-783b-4a87-897d-b26f5574186b",
            "displayName": "SAP - Deactivation of Security Audit Log",
            "description": "Identifies deactivation of Security Audit LogSource Action: Disable secruity Audit Log using SM19/RSAU_CONFIG.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Audit Log Classes - Audit Log Active Status Eventslet AuditClasses = dynamic(['AUJ']);SAPAuditLog| where MessageID in (AuditClasses)| where Variable1 == '0' // Audit Active Status = 0| project// DetailsTimeGenerated, Instance ,SystemID, ClientID, User, MessageText, Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'deactivationofsecurityauditlog'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration",
                "Defense Evasion",
                "Persistence"
            ],
            "mitreAttackMultiple": "Exfiltration2\ue946Defense EvasionPersistence",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "a7babb63-a466-4ec7-a056-a213555f18df",
            "displayName": "SAP - Debugging Activities",
            "description": "Identifies all debugging related activities.Source Action: Activate Debug (\"/h\") in system, debug an active process, add breakpoint to source code etc.Recommended for Production onlyData Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let Role = 'Production';let DebuggerProgram = 'RSTPDAMAIN';let AuditClasses = dynamic(['CUK','CUL','CUM','CUN','CUO','CUP']); // Audit Log Classes - Debug Activitieslet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roleslet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages// Get Relevant Systems from WatchListlet systemID = _GetWatchlist('SAP - Systems')| where SystemRole == Role; // Reccommended is Production onlylet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)// Maintain these if WatchList is not available    [\"S4H\",\"Production\",\"ERP\",    \"XXX\",\"Sandbox\",\"BW\"]    | where SystemRole == Role // Reccommended is Production only;let SystemUnited = union systemID, fixedSID| summarize by SystemID, SystemRole, SystemUsage;//| where SystemRole in (allSystemRoles); // Use this for all system rolesSAPAuditLog    | where MessageID in (AuditClasses) or ABAPProgramName == DebuggerProgram // Get logs by messege ID or program name    | extend Object = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,})\", 1, MessageText, typeof(string)) // Extract Object    | extend Action = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,}.{1,}?)\\)?\\(\", 1, MessageText, typeof(string)) // Extract Action    | extend Program = extract(@\"Prgm:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Program    | extend Function = extract(@\"Funct:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Function    | extend Include = extract(@\"Incl:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Include    | extend Line = extract(@\"Line:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Line    | project-rename SystemIDTemp = SystemID| project-rename SystemID= SystemIDTemp| project-rename SystemID= SystemID    | lookup kind=inner (SystemUnited) on SystemID    | order by TimeGenerated asc    | project TimeGenerated, Instance, ClientID ,User, MessageText, ABAPProgramName, TransactionCode, SystemID, SystemRole, SystemUsage,MessageID, Email, TerminalIPv6, Host, Object , Action, Program, Function, Include, Line| extend AlertRuleUniqueName = 'debuggingactivities'",
            "ruleFrequency": "3 hours",
            "rulePeriod": "3 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery"
            ],
            "mitreAttackMultiple": "Discovery",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "db123b5e-bcc2-43a5-9e13-8ac1e1a3c530",
            "displayName": "SAP - Dialog logon attempt from a privileged user",
            "description": "Identifies dialog logon (Type AUM) attempts by priviledged users (See Function SAPUsersGetPrivileged) on SAP system .Source Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - High- Dialog logon attempt from a privileged user// time span for audit eventslet AuditTimeAgo= 6h;// Define variableslet AuditClasses = dynamic(['AUM']);//Dialog onlylet perIPLimit = 1;// Query logicSAPAuditLog| where TimeGenerated > ago(AuditTimeAgo)| where MessageID in (AuditClasses)| extend DetailsBy = pack(\"User\", User, \"Email\", Email, \"SystemID\", SystemID, \"ClientID\", ClientID)| summarize LoginbyIPAttempts = count(), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)    by TerminalIPv6// Check if number of login attempts per IP is higher than limit| where LoginbyIPAttempts > perIPLimit| mv-expand Details| evaluate bag_unpack(Details, \"Details_\")| project    StartTime, EndTime,  TerminalIPv6,    Email = column_ifexists(\"Details_Email\", \"\"), User = column_ifexists(\"Details_User\", \"\"),    SysetmID = column_ifexists(\"Details_SystemID\", \"\"),   ClientID = column_ifexists(\"Details_ClientID\", \"\")| join kind= inner (SAPUsersGetPrivileged | project User ) on $left.User == $right.User| extend AlertRuleUniqueName = 'dialoglogonattemptfromaprivilegeduser'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access"
            ],
            "mitreAttackMultiple": "Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SysetmID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetPrivileged --"
        },
        {
            "searchKey": "fd655ec6-cb11-4e79-a825-0935a66596c8",
            "displayName": "SAP - Dynamic ABAP Program",
            "description": "Identifies execution of dynamic ABAP programming. For example, ABAP code was dynamically created/changed/deleted. Source Action: Create an ABAP Report which uses ABAP program generation commands such as \"INSERT REPORT\" and execute it. Excluded Transaction Codes can be maintained in \"SAP - Transactions for ABAP Generations\" watchlist. Data Sources: SAPcon - Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "// Define variables// here you can exclude system users which are OK to execute a Dynamic ABAP Program// by adding those users in the SAP_User_Config watchlist with a tag of 'DynamicABAPProgramOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['DynamicABAPProgramOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let AuditClasses = dynamic(['BU4']); // Message of dynamic ABAP programlet TranForABAPGen = _GetWatchlist(\"SAP - Transactions for ABAP Generations\"); // Transactions to exclude// Maintain if watchlist is not availablelet fixedTran = datatable(TransactionCode:string)['SE11','SE12', \"SE16\", \"SE16N\"];let UnitedTransactions =toscalar(union TranForABAPGen, fixedTran| summarize Transactions = make_set(TransactionCode));// Query logicSAPAuditLog| where MessageID in (AuditClasses)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| where TransactionCode !in (UnitedTransactions) // Exclude transactions| project TimeGenerated, Instance, User, SystemID, ClientID, Email, TerminalIPv6, Host, ABAPProgramName| extend AlertRuleUniqueName = 'dynamicabapprogram'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "6 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Command And Control",
                "Impact"
            ],
            "mitreAttackMultiple": "Discovery2\ue946Command And ControlImpact",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --"
        },
        {
            "searchKey": "68a03140-24bc-4985-8b77-ca5cc8aadeda",
            "displayName": "SAP - Dynamic Deterministic Audit Log Monitor",
            "description": "SAP Audit log events with message IDs preconfigured in Watchlist SAP_Dynamic_Audit_Log_Monitor_Configurationwill be shown here.See Sentinel4SAP Documentation for further information.",
            "version": "3.1.1",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// populate static selections for workspace level configuration// time span for audit eventslet AuditTimeAgo= 65m;let SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do//let SelectedSeverities =  dynamic([\"All Severities\"])let SelectedRuleTypes= dynamic([\"Deterministic\"]); // Rule only goes for deterministic alerting// users that are tagged with these tags in the SAP_User_Config WL will produce high severity incidents on all activitieslet SpecialFocusTags=dynamic([\"SoonToLeave\"]); // can also do dynamic([\"SoonToLeave\", \"Compromised\"])let AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSystems, SelectedSystemRoles, SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes));// get special users for exclusion and in-focus analysislet SAPUsersGottenVIP = (SAPUsersGetVIP(SpecialFocusTags= SpecialFocusTags)    | project-rename User = SAPUser);let SAPUserRolesAndProfiles = (SAPUsersAssignments    | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles    | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID    | where SystemID in ((AuditConfiguration        | summarize by SystemID)));let AuditEvents = (SAPAuditLog    | where TimeGenerated > ago(AuditTimeAgo)    | where SystemID in ((AuditConfiguration        | summarize by SystemID))    | where MessageID in ((AuditConfiguration        | summarize by MessageID))    // Alerts coming from SAP as \"Low\" aren't very intersting    | where AlertSeverityText != \"Low\"    // get the configuration from the \"SAPAuditLogConfiguration\" watchlist which allows    // assigning severity levels per system Role (Production/ non-production), automatic team assignments and other configuration options    // we'll fetch all severities to allow for alerting on \"Special Focus\" users regardless of severity    | lookup kind=inner AuditConfiguration on MessageID, SystemID);// QueryAuditEvents// get the user privleged status| lookup (SAPUsersGetPrivileged()| extend IsPrivilegedUser = true, ClientID= Client) on SystemID, User, ClientID| extend DetailedDescription = iff(IsPrivilegedUser, strcat('User ', User, ' is a privileged user! <br/>', DetailedDescription), DetailedDescription)| extend BagOfDetails = tostring(BagOfDetails)// handle threshold per system (configurable via the SAPAuditLogConfigurator watchlist)// calculate the timespan for analysis for thresholding| summarize    EventCount= count(),    Threshold = max(Threshold),    MinTime= min(TimeGenerated),    MaxTime = max(TimeGenerated)    by    AuditClassID,    AlertSeverityText,    SystemID,    Instance,    MonitoringObjectName,    MonitorShortName,    MessageText,    MessageClass,    MessageID,    AlertValue,    AlertSeverity,    ClientID,    User,    Variable1,    Variable2,    Variable3,    Variable4,    TerminalIPv6,    TransactionCode,    ABAPProgramName,    SAPProcesType,    SAPWPName,    Email,    SystemNumber,    Host,    Type,    CategoryName,    DestinationEmail,    DetailedDescription,    Tactics,    TeamsChannelID,    SystemRole,    SystemUsage,    IsProd,    Severity,    BagOfDetails,    IsPrivilegedUser,    RolesTagsToExclude| extend TimeGenerated = MaxTime| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText) - 1), MessageText)// To reduce false positives, exclude users whos tags in the SAP_User_Config watchlist// match tags in the RolesTagsToExclude column in the SAP_Dynamic_Audit_Log_Monitor_Configuration// tags can be either strings representing a group such as Batch; Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK// or SAP roles such as SAP_BC_TRANSPORT_ADMINISTRATOR, or SAP profiles like SAP_ALL| lookup SAPUsersGottenVIP on User| lookup SAPUserRolesAndProfiles on User, SystemID| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)| extend TagsIntersect = set_intersect(split(RolesTagsToExclude, \";\"), RolesProfilesAndTags)| extend IntersectionSize = array_length(TagsIntersect)// keep only non-excluded users that are not under \"Special Focus\"| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true| extend DetailedDescription = iff(SpecialFocusTagged, strcat('User ', User, ' is a specially tagged User with tags ', TagsList, '<br/>', DetailedDescription), DetailedDescription)// Special Focus users production alerts are considered as high| extend Severity = iff(SpecialFocusTagged, 'High', Severity)| where SelectedSeverities contains Severity//  apply the threshold criteria, consider that the watchlist describes hourly thresholds| extend MinutesSpan = datetime_diff('Minute', MaxTime, MinTime)| where EventCount > (Threshold * max_of(MinutesSpan, 10) / 60) or SpecialFocusTagged == true| extend DetailedDescription = iff(EventCount > 1, strcat(' Event occured ', EventCount, ' times within ', MinutesSpan + 1, ' minutes.<br/> ', 'The predefined threshold of ', Threshold, ' Events per hour was exceeded! <br/>', DetailedDescription), DetailedDescription)| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText) - 1), MessageText)| project-keep    AuditClassID,    AlertSeverityText,    SystemID,    Instance,    MessageText,    MessageClass,    MessageID,    AlertValue,    AlertSeverity,    ClientID,    User,    Variable1,    Variable2,    Variable3,    Variable4,    TerminalIPv6,    TransactionCode,    ABAPProgramName,    SAPProcesType,    SAPWPName,    Email,    SystemNumber,    Host,    CategoryName,    DestinationEmail,    DetailedDescription,    Tactics,    TeamsChannelID,    SystemRole,    SystemUsage,    IsProd,    Severity,    BagOfDetails,    IsPrivilegedUser,    EventCount,    Threshold,    TimeGenerated| extend AlertRuleUniqueName = 'dynamicdeterministicauditlogmonitor'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [],
            "mitreAttackMultiple": [],
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "TransactionCode",
                            "identifier": "ProcessId"
                        },
                        {
                            "columnName": "ABAPProgramName",
                            "identifier": "CommandLine"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPUsersAssignments --SAPAuditLog --SAPUsersGetVIP --SAPUsersGetPrivileged --SAPAuditLogConfiguration --"
        },
        {
            "searchKey": "57e99014-746b-4696-ae6a-447aecc9e800",
            "displayName": "SAP - Dynamic RFC Destination",
            "description": "Identifies execution of RFC using dynamic destinations. Source Action: Execute an ABAP report which is using dynamic destinations (cl_dynamic_destination). Sample report: DEMO_RFC_DYNAMIC_DEST. Data Sources: SAPcon - Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "// Define variableslet AuditClasses = dynamic(['FU1']); // Message of dynamic RFC execution using dynamic destination// Query logicSAPAuditLog| where MessageID in (AuditClasses)| parse Variable3 with \"id=\" Created_RFC_Name| project TimeGenerated,Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, ABAPProgramName, ExecutedProgram = Variable2, Created_RFC_Name| extend AlertRuleUniqueName = 'dynamicrfcdestination'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "6 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Collection",
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Collection1\ue946Exfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "d940bee2-46ff-4bb5-869a-1a54a967977d",
            "displayName": "SAP - Execution of Sensitive Function Module",
            "description": "Identifies execution of a sensitive ABAP Function Module.Source Action: Execute a sensitive function module directly using SE37.Recommended for Production onlySensitive functions should be maintained in \"SAP - Sensitive Function Modules\" Watchlist.Data Sources: SAPcon -  Table Data Log",
            "version": "3.1.6",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Execution of Sensitive Function Module// Actual lookback is set by setting AuditTimeAgolet AuditTimeAgo= 75m;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = materialize(SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole);let SenseModules =  _GetWatchlist('SAP - Sensitive Function Modules');let fixedModules = datatable(FunctionModule:string)['RSAU_CLEAR_AUDIT_LOG','BAPI_USER_CREATE', 'RFC_GET_TABLE_ENTRIES'];let UnitedModules = toscalar(union fixedModules, SenseModules| summarize FunctionModules =  make_set(trim(@\"\\s+\",FunctionModule),1024));// here you can exclude system users which are OK to execute a Sensitive function module// by adding those users in the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveFMOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['ExecuteSensitiveFMOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;SAPAuditLog    | where TimeGenerated > (AuditTimeAgo + 1h)// cover possible ingestion latency    | where MessageID == \"BU4\"    | where ABAPProgramName == \"RS_TESTFRAME_CALL\"    | where Variable3 endswith_cs \"FT\" // function test    | join kind= inner SelectedSystems on SystemID    | where UpdatedOn_t > ago(AuditTimeAgo)    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude    | extend Module= tostring(split(trim_end(\"FT\", Variable3),\"=\",0)[0])    | lookup kind=inner SenseModules on $left.Module == $right.FunctionModule // Module is sensitive    // can also allow users which are OK to run specific function modules, by specifying those in the 'SAP - Sensitive Function Modules' watchlist    | where parse_csv(column_ifexists(\"UsersExcluded\", \",\")) !has User    | distinct Instance ,SystemID, User, ClientID, Email, TerminalIPv6, Host, Module, MessageText, SystemRole, UpdatedOn_t    | extend PackedDetails= pack_all()    | extend AlertName= strcat('Sensitive Function Module ', Module, ' was executed by user ', User, ' in a ', tolower(SystemRole), ' system'), Dummy=' '    | extend AlertDescription= strcat(AlertName, \".\\n \", MessageText)    | extend AlertRuleUniqueName = 'executionofsensitivefunctionmodule'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Command And Control"
            ],
            "mitreAttackMultiple": "Discovery1\ue946Command And Control",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "e0e53cb9-d3f4-47c3-b953-ad62a8414f4f",
            "displayName": "SAP - Execution of a Sensitive ABAP Program",
            "description": "Identifies direct execution of a sensitive ABAP program.Source Action: Execute a program directly using SE38/SA38/SE80.Recommended for Production onlyABAP Programs should be maintained in watchlist \"SAP - Sensitive ABAP Programs\"Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Execution of a Sensitive ABAP Program// this alert rule requires the \"look back\" period to be greater than 2 days to include a full user master data load// the actual lookback period for the events is determined using the TimeAgo parameterlet TimeAgo= 60m;// determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// here you can exclude system users which are OK to execute a Sensitive ABAP Program// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveABAPProgramOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['SensitiveABAPProgramOK','SAPRole','SAPProfile']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Get Relevant ABAP Programs, along with users which are OK to execute them. if the 'SAP - Sensitive ABAP Programs' watchlist is missing the UsersExcluded column,// add the column manually, or force this watchlist to refresh using a fresh install of the solution, using thelet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs')| extend UsersExcluded= replace_string(column_ifexists(\"UsersExcluded\",\"\"), \" \",\"\")| extend UsersExcluded= parse_csv(UsersExcluded)| summarize UsersExcluded= make_set(UsersExcluded, 1000), Description=take_anyif(Description, isnotempty(Description)) by ABAPProgramName= SearchKey;let fixedABAPReports = datatable(ABAPProgramName:string, Description:string , UsersExcluded: dynamic)// Maintain these if WatchList is not available    [\"RSPFLDOC\", \"Profile Parameter Maintenance\", \"DummyUser\"];let UnionAbap =    union SensitiveABAPReports, fixedABAPReports    | summarize UsersExcluded= make_set(UsersExcluded, 1000), Description=any(Description)  by ABAPProgramName;// Query logicSAPAuditLog| where TimeGenerated > ago(TimeAgo + 1h)| where MessageID == 'AUW'| where ingestion_time() > ago(TimeAgo)| join kind= inner UnionAbap on ABAPProgramName| where UsersExcluded !has User| where SystemID in ((SelectedSystems | project SystemID))| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| order by TimeGenerated asc| project TimeGenerated, Instance , SystemID, ClientID, User, ABAPProgramName, MessageText, TransactionCode, MessageID, Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'executionofasensitiveabapprogram'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration",
                "Lateral Movement",
                "Execution"
            ],
            "mitreAttackMultiple": "Exfiltration2\ue946Lateral MovementExecution",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "797db008-0a53-4510-9883-b32673f9c3f5",
            "displayName": "SAP - Execution of a Sensitive Transaction Code",
            "description": "Identifies execution of a sensitive Transaction Code.Source Action: Execute a sensitive Transaction Code.Recommended for Production onlyTransaction Codes should be maintained in watchlist \"\"SAP - Sensitive Transaction Codes\"\"Data Sources: SAPcon -  Audit Log",
            "version": "3.1.1",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Execution of a Sensitive Transaction Code// Define Variables// the actual lookback period is 1h. The alert looks back further to allow for user master data to be built slowlylet TimeAgo= 75m;// let AuditClasses = dynamic(['AU3']); // Audit Log Classes - Transaction Startedlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;// Get Relevant Transaction Codeslet SensitiveTcode = _GetWatchlist('SAP - Sensitive Transactions') | summarize by TransactionCode;// here you can exclude system users which are OK to execute a Sensitive Transaction Code// by adding those users in the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['ExecuteSensitiveOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Query logicSAPAuditLog| where ingestion_time() > ago(TimeAgo)| where MessageID == 'AU3'| join kind=inner SelectedSystems on SystemID| where TransactionCode in (SensitiveTcode) or Variable1 in (SensitiveTcode)| extend TransactionCode = coalesce(Variable1, TransactionCode)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| order by TimeGenerated asc| project TimeGenerated,Instance ,SystemID, ClientID, User, TransactionCode, MessageText, MessageID, Email, TerminalIPv6, Host, TCODE=Variable1, SystemRole| extend AlertName= strcat(\"SAP - \", replace_string(MessageText, \".\",\"\"), \" by user \", User,\" in a \", tolower(SystemRole), \" system\")| extend AlertDescription= strcat(iff(TCODE in (SensitiveTcode), \"Sensitive transaction code \", \"Transaction code \"), TCODE,\" was started from \", iff(TransactionCode in (SensitiveTcode), \" the sensitive context of \", \" from the context of \"),TransactionCode, \". Sensitive transactions are being maintained in the 'SAP - Sensitive Transactions' watchlist.\")| extend Dummy= \"\"| extend AlertRuleUniqueName = 'executionofasensitivetransactioncode'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Execution"
            ],
            "mitreAttackMultiple": "Discovery1\ue946Execution",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "45e784d5-0414-4029-8fc6-5f6722abdb5c",
            "displayName": "SAP - Execution of an Obsolete or an Insecure Function Module",
            "description": "Identifies execution of an obsolete/insecure ABAP Function Module.Source Action: Execute an obsolete/insecure function module directly using SE37, calling it using an RFC callback, JSON or SON RPC calls.Recommended for Production onlyObsolete functions should be maintained in \"SAP - Obsolete Function Modules\" Watchlist.",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Execution of Obsolete or Insecure Function Module// AUK - Successful RFC call &C (function group = A) (C)// AUL - Failed RFC call &C (function group = &A)  (C)// DUI - RFC callback executed (destination &A, called &B, callback &C) (B)// DUJ - RFC callback rejected (destination &A, called &B, callback &C) (B)// DUK - RFC callback rejected (destination &A, called &B, callback &C) (B)// DUR - JSON RPC call of function module &A succeeded  (A)// DUS - SON RPC call of function module &A failed  (A)// DUT - Critical JSON RPC call of function module &A (S_RFC * authorization) (A)// EUE - RFC function module &A called successfully (A)// EUF - Could not call RFC function module &A  (A)// EUG - User does not have authorization to run RFC function module &A (A)// FU1 - FC function &B with dynamic destination &C was called in program &A (B)// BU4 - Dynamic ABAP code: Event &A, event type &B, check total &Clet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey;// here you can exclude system users which are OK to run obolete/ sensitive function modules// by adding those users in the SAP_User_Config watchlist with a tag of 'RunObsoleteFMOK'let excludeUsersTags= dynamic(['RunObsoleteFMOK']);let excludedUsers= _GetWatchlist('SAP_User_Config')    | where Tags has_any (excludeUsersTags)    | summarize by User2Exclude=SAPUser;let AuditClassesA= dynamic(['DUR', 'DUS', 'DUT', 'EUE', 'EUF', 'EUG']);let AuditClassesB= dynamic(['DUI', 'DUJ', 'DUK', 'FU1']);let AuditClassesC= dynamic(['AUK', 'AUL','BU4']);let ObsoleteModules =  _GetWatchlist('SAP - Obsolete Function Modules');// Maintain if watchlist is not availablelet fixedModules = datatable(FunctionModule: string)['TH_SAPREL', 'TH_SAPREL2', 'TH_SAPREL3', 'SUSR_RFC_USER_INTERFACE', 'RFC_ABAP_INSTALL_AND_RUN'];let UnitedModules =    toscalar(union fixedModules, ObsoleteModules    | summarize FunctionModules =  make_set(FunctionModule));// Query logiclet FunctionRuns =    SAPAuditLog    | where MessageID in (array_concat(AuditClassesA, AuditClassesB, AuditClassesC))    | join kind= inner SelectedSystems on SystemID    | extend Module = case(MessageID in (AuditClassesA), Variable1, MessageID in (AuditClassesB), Variable2, MessageID in (AuditClassesC), Variable3, 'Could Not find function module')    | extend Module= tostring(split(Module,\"==\",0)[0])    | where Module in (UnitedModules);FunctionRuns| project    TimeGenerated,    SystemID,    ClientID,    User,    Email= iff(isempty(Email), User, Email),    TerminalIPv6,    Host= iff(isempty(Host), TerminalIPv6, Host),    Module,    MessageText| extend UserName= User| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| extend PackedDetails= pack_all()| extend    AlertName= strcat('Obsolete Function Module ', Module, ' was executed by user ', UserName),    Dummy=' '| extend AlertDescription= strcat(AlertName, \".\\n \", MessageText)| extend AlertRuleUniqueName = 'executionofanobsoleteoraninsecurefunctionmodule'",
            "ruleFrequency": "2 hours",
            "rulePeriod": "2 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Command And Control"
            ],
            "mitreAttackMultiple": "Discovery1\ue946Command And Control",
            "techniques": [
                "T1018",
                "T1007",
                "T1426",
                "T1219",
                "T1437",
                "T1637",
                "T1481",
                "T0869"
            ],
            "techniquesMultiple": "T10187\ue946T1007T1426T1219T1437T1637T1481T0869",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "Module",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPSystems --"
        },
        {
            "searchKey": "bd39a2f0-2eaa-41e6-a071-70c42e42dd21",
            "displayName": "SAP - FTP for non authorized servers",
            "description": "Identifies FTP connection for non authorized server.Maintain new Watchlist, similar to SAPFTP_SERVERSSource Action: Create a new FTP connection e.g. by using Function Module FTP_CONNECT.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define variableslet AuditClasses = dynamic(['DU8']); // Message of Successfull FTP Connectionlet FTPSafeConnections = _GetWatchlist(\"SAP - FTP Servers\");let fixedConnections = datatable(Client: string, Description: string,FTP_Server_Name: string, FTP_Server_Port: string)    // Maintain these if WatchList is not available    [100, \"description\", \"http://ourorgftpserver.com/\", 22];let UnitedConnections = toscalar(union kind=outer isfuzzy=true FTPSafeConnections, fixedConnections | summarize Connections = make_set(FTP_Server_Name));// Query logicSAPAuditLog| where MessageID in (AuditClasses)| extend TerminalIPv6 = Variable1| where TerminalIPv6 !in (UnitedConnections) // The IP is unknown| project TimeGenerated, Instance ,User, SystemID, ClientID, Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'ftpfornonauthorizedservers'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "6 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Initial Access",
                "Command And Control"
            ],
            "mitreAttackMultiple": "Discovery2\ue946Initial AccessCommand And Control",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "7e6cb00d-d7cb-4411-837f-6e62c2fab6e7",
            "displayName": "SAP - Function module tested",
            "description": "Identifies testing of a function module.Source Action: Test a function module using  SE37 / SE80.Recommended for Production onlyData Sources: SAPcon -  Audit Log",
            "version": "3.1.6",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Function module tested// !!!IMPORTANT!!!// Please keep \"Lookup data from the last\" to be 2 days to allow reading of user authorization data// Actual lookback is set by setting AuditTimeAgolet AuditTimeAgo= 75m;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole;// here you can exclude system users which are OK to test function modules// by adding those users in the SAP_User_Config watchlist with a tag of 'TestFMOK'let excludeUsersTags= dynamic(['TestFMOK']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Query logiclet FunctionRuns = SAPAuditLog    | where TimeGenerated > (AuditTimeAgo + 1h)// cover possible ingestion latency    | where MessageID == \"BU4\"    | where ABAPProgramName == \"RS_TESTFRAME_CALL\"    | where Variable3 endswith_cs \"FT\" // function test    | join kind= inner SelectedSystems on SystemID    | where UpdatedOn_t > ago(AuditTimeAgo)    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude    | extend Module= tostring(split(trim_end(\"FT\", Variable3),\"=\",0)[0]);FunctionRuns| project    UpdatedOn_t,    TransactionCode,    SystemID,    ClientID,    User,    Instance,    Email= iff(isempty(Email), User, Email),    TerminalIPv6,    Host= iff(isempty(Host), TerminalIPv6, Host),    Module,    MessageText,    SystemRole| extend UserName= User| extend PackedDetails= pack_all()| extend    AlertName= strcat('Function Module ', Module, ' was tested by user ', UserName, ' in a ', tolower(SystemRole), ' system'),    Dummy=' '| extend AlertDescription= strcat(AlertName, \".\\n \", MessageText)| extend AlertRuleUniqueName = 'functionmoduletested'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Collection",
                "Defense Evasion",
                "Lateral Movement"
            ],
            "mitreAttackMultiple": "Collection2\ue946Defense EvasionLateral Movement",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "a4dee43c-f06e-4f6f-8735-db6dec4c5aa3",
            "displayName": "SAP - High volume of potentially sensitive data exported",
            "description": "High volume of data exported via files in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.",
            "version": "3.2.0",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - High volume of potentially sensitive data exported// high volume of file downloads by users who were obsereved accessing sensitive data// or sensitive programs/ transactions// !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required// actual lookback is set by setting TimeAgolet TimeAgo= 4h;let TimeBetweenAccessAndDownload= 1h;let ByteCountThreshold= 800000; //  Threshold in Bytes for entire lookback period// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])// let SelectedSystemRoles= dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;// Get sensitive Tables// CONFIGURATION OPTION- list sensitive tables in the 'SAP - Sensitive Tables' watchlistlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables') | summarize by Table;let TableAccessTcodes= dynamic([\"SE16\", \"SE16N\", \"SE11\", \"SE16H\", \"SM30\", \"SE12\", \"SM31\", \"SE16H\", \"SE14\", \"SE54\",\"SE17\", \"SE16T\", \"DB01\", \"DB02\"]);// CONFIGURATION OPTION- list sensitive transactions in the 'SAP - Sensitive Transactions' watchlistlet SensitiveTransWL= toscalar(_GetWatchlist('SAP - Sensitive Transactions') | summarize TransactionCodes= make_set(TransactionCode));// CONFIGURATION OPTION- exclude TCODEs which are not to be consideredlet ExcludedTcodes= dynamic([\"S000\", \"\"]);let SensitiveTcodes= (set_difference(set_union(SensitiveTransWL, TableAccessTcodes), ExcludedTcodes));// CONFIGURATION OPTION- list sensitive programs in the 'SAP - Sensitive ABAP Programs' watchlistlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');let fixedABAPReports = datatable(ABAPProgram:string) [\"RSPFLDOC\"];let UnionABAP = union isfuzzy=true SensitiveABAPReports, fixedABAPReports| summarize by ABAPProgram;// CONFIGURATION OPTION- exclude system users which are OK to download massive amounts of sensitive data// by adding those users in the SAP_User_Config watchlist with a tag of 'MassiveDownloadsOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['MassiveDownloadsOK','SAP_ROLE1', 'SAP_PROFILE1']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Get direct sensitive table accesslet SensitiveTableAccess= SAPAuditLog    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"DU9\" or MessageID == \"CUZ\"    | where SystemID in (SelectedSystems)    | where Variable1 in (SensitiveTables)    | project-rename Table = Variable1, Activity = Variable2    | summarize Activities= make_set(Activity, 3) by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName    , Table, TransactionCode, TableOrProgram= Table    | lookup (_GetWatchlist('SAP - Sensitive Tables')| project Table, Description) on Table    | extend SourceAction= strcat(\"after visiting transaction \", TransactionCode, \" and viewing sensitive table \", Table, \" (\", Description, \")\");// get sensitive program executionlet SensitiveProgramExec= SAPAuditLog    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"AUW\"    | where SystemID in (SelectedSystems)    | where ABAPProgramName in (UnionABAP)    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, TransactionCode, TableOrProgram= ABAPProgramName    | lookup (_GetWatchlist('SAP - Sensitive ABAP Programs') | project ABAPProgramName= ABAPProgram, Description) on ABAPProgramName    | extend  SourceAction= strcat(\"after executing sensitive program \", ABAPProgramName, \" (\", Description, \")\");// get sensitive transaction executionlet SensitiveTcodeExec= SAPAuditLog    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"AU3\" or MessageID == \"AU4\"    | where SystemID in (SelectedSystems)    // make sure sensitive transactions do not contain the TableAccessTcodes which are checked for the specific table name    | where TransactionCode in (set_difference(SensitiveTcodes,TableAccessTcodes)) or Variable1 in (set_difference(SensitiveTcodes,TableAccessTcodes))    | extend TransactionCode= iff(TransactionCode in (set_difference(SensitiveTcodes,TableAccessTcodes)), TransactionCode, Variable1)    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, TransactionCode, TableOrProgram= TransactionCode    | lookup (_GetWatchlist('SAP - Sensitive Transactions')| project TransactionCode, Description) on TransactionCode    | extend SourceAction= strcat(\"after executing sensitive transaction \", TransactionCode, \" (\", Description, \")\");// Get all downloadslet FileDownloads= SAPAuditLog    | where MessageID == \"AUY\"    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)    | where SystemID in (SelectedSystems)    | where TransactionCode in (SensitiveTcodes) or ABAPProgramName in (UnionABAP)    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude // exclude specific users    | extend ByteCount= toint(replace_string(replace_string(Variable1, \".\",\"\"), \",\",\"\")), Code=Variable2, Path= Variable3    | summarize DownloadsByUser = count(), Paths= make_set(Variable3, 10), ByteCount=sum(ByteCount) by TimeDownloaded= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, TerminalIPv6, Email, Host, TransactionCode, Instance;// Time window join to find dowloads after table accessFileDownloads | join kind=inner (SensitiveTableAccess | union SensitiveProgramExec, SensitiveTcodeExec) on User, SystemID    | where (TimeAccessed- TimeDownloaded) between (-(TimeBetweenAccessAndDownload*2) .. 0h)    | summarize Activities= tostring( make_set_if(Activities, tostring(Activities) != \"\")), DownloadsByUser= max(DownloadsByUser), ByteCount=max(ByteCount), TablesOrPrograms=make_set(TableOrProgram,10), SourceActions= make_set(SourceAction,10), TimeAccessed= any(TimeAccessed) by TimeDownloaded, User, SystemID, ClientID, Email, Host , TerminalIPv6, Paths= tostring(Paths), Instance    | where ByteCount > ByteCountThreshold    | extend PackedDetails= pack_all()    | extend Details= strcat(\"User \", User, \" has downloaded \", ByteCount, \" bytes of potentially sensitive data \")    | extend AlertDetails= strcat(Details , tostring(SourceActions)), Dummy= ''| extend AlertRuleUniqueName = 'highvolumeofpotentiallysensitivedataexported'",
            "ruleFrequency": "4 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Exfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "TablesOrPrograms",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "78fbdc7d-6136-4afc-9cc5-5e5aff1563ae",
            "displayName": "SAP - Insecure FTP servers configuration",
            "description": " Identifies Insecure FTP servers configuration - FTP Whitelist is empty / Contains Placeholders.Source Action: Do not maintain / maintain values which contains placeholders in table SAPFTP_SERVERS using maintenance view SAPFTP_SERVERS_V. (SM30)Data Sources: SAPcon -  Audit Log",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define variableslet AuditClasses = dynamic(['DU1', 'DU2']); // Messages of FTP Whitelist is empty / Contains Placeholders// Query logicSAPAuditLog| where MessageID in (AuditClasses)| project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, Reason = MessageText| extend AlertRuleUniqueName = 'insecureftpserversconfiguration'",
            "ruleFrequency": "6 hours",
            "rulePeriod": "6 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access",
                "Command And Control"
            ],
            "mitreAttackMultiple": "Initial Access1\ue946Command And Control",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "7f364fac-c6a9-4935-a73b-ba215acace31",
            "displayName": "SAP - Lifecycle - SAP Notes were implemented in system",
            "description": "Identifies SAP Notes implementation in the system.Source Action: Implement SAP Note using SNOTE/TCI.Data Sources: SAPcon -  Change Requests",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Informational",
            "query": "// Define variableslet VarNote = \"NOTE\";let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user// Query logiclet LastLogin =SAPAuditLog| where MessageID in (AuditLogIn)| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User; // Get last connection date for userSAPCRLog| where ObjectType == VarNote // Type is NOTE| lookup kind=inner LastLogin on $left.Owner == $right.User // Get last login details| summarize by TimeGenerated, Instance, SystemID, SystemNumber, ClientID, Owner, Request, Description, ObjectName, Category, Status, Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'lifecycle-sapnoteswereimplementedinsystem'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [],
            "mitreAttackMultiple": [],
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPCRLog --"
        },
        {
            "searchKey": "978e1cc8-f891-41c7-83b8-b21762a2ebb7",
            "displayName": "SAP - Login from unexpected network",
            "description": "Identifies logons from an unexpected network.Source Action: Logon to the backend system from an IP address which is not assigned to one of the networks.Networks can be maintained in the \"SAP - Networks\" watchlist .Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let SelectedSystemRoles = dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles);let AuditClasses = dynamic(['AU1','AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Calllet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);let Networks = _GetWatchlist('SAP - Networks');// here you can exclude system users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of \"LoginUnExpectedOK\"let excludeUsersTags= dynamic([\"LoginUnExpectedOK\"]);// dynamic([\"LoginUnExpectedOK\",\"SAP_ALL\"]);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;SAPAuditLog// Add audit classes| join kind= inner SelectedSystems on SystemID| where MessageID in (AuditClasses)| where Variable1 in (DialogLogonTypes) // Is a dialog logon type from the list| where isnotempty(TerminalIPv6) // There is a Ipv6 address// if you wish to allow all private adreesses| where not (ipv4_is_private(TerminalIPv6 ))| evaluate ipv4_lookup(Networks, TerminalIPv6, Network, return_unmatched = true)// Similar to regular lookup, by ipv4 address, unmatched is like left join| where isempty(Network) // Network is not familiar| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude// Details| project TimeGenerated, SystemID, ClientID, User, TransactionCode, MessageText, Email , TerminalIPv6, Host| extend GeoLocation= iff(ipv4_is_private( TerminalIPv6), dynamic({\"IsPrivate\": true}), geo_info_from_ip_address(TerminalIPv6))| extend AlertRuleUniqueName = 'loginfromunexpectednetwork'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access"
            ],
            "mitreAttackMultiple": "Initial Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "b0594a30-5da4-4eca-89af-cb8ad111d697",
            "displayName": "SAP - Missing configuration in the Dynamic Security Audit Log Monitor",
            "description": "An SAP audit log event has occurred bearing a message ID which was not maintained in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist.The SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist allows for dynamically alerting on SAP audit log events.Recommended solution - go to the SAP_Dynamic_Audit_Log_Monitor_Configuration and add the missing SAP audit log message ID.  Specify a severity level of medium or high to have this message ID covered by the alerts based on rule \"Dynamic Security Audit Log Monitor\".",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Informational",
            "query": "let MissingMessagesinSystems = SAPAuditLog| where MessageID <> \"RZ 792\"| summarize LastSeenMessageOn = arg_max(TimeGenerated, MessageID) by MessageID, SystemID, ClientID| join kind = leftanti (SAPAuditLogConfiguration(SelectedSeverities =  dynamic([\"All Severities\"])) | summarize by MessageID) on MessageID| project-keep LastSeenMessageOn, MessageID, SystemID, ClientID| project-rename MissingMessageID = MessageID, ComingFromSystemID = SystemID| extend Dummy = 1;let MissingSummary = MissingMessagesinSystems| summarize  ComingFromSystemIDs =  make_set(ComingFromSystemID), MissingMessageIDs = make_set(MissingMessageID)| extend ComingFromSystemIDs = iff(array_length(ComingFromSystemIDs) > 1, strcat('Systems ', strcat_array(ComingFromSystemIDs,\", \")), strcat('System ',strcat_array(ComingFromSystemIDs,\", \")))| extend MissingMessageIDs = iff(array_length(MissingMessageIDs) > 1, strcat('Message IDs ', strcat_array(MissingMessageIDs,\", \"), \" have occured in \"), strcat('Message ID ',strcat_array(MissingMessageIDs,\", \"), \" has occured in \"))| extend Dummy = 1;MissingMessagesinSystems | join kind= inner MissingSummary on Dummy| project-away Dummy, Dummy1| extend AlertRuleUniqueName = 'missingconfigurationinthedynamicsecurityauditlogmonitor'",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [],
            "mitreAttackMultiple": [],
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "ComingFromSystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPAuditLogConfiguration --"
        },
        {
            "searchKey": "4285d707-f969-4a8c-801f-e9c6a328d884",
            "displayName": "SAP - Multiple Files Download",
            "description": "Identifies multiple files downloads for a user within a specific timerange.Source Action: Download multiple files while using SAPGui to Excel/Lists etc.Data Sources: SAPcon -  Audit Log",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define variableslet NumberOfDownloads = 10; // Number of downloads of user as thresholdlet HoursBucket = 2h; // How much time between bucketslet AuditClasses = dynamic([\"AUY\"]); // Relevant message// Query logicSAPAuditLog // Get all downloads| where MessageID in (AuditClasses)| summarize DownloadsByUser = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, TerminalIPv6, Email, Host| where DownloadsByUser >= NumberOfDownloads // User downloaded more than threshold| project SystemID, ClientID, User, Email, TerminalIPv6, Host,DownloadsByUser| extend AlertRuleUniqueName = 'multiplefilesdownload'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "12 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Collection",
                "Exfiltration",
                "Credential Access"
            ],
            "mitreAttackMultiple": "Collection2\ue946ExfiltrationCredential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "e5a176ef-dd12-47a3-a5ef-1900997f1b17",
            "displayName": "SAP - Multiple Logons by IP",
            "description": "Identifies logon of several users from same IP within scheduled time interval.Source Action: Logon using several users thorugh the same IP.Networks can be excluded from this alert by specifying ranges in the 'SAP - Excluded Networks' watchlist.This rule alerts on \"empty\" IP addresses as well- Add an entry with serachkey= 000.00.000.0 and Description= EmptyIPAddressesShouldBeExcluded in the 'SAP - Excluded Networks' watchlist to avoid alerting on empty IP addressesData Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Medium - Multiple Logons by IP// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet TimeAgo= 75m;let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// here you can exclude system users which are OK to share IP addresses// by adding those users in the SAP_User_Config watchlist with a tag of 'MultipleLogonsOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['MultipleLogonsOK', 'SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by User2Exclude=SAPUser;// CONFIG OPTION - include users by types ([\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"])let UsersTypeToInclude= dynamic([\"A\"]);// Dialog Only// CONFIG OPTION - exclude users by user classeslet UserClassesToExclude= dynamic([\"RFC\", \"BATCH\"]);let UserInFocus= (SAP_USR02| where CLASS !in (UserClassesToExclude)// | where USTYP in (UsersTypeToInclude)| summarize arg_max(TimeGenerated, *) by GLTGB, SystemID, User=BNAME, ClientID= MANDT, UserType=USTYP| summarize arg_max(GLTGB, CLASS) by SystemID, User, ClientID, UserType);let AuditClasses = dynamic(['AU1', 'AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successfullet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']); // Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Calllet excNetworks = materialize(_GetWatchlist('SAP - Excluded Networks')); // Networks that should be removed from query// add an entry with serachkey= 000.00.000.0 and Description= EmptyIPAddressesShouldBeExcluded in the 'SAP - Excluded Networks' watchlist// to avoid alerting on empty IP addresseslet EmptyIPAddressesShouldBeExcluded = toscalar(excNetworks    | where Description == 'EmptyIPAddressesShouldBeExcluded'    | summarize Count =count()    | project IfEmptyIPAddressesShouldBeExcluded = iff(Count > 0, true, false));let fixedNetworks =    datatable(Network: string) [    \"255.68.255.0/32\", \"\"];let UnitedNetworks = union excNetworks, fixedNetworks    | summarize by Network    | where isnotempty(Network)    | extend DummyJoinField= 1;let UsersPerIP = 1;// Query logicSAPAuditLog| where TimeGenerated > ago(TimeAgo + 1h)| where ingestion_time() > ago(TimeAgo)| where SystemID in (SelectedSystems)// rule only cares for audit records with IP addresses| where isnotempty(TerminalIPv6) or EmptyIPAddressesShouldBeExcluded == false// exclude users by type/ class| join kind= inner UserInFocus on SystemID, ClientID, User//comment the next line if private IP addresses are relevant| where not (ipv4_is_private(TerminalIPv6 ))| where MessageID in (AuditClasses)| where Variable1 in (DialogLogonTypes)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| extend DummyJoinField= 1| join kind= inner UnitedNetworks on DummyJoinField// check if IP is in one of the ranges of the watchlist| extend IPIsInRange= ipv4_is_in_range(TerminalIPv6, Network)| extend UserandEmail = pack(\"ID\", User, \"Email\", Email)// count cases in which an IP address shows in any of the ranges in the watchlist| summarize CountUsers = dcount(strcat(User, \"_&_\", Email)), Users = make_set(UserandEmail), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)    , IPIsInRange= countif(IPIsInRange)    by SystemID, ClientID, TerminalIPv6// filter out matches of IPs and excluded networks| where IPIsInRange == 0| where CountUsers > UsersPerIP| mv-expand Users| evaluate bag_unpack(Users, \"User_\")| project SystemID, ClientID, TerminalIPv6, StartTime, EndTime,    User = column_ifexists(\"User_ID\", \"\"),    Email = column_ifexists(\"User_Email\", \"\")| extend Email= iff(isempty(Email), User, Email)| lookup UserInFocus on User, SystemID, ClientID| extend AlertRuleUniqueName = 'multiplelogonsbyip'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access"
            ],
            "mitreAttackMultiple": "Initial Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --SAP_USR02 --"
        },
        {
            "searchKey": "c01c6b88-6323-4a71-b981-4bc0ddca88bf",
            "displayName": "SAP - Multiple Password Changes",
            "description": "Identifies multiple password changes at different levels:Users across systemsPer user performing the password changePer user who's password is being changedSource Action: Change user password",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "// Multiple Password Changes by User// !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle (2 days)// this is critical so we can infer the changed user AD account ID// actual lookback period is maintained by the TimeAgo parameterlet TimeAgo= 3h;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | project SystemID= SearchKey;// here you can exclude system users which are OK to perform multiple password changes// by adding those users in the SAP_User_Config watchlist with a tag of 'UpdateMultiPassOK'let excludeUsersTags= dynamic(['UpdateMultiPassOK']);let excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;let PasswordChanges = materialize(SAPAuditLog| where TimeGenerated > ago(1d + TimeAgo)| where ingestion_time() > ago(TimeAgo)| where MessageID == \"BU2\" // Audit Log Classes - Password Changed| join kind= inner  SelectedSystems on SystemID| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| extend UserReset= Variable2| extend Email= iff(isempty(Email), User, Email)| extend Host= iff(isempty(Host), TerminalIPv6, Host)| summarize Count= dcount(UpdatedOn_t), Email =any(Email), Host=any(Host), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)  by User, UserReset, TerminalIPv6, ClientID, SystemID) ;let PerUserSysClient = 3; // Systems & Clients per Userlet TPerUserSysClient= PasswordChanges| extend DetailsBy = pack(\"SystemID\", SystemID, \"ClientID\", ClientID, 'UserChanging', User, 'Email', Email)| summarize CountPerUserSysClient = dcount(strcat(SystemID, ClientID)), User= any(User), StartTime = min(StartTime), EndTime = max(EndTime), Details = make_set(DetailsBy, 10)by UserReset| where  CountPerUserSysClient>= PerUserSysClient| where isnotempty(UserReset)| extend AlertDescription= strcat('User\\'s ',UserReset, ' password was reset across ', CountPerUserSysClient, ' systems '), Source= 'PerUserSysClient';let PerUserChanged = 3;  // password changes across all systems and scenarioslet TPerUserChanged = PasswordChanges| extend DetailsBy = pack(\"SystemID\", SystemID, \"ClientID\", ClientID, 'UserChanging', User, 'Email', Email)| summarize TerminalIPv6= take_any(TerminalIPv6), CountPerUserChanged = sum(Count), User= any(User), StartTime = min(StartTime), EndTime = max(EndTime) , Details = make_set(DetailsBy, 10)by UserReset| where  CountPerUserChanged >= PerUserChanged| extend AlertDescription= strcat('User\\'s ',UserReset, ' password was reset ', CountPerUserChanged, ' times', ' by user ', User), Source= 'PerUserChanged';let PerUserChanging = 3; // user changing across all systemslet TPerUserChanging = PasswordChanges| extend DetailsBy = pack(\"SystemID\", SystemID, \"ClientID\", ClientID, 'UserReset', UserReset)| summarize CountPerUserChanging = sum(Count), StartTime = min(StartTime), EndTime = max(EndTime), Details = make_set(DetailsBy, 10), ResetUsers= make_set(UserReset, 10), Email= anyif(Email, isnotempty(Email)), TerminalIPv6= anyif(TerminalIPv6, isnotempty(TerminalIPv6))by User| where  CountPerUserChanging >= PerUserChanging| extend AlertDescription= strcat('User ',User, ' has changed passwords ', CountPerUserChanging, ' times to user ', tostring(ResetUsers)), Source= 'PerUserChanging'; TPerUserSysClient | union TPerUserChanged, TPerUserChanging| extend Dummy=' ', PackedDetails= tostring(pack_all())| mv-expand Details| evaluate bag_unpack(Details, \"Details_\") // Unpack the details to a couple of fields| project    StartTime, EndTime, User, TerminalIPv6, AlertDescription    , Count= CountPerUserSysClient + CountPerUserChanged + CountPerUserChanging, PackedDetails,    SystemID = column_ifexists(\"Details_SystemID\", \"\"),    ClientID = column_ifexists(\"Details_ClientID\", \"\"),    UserReset= strcat(column_ifexists(\"Details_UserReset\", \"\"), column_ifexists(\"UserReset\", \"\") ),    Email= coalesce(column_ifexists(\"Details_Email\", \"\"), column_ifexists(\"Email\", \"\") ),    Source | join kind= leftouter  (SAPUsersHeader | project SystemID, ClientID=Client, UserReset= User, EmailReset= Email) on UserReset, SystemID, ClientID | extend EmailReset= coalesce(EmailReset, UserReset), Dummy= '' | project-away *1 // cleanup before take any // to prevent same action being surfaced by multiple scenario, we take any action per actors and resources: | summarize AlertDescriptions=make_set(AlertDescription, 12), EventCount=count(), take_any(*) by User, UserReset, SystemID, ClientID, TerminalIPv6",
            "ruleFrequency": "3 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access"
            ],
            "mitreAttackMultiple": "Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "EmailReset",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersHeader --SAPSystems --"
        },
        {
            "searchKey": "dfbcb26d-7b53-41f8-9647-1e158722a80e",
            "displayName": "SAP - Multiple Spool Executions",
            "description": "Identifies multiple spools for a user within a specific timerange.Source Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)Data Sources: SAPcon -  Spool Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define variableslet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with userlet NumberOfRequests = 3; // Number of requests as thresholdlet HoursBucket = 2h; // // How much time between buckets// Query logiclet LastLogin =SAPAuditLog| where MessageID in (AuditLogIn)| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for userSAPSpoolLog // Get all spool requests| summarize UserRequests = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance| where UserRequests >= NumberOfRequests // User requested to print more than threshold| lookup kind=inner LastLogin on User // Check IP of last login| project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, UserRequests| extend AlertRuleUniqueName = 'multiplespoolexecutions'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "12 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access",
                "Collection",
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Credential Access2\ue946CollectionExfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPSpoolLog --"
        },
        {
            "searchKey": "c123a8d7-f72f-4ba0-8b06-ba5e12043432",
            "displayName": "SAP - Multiple Spool Output Executions",
            "description": "Identifies multiple spools for a user within a specific timerange.Source Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)Data Sources: SAPcon -  Spool Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define variableslet AuditLogIn = dynamic(['AU1', 'AU5']); // Messeges of connect with userlet NumberOfPrints = 3; // Number of prints as thresholdlet HoursBucket = 2h; // // How much time between buckets// Query logiclet LastLogin =SAPAuditLog| where MessageID in (AuditLogIn)| summarize arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for userSAPSpoolOutputLog // Get all spool outputs| summarize UserPrints = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance| where UserPrints >= NumberOfPrints // User requested to print more than threshold| lookup kind=inner LastLogin on User // Get IP of last login| project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6,  Host, UserPrints| extend AlertRuleUniqueName = 'multiplespooloutputexecutions'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "12 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access",
                "Collection",
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Credential Access2\ue946CollectionExfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPSpoolOutputLog --"
        },
        {
            "searchKey": "0079fee8-1ebf-4721-92c2-ac1861a79626",
            "displayName": "SAP - Multiple Subnets by User",
            "description": "Identifies logon of the same user from several subnets within scheduled time interval.Multiple configuration options available within the query.Source Action: Logon using the same user thorugh different IP's.Data Sources: SAPcon -  Audit Log",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Multiple Subnets by User (previously named as SAP - Multiple Logons by User)// !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required// actual lookback is set by setting TimeAgo// Define variables// CONFIG OPTION time ago is same as lookbacklet TimeAgo= 1h;// CONFIG OPTION Mask is a number between 0 and 32 representing sensitivity to network changes// Mask= 32 means '192.168.1.255' and '192.168.1.254' are different addresses.// Mask= 24 means '255.255.255.0' and '255.255.255.255' are considered as same address.let Mask= 24;let AuditClasses = dynamic(['AU1', 'AU5']); // Logon successful, RFC/CPIC logon successful// CONFIG OPTION - include users by types ([\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"])let UsersTypeToInclude= dynamic([\"A\"]);// Dialog Only// CONFIG OPTION - exclude users by user classeslet UserClassesToExclude= dynamic([\"SYSTEM\"]);let UserInFocus= (SAP_USR02| where CLASS !in (UserClassesToExclude)| where USTYP in (UsersTypeToInclude)| summarize arg_max(TimeGenerated, *) by GLTGB, SystemID, User=BNAME, ClientID= MANDT, UserType=USTYP| summarize arg_max(GLTGB, *) by SystemID, User, ClientID, UserType);// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Calllet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);let excUsers = _GetWatchlist('SAP - Excluded Users'); // Users that should be removed from querylet fixedExcUsers = datatable(User: string) [\"SYSWF\"];// CONFIG OPTION- exclude user by SAP roles, profiles or tags// here you can exclude system users which are OK to logon from multiple IPs// by adding those users in the SAP_User_Config watchlist with a tag of 'MultipleIPsOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['MultipleIPsOK', \"SAPRole1\", \"SAPProfile1\"]);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let UnitedExcUsers =    toscalar(union excUsers, fixedExcUsers    | summarize Users = make_set(User));// CONFIG OPTION- set the threshold of the number of unique IP addresses per userlet IPThreshold = 1;// CONFIG OPTION- exclude networks (or ranges) using the watchlistlet ExcNetworks = toscalar(_GetWatchlist('SAP - Excluded Networks') // Networks that should be removed from query| where isnotempty(Network)| summarize make_set(Network));// CONFIG OPTION- exclude blank IP addresses// add an entry with serachkey= 000.00.000.0 and Description= EmptyIPAddressesShouldBeExcluded in the 'SAP - Excluded Networks' watchlist// to avoid alerting on empty IP addresseslet EmptyIPAddressesShouldBeExcluded = toscalar(_GetWatchlist('SAP - Excluded Networks')| where Description == 'EmptyIPAddressesShouldBeExcluded' and SearchKey == \"000.00.000.0\" | take 1| project IfEmptyIPAddressesShouldBeExcluded = true);// Query Logiclet LogOns= materialize(SAPAuditLog| where TimeGenerated > ago(1d)// actual lookback is set by setting TimeAgo| where ingestion_time() > ago(TimeAgo)| where MessageID in (AuditClasses)| where isnotempty(TerminalIPv6) or  EmptyIPAddressesShouldBeExcluded != true| where ipv4_is_in_any_range(TerminalIPv6, ExcNetworks) == false| where Variable1 in (DialogLogonTypes)| where User !in (UnitedExcUsers)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| join kind= inner UserInFocus on SystemID, ClientID, User| summarize LogonCount= count(), StartTime = min(TimeGenerated), UserType= any(UserType)    ,EndTime = max(TimeGenerated), Email= any(Email), Instance= any(Instance), Host= any(Host) by SystemID, ClientID, User, TerminalIPv6) ;// aggregate the number of subnets (not IP addresses) by userlet UsersWithTooManySubnets= LogOns| extend MaskedIP= format_ipv4_mask(TerminalIPv6, Mask)| summarize CountSubnets= dcount(MaskedIP) by User| where CountSubnets > IPThreshold;UsersWithTooManySubnets | join kind = inner LogOns on User| project SystemID, ClientID, User, StartTime, EndTime, Email, TerminalIPv6, Instance, LogonCount, Host, CountSubnets, UserType| extend PackedDetails= pack_all()| extend AlertName= strcat('SAP - User ',User, ' has logged on from ', CountSubnets, ' different subnets'), Dummy= ''| extend AlertRuleUniqueName = 'multiplesubnetsbyuser'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Credential Access",
                "Initial Access",
                "Collection"
            ],
            "mitreAttackMultiple": "Credential Access2\ue946Initial AccessCollection",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAP_USR02 --"
        },
        {
            "searchKey": "45ae0492-fe7d-4ba8-addd-ca984ea30bc1",
            "displayName": "SAP - New ICF Service Handlers",
            "description": "Identifies creation of ICF Handlers.Source Action: Assign a new handler to a service using SICF.Data Sources: SAPcon - Table Data Log",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// New ICF Service Handlerslet TimeAgo= 2h;SAPTableDataLog| where TimeGenerated > ago(TimeAgo)| where TableName == \"ICFHANDLER\"| where TableField == \"ICF_NAME\" // Service name| where OldValue == \"\" and NewValue != \"\" // New value is inserted in name -> new service| order by TimeGenerated desc| project-rename Service = NewValue| lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User| extend TerminalIPv6= iff(isnotempty( LastKnownIP), LastKnownIP, PrimaryIP)| project TimeGenerated, Service, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance| extend Dummy= ''| extend AlertRuleUniqueName = 'newicfservicehandlers'",
            "ruleFrequency": "2 hours",
            "rulePeriod": "2 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Persistence",
                "Lateral Movement",
                "Command And Control"
            ],
            "mitreAttackMultiple": "Persistence2\ue946Lateral MovementCommand And Control",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "PrimaryEmail",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "Client",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPUsersHeader --SAPTableDataLog --"
        },
        {
            "searchKey": "263ea651-10c8-48a6-a5ac-2c9fc0655ebc",
            "displayName": "SAP - New ICF Services",
            "description": "Identifies creation of ICF Services.Source Action: Create a service using SICF.Data Sources: SAPcon - Table Data Log",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// New ICF Serviceslet TimeAgo= 2h;SAPTableDataLog| where TableName == \"ICFSERVLOC\"| where TimeGenerated > ago(TimeAgo)| where TableField == \"ICF_NAME\" // Service name| where OldValue == \"\" and NewValue != \"\" // New value is inserted in name -> new service| order by TimeGenerated desc| lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User| extend TerminalIPv6= iff(isnotempty( LastKnownIP), LastKnownIP, PrimaryIP)| project TimeGenerated, Service = NewValue, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance| extend Dummy= ''| extend AlertRuleUniqueName = 'newicfservices'",
            "ruleFrequency": "2 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Command And Control",
                "Persistence",
                "Lateral Movement"
            ],
            "mitreAttackMultiple": "Command And Control2\ue946PersistenceLateral Movement",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "PrimaryEmail",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "Client",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "LastKnownIP",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPUsersHeader --SAPTableDataLog --"
        },
        {
            "searchKey": "49f11dc5-03c9-4ea3-83ee-33434b42e699",
            "displayName": "SAP - Printing of potentially sensitive data",
            "description": "User has requested printing or has printed data which is potentially sensitive.Data is considered sensitive if it is obtained by using a sensitive transaction, by executing a sensitive program or by directly accessing a sensitive table.",
            "version": "3.0.4",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Potentially sensitive data exported via spool request// Spool requests made by users who were obsereved accessing sensitive data// or sensitive programs/ transactions// actual lookback is set by setting TimeAgolet TimeAgo= 4h;let TimeBetweenAccessAndDownload= 30m;// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])// let SelectedSystemRoles= dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey;// Get sensitive Tables// CONFIGURATION OPTION- list sensitive tables in the 'SAP - Sensitive Tables' watchlistlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables')    | summarize by Table;let TableAccessTcodes= dynamic([\"SE16\", \"SE16N\", \"SE11\", \"SE16H\", \"SM30\", \"SE12\", \"SM31\", \"SE16H\", \"SE14\", \"SE54\", \"SE17\", \"SE16T\", \"DB01\", \"DB02\"]);// CONFIGURATION OPTION- list sensitive transactions in the 'SAP - Sensitive Transactions' watchlistlet SensitiveTransWL= toscalar(_GetWatchlist('SAP - Sensitive Transactions')    | summarize TransactionCodes= make_set(TransactionCode));// CONFIGURATION OPTION- exclude TCODEs which are not to be consideredlet ExcludedTcodes= dynamic([\"S000\", \"\"]);let SensitiveTcodes= (set_difference(set_union(SensitiveTransWL, TableAccessTcodes), ExcludedTcodes));// CONFIGURATION OPTION- list sensitive programs in the 'SAP - Sensitive ABAP Programs' watchlistlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');let fixedABAPReports = datatable(ABAPProgram: string) [\"RSPFLDOC\"];let UnionABAP = union isfuzzy=true SensitiveABAPReports, fixedABAPReports    | summarize by ABAPProgram;// CONFIGURATION OPTION- exclude system users which are OK to print sensitive data// by adding those users in the SAP_User_Config watchlist with a tag of 'PrintSensitivesOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['PrintSensitivesOK', 'SAP_ROLE1', 'SAP_PROFILE1']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by User2Exclude=SAPUser;// Get direct sensitive table accesslet SensitiveTableAccess= SAPAuditLog    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"DU9\"    | where SystemID in (SelectedSystems)    | where Variable1 in (SensitiveTables)    | project-rename Table = Variable1, Activity = Variable2    | summarize Activities= make_set(Activity, 3)        by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, Email, Host, TerminalIPv6        , Table, SourceAction= strcat(\"after visiting transaction \", TransactionCode, \" and viewing sensitive table \", Table), TransactionCode, TableOrProgram= Table, Instance;// get sensitive program executionlet SensitiveProgramExec= SAPAuditLog    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"AUW\"    | where SystemID in (SelectedSystems)    | where ABAPProgramName in (UnionABAP)    | summarize        by        TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload),        SystemID,        ClientID,        User,        ABAPProgramName,        Email,        Host,        TerminalIPv6,        SourceAction= strcat(\"after executing sensitive program \", ABAPProgramName),        TransactionCode,        TableOrProgram= ABAPProgramName,        Instance;// get sensitive transaction executionlet SensitiveTcodeExec= SAPAuditLog    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)    | where MessageID == \"AU3\"    | where SystemID in (SelectedSystems)    // make sure sensitive transactions do not contain the TableAccessTcodes which are checked for the specific table name    | where TransactionCode in (set_difference(SensitiveTcodes, TableAccessTcodes))    | summarize        by        TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload),        SystemID,        ClientID,        User,        ABAPProgramName,        SourceAction= strcat(\"after executing sensitive transaction \", TransactionCode),        TransactionCode,        TableOrProgram= TransactionCode,        Email,        Host,        TerminalIPv6,        Instance;// Get all spool requestslet SpoolRequests= SAPSpoolLog    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)    | summarize        by        SpoolRequestNumber,        ClientID,        User,        RecipientofSpoolRequest,        SpoolRequestSuffix2,        SpoolRequestTitle,        SystemID,        OutputDevice,        DeleteSpoolRequestAuto,        TimeRequested= TimeGenerated,        ValueAuthCheck;let SpoolOutputs= SAPSpoolOutputLog    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)    | summarize        by        SpoolRequestNumber,        User,        RecipientofSpoolRequest,        PhysicalFormatType,        SystemID,        ClientID,        TimePrinted= TimeGenerated    | lookup (SAP_USR02        | summarize by SystemID, RecipientofSpoolRequest= BNAME, USTYP, ClientID= MANDT)        on RecipientofSpoolRequest, SystemID, ClientID    | extend        HasPrinted= true,        PrintRecievedByAnother= iff(User == RecipientofSpoolRequest, false, iff(isempty(USTYP), false, true));SpoolRequests| join kind=inner (SensitiveTableAccess    | union SensitiveProgramExec, SensitiveTcodeExec)    on User, SystemID| where (TimeAccessed - TimeRequested) between (-(TimeBetweenAccessAndDownload * 2) .. 0h)| lookup SpoolOutputs on SpoolRequestNumber, SystemID, ClientID| summarize Activities= tostring(make_set_if(Activities, tostring(Activities) != \"\"))    , TablesOrPrograms=make_set(TableOrProgram, 10), SourceActions= make_set(SourceAction, 10)    , TimeAccessed= min(TimeAccessed), TimeRequested= min(TimeRequested), HasPrinted=max(HasPrinted)    , PrintRecievedByAnother=max(PrintRecievedByAnother), RecipientofSpoolRequest= max(RecipientofSpoolRequest)    by    User,    SystemID,    Email,    Host,    TerminalIPv6,    ClientID,    Instance| extend PackedDetails= pack_all()| extend Details= strcat(\"User \", User, \" has \", iff(HasPrinted, \"printed\", \"requested printing of\"), \" potentially sensitive data \")| extend AlertDetails= strcat(Details, tostring(SourceActions), iff(PrintRecievedByAnother, strcat(\"<br/> Print has been pulled by another User \", RecipientofSpoolRequest), \"\")), Dummy= ''| extend AlertRuleUniqueName = 'printingofpotentiallysensitivedata'",
            "ruleFrequency": "4 hours",
            "rulePeriod": "5 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration"
            ],
            "mitreAttackMultiple": "Exfiltration",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "HostName"
                        }
                    ]
                },
                {
                    "entityType": "Process",
                    "fieldMappings": [
                        {
                            "columnName": "TablesOrPrograms",
                            "identifier": "ProcessId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSystems --SAPAuditLog --SAPUsersGetVIP --SAPSpoolOutputLog --SAPSpoolLog --SAP_USR02 --"
        },
        {
            "searchKey": "d83d4699-7bd5-44f1-826a-3bd3501712a9",
            "displayName": "SAP - SPNego Attack",
            "description": "Identifies SPNego Replay Attack.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Define variableslet AuditClasses = dynamic(['BUI']); // Message of SPNego// Query logicSAPAuditLog| where MessageID in (AuditClasses)| project TimeGenerated, Instance , SystemID, ClientID, User ,  Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'spnegoattack'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Impact",
                "Lateral Movement"
            ],
            "mitreAttackMultiple": "Impact1\ue946Lateral Movement",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4",
            "displayName": "SAP - Security Audit Log Configuration Change",
            "description": "Identifies changes for configuration in the Security Audit LogSource Action: change any dynamic Security Audit Log Configuration using SM19/RSAU_CONFIG.(Filters/Status/Recording mode etc..).Data Sources: SAPcon -  Audit Log",
            "version": "2.0.75",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Security Audit Log Configuration Change// !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required// actual lookback is set by setting TimeAgolet TimeAgo= 75m;// Audit Log Classes - Audit Log Configuration Events// determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage;// here you can exclude system users which are OK to execute a configuration change// by adding those users in the SAP_User_Config watchlist with a tag of 'AuditLogConfigOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['AuditLogConfigOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let AuditClasses = dynamic(['AUE', 'AUF', 'AUI', 'AUJ', 'FU0', 'E05', 'AUG']); // Relevant messages// gather all audit log configuration changeslet ConfigChanges= materialize(SAPAuditLog| where TimeGenerated > ago(TimeAgo)| where MessageID in (AuditClasses)| where SystemID in ((SelectedSystems | project SystemID))| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| project TimeGenerated, Instance, SystemID, User, MessageText, Email, TerminalIPv6, Host, MessageID, UpdatedOn_t);let SystemRestarts= ConfigChanges | where MessageID == \"AUG\"| distinct SystemID, Instance, Host, UpdatedOn_t;ConfigChanges// disregard changes that got applied when system restarted| join kind =leftanti SystemRestarts on SystemID, Instance, Host, UpdatedOn_t| lookup (SelectedSystems | project SystemID, SystemRole) on SystemID| summarize FirstChangedOn=min(UpdatedOn_t), LastChangedOn=max(UpdatedOn_t), Events=make_set(MessageText), SystemRole=any(SystemRole) by SystemID, User, Email, TerminalIPv6, BinTime= bin(UpdatedOn_t,1h), Host, Instance| extend AlertName= strcat(\"SAP audit log configuration change detected in a \", tolower(SystemRole),\" system\")| extend Dummy= \"\"| extend AlertRuleUniqueName = 'securityauditlogconfigurationchange'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Persistence",
                "Exfiltration",
                "Defense Evasion"
            ],
            "mitreAttackMultiple": "Persistence2\ue946ExfiltrationDefense Evasion",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "97d13311-748b-4016-b095-9100ab00e4db",
            "displayName": "SAP - Sensitive Privileged User Logged in",
            "description": "Identifies Dialog logon of a sensitive privileged user.Source Action: Logon to the backend system using SAPor anoter privileged user.Priveleged users should be maintained in \"SAP - Privileged Users\" WatchlistThis rule requires a fresh full reload of the SAP user master data to be performed daily.Data Sources: SAPcon -  Audit LogData Sources: SAPcon -  User MD",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - Sensitive Privileged User Logged in// !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required// actual lookback is set by setting TimeAgo// time span for audit eventslet AuditTimeAgo= 75m;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;// here you can exclude system users which are OK to execute a Sensitive Transaction Code// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveLogOnOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['SensitiveLogOnOK']);// dynamic(['SensitiveLogOnOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Audit Log Classes - Dialog Logon Successfullet AuditClassesSuccess = dynamic(['AU1']);let AuditClassesFail = dynamic(['AU2']);let LogonTypes = dynamic(['A','H', 'R', 'S']); // Dialog / HTTPlet DataTypes = materialize(SAPGetDataTypes());// Query logicSAPAuditLog| where TimeGenerated > ago(AuditTimeAgo)| join kind= inner SelectedSystems on SystemID| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| where (MessageID in (AuditClassesSuccess) and Variable1 in (LogonTypes)) or // Success loginMessageID in (AuditClassesFail)|join kind = inner (SAPUsersGetPrivileged())on $left.ClientID == $right.Client, $left.SystemID == $right.SystemID, $left.User == $right.User| project-rename LogonTypeKey = Variable1, ReasonKey= Variable2, LogonMethodKey= Variable3| lookup (DataTypes | where DataType == \"LogonFailureCause\"| project Key, LogonFailureCause= Value) on $left.ReasonKey == $right.Key| lookup (DataTypes | where DataType == \"LogonType\"| project Key, LogonType= Value) on $left.LogonTypeKey == $right.Key| lookup (DataTypes | where DataType == \"LogonMethod\"| project Key, LogonMethod= Value) on $left.LogonMethodKey == $right.Key| project TimeGenerated, Instance ,SystemID, ClientID, LogonType, User, MessageText,Email, TerminalIPv6, Host, SystemRole, LogonFailureCause, LogonMethod, MessageID| extend PackedDetails= pack_all()| extend AlertName= strcat(\"SAP - Privileged User \", User, iff(MessageID==\"AU1\",\" Has Logged into a \", \" Has Failed to Log into a \"), SystemRole, \" System\" )| extend AlertDescription= strcat(\" LogonType: \", LogonType, \". LogonFailureCause: \", LogonFailureCause, \". LogonMethod: \", LogonMethod), Dummy= ''| extend AlertRuleUniqueName = 'sensitiveprivilegeduserloggedin'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "7 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access",
                "Credential Access"
            ],
            "mitreAttackMultiple": "Initial Access1\ue946Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSystems --SAPGetDataTypes --SAPAuditLog --SAPUsersGetVIP --SAPUsersGetPrivileged --"
        },
        {
            "searchKey": "9fadb366-a7ec-474c-90e1-d1a823176a1e",
            "displayName": "SAP - Sensitive Role Changes",
            "description": "Identifies changes in sensitive roles.Source Action: Change a role using PFCG.Sensitive roles should be maintained in \"SAP - Sensitive Roles\" WatchlistData Sources: SAPcon - Change Documents Log",
            "version": "3.1.1",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Sensitive Roles Changes// Define variableslet TimeAgo= 2h;let RoleObjectClass = \"PFCG\";let ChangeType = \"U\";let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with userlet SensitiveRoles = _GetWatchlist(\"SAP - Sensitive Roles\");// Maintain if watchlist is not availablelet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];let UnitedRoles =toscalar(union fixedRoles, SensitiveRoles| summarize Roles = make_list(Role));let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;// here you can exclude system users which are OK to run sensitive role updates// by adding those users in the SAP_User_Config watchlist with a tag of 'UpdateSensitiveAuthOK'let excludeUsersTags= dynamic(['UpdateSensitiveAuthOK']);let excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;// Query logiclet RoleChanges= SAPChangeDocsLog| where TimeGenerated> ago(TimeAgo+ 1h)| where ingestion_time() > ago(TimeAgo)| where TableName contains (\"1251\")| where ObjectClass == RoleObjectClass // Relevant role object class| where TypeofChange_Header == ChangeType| join kind= inner  SelectedSystems on SystemID| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| extend AuthorizationObj = extract(@\"\\S+\\s+(\\S+)\\s+\", 1, ChangedTableKey, typeof(string)) // Extract Authorization Object| extend Authorization = extract(@\"\\S+\\s+\\S+\\s+(\\S+\\d+)\", 1, ChangedTableKey, typeof(string)) // Extract Authorization| where ObjectID in (UnitedRoles) // Role is sensitive| project-rename ChangedOn= UpdatedOn_t| extend BagOfChange= bag_pack(\"Authorization\",Authorization, \"AuthorizationObj\", AuthorizationObj, \"FieldName\", FieldName, \"OldValue\", ValueOld,\"NewValue\", ValueNew )| summarize TableName=any(TableName), TransactionCode=any(TransactionCode), SystemRole=any(SystemRole), Host=any(Host), Instance=any(Instance), Authorizations= makeset(Authorization), BagOfChanges= make_set(BagOfChange, 30) by ChangedOn , SystemID, ClientID, ChangedRole= ObjectID, User;let RoleChangesEarliest= toscalar(RoleChanges | summarize EarliestChange= min(ChangedOn));let Logins = SAPAuditLog| where TimeGenerated> RoleChangesEarliest - 1h| where MessageID in (AuditLogIn)| where User in((RoleChanges | distinct User))| project-rename LoggedOn= UpdatedOn_t| summarize count() by Email, TerminalIPv6, User, SystemID, ClientID, bin(LoggedOn, 1h); // Get last connection date for userRoleChanges| lookup kind=inner Logins on User, ClientID, SystemID // Get IP| where ChangedOn > LoggedOn| extend ChangeKey=strcat(ChangedRole, User, SystemID, ChangedOn)| order by ChangeKey| extend UpdatedOnDiff= datetime_diff('minute', ChangedOn, LoggedOn)| extend Rank=row_number(1, prev(ChangeKey) != ChangeKey)| where Rank< 3 // allow up to 2 IP addresses per 1h for capture replay scenarios| project Authorizations, TimeGenerated= ChangedOn, Instance, SystemID, ClientID, Email, User, TerminalIPv6, Host, ChangedRole, BagOfChanges, SystemRole| extend Email= iff(isempty(Email),User, Email), Host= iff(isempty(Host), TerminalIPv6, Host)| extend AlertName= strcat('Sensitive Role ' , ChangedRole, ' was updated by ', User, \" in a \", tolower(SystemRole), \" system\"), Dummy=' '| extend PackedDetails= pack_all()| extend AlertDescription= strcat(\" The sensitive role \", ChangedRole, \" was changed by user \", User,\". Changed authorizations: \", Authorizations,\". The list of changes detected: \", BagOfChanges)| extend AlertRuleUniqueName = 'sensitiverolechanges'",
            "ruleFrequency": "2 hours",
            "rulePeriod": "12 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Impact",
                "Privilege Escalation",
                "Persistence"
            ],
            "mitreAttackMultiple": "Impact2\ue946Privilege EscalationPersistence",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "SecurityGroup",
                    "fieldMappings": [
                        {
                            "columnName": "ChangedRole",
                            "identifier": "DistinguishedName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPChangeDocsLog --SAPSystems --"
        },
        {
            "searchKey": "940baadd-fe19-4c1a-9680-63a9c5d21e1c",
            "displayName": "SAP - Sensitive Tables Direct Access By Dialog Logon",
            "description": "Identifies generic table access by dialog logon, for which authorization did not exist 24 hours ago.Source Action: Open table contents using SE11/SE16/SE16N with a user which was unauthorized to do so 24 hours ago.Recommended for Production onlyTables should be maintained in \"\"SAP - Sensitive Tables\"\" Watchlist.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.13",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "// SAP - Sensitive Tables Direct Access By Dialog Logon// !!!IMPORTANT!!!// Please keep \"Lookup data from the last\" to be > =2 days to allow reading of historical user authorization data// Actual lookback is set by setting AuditTimeAgolet AuditTimeAgo= 2h;let AuditClasses = dynamic(['DU9']); // Dialog, Audit Log Classes - Generic Table Accesslet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;// here you can exclude certain users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveTableDialogOK'// can also specify relevant SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['SensitiveTableDialogOK']);// dynamic(['SensitiveTableDialogOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Get Relevant Tableslet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');// Query logiclet TableAccessEvents= materialize(SAPAuditLog    | where TimeGenerated > ago(AuditTimeAgo)    | where SystemID in ((SelectedSystems | distinct SystemID))    | where MessageID in (AuditClasses)    | project-rename Table = Variable1, Activity = Variable2    | where Table in ((SensitiveTables| distinct SearchKey))    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude    | project TimeGenerated, Instance, SystemID, ClientID, User, TransactionCode, ABAPProgramName, Table, Activity, MessageText, MessageID, Email, TerminalIPv6, Host);// build the authorization snapshot of 1 day ago for the specific table names// this will exclude any authorized access to a specific table given a day earlierlet Auths= materialize(SAPUsersAuthorizations(SnapshotAge= 1d)| where Object == \"S_TABU_NAM\" // table name| where Field == \"TABLE\"| where User in ((TableAccessEvents| distinct User))| where SystemID in ((TableAccessEvents| distinct SystemID))| project ClientID, SystemID, User, Tables= EQs| mv-expand Tables to typeof(string)| summarize Tables=make_set_if(Tables, isnotempty( Tables),  1000) by SystemID, ClientID, User);TableAccessEvents| lookup Auths on User, SystemID, ClientID| extend WASTableAuthorized= Tables has Table or Tables has '*'| where not(WASTableAuthorized)| extend AlertName= \"SAP - Unauthorized Sensitive Tables Direct Access By Dialog Logon\"| extend AlertDescription= strcat(\"User \", User, \" has read sensitive table \", Table, \". The system could not find a matching S_TABU_NAM authorization for this table in an authorization snapshot taken a day ago.\")| extend AlertRuleUniqueName = 'sensitivetablesdirectaccessbydialoglogon'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery"
            ],
            "mitreAttackMultiple": "Discovery",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --SAPUsersAuthorizations --"
        },
        {
            "searchKey": "2521fd74-79f3-4adc-8350-edf4036913b3",
            "displayName": "SAP - Sensitive Tables Direct Access By RFC Logon",
            "description": "Identifies generic table access by RFC logonSource Action: Open table contents using SE11/SE16/SE16N.Recommended for Production onlyTables should be maintained in \"SAP - Sensitive Tables\" Watchlist.Data Sources: SAPcon -  Audit Log",
            "version": "2.0.67",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// SAP - Sensitive Tables Direct Access By RFC Logon// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;// Get Relevant Tableslet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables')| project Table;// here you can exclude system users which are OK to access sensitive tables via RFC// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveTablebyRFCOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['SensitiveTablebyRFCOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Query logicSAPAuditLog    | where SystemID in (SelectedSystems)    | where MessageID == 'CUZ'    | where Variable1 in (SensitiveTables)    | project-rename Table = Variable1, Activity = Variable2    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude    | order by TimeGenerated asc    | project TimeGenerated,Instance, SystemID, ClientID, User, TransactionCode, ABAPProgramName, Table, Activity, MessageText, MessageID,Email, TerminalIPv6, Host    | extend PackedDetails= pack_all()    | extend AlertDescription= strcat('SAP - User ', User, ' has accessed sensitive table ', Table, ' using RFC'), Dummy=''    | extend RemediationSteps= strcat(\"Consult with the SAP security team to determine if user \", User, \" is OK to perform this action. If the activity is benign, assign the user with the SensitiveTablebyRFCOK tag in SAP_User_Config watchlist. Otherwise, lock the SAP user in system \", SystemID), Dummy= ''| extend AlertRuleUniqueName = 'sensitivetablesdirectaccessbyrfclogon'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "13 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Collection",
                "Exfiltration",
                "Credential Access"
            ],
            "mitreAttackMultiple": "Collection2\ue946ExfiltrationCredential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "4cc23b15-a048-45f1-b1e8-2dfc40013d84",
            "displayName": "SAP - Sensitive User's Password Change and Log in",
            "description": "Identifies password changes and other master record changes made to privileged users which are later exploited by the admin.Source Action: Change Password or maintain a privileged user and then login with the same user from the same IP address.Privileged users should be maintained in \"SAP - Privileged Users\" WatchlistThis rule requires a fresh full reload of SAP user master data to be performed daily.Data Sources: SAPcon -  Audit LogData Sources: SAPcon -  User MD",
            "version": "3.2.02",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - High - Sensitive Users Password Change and Login// IMPORTANT!!! The alert rule's \"lookup data from the last\" parameter needs to be greater than both of these time spans:let CreationLookBack= 75m;// lookback for user creation/ modification to be alerted onlet LogOnLookBack= 2d; // further lookback to evaluate known IP address// true- include sensitive users, like those who have sensitive roles or profiles listed// false- only focus on users that are listed in the \"SAP - Privileged Users\" WL or have SAP_ALLlet IncludeSensitiveUsers= false;// here you can exclude system users which are OK to execute this action// by adding those users in the SAP_User_Config watchlist with a tag of 'CreateUsersAndUseOK'// can also specify relevant SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['CreateUsersAndUseOK']);// dynamic(['CreateUsersAndUseOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)    | summarize by User=SAPUser;let SelectedSystemRoles = dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole;let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with userlet AuditUserMaintain = dynamic(['BU2', 'AUD']); // Message of user password change, maintenancelet SensitivePrivilegedUsers= materialize(SAPUsersGetSensitive()    | join kind=inner SelectedSystems on SystemID    | where IsPrivileged or IncludeSensitiveUsers    | summarize IsPrivileged=max(IsPrivileged) by UserGotChanged=User, SystemID, ClientID= Client);let PrivUserModifications=materialize(SAPAuditLog    | where TimeGenerated > ago(CreationLookBack)    | where SystemID in (SelectedSystems)    | where MessageID in (AuditUserMaintain)    | where isnotempty(TerminalIPv6)    | join kind=leftantisemi excludedUsers on User    | extend UserGotChanged=iff(MessageID == \"BU2\", Variable2, Variable1)    | join kind= inner SensitivePrivilegedUsers on UserGotChanged, SystemID, ClientID    | project-rename UserChanger= User    | where UserChanger != UserGotChanged    | extend Action=iff(MessageID == \"BU2\", \"'s password was changed\", \"'s authorization maintained\"));let UsersHeaders= materialize(SAPUsersHeader()    | join kind=inner (PrivUserModifications        | distinct UserChanger, UserGotChanged        | evaluate narrow()        | distinct User= Value)        on User    | where isnotempty(PrimaryIP) and LastSeen > ago(CreationLookBack + LogOnLookBack)    | summarize        KnownIPs=make_set(KnownIPs),        PrimaryEmail=make_set_if(PrimaryEmail, isnotempty(PrimaryEmail))        by User);PrivUserModifications// get logon details for UserCreator, cross-client| lookup UsersHeaders on $left.UserChanger == $right.User| project-rename KnownIPsChangerUser= KnownIPs, ChangerEmail= PrimaryEmail// get logon details for UserCreated| lookup UsersHeaders on $left.UserGotChanged == $right.User| project-rename KnownIPsChangedUser= KnownIPs, ChangedEmail= PrimaryEmail| extend IPsIntersected= set_intersect(KnownIPsChangerUser, KnownIPsChangedUser)| where array_length(IPsIntersected) > 0| lookup SelectedSystems on SystemID| lookup SensitivePrivilegedUsers on UserGotChanged| extend AlertName= strcat(iff(IsPrivileged, \"SAP - privileged user \", \"SAP - sensitive user \"), UserGotChanged, Action, \" and then used by \", UserChanger, \" in a \", tolower(SystemRole), \" system\")| extend Severity= iff(IsPrivileged, \"High\", \"Medium\")| mv-expand IPIntersected= IPsIntersected to typeof(string)| extend IPGeoLocation= geo_info_from_ip_address(IPIntersected)| extend AlertDescription= strcat(trim_end(@\"\\.\", MessageText),\" by User \", UserChanger, \".\\n Both users were observed using the same IP address: \", IPIntersected, \".\\n\", iff(IPGeoLocation != (\"{}\"), strcat(\".\\n Geo location: \", IPGeoLocation), \"\"))| project    UserChanger,    UserGotChanged,    TimeChanged=UpdatedOn_t,    ChangerEmail= coalesce(Email, tostring(ChangerEmail[0])),    ChangedEmail= ChangedEmail[0],    Instance,    Host,    SystemID,    ClientID,    IPsIntersected,    AlertName,    AlertDescription,    Severity",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Impact",
                "Command And Control",
                "Privilege Escalation"
            ],
            "mitreAttackMultiple": "Impact2\ue946Command And ControlPrivilege Escalation",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "ChangerEmail",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "IPsIntersected",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSystems --SAPAuditLog --SAPUsersHeader --SAPUsersGetVIP --SAPUsersGetSensitive --"
        },
        {
            "searchKey": "47848010-7a36-44f7-96be-d988f3de9421",
            "displayName": "SAP - Sensitive privileged user makes a change in another user",
            "description": "Identifies changes  of sensitive privileged users in other users.Source Action: Change user details / authorizations using SU01.Priveleged users should be maintained in \"SAP - Privileged Users\" WatchlistThis rule requires a fresh full reload of SAP user master data to be performed daily.Data Sources: SAPcon -  Audit LogData Sources: SAPcon -  User MD",
            "version": "3.0.3",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - High - Sensitive privileged user makes a change in another user// here you can exclude system users which are OK to modify other users' master data// by adding those users in the SAP_User_Config watchlist with a tag of 'ChangeUserMasterDataOK'let excludeUsersTags= dynamic(['ChangeUserMasterDataOK']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;// time span for audit eventslet AuditTimeAgo= 75m;// Audit Log Classes - User Master Changeslet AuditClasses = dynamic(['AU7', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'BU2']);// Query LogicSAPAuditLog| where TimeGenerated > ago(AuditTimeAgo)| where MessageID in (AuditClasses)| where SystemID in (SelectedSystems)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| join kind= leftsemi SAPUsersGetPrivileged on User, SystemID, $left.ClientID == $right.Client // The user that makes a change is a sensitive privileged user| extend ChangedUser= iff(MessageID == \"BU2\", Variable2, Variable1)| lookup  (SAPUsersEmail()| project ChangedEmail= Email, ChangedUser= User, SystemID, ClientID)    on SystemID, ClientID, ChangedUser| project    TimeGenerated,    Instance,    SystemID,    ClientID,    User,    MessageText,    MessageID,    Email= iff(isempty(Email), User, Email),    TerminalIPv6,    Host= iff(isempty(Host), TerminalIPv6, Host),    ChangedUser,    ChangedEmail| extend AlertRuleUniqueName = 'sensitiveprivilegedusermakesachangeinanotheruser'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Privilege Escalation",
                "Credential Access"
            ],
            "mitreAttackMultiple": "Privilege Escalation1\ue946Credential Access",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "ChangedEmail",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPSystems --SAPAuditLog --SAPUsersGetVIP --SAPUsersGetPrivileged --SAPUsersEmail --"
        },
        {
            "searchKey": "27d73c8f-88fd-41b8-a785-231541aa32a0",
            "displayName": "SAP - Spool Takeover",
            "description": "Identifies a user printing a spool request which was created by someone else.Source Action: Create a Spool Request using one user, Output it in using another user.Data Sources: SAPcon -  Spool LogData Sources: SAPcon -  Spool Output Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Define variableslet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user// Query logiclet LastLogin =SAPAuditLog| where MessageID in (AuditLogIn)| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User; // Get last connection date for user// Query LogicSAPSpoolOutputLog // Get all spool outputs| lookup kind=inner SAPSpoolLog on SpoolRequestNumber| lookup kind=inner LastLogin on User, SystemID| where User != User1 // The user that created the request is not the one that printed it| project TimeGenerated, Instance, SystemID, ClientID, UserCreated = User1, UserPrinted = User, SpoolRequestNumber, Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'spooltakeover'",
            "ruleFrequency": "12 hours",
            "rulePeriod": "12 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Collection",
                "Exfiltration",
                "Command And Control"
            ],
            "mitreAttackMultiple": "Collection2\ue946ExfiltrationCommand And Control",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPSpoolLog --SAPSpoolOutputLog --"
        },
        {
            "searchKey": "f4da8e9d-3515-4a2a-8cf0-43334fa29d91",
            "displayName": "SAP - System Configuration Change",
            "description": "Identifies changes for system configuration.Source Action:  Adapt system change options or software components modifcation using SE06 transaction code.Data Sources: SAPcon -  Audit Log",
            "version": "3.2.0",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Audit Log Classes - System Change Configuration// !!!IMPORTANT!!!// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required// actual lookback is set by setting TimeAgolet TimeAgo= 1h;// CONFIGURATION OPTION- determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// here you can exclude system users which are OK to perform this action// by adding those users in the SAP_User_Config watchlist with a tag of 'SystemConfigOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['SystemConfigOK']); // can also do dynamic(['SystemConfigOK','SAP_ALL'])let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;let AuditClasses = dynamic(['EU1']); // Relevant messageSAPAuditLog| where TimeGenerated > ago(TimeAgo)| where MessageID in (AuditClasses)| where SystemID in (SelectedSystems)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| project// DetailsTimeGenerated,Instance, ClientID ,SystemID, User, TransactionCode, SoftwareComponent = Variable1, NewModifiabilityStatus = Variable2, MessageText,Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'systemconfigurationchange'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 dayT12H",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Exfiltration",
                "Defense Evasion",
                "Persistence"
            ],
            "mitreAttackMultiple": "Exfiltration2\ue946Defense EvasionPersistence",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --SAPSystems --"
        },
        {
            "searchKey": "35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294",
            "displayName": "SAP - Transaction is unlocked",
            "description": "Identifies unlocking of a transaction.Source Action: Unlock a transaction code using SM01/SM01_DEV/SM01_CUS.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Audit Log Classes - Transaction UnLock Events// AUP - Transaction Lockedlet AuditClasses = dynamic(['AUQ']); // AUQ - Transaction UnlockedSAPAuditLog| where MessageID in (AuditClasses)| project-rename TransactionCodeTemp = TransactionCode| project-rename TransactionCode= Variable1| parse TransactionCode with \"( TR ) \" _TCODE \" - \" ClientTR // Parse to _TCODE and ClientTR// Specific Client Action (SM01_CUS) / Cross Client (SM01_DEV)| extend TransactionCode = iif(_TCODE != \"\",_TCODE, TransactionCode) // Check if _TCODE is not empty| extend ClientTR = iif(ClientTR != \"\",ClientTR, \"CrossClient\") // Check if ClientTR is not empty| project// DetailsTimeGenerated, Instance, SystemID, User, MessageText,TransactionCode, ClientTR,Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'transactionisunlocked'",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Persistence",
                "Execution"
            ],
            "mitreAttackMultiple": "Persistence1\ue946Execution",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientTR",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --"
        },
        {
            "searchKey": "8e8a95c5-7f78-435e-9e6a-7e29c0b831c1",
            "displayName": "SAP - Unauthorized Remote Execution of a Sensitive Function Module",
            "description": "Detects an unauthorized execution of a sensitive function module using RFC.Source Action: Execute a function module using RFC.Recommended for Production onlyFunction Modules should be maintained in watchlist \"SAP - Sensitive Function Modules\"Data Sources: SAPcon -  Audit Log",
            "version": "2.0.74",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// RFC Execution of a Sensitive Function Modulelet TimeAgo= 60m;// determine which system roles are relevant for this alertlet SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// here you can exclude system users which are OK to execute a Sensitive function module// by adding those users in the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveFMOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['ExecuteSensitiveFMOK','SAP_ALL']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// this watchlist lists the sensitive function modules, along with users that are OK to run those.// if you don't see a column named \"UsersExcluded\" in this WL, add onelet SensitiveFMs = _GetWatchlist('SAP - Sensitive Function Modules')| extend UsersExcluded= replace_string(column_ifexists(\"UsersExcluded\",\"\"), \" \",\"\")| extend UsersExcluded= parse_csv(UsersExcluded)| summarize UsersExcluded= make_set(UsersExcluded, 1000), Description=take_anyif(Description, isnotempty(Description)) by SearchKey;let SensitiveFMExecs= materialize(SAPAuditLog| where TimeGenerated > ago(TimeAgo + 1h)| where ingestion_time() > ago(TimeAgo)| where MessageID == \"AUK\"| where SystemID in ((SelectedSystems | project SystemID))| where Variable3 in ((SensitiveFMs | summarize make_set(SearchKey)))| join kind = inner SensitiveFMs on $left.Variable3 == $right.SearchKey// exclude users which are OK to run the specific FM| where UsersExcluded !has User| project-rename FunctionModule = Variable3, FunctionGroup = Variable1| order by TimeGenerated asc| project TimeGenerated,Instance ,User, SystemID, ClientID, FunctionGroup, FunctionModule, Description, MessageID, Email, TerminalIPv6, Host);let UsersExecuted= (SensitiveFMExecs | summarize make_set(User,1000));// let's see if the auth was there yesterdaylet UsersAuth= SAPUsersAuthorizations(SnapshotAge= 1d)| where User in (UsersExecuted) and Field == \"RFC_NAME\" and SystemID in ((SelectedSystems | project SystemID))| summarize EQs= make_set(EQs) by User, ClientID, SystemID;let UserMDSystems= SAP_AGR_AGRS | where TimeGenerated > 1d | summarize by SystemID, ClientID= MANDT | extend IsUserMDThere= true;// now we check if the user had permisions to perform the RFC call yesterdaylet UnAuthFMExec= SensitiveFMExecs | lookup UsersAuth on SystemID, ClientID, User| where not(EQs has FunctionModule or EQs has FunctionGroup or EQs has \"*\");UnAuthFMExec| lookup (SelectedSystems | project SystemID, SystemRole) on SystemID| lookup UserMDSystems on SystemID, ClientID| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| extend AlertName= strcat(\"SAP - Unauthorized RFC Execution of a Sensitive Function Module in a \", tolower(SystemRole), \" system\")| extend AlertDescription = strcat(\"The Function module \", FunctionModule, \" of the function group \", FunctionGroup, iff(isnotempty(Description), strcat(\", described as '\", Description, \"',\"), \"\"), \" was executed by user \", User, iff(IsUserMDThere, \". No authorization for this execution was found in the user master data profile gathered from SAP system \", \". Sentinel could not verify the authorization for this action as no user master data found for SAP system \"), SystemID, \", Client \", ClientID, \". If this execution is benign, consider checking if the relevant system is configured to send the user master data profile. If you wish to allow this activity, add the specific user USER as UsersExcluded in the \u2018SAP - Sensitive Function Modules\u2019 watchlist. If you wish to allow this user to perform all sensitive FM calls (not recommended), add the user to the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveFMOK'.\")| extend Dummy= \"\"// | summarize by User, SystemID, ClientID, FunctionGroup, FunctionModule| extend AlertRuleUniqueName = 'rfcexecutionofasensitivefunctionmodule'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "2 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Exfiltration",
                "Lateral Movement"
            ],
            "mitreAttackMultiple": "Discovery2\ue946ExfiltrationLateral Movement",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "Email",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAP_AGR_AGRS --SAPSystems --SAPAuditLog --SAPUsersGetVIP --SAPUsersAuthorizations --"
        },
        {
            "searchKey": "12509d03-0206-4b85-84b9-6d2349afa42b",
            "displayName": "SAP - User Creates and uses new user",
            "description": "Identifies a user creating and using other users.Source Action: Create a user using SU01. Login using the newly created user from the same IP.Data Sources: SAPcon -  Audit Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// Define Variableslet MinutesThreshold = 15; // Difference by minutes between Create and Connectlet AuditUserCreated = dynamic(['AU7']); // Message of create userlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user// here you can exclude system users which are OK to Create Other Users// by adding those users in the SAP_User_Config watchlist with a tag of 'CreateUserOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['CreateUserOK','SAP_ROLE', 'SAP_PROFILE']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Query Logiclet UserCreated = // Get users createdSAPAuditLog| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| where MessageID in (AuditUserCreated)| project-rename UserCreationTimeGenerated = TimeGenerated, UserCreated = Variable1;SAPAuditLog // Get users connections| where MessageID in (AuditLogIn)| lookup kind=inner UserCreated on TerminalIPv6,$left.User == $right.UserCreated, SystemID, ClientID // Lookup of user created to user log in| where abs(datetime_diff('Minute', TimeGenerated, UserCreationTimeGenerated)) <= MinutesThreshold // Connect after creation| summarize by TimeGenerated, Instance ,SystemID, ClientID, UserActing = User1, UserActingEmail= Email1, UserCreated = User, UserCreatedEmail= Email, TerminalIPv6, Host| extend AlertRuleUniqueName = 'usercreatesandusesnewuser'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Discovery",
                "Persistence"
            ],
            "mitreAttackMultiple": "Discovery1\ue946Persistence",
            "techniques": [
                "T1078",
                "T1136",
                "T0859"
            ],
            "techniquesMultiple": "T10782\ue946T1136T0859",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "UserActingEmail",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "UserCreatedEmail",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --"
        },
        {
            "searchKey": "7224ad22-e2cf-459d-9359-62310555e716",
            "displayName": "SAP - User Unlocks and uses other users",
            "description": "A user unlocked another, and then used the other's user credentials.Source Action: Unlock a user using SU01. Login using the unlocked user from the same IP.Data Sources: SAPcon -  Audit LogData Sources: SAPcon -  Change Documents Log",
            "version": "3.1.9",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "// SAP - User Unlocks and uses other users// Define variableslet MinutesThreshold = 30; // Difference by minutes between Unlock and Connectlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user// here you can exclude system users which are OK to Unlock Other Users// by adding those users in the SAP_User_Config watchlist with a tag of 'UnlockUserOK'// can also specify SAP Roles or Profiles to excludelet excludeUsersTags= dynamic(['UnlockUserOK','SAP_ROLE', 'SAP_PROFILE']);let excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;// Get users which were unlockedlet UsersUnlocked = SAPAuditLog| where MessageID == 'AUA' // Message of unlock user| where isnotempty( TerminalIPv6)| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude| project-rename UserUnlockTimeGenerated = TimeGenerated, UserThatWasUnlocked = Variable1, EmailWhoUnlocked = Email, UserWhoUnlocked= User| project-keep UserUnlockTimeGenerated, UserThatWasUnlocked, EmailWhoUnlocked, SystemID, ClientID, TerminalIPv6, Instance, Host, UserWhoUnlocked;// Query Logiclet ActionUsers = SAPAuditLog| where isnotempty( TerminalIPv6)| project-keep MessageID, User, Email, SystemID, TimeGenerated, ClientID, TerminalIPv6// Get users connections| project-rename UserAction = User, EmailAction= Email| where MessageID in (AuditLogIn); // check if the locked was user was unlocked and then used from the same IP address//  as the unlockerUsersUnlocked | join kind=inner ActionUsers onTerminalIPv6, SystemID, ClientID, $left.UserThatWasUnlocked==$right.UserAction| where abs(datetime_diff('Minute', TimeGenerated, UserUnlockTimeGenerated)) <= MinutesThreshold // Connect after unlock| summarize Count=count(), TimeGenerated= max(TimeGenerated) by Instance ,SystemID, ClientID, UserWhoUnlocked , UserThatWasUnlocked, EmailWhoUnlocked, EmailThatWasUnLocked= EmailAction, TerminalIPv6, Host| extend AlertRuleUniqueName = 'userunlocksandusesotherusers'",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "mitreAttack": [
                "Initial Access",
                "Discovery",
                "Lateral Movement"
            ],
            "mitreAttackMultiple": "Initial Access2\ue946DiscoveryLateral Movement",
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "EmailWhoUnlocked",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "columnName": "Host",
                            "identifier": "FullName"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "TerminalIPv6",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                        {
                            "columnName": "SystemID",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "ClientID",
                            "identifier": "AppId"
                        },
                        {
                            "columnName": "Instance",
                            "identifier": "InstanceName"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "EmailThatWasUnLocked",
                            "identifier": "FullName"
                        }
                    ]
                }
            ],
            "dataConnectorId": "SAP",
            "dataConnectorName": "Microsoft Sentinel for SAP",
            "dataTypes": "SAPAuditLog --SAPUsersGetVIP --"
        }
    ],
    "huntingQuery": [],
    "parser": [
        {
            "searchKey": "SAPAppLog-Parser",
            "displayName": "SAPAppLog",
            "functionAlias": "SAPAppLog",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPAppLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPAuditLog-Parser",
            "displayName": "SAPAuditLog",
            "functionAlias": "SAPAuditLog",
            "version": "3.2.02",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPAuditLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPAuditLogAnomalies-Parser",
            "displayName": "SAPAuditLogAnomalies",
            "functionAlias": "SAPAuditLogAnomalies",
            "version": "3.0.0",
            "query": "////// get anomalies from the SAPAuditLog//// Dynamic parameters// let LearningTime = 14d;// let DetectingTime = 1h;// use 1 h for alerting on anomalies // can also do // let DetectingTime = 0h;//0h for seeing anomalies across all training data// let SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do dynamic([\"All Severities\"]), dynamic([\"High\", \"Medium\", \"Low\"])// let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);// let SelectedPrefixMask = 24;// // other potential values can be:// // let SelectedRuleTypes= dynamic([\"Deterministic\"]);// // let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);//// Static parameters// If DetectingTime==0h, we want anomalies to show across all training time as well// 1h hour detecting will spill over 2 hour binslet ActualDetectingTime= iff(DetectingTime == 0h, LearningTime, DetectingTime + 1h);let TestPoints= iff(DetectingTime == 0h, 0, toint((DetectingTime + 1h) / 1h));let Now = now();let AnomalyThreshold= 2;let AnomalyTrendKind= 'linefit';// can be 'linefit', 'avg' or 'none'let AnomalySeasonality= 24; // can be 0, or number of bins, -1 is AutoDetectlet AnomalyAD_method = 'ctukey'; // 'ctukey' = 10th-90th percentile, 'tukey' = 25th-75th percentile range// get special users for exclusion and in-focus analysislet SAPUsersGottenVIP = materialize(SAPUsersGetVIP    | project User = SAPUser, TagsList);let SAPUserRolesAndProfiles = (SAPUsersAssignments    | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles    | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);// get the configuration from the \"SAPAuditLogConfiguration\" watchlist which allows// assigning severity levels per system Role (Production/ non-production), automatic team assignments and other configuration optionslet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSystems, SelectedSystemRoles, SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)    | extend FrequencyThreshold= Threshold);// get relevant audit events according to configurationlet AuditEvents = (SAPAuditLog        | where TimeGenerated > ago(LearningTime)        | where SystemID in ((AuditConfiguration | summarize  by SystemID))        | where MessageID in ((AuditConfiguration | summarize  by MessageID))        // Alerts coming from SAP as \"Low\" or missing User ID aren't very intersting        | where AlertSeverityText != \"Low\" and isnotempty(User)        | join kind= leftsemi AuditConfiguration on SystemID, MessageID        | project-away            AuditClassID,            AlertSeverityText,            MonitoringObjectName,            MonitorShortName,            AlertValue,            AlertSeverity,            Variable1,            Variable2,            Variable3,            Variable4,            Type,            SystemNumber        | extend HourOfDay= hourofday(TimeGenerated) * 1h + startofday(TimeGenerated));// create time-serieslet TimeSeriesLog = AuditEvents    | where TimeGenerated > ago(LearningTime)    // aggregate by sub net    | extend IPRange = format_ipv4(TerminalIPv6, SelectedPrefixMask)    | make-series Count= count()        on TimeGenerated        from (startofday(ago(LearningTime)) + hourofday(Now) * 1h)to Now step 1h        by        SystemID, MessageID, User, IPRange        | lookup (AuditConfiguration | project SystemID, MessageID, FrequencyThreshold) on SystemID, MessageID;// detect anomalies at aggregated levellet TimeSeriesAlerts= TimeSeriesLog    | extend (anomalies, score, baseline) = series_decompose_anomalies(Count, Threshold= AnomalyThreshold, Seasonality= AnomalySeasonality, Trend= AnomalyTrendKind, Test_points= TestPoints)    // expand to hourly    | mv-expand        Count to typeof(double),        TimeGenerated to typeof(datetime),        anomalies to typeof(double),        score to typeof(double),        baseline to typeof(long)    | where TimeGenerated >= ago(ActualDetectingTime)    // apply anomaly filters + thesholds    | where anomalies > 0    | where score > 2    | where Count > FrequencyThreshold    | project-rename DiscoveredOn= TimeGenerated, AnomalCount= Count    | project        SystemID,        MessageID,        User,        DiscoveredOn,        score,        baseline,        AnomalCount,        FrequencyThreshold    // To reduce false positives, exclude users whos tags in the SAP_User_Config watchlist// match tags in the RolesTagsToExclude column in the SAP_Dynamic_Audit_Log_Monitor_Configuration// tags can be either strings representing a group such as Batch; Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK// or SAP roles such as SAP_BC_TRANSPORT_ADMINISTRATOR, or SAP profiles like SAP_ALL    | lookup AuditConfiguration on MessageID, SystemID    | lookup SAPUsersGottenVIP on User    | lookup SAPUserRolesAndProfiles on User, SystemID    | extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)    | extend TagsIntersect = set_intersect(split(RolesTagsToExclude, \";\"), RolesProfilesAndTags)    | extend IntersectionSize = array_length(TagsIntersect)    // keep only non-excluded users    | where IntersectionSize == 0 or isempty(IntersectionSize)    | project-away MessageText    // fetch detailed data for anomal combinations    | join kind= inner (AuditEvents        | where TimeGenerated > ago(ActualDetectingTime))        on User, SystemID, MessageID, $left.DiscoveredOn == $right.HourOfDay| summarize EventCount= count(), AnomalCount= max(AnomalCount), MinTime= min(TimeGenerated), MaxTime = max(TimeGenerated), Score= max(score), take_any(Instance, MessageClass, ClientID, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, Host, BagOfDetails, DetailedDescription, Threshold, CategoryName, DestinationEmail,  Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, RolesTagsToExclude)by DiscoveredOn, SystemID, MessageText, User, MessageID| extend BagOfDetails = tostring(BagOfDetails);TimeSeriesAlerts"
        },
        {
            "searchKey": "SAPAuditLogConfigRecommend-Parser",
            "displayName": "SAPAuditLogConfigRecommend",
            "functionAlias": "SAPAuditLogConfigRecommend",
            "version": "3.0.0",
            "query": "// This query aims to give configuration recommendations related to the handling of the anomaly detection rules// performed on the SAP audit loglet LearningTime = 14d;// get anomalies from the last 14 dayslet MaterAnoms= materialize(SAPAuditLogAnomalies(DetectingTime= 0h, LearningTime= LearningTime));let UserRolesProfiles= SAPUsersAssignments()| summarize DirectRoles= make_set_if(DirectRoles, isnotempty( DirectRoles), 50) , ChildRoles= make_set_if(ChildRoles, isnotempty( ChildRoles),20), Profiles= make_set_if(Profiles, array_length(Profiles) > 0, 50) by User, SystemID, ClientID= Client| extend Roles= array_concat(DirectRoles, ChildRoles);// overview of all anomalieslet AnomalyCount= MaterAnoms    | summarize Count= count() * 1.00    | extend        Issue= strcat(\"Total Anomalies counted within the last \", format_timespan(LearningTime, 'd'), ' days'),        Recommendation= '',        Sort= 100;// daily averagelet DailyAnomalyCount= MaterAnoms    | summarize Count= count() * (1d / LearningTime)    | extend        Issue= iff(Count > 10, strcat(\"Daily average anomaly count of \", toint(Count), \" is too high\"), strcat(\"Expected daily incident count is \", toint(Count))),        Recommendation= 'Consider the recommendations below to further configure your SAP audit log alerting',        Sort= 90;let NoiseThreshold= max_of(toscalar(DailyAnomalyCount    | project Count) / 10, 10);//  Recommended tags to be addedlet RecommendedTagsToAdd= MaterAnoms    | where isempty(RolesTagsToExclude)    | summarize Count= count() * 1.00 by MessageID    | where Count > NoiseThreshold    | extend        Issue= 'Noisey MessageIDs- add tags',        Recommendation= strcat(\"Create Tags for MessageID \", MessageID, \" using the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),        Sort= 80;// recommended users to assign with tagslet RecommendedTagsPerUser= MaterAnoms    | where isnotempty(RolesTagsToExclude) and tostring(RolesTagsToExclude)!= '[\"nan\"]'    | summarize        Count= count() * 1.00,        Values= make_set_if(RolesTagsToExclude, isnotempty(RolesTagsToExclude) or tostring(RolesTagsToExclude)!= '[\"nan\"]', 50)        by User    | where Count > NoiseThreshold    | extend        Issue= 'Noisey Users',        Recommendation= strcat(\"Add the tags \", tostring(Values), \" to user \", User, \" using the SAP_User_Config watchlist\"),        Sort= 70;// recommended profiles to add to Message IDslet RecommendedProfilesToAdd= MaterAnoms    | join kind= inner UserRolesProfiles on User, SystemID, ClientID    | where array_length(Profiles) > 0    | summarize        Count= count() * 1.00,        Values= make_set(Profiles, 50)        by MessageID    | where Count > NoiseThreshold    | extend        Issue= 'Noisey MessageIDs- add profiles',        Recommendation= strcat(\"Add the Profiles \", tostring(Values),\" as RolesTagsToExclude next to MessageID  \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),        Sort= 60;// recommended Roles to add to Message IDslet RecommendedRolesToAdd= MaterAnoms    | join kind= inner UserRolesProfiles on User, SystemID, ClientID    | where array_length(Roles) > 0    | summarize        Count= count() * 1.00,        Values= make_set(Roles, 50)        by MessageID    | where Count > NoiseThreshold    | extend        Issue= 'Noisey MessageIDs- add roles',        Recommendation= strcat(\"Add the Roles \", tostring(Values),\" as RolesTagsToExclude next to MessageID \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),        Sort= 50;// queryunion AnomalyCount, DailyAnomalyCount, RecommendedTagsPerUser, RecommendedTagsToAdd, RecommendedProfilesToAdd, RecommendedRolesToAdd| order by Sort, Count desc| project IncidentCount= toint(Count), Issue, Recommendation"
        },
        {
            "searchKey": "SAPAuditLogConfiguration-Parser",
            "displayName": "SAPAuditLogConfiguration",
            "functionAlias": "SAPAuditLogConfiguration",
            "version": "3.1.1",
            "query": "// // optional parameters can look like this// let SelectedSystems =  dynamic([\"All Systems\"]);// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);// let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);// // let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);// let SelectedRuleTypes= dynamic([\"Deterministic\"]);// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);// let SelectedSeverities =  dynamic([\"All Severities\"]);let Configuration = materialize(_GetWatchlist('SAP_Dynamic_Audit_Log_Monitor_Configuration')    | where (SelectedSeverities has ProductionSeverity or SelectedSeverities has NonProdSeverity or tostring(SelectedSeverities) == '[\"All Severities\"]')    | where (SelectedRuleTypes has RuleType or tostring(SelectedRuleTypes) == '[\"All RuleTypes\"]')    | summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey    | extend DummyJoinField = 1);let Systems = materialize(SAPSystems(SelectedSystems, SelectedSystemRoles)| project SystemID, SystemRole, SystemUsage, DummyJoinField);let SystemConfigurations =  Configuration    | join kind= inner Systems on DummyJoinField;SystemConfigurations| extend IsProd = iff(SystemRole == \"Production\" , true, false)| extend Severity = iff(IsProd, ProductionSeverity, NonProdSeverity)| extend Threshold = tolong( iff(IsProd, ProductionThreshold, NonProdThreshold))| where (SelectedSeverities has Severity or  tostring(SelectedSeverities) == '[\"All Severities\"]')| extend BagOfDetails = bag_pack('MessageID', MessageID, 'Tactics', Tactics, 'SystemID', SystemID, 'Severity', Severity, 'DestinationEmail', DestinationEmail, 'TeamsChannelID', TeamsChannelID)| extend RolesTagsToExclude = parse_csv(translate(';. ', ',,', RolesTagsToExclude))| extend RolesTagsToExclude= set_difference(RolesTagsToExclude, dynamic([\"nan\",\"\",\" \"]))| summarize RolesTagsToExclude=make_set_if(RolesTagsToExclude, isnotempty( RolesTagsToExclude)), BagOfDetails=make_set(BagOfDetails), Tactics=make_set_if(Tactics, isnotempty( Tactics) and Tactics != \"nan\"), TeamsChannelID=make_set_if(TeamsChannelID, isnotempty( TeamsChannelID) and TeamsChannelID != \"nan\")by CategoryName, MessageID, MessageText, SystemID, SystemRole, SystemUsage, DetailedDescription, Severity, DestinationEmail, IsProd, Threshold, RuleType| extend RolesTagsToExclude= replace_string(translate(',[]\"',@';   ',tostring(RolesTagsToExclude)),' ','')| extend Tactics= translate(',[]\"',@';   ',tostring(Tactics))| extend TeamsChannelID=tostring(TeamsChannelID[0])"
        },
        {
            "searchKey": "SAPCRLog-Parser",
            "displayName": "SAPCRLog",
            "functionAlias": "SAPCRLog",
            "version": "3.1.6",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPCRLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPChangeDocsLog-Parser",
            "displayName": "SAPChangeDocsLog",
            "functionAlias": "SAPChangeDocsLog",
            "version": "3.0.3",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPChangeDocsLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPConnectorHealth-Parser",
            "displayName": "SAPConnectorHealth",
            "functionAlias": "SAPConnectorHealth",
            "version": "3.1.13",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPConnectorHealthQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPConnectorOverview-Parser",
            "displayName": "SAPConnectorOverview",
            "functionAlias": "SAPConnectorOverview",
            "version": "3.0.0",
            "query": "union isfuzzy=trueABAPAppLog_CL,ABAPAuditLog_CL,ABAPCRLogHeader_CL,ABAPCRLogLine_CL,ABAPCRLog_CL,ABAPChangeDocsLog_CL,ABAPFilesLogs_CL,ABAPJobLog_CL,ABAPOS_GW_CL,ABAPOS_ICM_CL,ABAPOS_Syslog_CL,ABAPOS_WP_CL,ABAPSpoolLog_CL,ABAPSpoolOutputLog_CL,ABAPTableDataLog_CL,ABAPWorkflowLog_CL,ABAP_ADCP_CL,ABAP_ADR6_CL,ABAP_AGR_1251_CL,ABAP_AGR_AGRS_CL,ABAP_AGR_DEFINE_CL,ABAP_AGR_FLAGS_CL,ABAP_AGR_PROF_CL,ABAP_AGR_TCODES_CL,ABAP_AGR_USERS_CL,ABAP_DEVACCESS_CL,ABAP_PAHI_CL,ABAP_USGRP_USER_CL,ABAP_USR01_CL,ABAP_USR02_CL,ABAP_USR05_CL,ABAP_USR21_CL,ABAP_UST04_CL,SAP_HeartBeat_CL,SecurityAlert| where Type != 'SecurityAlert'| where TimeGenerated > ago(DaysAgo)| extend SystemID_s= column_ifexists('SystemID_s','No system found')| project TimeGenerated, SystemID_s, Type"
        },
        {
            "searchKey": "SAPFilesLogs-Parser",
            "displayName": "SAPFilesLogs",
            "functionAlias": "SAPFilesLogs",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPFilesLogsQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPGetDataTypes-Parser",
            "displayName": "SAPGetDataTypes",
            "functionAlias": "SAPGetDataTypes",
            "version": "3.0.0",
            "query": "// Function returns all keys and datatypes by default// let DataTypes = dynamic(['All DataTypes']);// let DataKeys = dynamic(['All DataKeys']);// multiple valus are also accepted// let DataTypes = dynamic(['LogonTypes', 'LogonFailureCauses']);// let DataKeys = dynamic(['A', 'B']);// single values are OK too// let DataTypes = dynamic(['LogonType']) ;//single value is also OK// let DataKeys = dynamic(['J']);//single value is also OKlet LogonTypes = datatable(Key: string , Value: string )[\"A\",\"Dialog logon (SAP GUI)\",\"B\",\"Background job start\",\"H\",\"HTTP logon\",\"U\",\"User switch (internal call)\",\"'\",\"' = Password check (API, internal call)\",\"M\",\"SMTP\",\"P\",\"ABAP Push Channel (APC)\",\"E\",\"Build of a shared object area (internal call)\",\"O\",\"AutoABAP (internal call)\",\"T\",\"Server startup procedure (internal call)\",\"V\",\"SAP start service (internal call)\",\"J\",\"JAVA virtual machine (internal call)\",\"W\",\"BGRFC watchdog (internal call)\", \"C\", \"CPIC call\",\"R\",\"external RFC call\",\"F\",\"internal RFC call\",\"S\",\"external RFC system call (function group SRFC\",\"I\",\"internal RFC system call (function group SRFC)\"]| extend DataType = 'LogonType';let LogonFailureCauses = datatable(Key: string , Value: string )[\"0\",\"No error - successful logon\",\"1\",\"Incorrect logon data (client, user name, password)\",\"2\",\"User is locked (by administrator or incorrect logon attempts)\",\"3\",\"As 1 (connection to terminal also terminated)\",\"4\",\"Logon using emergency user SAP* (see SAP Note 2383)\",\"5\",\"Error creating the user buffer (==> may be a follow-on error)\",\"6\",\"User only exists in Central User Administration (CUA)\",\"7\",\"Invalid user type\",\"8\",\"User account is outside its validity period\",\"10\",\"Logon requires Secure Network Communication (SNC)\",\"11\",\"No SAP user exists in the system with this SNC ID\",\"12\",\"ACL entry missing for SNC-secured server-server connection\",\"13\",\"No matching SAP account found for SNC name\",\"14\",\"Ambiguous assignment between SNC name and SAP account\",\"15\",\"Unencrypted SAP GUI connection (was blocked)\",\"20\",\"Logon with logon ticket deactivated in general\",\"21\",\"Syntax error in received logon ticket\",\"22\",\"Check of logon ticket digital signature failed\",\"23\",\"Issuer of logon ticket is not in ACL table\",\"24\",\"Validity of logon ticket has expired\",\"25\",\"Unintended recipient (assertion ticket)\",\"26\",\"Ticket contains empty ABAP user ID\",\"27\",\"Ticket does not match current user\",\"28\",\"Ticket logon deactivated (security policy)\",\"30\",\"Logon by X.509 certificate deactivated in general\",\"31\",\"Syntax error in received X.509 certificate\",\"32\",\"X.509 certificate not from Internet Transaction Server\",\"34\",\"No matching SAP account found for X.509 certificate\",\"35\",\"Ambiguous assignment between X.509 certificate and SAP accounts\",\"36\",\"X.509 certificate rejected due to minimum validity period requirement\",\"40\",\"Logon using external ID deactivated generally\",\"41\",\"No matching SAP account found for external ID\",\"42\",\"Ambiguous assignment between external ID and SAP accounts\",\"50\",\"Logon using a password deactivated generally\",\"51\",\"Initial password not used for too long => no longer valid\",\"52\",\"User does not have a password => password logon not possible\",\"53\",\"Too many failed password logon attempts\",\"54\",\"Productive password not used for too long => no longer valid\",\"60\",\"SPNego logon deactivated\",\"61\",\"Invalid SPNego token (syntax)\",\"62\",\"NTLM token received instead of SPNego token\",\"63\",\"Missing/incorrect KeyTab entry\",\"64\",\"Expired SPNego token (time)\",\"65\",\"SPNego replay attack detected\",\"66\",\"Kerberos user name -> SNC name failed\",\"67\",\"SPNego: No SNC mapping found\",\"68\",\"SPNego: Multiple SNC mappings found\",\"100\",\"Client does not exist\",\"101\",\"Client is currently locked for logons (upgrade running)\",\"999\",\"Other error (see trace)\",\"1002\",\"Trusted system logon: Missing S_RFCACL authorization\"]| extend DataType = 'LogonFailureCause';let LogonMethods = datatable(Key: string , Value: string )[\"P\",\"Password\",\"T\",\"Logon ticket\",\"t\",\"Assertion ticket\",\"X\",\"X.509 certificate\",\"S\",\"SNC\",\"R\",\"RFC ticket\",\"A\",\"Authorized impersonation (background processing)\",\"E\",\"External (EXTID)\",\"U\",\"User switch\",\"s\",\"HTTP security session\",\"2\",\"SAML2\",\"1\",\"SAML1\",\"o\",\"OAuth2\",\"N\",\"SPNego\",\"a\",\"APC session\"]| extend DataType = 'LogonMethod';let UserTypes = datatable(Key: string , Value: string )[\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"]| extend DataType = 'UserType';union LogonTypes, LogonFailureCauses, LogonMethods, UserTypes| where tostring(DataKeys) == '[\"All DataKeys\"]' or Key == DataKeys[0] or (array_length( DataKeys) > 1 and tostring(DataKeys) contains_cs Key)| where tostring(DataTypes) == '[\"All DataTypes\"]' or DataType == DataTypes[0] or (array_length( DataTypes) > 1 and tostring(DataTypes) contains_cs DataType )"
        },
        {
            "searchKey": "SAPGetParameters-Parser",
            "displayName": "SAPGetParameters",
            "functionAlias": "SAPGetParameters",
            "version": "3.0.0",
            "query": "// let ParameterType= 'Static';// let ParameterName= 'UserMDLookBack';let ParametersTable= datatable ( Parameter_Type: string, Parameter_Name: string, \tValueLow: string, ValueHigh: string , ValueOPT:string, ValueSIGN:string, Tags: dynamic )[ 'Static', 'UserMDLookBack', '36h', '', '', '', '','Static', 'UserHeaderAuditLookBack', '3d', '', '', '', '','Static', 'HearbeatTimeAgo', '1d', '', '', '', '','Static', 'SolutionVersion', '3.0.4', '', '', '', ''];ParametersTable| where Parameter_Type==ParameterType or ParameterType == '*'| where  Parameter_Name== ParameterName or ParameterName == '*'| project-rename ParameterName=Parameter_Name, ParameterType= Parameter_Type;"
        },
        {
            "searchKey": "SAPGetSystemParameter-Parser",
            "displayName": "SAPGetSystemParameter",
            "functionAlias": "SAPGetSystemParameter",
            "version": "3.1.7",
            "query": "// we would like to offer a built in default for security related SAP parameters, but also allow customers to add/ modify those// let Parameter= \"auth/tcodes_not_checked\";// let Parameter= \"All parameters\";// these are values which are generatd by the solution, but can be overtaken by the values specified in the \"SAPSystemParameters\" watchlistlet DefaultParametersDT= datatable ( LastUpdatedTimeUTC: datetime, SearchKey: string, Comment: string, EnableAlerts: string, NonProdSeverity: string, NonProdValues: string, Option: string, ParameterName: string, ProductionSeverity: string, ProductionValues: string)[\"2023-02-21 15:20:24.2148582\",\"auth/tcodes_not_checked\",\"Disables Tcode checking for SU53 & SU56 auth analysis\",\"true\",\"High\",\"\",\"\",\"auth/tcodes_not_checked\",\"High\",\"\",\"2023-02-21 15:20:24.2148582\",\"login/create_sso2_ticket\",\"Create SSO tickets on  this  system\",\"true\",\"High\",\"3\",\"\",\"login/create_sso2_ticket\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/password_downwards_compatibility\",\"password downwards compatibility (8 / 40 characters, case-sensitivity)\",\"true\",\"Medium\",\"0\",\"\",\"login/password_downwards_compatibility\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_cpic\",\"Accept insecure CPIC-connections to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_cpic\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/min\",\"Min. required data protection for incoming connections\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/min\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/disable_multi_gui_login\",\"disable multiple sapgui logons (for same SAP account)\",\"true\",\"High\",\"1\",\"\",\"login/disable_multi_gui_login\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/ticket_only_by_https\",\"generate ticket that will only be sent via https\",\"true\",\"Medium\",\"0\",\"\",\"login/ticket_only_by_https\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"auth/object_disabling_active\",\"Value 'N' prohibits disabling of authorization objects\",\"true\",\"High\",\"Y\",\"\",\"auth/object_disabling_active\",\"High\",\"Y\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_lng\",\"Minimum Password Length\",\"true\",\"Medium\",\"6\",\"GE\",\"login/min_password_lng\",\"High\",\"8\",\"2023-02-21 15:20:24.2148582\",\"gw/accept_remote_trace_level\",\"CPIC and RFC: adopt remote trace level?\",\"true\",\"High\",\"0\",\"\",\"gw/accept_remote_trace_level\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"icm/accept_remote_trace_level\",\"Accept external switch of trace level\",\"true\",\"High\",\"0\",\"\",\"icm/accept_remote_trace_level\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/failed_user_auto_unlock\",\"Enable automatic unlock off locked user at midnight\",\"true\",\"Medium\",\"0\",\"\",\"login/failed_user_auto_unlock\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_digits\",\"min. number of digits in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_digits\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_letters\",\"min. number of letters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_letters\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_lowercase\",\"minimum number of lower-case characters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_lowercase\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_uppercase\",\"minimum number of upper-case characters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_uppercase\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/no_automatic_user_sapstar\",\"Control of the automatic login user SAP*\",\"true\",\"Medium\",\"1\",\"\",\"login/no_automatic_user_sapstar\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_change_for_SSO\",\"Handling of password change enforcements in Single Sign-On situations\",\"true\",\"Medium\",\"1\",\"\",\"login/password_change_for_SSO\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/per_day\",\"Maximum size of all security audit files per day\",\"true\",\"Medium\",\"1000000000\",\"\",\"rsau/max_diskspace/per_day\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_gui\",\"Accept insecure SAPGUI logins to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_gui\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_r3int_rfc\",\"Accept insecure internal RFCs on SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_r3int_rfc\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/extid_login_rfc\",\"Enable login with external identity (RFC)\",\"true\",\"Medium\",\"1\",\"\",\"snc/extid_login_rfc\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rfc/reject_expired_passwd\",\"Prevents logon with initial or expired Password via RFC\",\"true\",\"Medium\",\"1\",\"\",\"rfc/reject_expired_passwd\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"gw/logging\",\"settings for gateway logging\",\"true\",\"Medium\",\"ACTION=Ss LOGFILE=gw_log-%y-%m-%d SWITCHTF=day MAXSIZEKB=100\",\"\",\"gw/logging\",\"High\",\"ACTION=Ss LOGFILE=gw_log-%y-%m-%d SWITCHTF=day MAXSIZEKB=100\",\"2023-02-21 15:20:24.2148582\",\"login/accept_sso2_ticket\",\"Accept SSO tickets for this (component) system\",\"true\",\"High\",\"1\",\"\",\"login/accept_sso2_ticket\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_specials\",\"min. number of special characters in passwords\",\"true\",\"Medium\",\"0\",\"\",\"login/min_password_specials\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/local\",\"Maximum space for security audit file\",\"true\",\"Medium\",\"1000000000\",\"GE\",\"rsau/max_diskspace/local\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/per_file\",\"Maximum size of one single security audit file\",\"true\",\"Medium\",\"1000000000\",\"\",\"rsau/max_diskspace/per_file\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"rsau/selection_slots\",\"Number of selection slots for security audit\",\"true\",\"High\",\"10\",\"\",\"rsau/selection_slots\",\"High\",\"10\",\"2023-02-21 15:20:24.2148582\",\"rspo/auth/pagelimit\",\"Activation of page limit check for spool devices\",\"true\",\"High\",\"0\",\"\",\"rspo/auth/pagelimit\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/use\",\"Level of data protection for R/3 initiated connections\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/use\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"gw/sim_mode\",\"start simulation mode for reg_info and sec_info\",\"true\",\"Medium\",\"0\",\"\",\"gw/sim_mode\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/fails_to_user_lock\",\"Number of invalid login attempts until user lock\",\"true\",\"Medium\",\"5\",\"LE\",\"login/fails_to_user_lock\",\"High\",\"5\",\"2023-02-21 15:20:24.2148582\",\"login/multi_login_users\",\"list of exceptional users: multiple logon allowed\",\"true\",\"Medium\",\"\",\"\",\"login/multi_login_users\",\"High\",\"\",\"2023-02-21 15:20:24.2148582\",\"rsau/enable\",\"Enable Security Audit\",\"true\",\"High\",\"1\",\"\",\"rsau/enable\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"snc/extid_login_diag\",\"Enable login with external identity (DIAG)\",\"true\",\"Medium\",\"1\",\"\",\"snc/extid_login_diag\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"wdisp/ssl_encrypt\",\"SSL reencryption mode\",\"true\",\"High\",\"1\",\"\",\"wdisp/ssl_encrypt\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"gw/acl_mode\",\"Mode for non existing ACL file\",\"true\",\"High\",\"1\",\"\",\"gw/acl_mode\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"auth/no_check_in_some_cases\",\"Activation of the Profile Generator\",\"true\",\"High\",\"Y\",\"\",\"auth/no_check_in_some_cases\",\"High\",\"Y\",\"2023-02-21 15:20:24.2148582\",\"gw/monitor\",\"Enables or disables monitor commands\",\"true\",\"Medium\",\"1\",\"\",\"gw/monitor\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/fails_to_session_end\",\"Number of invalid login attempts until session end\",\"true\",\"Medium\",\"3\",\"LE\",\"login/fails_to_session_end\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_diff\",\"min. number of chars which differ between old and new password\",\"true\",\"Medium\",\"1\",\"LE\",\"login/min_password_diff\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/password_compliance_to_current_policy\",\"current password needs to comply with current password policy\",\"true\",\"Medium\",\"0\",\"\",\"login/password_compliance_to_current_policy\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/password_expiration_time\",\"Dates until password must be changed\",\"true\",\"Medium\",\"180\",\"LE\",\"login/password_expiration_time\",\"High\",\"90\",\"2023-02-21 15:20:24.2148582\",\"login/password_max_idle_initial\",\"maximum #days a password (set by the admin) can be unused (idle)\",\"true\",\"Medium\",\"7\",\"LE\",\"login/password_max_idle_initial\",\"High\",\"7\",\"2023-02-21 15:20:24.2148582\",\"rdisp/gui_auto_logout\",\"Maximum idle time for SAP GUI connections\",\"true\",\"Medium\",\"5400\",\"LE\",\"rdisp/gui_auto_logout\",\"High\",\"3600\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_rfc\",\"Accept insecure RFC-connections to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_rfc\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/max\",\"Limit for data protection of Secure Network Comm.\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/max\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"snc/enable\",\"Enable SNC-Module (Secure Network Communications)\",\"true\",\"Medium\",\"1\",\"\",\"snc/enable\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rfc/ext_debugging\",\"Remote Function call debugging. See SAP KB 2909642 - Deletion of parameter rfc/ext_debugging\",\"true\",\"Medium\",\"2\",\"LE\",\"rfc/ext_debugging\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"auth/rfc_authority_check\",\"Execution option for the RFC authority check\",\"true\",\"High\",\"1\",\"GE\",\"auth/rfc_authority_check\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_change_waittime\",\"Password change possible after # days (since last change)\",\"true\",\"Medium\",\"1\",\"GE\",\"login/password_change_waittime\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_history_size\",\"Number of records to be stored in the password history\",\"true\",\"Medium\",\"5\",\"GE\",\"login/password_history_size\",\"High\",\"5\"];let CustomersParameters= _GetWatchlist(\"SAPSystemParameters\")| project-away _DTItemId| summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey| where SearchKey == Parameter or Parameter contains \"All parameters\"| extend Priority= 1;let DefaultParameters= DefaultParametersDT| where SearchKey == Parameter or Parameter contains \"All parameters\"| extend Priority = 2;let RelevantParams= (CustomersParameters | union DefaultParameters| summarize arg_min(Priority, *) by SearchKey| extend Source= iff(Priority==1, \"'SAPSystemParameters' watchlist\", \"Sentinel built-in content\")| extend EnableAlerts= tolower(EnableAlerts)| extend EnableAlerts= iff(EnableAlerts == \"true\", true, false), DummyJoinField= 1);RelevantParams | join kind= inner SAPSystems() on DummyJoinField| extend Severity= iff(SystemRole == \"Production\", ProductionSeverity, NonProdSeverity)| extend ExpectedValue= iff(SystemRole == \"Production\", ProductionValues, NonProdValues)| project-away DummyJoinField1, SearchKey1, ProductionSeverity, NonProdSeverity, ProductionValues, NonProdValues, Priority| extend ExpectedNumeric= extract(\"([0-9.]+)\", 1, replace(\",\",\".\", ExpectedValue), typeof(real))| extend ExpectedAlpha= extract(\"([A-Z]+[a-z])\", 1, ExpectedValue, typeof(string))"
        },
        {
            "searchKey": "SAPHeartBeat-Parser",
            "displayName": "SAPHeartBeat",
            "functionAlias": "SAPHeartBeat",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPHeartBeatQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPJAVAFilesLogs-Parser",
            "displayName": "SAPJAVAFilesLogs",
            "functionAlias": "SAPJAVAFilesLogs",
            "version": "3.2.0",
            "query": "//generated function structure for custom log JAVAFilesLogs_CLlet EmptyColValue = '';let D_JAVAFilesLogs_CL = datatable(TimeGenerated:datetime,Text:string,DSRRootContextID:string,DSRConnection:string,SystemID:string,Guid: string,SidGuid: string,FileName:string,Instance:string,Version:string,Time:datetime,SourceName:string,MsgType:string,MsgCode:string,ResourceBundle:string,Transaction:string,Application:string,Location:string,DCComponent:string,CSNComponent:string,User:string,Session:string,CorrelationId:string,DSRCounter:string,ThreadName:string,TZone:string,Severity:string)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];let T_JAVAFilesLogs_CL = (SAPCONTROL_CL | projectTimeGenerated = column_ifexists('TimeGenerated', datetime(null)),DSRRootContextID = coalesce(column_ifexists('DSRRootContextID_s', EmptyColValue), column_ifexists('DSRRootContextID_g', EmptyColValue)),DSRConnection = coalesce(column_ifexists('DSRConnection_s', EmptyColValue), column_ifexists('DSRConnection_g', EmptyColValue)),Guid= coalesce(column_ifexists('Guid_s', EmptyColValue), column_ifexists('Guid_g', EmptyColValue)),SystemID = column_ifexists('SystemID_s', EmptyColValue),FileName = column_ifexists('FileName_s', EmptyColValue),Instance = column_ifexists('Instance_s', EmptyColValue),Version = column_ifexists('Version_s', EmptyColValue),Time = column_ifexists('Time_t', datetime(null)),SourceName = column_ifexists('SourceName_s', EmptyColValue),MsgType = column_ifexists('MsgType_s', EmptyColValue),MsgCode = column_ifexists('MsgCode_s', EmptyColValue),ResourceBundle = column_ifexists('ResourceBundle_s', EmptyColValue),Text = column_ifexists('Text_s', EmptyColValue),Transaction = column_ifexists('Transaction_s', EmptyColValue),Application = column_ifexists('Application_s', EmptyColValue),Location = column_ifexists('Location_s', EmptyColValue),DCComponent = column_ifexists('DCComponent_s', EmptyColValue),CSNComponent = column_ifexists('CSNComponent_s', EmptyColValue),User = column_ifexists('User_s', EmptyColValue),Session = column_ifexists('Session_s', EmptyColValue),CorrelationId = column_ifexists('CorrelationId', EmptyColValue),DSRCounter = column_ifexists('DSRCounter_s', EmptyColValue),ThreadName = column_ifexists('ThreadName_s', EmptyColValue),TZone = column_ifexists('TZone_s', EmptyColValue),Severity = column_ifexists('Severity_s', EmptyColValue),SidGuid = coalesce(column_ifexists('SidGuid_g',column_ifexists('SidGuid_s',EmptyColValue)), EmptyColValue),Type = column_ifexists('Type', EmptyColValue));let Source= T_JAVAFilesLogs_CL | union isfuzzy= true D_JAVAFilesLogs_CL| where SystemID != 'initialString';Source| parse Text with * \"LOGIN.\" _Login \"\\n\" * \"IP Address: \" _IP_Address \"\\n\" *| extend Text= split(Text, '\\n')"
        },
        {
            "searchKey": "SAPJobLog-Parser",
            "displayName": "SAPJobLog",
            "functionAlias": "SAPJobLog",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPJobLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPOS_GW-Parser",
            "displayName": "SAPOS_GW",
            "functionAlias": "SAPOS_GW",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPOS_GWQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPOS_ICM-Parser",
            "displayName": "SAPOS_ICM",
            "functionAlias": "SAPOS_ICM",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPOS_ICMQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPOS_SAPCONTROL-Parser",
            "displayName": "SAPOS_SAPCONTROL",
            "functionAlias": "SAPOS_SAPCONTROL",
            "version": "3.0.0",
            "query": "//generated function structure for custom log ABAPOS_SAPCONTROL_CLlet D_ABAPOS_SAPCONTROL_CL = datatable(TimeGenerated:datetime,System:string,MessageText:string,Type:string)[];let T_ABAPOS_SAPCONTROL_CL = (ABAPOS_SAPCONTROL_CL | projectTimeGenerated = TimeGenerated,System = System_s,MessageText = MessageText_s,Type = Type);T_ABAPOS_SAPCONTROL_CL | union isfuzzy= true D_ABAPOS_SAPCONTROL_CL| extend SplitMessage= split(MessageText, \"\\t\")| extend Severity= SplitMessage[1]| extend LogType= SplitMessage[2]| extend SplitDateTime= split(tostring(SplitMessage[0]), \" \")| extend UpdatedOn= todatetime(strcat(SplitDateTime[0],\"-\", SplitDateTime[1], \"-\", SplitDateTime[2],\" \", substring(SplitDateTime[3],0,8), \".\",substring(SplitDateTime[3],9,11)))| extend MessageText= strcat_array(array_slice(SplitMessage, 3, -1),\"\")| project-away SplitMessage, SplitDateTime"
        },
        {
            "searchKey": "SAPOS_Syslog-Parser",
            "displayName": "SAPOS_Syslog",
            "functionAlias": "SAPOS_Syslog",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPOS_SyslogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPOS_WP-Parser",
            "displayName": "SAPOS_WP",
            "functionAlias": "SAPOS_WP",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPOS_WPQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPSpoolLog-Parser",
            "displayName": "SAPSpoolLog",
            "functionAlias": "SAPSpoolLog",
            "version": "3.1.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPSpoolLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPSpoolOutputLog-Parser",
            "displayName": "SAPSpoolOutputLog",
            "functionAlias": "SAPSpoolOutputLog",
            "version": "3.1.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPSpoolOutputLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPSyslog-Parser",
            "displayName": "SAPSyslog",
            "functionAlias": "SAPSyslog",
            "version": "3.0.0",
            "query": "//generated function structure for custom log Syslog//generated on 2022-05-07//Sentinel4SAP solution version 1.2.98let D_Syslog = datatable(TimeGenerated:datetime,EventTime:datetime,Facility:string,HostName:string,SeverityLevel:string,SyslogMessage:string,ProcessID:int,HostIP:string,ProcessName:string,Type:string)['1000-01-01T00:00:00Z','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1,'initialString','initialString','initialString'];let T_Syslog = (Syslog | projectTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z'),EventTime = column_ifexists('EventTime', '1000-01-01T00:00:00Z'),Facility = column_ifexists('Facility', 'initialString'),HostName = column_ifexists('HostName', 'initialString'),SeverityLevel = column_ifexists('SeverityLevel', 'initialString'),SyslogMessage = column_ifexists('SyslogMessage', 'initialString'),ProcessID = column_ifexists('ProcessID', 1),HostIP = column_ifexists('HostIP', 'initialString'),ProcessName = column_ifexists('ProcessName', 'initialString'),Type = column_ifexists('Type', 'initialString'));T_Syslog | union isfuzzy= true (D_Syslog  | where TimeGenerated != '1000-01-01T00:00:00Z')"
        },
        {
            "searchKey": "SAPSystems-Parser",
            "displayName": "SAPSystems",
            "functionAlias": "SAPSystems",
            "version": "3.1.9",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPSystemsQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPTableDataLog-Parser",
            "displayName": "SAPTableDataLog",
            "functionAlias": "SAPTableDataLog",
            "version": "3.0.3",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPTableDataLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPThreatIntelligenceIndicator-Parser",
            "displayName": "SAPThreatIntelligenceIndicator",
            "functionAlias": "SAPThreatIntelligenceIndicator",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPThreatIntelligenceIndicatorQuery'),'CWSQSOC.', variables('_Reserved_CWSQSOCIdentifier'))]"
        },
        {
            "searchKey": "SAPUsersAssignments-Parser",
            "displayName": "SAPUsersAssignments",
            "functionAlias": "SAPUsersAssignments",
            "version": "3.0.3",
            "query": "// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);// let SelectedSystems = dynamic([\"All Systems\"]); // can also do // let SelectedSystems = dynamic([\"BIP\", \"C4D\"]);let UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));// only show users which are not locked for over 180 days (for performance considerations)let agoLocked = format_datetime(ago(180d), 'yyyyMMdd');let Systems= SAPSystems(SelectedSystemRoles= SelectedSystemRoles, SelectedSystems=SelectedSystems)    | project SystemID= SearchKey, SystemRole, SystemUsage    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');// get assignments from change documentslet UserMDUpdates= SAP_AGR_USERS | where TimeGenerated > ago(UserMDTimeAgo)| where SystemID in (Systems)| summarize LastSynched= max(TimeGenerated) by SystemID, ClientID=MANDT;let RoleAssignments =SAPChangeDocsLog| where TimeGenerated > ago(UserMDTimeAgo)| where SystemID in (Systems)| where UpdatedOn_t > ago(UserMDTimeAgo)| where (ObjectClass == \"PFCG\" and TableName == \"AGR_USERS\")| extend UserAssigned = trim_end(@\"[^\\w]+\" ,extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey))| project-rename Role=ObjectID, ChangedOn= UpdatedOn_t;let ProfileAssignments =SAPChangeDocsLog| where TimeGenerated > ago(UserMDTimeAgo)| where SystemID in (Systems)| where UpdatedOn_t > ago(UserMDTimeAgo)| where (ObjectClass == \"IDENTITY\" and TableName == \"SUSR_UST04\")| extend UserAssigned = ObjectID| project-rename ChangedOn= UpdatedOn_t;let UserRecordChanges= SAPAuditLog| where TimeGenerated> ago(UserMDTimeAgo + 1h)| where SystemID in (Systems)| where MessageID == \"AUB\" or MessageID == \"AUD\"| where ingestion_time() > ago(UserMDTimeAgo)| project-rename ChangedOn= UpdatedOn_t| distinct ChangedOn, TerminalIPv6, User, Host, Email, UserAssigned=Variable1;let Assignments= UserRecordChanges| join kind=inner (RoleAssignments | union ProfileAssignments) on User, ChangedOn| extend Profile= iff(TableName == \"SUSR_UST04\", ChangedTableKey, \"\")| summarize LastChangedOn=arg_max(ChangedOn, *)by UserAssigned, Role, Profile, SystemID, ClientID| lookup UserMDUpdates on SystemID, ClientID| where LastChangedOn > LastSynched // drop the updates that are already included in user MD synch| summarize AddedProfiles=make_set_if(Profile,isnotempty(Profile) and TypeofChange_Item in(dynamic([\"I\", \"U\", \"J\"]))), RemovedProfiles=make_set_if(Profile,isnotempty(Profile) and TypeofChange_Item in(dynamic([\"E\", \"D\"]))), AddedRoles=make_set_if(Role,isnotempty(Role) and TypeofChange_Item in(dynamic([\"I\", \"U\", \"J\"]))), RemovedRoles=make_set_if(Role,isnotempty(Role) and TypeofChange_Item in(dynamic([\"E\", \"D\"])))by User= UserAssigned, SystemID, ClientID| extend Source= \"ChangeDocs\";// get logon Data (Kernel-Side Use)SAP_USR02 | where TimeGenerated > ago(UserMDTimeAgo)| where SystemID in (Systems)| extend Relevant= strcmp( GLTGB, agoLocked) > 0 or GLTGB == \"00000000\"| where Relevant| summarize any(ERDAT), arg_max(TimeGenerated, CLASS, UFLAG, TZONE, USTYP, TRDAT, LTIME, ERDAT) by BNAME, MANDT, SystemID// get profiles| join kind=leftouter (SAP_UST04| where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, *), profiles = make_set(PROFILE, 50) by BNAME, MANDT, SystemID)on BNAME, MANDT, SystemID// get Assignment of roles to users| join kind=leftouter hint.strategy=shuffle (SAP_AGR_USERS | where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, UNAME, AGR_NAME, MANDT, SystemID, COL_FLAG) by UNAME, AGR_NAME, MANDT, SystemID, COL_FLAG// get the child roles as well| join kind= leftouter   (SAP_AGR_AGRS | where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, MANDT, AGR_NAME, CHILD_AGR, SystemID) by MANDT, AGR_NAME, CHILD_AGR, SystemID)on MANDT, SystemID, AGR_NAME| summarize DirectRoles = make_set_if(AGR_NAME, COL_FLAG != 'X',  50),// COL_FLAG==X -> indirectChildRoles = make_set_if(CHILD_AGR, isnotempty(CHILD_AGR) ,50)by UNAME, MANDT, SystemID)on $left.BNAME == $right.UNAME, $left.MANDT == $right.MANDT, $left.SystemID == $right.SystemID// get User Name/Address Key Assignment| join kind=leftouter hint.strategy=shuffle ( (SAP_USR21 | where TimeGenerated > ago(UserMDTimeAgo)| summarize arg_max(TimeGenerated, BNAME, ADDRNUMBER, PERSNUMBER) by BNAME, MANDT, SystemID )// get E-Mail Addresses| join kind= inner hint.strategy=shuffle (SAP_ADR6| where TimeGenerated > ago(UserMDTimeAgo) | summarize arg_max(TimeGenerated, ADDRNUMBER, SMTP_ADDR) by CLIENT, ADDRNUMBER, PERSNUMBER, DATE_FROM, CONSNUMBER, SystemID)on $left.ADDRNUMBER == $right.ADDRNUMBER, $left.MANDT == $right.CLIENT, $left.SystemID == $right.SystemID, $left.PERSNUMBER == $right.PERSNUMBER| summarizearg_max(TimeGenerated1, SMTP_ADDR, MANDT, SystemID),arg_max(TimeGenerated, BNAME, MANDT, SystemID)by BNAME, MANDT, SystemID)on $left.BNAME == $right.BNAME, $left.MANDT == $right.MANDT, $left.SystemID == $right.SystemID| extend LastSeen = todatetime(strcat(TRDAT, LTIME))| extend CreatedOn = todatetime(ERDAT)| project-rename User= BNAME, ClientID = MANDT| join kind=fullouter Assignments on SystemID, User, ClientID| extend User= coalesce(User, User1)| extend DirectRoles= set_difference(set_union(DirectRoles, AddedRoles),RemovedRoles)| extend ChildRoles= set_difference(ChildRoles,RemovedRoles)| extend Profiles= set_difference(set_union(profiles, AddedProfiles), RemovedProfiles)| project User, Email = SMTP_ADDR, UserType = USTYP, Timezone = TZONE, LockedStatus = UFLAG, LastSeen, UserGroupAuth = CLASS, Profiles, DirectRoles, ChildRoles, CreatedOn, Client= ClientID, SystemID = SystemID, AddedRoles, RemovedRoles, AddedProfiles, RemovedProfiles, Roles=set_union(DirectRoles, ChildRoles), Source=coalesce(Source,\"UserMD\")"
        },
        {
            "searchKey": "SAPUsersAuthorizations-Parser",
            "displayName": "SAPUsersAuthorizations",
            "functionAlias": "SAPUsersAuthorizations",
            "version": "3.1.13",
            "query": "// get the relevant user MD load frequencylet UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));// let SnapshotAge= 0d;// allow to go back in time and see user MD snapshotslet MaxLength= 256;let Star= '*';let ValidityDate= toint(toint(format_datetime(ago(UserMDTimeAgo+ SnapshotAge), 'yyyyMMdd')));let StarArray= todynamic(strcat('[\"', Star, '\"]'));// get the user role assignments, including child roleslet UserRoles= materialize((SAP_AGR_USERS| where TimeGenerated between (ago(UserMDTimeAgo+ SnapshotAge).. ago(SnapshotAge))// filter out obsolete assignments| where toint(TO_DAT)>= ValidityDate| summarizearg_max(TimeGenerated, UNAME, AGR_NAME, MANDT, SystemID)by UNAME, AGR_NAME, MANDT, SystemID// get the child roles as well| join kind= leftouter (SAP_AGR_AGRS| where TimeGenerated between (ago(UserMDTimeAgo+ SnapshotAge).. ago(SnapshotAge))| summarize arg_max(TimeGenerated, AGR_NAME) by CHILD_AGR, MANDT,SystemID)on MANDT, SystemID, AGR_NAME// Role is the lowest level| extend Role = iff(isempty(CHILD_AGR), AGR_NAME, CHILD_AGR)| distinct UNAME, MANDT, SystemID, Role));let Auths= SAP_AGR_1251| where TimeGenerated between (ago(UserMDTimeAgo+ SnapshotAge).. ago(SnapshotAge))// filter out obsolete assignments| joinhint.shufflekey = SystemID hint.shufflekey= AGR_NAMEkind=leftsemi(UserRoles | distinct AGR_NAME= Role, SystemID, MANDT) on AGR_NAME, SystemID, MANDT| summarizeEQs= make_set(LOW, MaxLength), Highs=make_set(HIGH, MaxLength/2), HasStar= anyif(true, LOW == Star or HIGH == Star)by AGR_NAME, MANDT, SystemID, OBJECT, FIELD| extend EQs= iff(HasStar, StarArray, set_union(EQs, Highs))| project-away Highs;Auths| joinhint.shufflekey = SystemID hint.shufflekey= AGR_NAMEkind=inner UserRoles onMANDT, SystemID, $left.AGR_NAME== $right.Role| summarizehint.shufflekey = SystemID hint.shufflekey= UNAMEEQs=make_set(EQs, MaxLength) by ClientID = MANDT, SystemID, User=UNAME, Object=OBJECT, Field= FIELD| extend EQs= iff(EQs contains Star, StarArray, EQs)"
        },
        {
            "searchKey": "SAPUsersEmail-Parser",
            "displayName": "SAPUsersEmail",
            "functionAlias": "SAPUsersEmail",
            "version": "3.0.0",
            "query": "let UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));// older agents have to use USR21 to get the ADDRNUMBER, PERSNUMBER before getting the email address from ADR6let AgentEmailsV1= SAP_USR21 | where TimeGenerated > ago(UserMDLookBack)| summarize arg_max(TimeGenerated, ADDRNUMBER, PERSNUMBER) by BNAME, MANDT, SystemID| project-rename CLIENT= MANDT| join kind= leftouter hint.strategy=shuffle(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)| summarize arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR) on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT| project SystemID, ClientID= CLIENT, User= BNAME, Email= iff(isempty(SMTP_ADDR), BNAME, SMTP_ADDR)| summarize Email= anyif(Email, isnotempty(Email) ) by ClientID, SystemID, User;// agents from version 60075287 have the join of USR21 and ADR6 performedlet AgentEmailsV2= SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)| summarize arg_max(TimeGenerated, SMTP_ADDR) by BNAME, ClientID= CLIENT, SystemID| project SystemID, ClientID, User= BNAME, Email= iff(isempty(SMTP_ADDR), BNAME, SMTP_ADDR)| summarize Email= anyif(Email, isnotempty(Email) ) by ClientID, SystemID, User;AgentEmailsV1 | union AgentEmailsV2"
        },
        {
            "searchKey": "SAPUsersGetPrivileged-Parser",
            "displayName": "SAPUsersGetPrivileged",
            "functionAlias": "SAPUsersGetPrivileged",
            "version": "3.1.9",
            "query": "// this function returns privilileged user by default but can also return sensitive users// let IncludeSensitiveUsers= false;// can also do IncludeSensitive= true which will include users with sensitive profiles// privileged users are users which are directly named as suchlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');let FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];// privileged users can also be such that carry a privileged rolelet fixedRoles = datatable(Role: string) [\"SAP_BC_BASIS_ADMIN\", \"SAP_BC_AUTH_PROFILE_ADMIN\"];// privileged users can also be such that carry a privileged profilelet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];let AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));let availableSystems= (SAPAuditLog| where TimeGenerated > ago(AuditTimeAgo)| distinct SystemID, Client= ClientID)// uncomment this if you have SAPControl interface for SAP AS JAVA instance// | union (SAPJAVAFilesLogs// | where TimeGenerated > ago(AuditTimeAgo)// | extend SystemID= column_ifexists(\"SystemID\", \"\")// | distinct SystemID )| extend dummy =\"\";// get the user assignments to roles and profileslet UserAssignments= materialize(SAPUsersAssignments() | project User, ChildRoles, DirectRoles, Profiles, Client, SystemID);// privileged userslet PrivUsersByMD = UserAssignments| mv-expand ChildRoles, DirectRoles, Profiles| where DirectRoles in (fixedRoles) or ChildRoles in (fixedRoles) or Profiles in (fixedProfiles)| summarize by User, Client, SystemID| extend IsPrivileged= true;// cross join watchlist users with available systems and clientslet FixedUPriv = ((PrivelegedUsers    | union isfuzzy=true  FixedUsers    | summarize by User    | extend dummy = '')    | join kind= fullouter availableSystems        on $left.dummy == $right.dummy)    | extend IsPrivileged= true;FixedUPriv| union isfuzzy=true PrivUsersByMD, FixedUsers| where Client != \"XXX\"| summarize by User, Client, SystemID"
        },
        {
            "searchKey": "SAPUsersGetSensitive-Parser",
            "displayName": "SAPUsersGetSensitive",
            "functionAlias": "SAPUsersGetSensitive",
            "version": "3.0.0",
            "query": "// this function returns privilileged and sensitive users// privileged users are users which are directly named as suchlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');let FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];// privileged users can also be such that carry a privileged rolelet fixedRoles = datatable(Role: string) ['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];// privileged users can also be such that carry a privileged profilelet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];// sensitive users are such that hold a sensitive role:let SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize by SearchKey;// or a sensitive profile:let SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize by SearchKey;// get SAP systems which are relevantlet AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));let availableSystems= SAPAuditLog| where TimeGenerated > ago(AuditTimeAgo)| summarize by SystemID, Client= ClientID| extend dummy ='';// get the user assignments to roles and profileslet UserAssignments= materialize(SAPUsersAssignments() | project User, ChildRoles, DirectRoles, Profiles, Client, SystemID);// privileged userslet PrivUsersByMD = UserAssignments| mv-expand ChildRoles, DirectRoles, Profiles| where DirectRoles in (fixedRoles) or ChildRoles in (fixedRoles) or Profiles in (fixedProfiles)| summarize by User, Client, SystemID| extend IsPrivileged= true;// sensitive userslet SensitiveUsersByMD = UserAssignments| project User, ChildRoles, DirectRoles, Profiles, Client, SystemID| mv-expand ChildRoles, DirectRoles, Profiles| where DirectRoles in (SensRoles) or ChildRoles in (SensRoles) or Profiles in (SensProfiles)| summarize by User, Client, SystemID| extend IsPrivileged= false;// cross join watchlist users with available systems and clientslet FixedUPriv = ((PrivelegedUsers    | union isfuzzy=true  FixedUsers    | summarize by User    | extend dummy = '')    | join kind= fullouter availableSystems        on $left.dummy == $right.dummy)    | extend IsPrivileged= true;FixedUPriv| union isfuzzy=true PrivUsersByMD, SensitiveUsersByMD, FixedUsers| where Client != \"XXX\"| summarize IsPrivileged= max(IsPrivileged) by User, Client, SystemID"
        },
        {
            "searchKey": "SAPUsersGetVIP-Parser",
            "displayName": "SAPUsersGetVIP",
            "functionAlias": "SAPUsersGetVIP",
            "version": "3.1.10",
            "query": "// function gets tags which can either be SAP roles, SAP Profiles or tags.// let SearchForTags= dynamic(['FireFighters', 'ContainsBoth', 'T-Z1220435']);// // let SearchForTags= todynamic('All Tags');// let SpecialFocusTags = split('SpecialAttention; SoonToLeave', ';');// get the SAP roles / SAP profiles that are relevantlet SAPUserRolesAndProfiles = SAPUsersAssignments| where (tostring(SearchForTags) == 'All Tags' or Profiles has_any (SearchForTags) or ChildRoles has_any (SearchForTags) or DirectRoles has_any (SearchForTags))| project-keep User, SystemID, DirectRoles, ChildRoles, Profiles| summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 1000) by SAPUser= User| extend SearchKey= SAPUser;let UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));let WildCards= materialize(_GetWatchlist('SAP_User_Config')| where SearchKey startswith '*' or SearchKey endswith '*' and SearchKey != 'SAP*'| extend SearchKind= case(SearchKey startswith '*' and SearchKey endswith '*', 'Both', SearchKey startswith '*', 'EndsWith', 'StartsWith')| extend SearchTerm= replace_string(SearchKey,'*','')| extend DummyJoinField= 1);let UsersFromWildCards= SAP_USR01| where TimeGenerated > ago(UserMDTimeAgo)| project SAPUser=BNAME// uncomment this if you have SAPControl interface for SAP AS JAVA instance// | union (SAPJAVAFilesLogs | where TimeGenerated > ago(UserMDTimeAgo)| project SAPUser= User)| distinct SAPUser| extend DummyJoinField= 1| join kind=inner  WildCards on DummyJoinField| where SAPUser contains SearchTerm and SearchKind == 'Both' orSAPUser startswith SearchTerm and SearchKind == 'StartsWith'or SAPUser endswith SearchTerm and SearchKind == 'EndsWith'| extend SearchKey= SAPUser;_GetWatchlist('SAP_User_Config') | union UsersFromWildCards| extend SearchKey= replace_string(SearchKey, ' ','')// remove spaces| extend Tags = replace_string(Tags, ' ', '')| extend TagsArr= split(Tags,';')| summarize Tags=make_set(Tags, 100), TagsList= make_set(TagsArr, 200), arg_max(LastUpdatedTimeUTC, SAPUser, ['User AAD Object Id'],\t['User Identifier'],\t['User On-Prem Sid'],\t['User Principal Name']) by SearchKey| join kind= fullouter SAPUserRolesAndProfiles on SAPUser| extend SAPUser= iff(isnotempty(SAPUser), SAPUser, SAPUser1)| extend SearchKey= SAPUser| extend TagsList = array_concat(TagsList, RolesAndProfiles)| extend TagsIntersect = set_intersect(TagsList, SearchForTags)| extend SpecialFocusTagged = iff(array_length(set_intersect(TagsList, SpecialFocusTags)) > 0, true, false)| extend IntersectionSize = array_length(TagsIntersect)| extend Tags= replace_string(tostring(Tags),',','; ')| extend Tags= translate('[]\"','', Tags)| where (IntersectionSize > 0 or tostring(SearchForTags) == 'All Tags' or SpecialFocusTagged == true)| project-away LastUpdatedTimeUTC, SAPUser1, SearchKey1| where SearchKey !startswith '*' and not(SearchKey endswith '*' and SearchKey != 'SAP*')"
        },
        {
            "searchKey": "SAPUsersHeader-Parser",
            "displayName": "SAPUsersHeader",
            "functionAlias": "SAPUsersHeader",
            "version": "3.2.02",
            "query": "// // optional parameters can look like this// let SelectedSystems =  dynamic([\"All Systems\"]);// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);// let SelectedUsers = dynamic([\"All Users\"]);// let SelectedUser = \"All Users\";// let AccountNames= dynamic([\"All account names\"]);// // let AccountNames= dynamic([\"All account names\"]);// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);// // let SelectedUsers = dynamic([\"DEVELOPER\",\"DDIC\"]);// // let SelectedUser = \"DDIC\";let UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));let UserHeaderAuditLookBack = totimespan(toscalar(SAPGetParameters('UserHeaderAuditLookBack')| project-keep ValueLow));let Now = now();let Statuses= dynamic({\"0\": \"Not Locked\", \"32\": \"Locked Globally By Administrator\", \"64\": \"Locked Locally By Administrator\", \"128\":\t\"Locked Due To Incorrect Logons (Limited Term)\"});let UserTypes = dynamic({\"A\": \"Dialog\", \"B\": \"System\", \"C\": \"Communications Data\", \"L\": \"Reference (Logon not possible)\", \"S\": \"Service\"});let Systems = materialize (SAPSystems(SelectedSystemRoles= SelectedSystemRoles, SelectedSystems=SelectedSystems)    | project-keep SystemID, SystemRole, SystemUsage);let AuditEvents= materialize(SAPAuditLog()| where TimeGenerated > ago(UserHeaderAuditLookBack)| where SystemID in ((Systems | distinct SystemID))| where Email has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"| summarize  TimeGenerated= arg_max(TimeGenerated, User, ClientID, SystemID, TerminalIPv6, Email) by User, ClientID, SystemID, TerminalIPv6, Email| lookup kind=inner Systems on SystemID| project-rename Client= ClientID);let UserLockUnlockFromAudit= SAPAuditLog| where TimeGenerated > ago(UserHeaderAuditLookBack)| where MessageID == \"AU9\" or MessageID == \"AUA\"| where Email has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"| extend Action= iff(MessageID == \"AUA\", \"unlocked\", \"locked\")| summarize ChangedOn= arg_max(UpdatedOn_t, User, Action) by Variable1, SystemID, Client= ClientID| project-rename User=Variable1, ActingUser=User| extend Details= strcat(\"SAP user \", User, \" was \", Action, \" in system \", SystemID, \" - \", Client, \" by user \", ActingUser);let LastKnownIPs = AuditEvents | where isnotempty(TerminalIPv6)| summarize LastUsedOn= arg_max(TimeGenerated, *) by User, Client, SystemID | project LastKnownIP= TerminalIPv6, User, Client, SystemID;let KnownIPsAndEmails = AuditEvents| summarize Count= count() by User, Client, SystemID, TerminalIPv6, Email| order by Count desc| summarize KnownEmails= make_set_if(Email,isnotempty( Email), 10), KnownIPs = make_set_if(TerminalIPv6, isnotempty(TerminalIPv6), 10)by User, SystemID, Client| extend PrimaryEmail = KnownEmails[0], PrimaryIP= KnownIPs[0];// querySystems | join kind= inner// get logon Data (Kernel-Side Use)(SAP_USR02| where TimeGenerated > ago(UserMDLookBack)| where (BNAME in (SelectedUsers) or tostring( SelectedUsers) == '[\"All Users\"]') and (BNAME == SelectedUser or SelectedUser contains \"All Users\")| summarize StatusDateTime= arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID )on SystemID// get User Name/Address Key Assignment| join kind=leftouter hint.strategy=shuffle(SAP_USR21 | where TimeGenerated > ago(UserMDLookBack) | summarize arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID)on BNAME, MANDT, SystemID| project-rename CLIENT= MANDT// get E-Mail Addresses| join kind= leftouter hint.strategy=shuffle(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)| summarize LastSynched= arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR) on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT| project-rename User= BNAME, Client= CLIENT| extend Priority= 1// fill user per system for clients that only send audit but not user MD| union (AuditEvents | distinct User, SystemID, Client | extend Priority= 2)| order by User, SystemID, Client| summarize arg_min(Priority, *) by User, SystemID, Client| lookup KnownIPsAndEmails on User, SystemID, Client| lookup LastKnownIPs on User, SystemID, Client| extend LastSeen = max_of(todatetime(strcat(TRDAT, LTIME)), column_ifexists(\"LastUsedOn\", datetime(null)))| extend LastSeenDaysAgo = datetime_diff('Day', Now, LastSeen)| extend CreatedOn = todatetime(ERDAT)| extend CreatedDaysAgo = datetime_diff('Day', Now, CreatedOn)| extend ValidFrom= todatetime(GLTGV)| projectLastSynched=max_of(LastSynched, StatusDateTime),User,UserGroup= CLASS,Email = coalesce(SMTP_ADDR, PrimaryEmail),UserType = USTYP,Timezone = TZONE,LockedStatus = UFLAG,LastSeen,LastSeenDaysAgo,PrimaryIP,LastKnownIP,PrimaryEmail,KnownIPs,KnownEmails,Client,SystemID,SystemRole,SystemUsage,CreatedOn,CreatedDaysAgo,ValidFrom,ValidityDate= todatetime(iff(isempty(GLTGB) or GLTGB == \"00000000\", \"99991231\",GLTGB))| lookup UserLockUnlockFromAudit on User, SystemID, Client| extend LockedStatus= case(isempty(Action),trim_start(\" \", LockedStatus),Action==\"unlocked\",\"0\",\"64\")| extend LockedStatusDescription= tostring(Statuses[LockedStatus])| extend UserTypeDescription= tostring(UserTypes[UserType])| extend LastSynched= max_of(LastSynched, ChangedOn)| where PrimaryEmail has_any(AccountNames) or tostring(AccountNames) contains \"All account names\""
        },
        {
            "searchKey": "SAPWSAlertRuleMetaData-Parser",
            "displayName": "SAPWSAlertRuleMetaData",
            "functionAlias": "SAPWSAlertRuleMetaData",
            "version": "3.1.9",
            "query": "let ARMetaDataConfig= _GetWatchlist(\"SAPAlertRulesMetadata\");//// zip it to save space// let PackedConfig= ARMetaDataConfig// | project-away SearchKey, LastUpdatedTimeUTC// | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId)// | extend AllPacked= pack_all()// | summarize AllPacked= make_set(AllPacked)// | project ZippedPacked= zlib_compress_to_base64_string(tostring(AllPacked));// PackedConfiglet ZippedInitialConfig= \"eAHtXWtvG0l2/SsNfckssLWp9yPfNPYa6yDjMcb2JsBiEdx6ycxQpEBS9ipB/ntONSlRksUW5WlZlDMYwGORtLr71uF9nHPr1t/+5+g/X75/vSqnr/PRvxwRD8GYqFmKmjMdvWJBKM5STVn5FAIFfvTHo+MZTS9Wk/TL+bS8odOCf/nu+G3HuleTaelezj/PpnPKJXevFvPTjrqfaDpJk/n5snv9tjvOeVGWy2u/Zvm+nJ5NaVX6ezBVGEkkWPUyMe18YD4XYtmq7LKNNdiIf/xiPlst5tP3F2ft8i/LqqTV5FPBOz9d/Lw42bz9ik4n04t2fyWdLyari1vvv36J917P6nxxSqvJfNYdp7S+uTev372//Ut+KnlC3dvFvL/YfHbzY/3v4upP3P+JG7z1S0nz09MygyHwiTo5OV/018CnjpfdZJYmucxW3Q8fJycfu4ofpri/P7R/CLP2v6zCnPnKmhXGpNNLU07O6MqQ737+j4Hn3b67+2nf0/LXJd7sb3RxCnPSZLr8Y3e8XE5OZu/n7ydlIdvn8H+xXu53P7/YvCC3L/zvH28CKrrCtfeCmWI008FyRkUkpkQqObsgXTFDgPrpfLqanAFU787m82n38/nq7HzV/fkfeLr2ALtRlIRU5LNj1ckKJBNnPnLLIpkiJNdKK3nwKBL3ooimZbHq5rPpRffDdP75bhidboy4bDac9yYs1y34NPDZXuEeDFEhLSJJVskXpm0pzFtuWM6yKq9LpSqGMLS+idP2XZtXeKNlmS0nbZU7PFPZiSCuYiCZKvMAC9OaMosaWAqkjOOiiiTpCwS9XZRPuBANgWhttW7z8vIuLL27usXj89XH+WLy32uD/zSfTVb4cXayA1s3f/cOZIl9/NNeyKIr084rXdl1Y9Y7YPXlo99C114P/qho08HxYk1lyqbINKfIvJEW0Ugny4UweOXr0Ha2mDeHvhNwukjpqyBmTELgo5iYL1XDdSpvouU1JP474O4C3NayzxNzJjhruS6sZmGZllkzj4jPRHVKkq0OWBjC3MuLGZ42db+8etG9LMvVZEabwLIjxXIlBC40c9oC4zZYRGVLcHKOSkqheM6fKDjuiSchx8FTXltugfz2ht0OPCSGIJzQJjJy5JhOuv3NOuZiko57stz6IcD85fjNcffyxyt3haT8dDK7if/duZXMLsVoFKoE4XH1gIDsjWHJqKCIgsjx+ToqOw6wPtKMMlalNy8169Jt4z5PXyVUtTaqxMjYViKiToxOBJa54mRyjuTDEPTeL2i2pD7x7SbL7hzFTfq15J1gU6ZWnapjJXPBdEmSBVkMqzXF6n2NMuivAtsLLNFJ6U6xUCelRZQ74XaxxIN3N1BwP9Zuffz6Fe5CnR4NdautcSfLa6a9A2p3Pf5tsN378I+biXHnbJGBCYU/tIK7C0VnhiwsImZJipSHkPZvk1rSRULxyLr2yhsUXMvuc1mUbgKA9Q8NjgJ+b9k/6E4IuqqsrpRYsoQbCcrA26qIWlIKQ4lSUeLxINh/Yc7mi9VyNLTdX1du2YlTVKvnp3fDbXppYbaks1kzb7PuNeNOZlem/ToI3nj4r0Dbj7ScLO+HWgY9UYpyzAuNFdZBsBBsZsVWwuICcXrQqb2eLRusS/fq/Vtk/AvUQMsu3TDrTnDBheXkAGuhkPtRTSykZBphQhVUmFVUvgpcQ+nYm7L6PF/82jVX8Wn9mXGQNVJaNtnYs67ONta8bcwHJWh3PO7jYcl4bkFdFmY8EgDwBs1tKSTzItoghIoxqiEsNQghn+xmMPllzgA3tbHDThzFrEBXVM5kIWTyoiCn504wx5OWBTVFluKpcLRn7iX5OOgBamBA2G9rvq31Dhc4UirnKqr+Gh2ckAfvHiUSLRGxfvAJmls5GO/mJ4hljSVGVlX+cYZqDbiZrR9hJ26C8yBkkwfBAa+nRYITVNHj0sJZSbLE6MatBfcEzesWfyZ1ktbeh2a5z3nbi4kGeFMDRzQOjqbNoM2eW3NurXm4OCJBOjkEM1E4eKTkOQvZO5Zr1oILi/J+0AF9wJel+9Anj8ve7OdL5E1zmH7R/jrgg5yUoEmlZKXxptqEzJAsBWalEtwYU5ywo/ugNezH8UDcHY2h2zQrrbPvJezXzNdb79J4D4LOF4/3qDl3djwHjUIryxZFAthIn2tA8ZVljNZ6cFND2HkxnTTb3Ewc1nneTtRoaXwyIjPgBQHTcFR4EX+gtKMoeQku64d7oIMq79QosEq9cW9kQunStAdU4e2bc3uTA4FAMkoqFPYqwE1lwTyQp52yxqbBnPtKBGw8+5YXeXU+S5vHyOcDbHuDeSxFgv6sTSCMBqpSICbIaArWBefyuHGv96vfzE/tFeGuZMB5vSLT68aAp5f2e5C7uv2Qj+qtqknVZkgkIRXQoNkWFlrmrY0IeEfz5NwQhH6a4C5mJzcrtUYIwFtfkeqXt4PsI09WLcu6/IbszsW5CZqQv5lMunFW8KKBKvhS0PpCiGyDOzTOav10fZaV0vwcNxIn0y+AeoVBtY9T20+dXi/CjTWYzLACG25+ubE/tRtESnZ6ZfxnyWpZQFV6Q012AX9qlGJBQ/UxHjVb5PBDNNhi8+MC6n33ar5IpfsBgs8fdqIwyZRUaLHcxozM3geG314ZgT3TOdXMXXiSzH48jWc/mio2k9VmsR8g9PzhoJN3XbFOEiR3daWs5Wci0Osa+k5WRoHyHnZplw0zrRVredWLNZB8IQw77lgNtl3FQ3TmorISQHYq6bP3+uj/WZ9M05KXeWu5QxcDJTSQkpA+aela30BpXU6CxVCJp9iEmcGOhTflc7dCcdLYgqYgwxPP1hbvEp2tQMOxRQFiLrpP59NZWWwCQ4uTPa1eVv9eCOxK97cXf/0zkxzZHAdh+vduJ+iKMjmK4JkUGpyntq3TITqw6i5apfEdyF8XH0fB3aMSD/vk+bPyebMecFfb1bi5GDfWAnwpCHj4qX4h/pY+lWvr8FQI3rcOoMqVQyIOcQV0hXCVefDerL2mtQsyWLV3HUCz7ue4nE/hoDpwqPjxipqHIzlZ0G6VxxIKgYA8Mgoo6RqlCYu1etgwU65WRqXT0UE3RYyVkV2rCmg235hzDiXmkpY/uzLlgbtG3tpmLbIrkq3RxYNVIF8tC9xrp42WwdshbB23tV3fMND0stC1n2v3+sUrVAeLT5O0u8wsjmvQuZrJCl4M6CYWFaREaYrtYe/EV9CrB0VuyFGc3ta080W+Zug5HHFdXln5+fEcDj6FFEhY6w0S/qBBsAN8TIHmR0HYgl0ZwuBLWlH3kZYbGi13+bzdM9AYz09O2t+Ot4npDo6fjIG6CGWhTyVtRsWsnGXCJY+8LyUZ/biurd10pGW5rxTYLEyLsde9w2uIxyeLndWn2KtjYh/UZdwnbLum0fLasvnSsNfu/UF+7q6H/wp8vUS+M52fbRB9D8qSTyWBZWdORt1qS1AOtRgUmBWJFgJpkoOebkugvafYVw6TBZZ/46e7Hy/61BDkx4CULY0UNQPaLlQwepSR1ilgHj5YcwXxU/XK5wFHUDFSm+oVmbbqjZl7W1J/D/ECSd10Y8cDD58KSaSP1iBetjZDbYkFgzLRW6NTLbwGNdxm2L53n+bT89PS4uUZKjkk0TSF7bZt0e0r2EFfmy9WA21gpHMpGmpo5WD5dLXIEp0yLEebS9LJED0VtsasU/fxWe2dtVHn9ZpJryzaDHrNngeOMa1FVAGCs4b83TCWmU/IkoSnGlAZUFJ1P8f1C/LUTZDcLVGiJs5RWWSErrTdZToB3AUcmSAPldJZEl/XbnMIvatuZO+FX1/SlUGfab+qq0a1zEtRQDgsBSyoAr+Woouek0qeBgm19caz9/RrmcMgu2Ofyw6/C17J10a2AtDkvGHAlNECzkkS/w780374aSZbbS124B4IlRmvgpCgo9JHaAHvGoKVzKQUkZ3HQn6Qkb/WTN9rKO8XuLnu7Xw6SRf3+qNahC46tpjatn443VgHZOoyKPC9nCpZc1D14cN1Ij8Oqi476tv1V83EZ72FB/3T4ctBqgSfU9Odc3NPPlvmSQYmpS88o1AkOZhiXfH9b2m5hEyR70Vc4iLZ6D2zve5OrjHFXkACTzznRN7HOjr5usHKI/Z83Y+y/cSiSxHgbGPPQXztdmN3PPDjMl2ovWzmlhXKrf4ThSGfAY5UgtyYuES6c7THFrLjH/HjfVRpzdaYkmzbANT2ZLgAWk0axoMyZK0BpTAyn3Dg+8dQ7p89G1I0kjQ5FLCg1PoDS+JIgXmvw5AnVVU05l5C6rLAWPebUtvcms/XotG65b8771srqFtdtvDvhJNWMiSTW68ywi5uqG1/RAIFdlbbwuEHAx187mRG8j/Xq7d+4sPWsmvD9nal61Y9cLxlqT1oBMNi7y1EUiza1lNoinGZB0S64Qrv7ZtyMu+OV2BQdvcxZ68yaK/AXMwIpEjc4ABBWKgI2ZwLJySN3O2wV+Ppk4uJS+iCJ3O6NN637z3dZ0xIMWQqGcu4F62RCwIJccQxLrmq1QlV8jB7eVcSd0/bacVlfAmZKQO1UZMEY5oqGHqllK7IwXJ4xF1dz6vzdO150nfSeRoDt976yECaQxVU4KmjRf2XKOfcpsOkao5+E1f+Eozc/OQeurw1oBIuyVADQpVJAuyqbToRmAqEQymKeCrBef+wN1IeNUiY596az4QzFyZURO7SNn0hmUENz3yxmhHqPKGli5UG5b5b/cvdqiyHeHFXbIqcZ9b25CPsIcJ65SqzxcokK0VbRt6+M2Yb80joudmyfGWxw21cDqXiP69QMRl89U3hLBJqcJ64itYWabXazwOdLXDD09J04ba9BD73Vzgk6tbuufVo0Wy7dWd3Cu689rzJh9R2oerq4ItiYTmAz1S5BP0IuwdH3bmjR3ZEW8M2w/VmpbVRJ7ONSTcW/eYp1b6tpIRKqubKoP43TyRk2xGKqFeV5SJXEJv3SMJfNL4/KMEqxKtsW5kDlDuAPALkCZGu5pirclHn+IiTG9Y3jaBx8m25zL3SqVst7WMmVref+7FHs1UfW3+VkLb1tnjk0FEwm2uSQQRQCYOl3ZY6v91bdY1KH4h9BjEWaVPbBII8TmcWQdezNvcPCnGw2ouj37nzoyvu/GZf1ZZJP6ws/gG5lkagdLzxna6VjU10g6zHTAUi2uRQHge3kL3AZVCGT7ubs3m67ZSxTXt0nxxsJ7vtRKSvIQbjLMs85VZZoKYsJJGcOWjOGWQ7z0fPVV0eqTcmbYx+0+Zbk7NZ+dwiK1039/PUngvKO5UdZ6VY23hyMF8EhSdmLzMXtpIYFHf2bW3ed88jEk3keaDHuBb40nDoTL6CxjfVOikp5mh+b3HeTB75Tbsgn6DTuaDsDI1arY3UBxUK+hP5PC8QhTzZnPUgp/FiWy9cqy7ebquLD0PlgyoUNUG7Ftm1LdwqQ89WgpFDJIaSHZyKz9bvjbUN7ap62FFjPFs3550JLnjLlGo7JyQcXqDU8kFPpJGXcTmYBX7RyTwZkK/JRYrRKka696nJoaoxrcNfKGNMFT7XoyfpZX4MPA10Lt/qUp48XKN+ij7lACmaa0/McgvWXSIO9aMkg62+lKyszIOb1TbMak8GdlA1AI3VVoO8wYXshFCOQqIyKShHEwpjRa1EFQqiYwLnSioZNXKv1qhMx0id71tSdWPGjdp4v0s6CHYjel2i1obVEDzTNao2qaS1keYUUsrJDpeex++6fz3+6/HlvJsXi0JtPGArzj60eTeXaf9OFHHIUhV3gZjXz/lqnVu4NBPS1Qx/WJQbf3DbAQ67oeV/0SdqaElrG25G3mzS+KeA0ANClywyBBD1hUKbG6HhjqAHon4Lvmalla+D7ujFb9kgu5vYSBKeEOK1SK0xWlTVJuJEEHmp7exAcvcI0PoG+2PFSAPevtOdsMibC8qzxtCa1gvIAwu1SgiCpgblkvBxv8Myet1x2cWL7vXbnSCD5i6cLZXlxgxrEP/AF34UgfMQXBVRPM3gt73c13hT3i4b/vpQCLVxcvZQmHzjARG+CuehL4p+QIRL4DtFhIJtrMpcuVztfpTrmtTqB3+vRwbvTrpVJGWslEy1kZLaOVyeamBGeR5TkaaI8R3SqHm3Ho062HCpPUXVz/W+st1TJN8P4OoVOEmFhCm2I5V0thX5r4XEx6ERe0nOqz13CN5iBZq7OekHKR/tHjKZhVLQpp327VANKAYR0icwzDlBvi46x6ODzpXG2hpxd+k/7S04eXB7wzfMt3OlhDhUWLKtcBMut/46LGFw2lif/Hpmxx7wedeWNHVvaYH3V8DPX7abm492j7ctqoJdZzIaMOuQNpnXbTt/kjXkGBN9ZUp0UN1aY6Ns2Zv67NLS253OR8+xb0s6fFlVtKw6ahjQoH5K05ed0oWnwEkNtta0ku7azIaBAy4sCE2LMkDwhPwb9ClSoza0IYWaeOt9j+n5g20sXhOF3nZEw4FtxNkTWQVsEFxYO+YLXJQGG8TIpoRwpWOmVLmNg0INIiKqHxCYg7ucd+JNhypEBpK5AoGgC1Jxr5DdKRSgOmpZbBi5d/lgNzefbSy5e2vz0cFrMbFqqB6mstSGmmrVZu45m5nMjirWMlVP+4XKll790/L23q6+5G7tOAMZlwa1qaIwIMe176dAsCiKxz3UpFEMq+y/rvnmINmpIfd0BZ5+/PLNbV0wZD/k+7BJqgw2SkH0YNy3llLLHYPSp1nytpTIK+S1uB/V+Q43w15vhsR/2A6Jf3PPkHjbV39NU2y3oYtvJ6BQgbpouNMlCytGPpP12QyJb+v7LKfEe6dtbi2e1KaDShPBnzc6XXLHnbHaxB35/MtSCZzJL0OdBjc/cxMXu+Dw5p+P70RC//Jdi//FO9c+P8LK3nyGO1ZyfaXbi9i/eLlu15bm2pJ8uQuYpxodKnLhWvutwDpQRa2lvRaSPGrlPLh782ajyPUNCtdO23oxz7sXzKFERyHuGaeWARkBDdd7BTZcWqcq/E01RwfbRz7+OOytSH/tTK20tuDh9pUrkgl8iocS1XdEElbRcBC7JC0yymqUGxTFbh23vMc5y7nGFCWSG9dUXEgVHlKubmdPCONbU5Hn5TtIXR9+zvJzOmG51JJ0O209tlIXdA7cj5GGGRGMhzKeTRwW5S83j8+gIMNEjdfMX85L746bFZdDZVBWKgRmHWoh7SIYymgF8yAoK0lHoJ++wNLr2ceCp+wpjTuxtOsDG1tv37wzv7j7/S/+7Yhbydc27E14a+Q5XZrvDjhdv5kv8LR966EwuvFv72FnqG3WToVBVEIh3bi6kIVmlnLVWcAyWXxVDNtrJEFBKqpSDCyriqu71gkX4JEoW/ggRNSqR24Lei7x6zfMJhghdj2oOahkqFclc5C8iSAT6AAaJlhWtCq2pFqclvuFr/OIHLxXQId7OLgLtaAsFgXORjspWD98naC1WkEuWGm/v7rmYYNQlmtbxouv6eb4piVNjZWqw9ffKR43gy3wtceP0kVXi3dpkMX7cO3AuO6XcorEYbdX2rfn2hdPwSCeuep8I4PazlBLzBUZEo9eiSQO1jGNNQ9zUdOdvunJz5p5kHvS4FsMymKWe5aYYz2DkY5JHbnh2pSaBw+k/aLRrD9YDfT5cLuikAb1H7J4LtuUlgjyxbeJYTZLpSHDk5YHLp6Od6raM2wxs4LnDD6FGQ9eX0vfdqmFxLKHnhVVlVCTjvZj73Yq8I3XK22E8k4QWR88VARivM+tUzUsltLyfO8zt7l6QYcNopGKtHW74g4dftnb8aB1eKV55fiDCVK57eqFEO6RdacYgxbBC27D0V7iQj94d0mf+taN1RzR7cO7H7u8WC/2jmjWzgcsbVZGDm2SuG5nbzli2UljI4/KlcMfczmOO7ohSvVmbFak82W8NOHTVP37zNsxoQZZuGQmtn277fQ0n3RqxZNyoPxQTQ2C6JaS3v2lCSlDJ4NqQwXpvGTI4YHaSJ61YSssUfBN7+QxfQfDdh5FUf+4te0zPOSRNGRH1HEqGtF2HKIsR8LbuoYyCB0JknswZepnzaX5dLo5kOhjoenqY5c+loFRYJJq4KEEuKYm6beDhqJPjhXPawmV81rj0TMbPDDOMLDmqrbWXBvz0pZPN25gH49FBk6Kw4HYVHhryUEWVWxqY3VUUmRi4GofirLFosXpZDZZth60/Y90tJ64Egi7SPZT29mGJDw6BwdmUvJEWBP67rnJfN14e53HuDH70VORkhpVNorvtqujHYvhfWTEwQ0akuAE2gaPPDzr8tZYii9nogyEPEh6EXm28yq2k/UQY+H1GCJuNcZpMExfoZk/fxd0YwbF8tYklCf1Q3uXdAbff2sVseJK43QgevlcM0PuxMF0Gxn1INW999yJmzt6/0rT892puS2WN4KUUWlTDB21wzpQ4SlLrctaSyd/nz2xx+yJG+992pj8mWzM/vv/ASZSAQk=\";let ExtractedInitialConfig= todynamic(zlib_decompress_from_base64_string(ZippedInitialConfig));// priority 2 is coming from this function to be used as fall back in case we want to add an item without risking overwriting an existing onelet UnpackedConfig= print InitialConfigArr= ExtractedInitialConfig| mv-expand bagexpansion= array InitialConfigArr| evaluate bag_unpack(InitialConfigArr)| extend _DTItemId = tostring(_DTItemId)| extend LastUpdatedTimeUTC= todatetime('20000101')| extend AnalyticsTemplateId = tostring(AnalyticsTemplateId)| extend Source= \"Function\";//  priority 1 is what is there on the watchlist. so when u edit a watchlist and it'll always overwritelet ARMetaData= ARMetaDataConfig| extend AnalyticsTemplateId = tostring(AnalyticsTemplateId)| extend Source= \"Watchlist\"| summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey| project-away SearchKey;let Teams= materialize(_GetWatchlist(\"SAPSolutionConfig\") | where SearchKey  == \"Teams\" | project Team= ConfigKey, TeamsChannel, TeamsGroup, Email);ARMetaData| union UnpackedConfig| summarize arg_max(LastUpdatedTimeUTC, *) by RuleID| lookup Teams on $left.Tier1 == $right.Team| project-rename Tier1TeamsChannel= TeamsChannel, Tier1TeamsGroup= TeamsGroup, Tier1Email= Email| lookup Teams on $left.Tier2 == $right.Team| project-rename Tier2TeamsChannel= TeamsChannel, Tier2TeamsGroup= TeamsGroup, Tier2Email= Email| project-rename ItemId= _DTItemId| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), \"DefaultRule\")| extend PackedDetails= pack_all()"
        },
        {
            "searchKey": "SAPWSAlertsDetailed-Parser",
            "displayName": "SAPWSAlertsDetailed",
            "functionAlias": "SAPWSAlertsDetailed",
            "version": "3.2.02",
            "query": "let AlertsWithEntities= SecurityAlert| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId| project ExtendedProperties, TimeGenerated, SystemAlertId, Entities, DisplayName, StartTime, Tactics=parse_csv(replace_string(Tactics,\" \",\"\"))| extend ExtendedProperties = parse_json(ExtendedProperties)| extend AnalyticRuleId= tostring(todynamic(replace_regex(tostring(ExtendedProperties[\"Analytic Rule Ids\"]), \"\\\\r\", \"\"))[0])| extend AnalyticRuleName= tostring(ExtendedProperties[\"Analytic Rule Name\"])| extend AnalyticsTemplateId= tostring(ExtendedProperties[\"Analytics Template Id\"])| extend BagOfEntities= tostring(ExtendedProperties.Query), SystemAlertId| extend BagOfEntities= tostring(split(BagOfEntities, \"'\",1)[0])| extend BagOfEntities = todynamic(zlib_decompress_from_base64_string(BagOfEntities))// | evaluate bag_unpack(BagOfEntities, ignoredProperties= dynamic([\"TimeGenerated\"]), columnsConflict= \"keep_source\")| mv-expand CustomDetails= parse_json(ExtendedProperties.[\"Custom Details\"])| mv-expand Entities = parse_json(Entities)| project-away ExtendedProperties| extend CustomDetailsReplaced = replace_regex(tostring(CustomDetails), \"\\\\r\", \"\"), AlertDisplayName= tostring(DisplayName), Entities, SystemAlertId, AnalyticRuleName| project-rename AlertStartTime = StartTime| extend SAP_User = tostring(parse_json(tostring(parse_json(CustomDetailsReplaced).SAP_User))[0])| extend Name= parse_json(tostring(Entities.Name))| extend ADAccountT= tostring(iff(Entities.Type == \"account\", Name, \"\"))| extend Address= tostring(parse_json(tostring(Entities.Address)))| extend IPAddressT= tostring(iff(Entities.Type == \"ip\", Address, \"\"))| extend SAPSystemT= tostring(iff(Entities.Type == \"cloud-application\", Name, \"\"))| project-away CustomDetailsReplaced, Entities, Name| summarize take_any(*), ADAccount= take_anyif(ADAccountT, isnotempty(ADAccountT)), IPAddress=take_anyif(IPAddressT, isnotempty( IPAddressT)), SAPSystem= take_anyif(SAPSystemT, isnotempty( SAPSystemT))by SystemAlertId| project-away ADAccountT, IPAddressT, SAPSystemT, CustomDetails| extend AlertRuleUniqueName= column_ifexists(\"AlertRuleUniqueName\",\"\")| project-reorder AnalyticRuleName| lookup (SAPWSAlertRuleMetaData | project AnalyticsTemplateId, RecommendedConfiguration) on AnalyticsTemplateId;AlertsWithEntities"
        },
        {
            "searchKey": "SAPWSIncidentsDetailed-Parser",
            "displayName": "SAPWSIncidentsDetailed",
            "functionAlias": "SAPWSIncidentsDetailed",
            "version": "3.0.0",
            "query": "let DetailedIncidents= SecurityIncident| summarize arg_max(TimeGenerated, *) by IncidentNumber| project-away TenantId, IncidentName, RelatedAnalyticRuleIds| mv-expand AlertIds| extend AlertIds = tostring(AlertIds)| join kind= fullouterSAPWSAlertsDetailedon $left.AlertIds == $right.SystemAlertId| extend IsPrivateIP= ipv4_is_private(IPAddress)| extend Owner = todynamic(Owner.assignedTo)| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))| extend Tactics = set_union(todynamic(AdditionalData.tactics), todynamic(Tactics))| project-away AdditionalData;DetailedIncidents"
        },
        {
            "searchKey": "SAPWorkflowLog-Parser",
            "displayName": "SAPWorkflowLog",
            "functionAlias": "SAPWorkflowLog",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAPWorkflowLogQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAPXalAlerts-Parser",
            "displayName": "SAPXalAlerts",
            "functionAlias": "SAPXalAlerts",
            "version": "3.0.0",
            "query": "//generated function structure for custom log XalAlerts_CL//generated on 2023-02-26//Sentinel4SAP solution version 2.0.56let Colors = dynamic (['Unclear','Green', 'Yellow', 'Red', 'Header',  'Footer']);let D_XalAlerts_CL = datatable(TimeGenerated:datetime,RC:real,ALSYSID:string,MSEGNAME:string,ALUNIQNUM:string,ALINDEX:string,ALERTDATE:string,ALERTTIME:string,DUMMYALIGN:string,SystemID:string,MTMCNAME:string,MTNUMRANGE:string,MTUID:string,MTCLASS:string,MTINDEX:string,EXTINDEX:string,VALUE:real,Severity:int,STATUS:real,OBJECTNAME:string,FIELDNAME:string,ClientID:string,USERID:string,GONEDATE:string,GONETIME:string,GONEDUMMY:string,REPORTEDBY:string,STATCHGDAT:string,STATCHGTIM:string,STATCHGDUM:string,STATCHGBY:string,TIMEOUTDAT:string,TIMEOUTTIM:string,TIMEOUTDUM:string,MSGCLASS:string,MSGID:string,MSGARG1:string,ARGTYPE1:string,MSGARG2:string,ARGTYPE2:string,MSGARG3:string,ARGTYPE3:string,MSGARG4:string,ARGTYPE4:string,MSGTEXT:string,MSG:string,MSCGLID:string,MonitorName:string,MonitorSetName:string,Type:string)['1000-01-01T00:00:00Z',1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,1,1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];let T_XalAlerts_CL = (XalAlerts_CL | projectTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z'),RC = column_ifexists('RC_d', 1.1111),ALSYSID = column_ifexists('ALSYSID_s', 'initialString'),MSEGNAME = column_ifexists('MSEGNAME_s', 'initialString'),ALUNIQNUM = column_ifexists('ALUNIQNUM_s', 'initialString'),ALINDEX = column_ifexists('ALINDEX_s', 'initialString'),ALERTDATE = column_ifexists('ALERTDATE_s', 'initialString'),ALERTTIME = column_ifexists('ALERTTIME_s', 'initialString'),DUMMYALIGN = column_ifexists('DUMMYALIGN_s', 'initialString'),SystemID = column_ifexists('MTSYSID_s', 'initialString'),MTMCNAME = column_ifexists('MTMCNAME_s', 'initialString'),MTNUMRANGE = column_ifexists('MTNUMRANGE_s', 'initialString'),MTUID = column_ifexists('MTUID_s', 'initialString'),MTCLASS = column_ifexists('MTCLASS_s', 'initialString'),MTINDEX = column_ifexists('MTINDEX_s', 'initialString'),EXTINDEX = column_ifexists('EXTINDEX_s', 'initialString'),VALUE = column_ifexists('VALUE_d', 1.1111),Severity = column_ifexists('Severity', 1),STATUS = column_ifexists('STATUS_d', 1.1111),OBJECTNAME = column_ifexists('OBJECTNAME_s', 'initialString'),FIELDNAME = column_ifexists('FIELDNAME_s', 'initialString'),ClientID = column_ifexists('MANDT_s', 'initialString'),USERID = column_ifexists('USERID_s', 'initialString'),GONEDATE = column_ifexists('GONEDATE_s', 'initialString'),GONETIME = column_ifexists('GONETIME_s', 'initialString'),GONEDUMMY = column_ifexists('GONEDUMMY_s', 'initialString'),REPORTEDBY = column_ifexists('REPORTEDBY_s', 'initialString'),STATCHGDAT = column_ifexists('STATCHGDAT_s', 'initialString'),STATCHGTIM = column_ifexists('STATCHGTIM_s', 'initialString'),STATCHGDUM = column_ifexists('STATCHGDUM_s', 'initialString'),STATCHGBY = column_ifexists('STATCHGBY_s', 'initialString'),TIMEOUTDAT = column_ifexists('TIMEOUTDAT_s', 'initialString'),TIMEOUTTIM = column_ifexists('TIMEOUTTIM_s', 'initialString'),TIMEOUTDUM = column_ifexists('TIMEOUTDUM_s', 'initialString'),MSGCLASS = column_ifexists('MSGCLASS_s', 'initialString'),MSGID = column_ifexists('MSGID_s', 'initialString'),MSGARG1 = column_ifexists('MSGARG1_s', 'initialString'),ARGTYPE1 = column_ifexists('ARGTYPE1_s', 'initialString'),MSGARG2 = column_ifexists('MSGARG2_s', 'initialString'),ARGTYPE2 = column_ifexists('ARGTYPE2_s', 'initialString'),MSGARG3 = column_ifexists('MSGARG3_s', 'initialString'),ARGTYPE3 = column_ifexists('ARGTYPE3_s', 'initialString'),MSGARG4 = column_ifexists('MSGARG4_s', 'initialString'),ARGTYPE4 = column_ifexists('ARGTYPE4_s', 'initialString'),MSGTEXT = column_ifexists('MSGTEXT_s', 'initialString'),MSG = column_ifexists('MSG_s', 'initialString'),MSCGLID = column_ifexists('MSCGLID_s', 'initialString'),MonitorName = column_ifexists('MonitorName_s', 'initialString'),MonitorSetName = column_ifexists('MonitorSetName_s', 'initialString'),Type = column_ifexists('Type', 'initialString'));let XalAlerts= T_XalAlerts_CL | union isfuzzy= true (D_XalAlerts_CL);let D_XalAlertsCompleted_CL = datatable(TimeGenerated:datetime,SystemID:string,MSEGNAME:string,ALUNIQNUM:string,ALINDEX:string,ALERTDATE:string,ALERTTIME:string,DUMMYALIGN:string,RC:real,RC_TEXT:string,Type:string)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString'];let T_XalAlertsCompleted_CL = (XalAlertsCompleted_CL | projectTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z'),SystemID = column_ifexists('ALSYSID_s', 'initialString'),MSEGNAME = column_ifexists('MSEGNAME_s', 'initialString'),ALUNIQNUM = column_ifexists('ALUNIQNUM_s', 'initialString'),ALINDEX = column_ifexists('ALINDEX_s', 'initialString'),ALERTDATE = column_ifexists('ALERTDATE_s', 'initialString'),ALERTTIME = column_ifexists('ALERTTIME_s', 'initialString'),DUMMYALIGN = column_ifexists('DUMMYALIGN_s', 'initialString'),RC = column_ifexists('RC_d', 1.1111),RC_TEXT = column_ifexists('RC_TEXT_s', 'initialString'),Type = column_ifexists('Type', 'initialString'));let XalCompleted= T_XalAlertsCompleted_CL | union isfuzzy= true (D_XalAlertsCompleted_CL);XalAlerts | join kind=leftouter (XalCompleted | project ALUNIQNUM, ALINDEX, RC_TEXT, SystemID)on ALUNIQNUM, ALINDEX, SystemID| where SystemID != 'initialString'| project-away ALUNIQNUM1, ALINDEX1, SystemID1| project-rename AlertCompletionStatus= RC_TEXT| extend UpdatedOn= todatetime(strcat(ALERTDATE, ALERTTIME))| extend Color= Colors[toint(VALUE)]| summarize arg_max(UpdatedOn, *) by SystemID, MSEGNAME, ALUNIQNUM, ALINDEX, OBJECTNAME, FIELDNAME, MonitorName, MonitorSetName"
        },
        {
            "searchKey": "SAPXalMonitorSetsTree-Parser",
            "displayName": "SAPXalMonitorSetsTree",
            "functionAlias": "SAPXalMonitorSetsTree",
            "version": "3.0.0",
            "query": "//generated function structure for custom log XalMonitorSetsTree_CL//generated on 2023-02-26//Sentinel4SAP solution version 2.0.56let D_XalMonitorSetsTree_CL = datatable(TimeGenerated:datetime,MonitorSetName:string,MonitorName:string,Type:string)['1000-01-01T00:00:00Z','initialString','initialString','initialString'];let T_XalMonitorSetsTree_CL = (XalMonitorSetsTree_CL | projectTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z'),MonitorSetName = column_ifexists('MonitorSetName_s', 'initialString'),MonitorName = column_ifexists('MonitorName_s', 'initialString'),Type = column_ifexists('Type', 'initialString'));T_XalMonitorSetsTree_CL | union isfuzzy= true (D_XalMonitorSetsTree_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')| summarize TimeGenerated = arg_max(TimeGenerated, *) by MonitorSetName, MonitorName, Type"
        },
        {
            "searchKey": "SAPXalPerformance-Parser",
            "displayName": "SAPXalPerformance",
            "functionAlias": "SAPXalPerformance",
            "version": "3.0.0",
            "query": "//generated function structure for custom log XalPerformance_CL//generated on 2023-02-26//Sentinel4SAP solution version 2.0.56let Colors = dynamic (['Unclear','Green', 'Yellow', 'Red', 'Header',  'Footer']);let D_XalPerformance_CL = datatable(TimeGenerated:datetime,MonitorName:string,MonitorSetName:string,MonitoringTypeName:string,ObjectName:string,RelevantMeasuredValue:real,DateOfRelevantMeasuredValue:string,TimeOfRelevantMeasuredValue:string,RelevantAlertStatus:real,LastReportedValue:real,AverageValueOfLastMinute:real,AverageValueOfLast5Minutes:real,AverageValueOfLast15Minutes:real,TotalValuesOfLastMinute:real,TotalValuesOfLast5Minutes:real,TotalValuesOfLast15Minutes:real,NumberOfMeasurementsAtLastMinute:real,NumberOfMeasurementsAtLast5Minutes:real,NumberOfMeasurementsAtLast15Minutes:real,MaxMeasuredValue:real,DateOfMaxMeasuredValue:string,TimeOfMaxMeasuredValue:string,MinMeasuredValue:real,DateOfMinMeasuredValue:string,TimeOfMinMeasuredValue:string,MTMCNAME:string,SystemID:string,Type:string)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString',1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,'initialString','initialString',1.1111,'initialString','initialString','initialString','initialString','initialString'];let T_XalPerformance_CL = (XalPerformance_CL | projectTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z'),MonitorName = column_ifexists('MonitorName_s', 'initialString'),MonitorSetName = translate('[]\"','',column_ifexists('MonitorSetName_s', 'initialString')),MonitoringTypeName = column_ifexists('MonitoringTypeName_s', 'initialString'),ObjectName = column_ifexists('ObjectName_s', 'initialString'),RelevantMeasuredValue = column_ifexists('RelevantMeasuredValue_d', 1.1111),DateOfRelevantMeasuredValue = column_ifexists('DateOfRelevantMeasuredValue_s', 'initialString'),TimeOfRelevantMeasuredValue = column_ifexists('TimeOfRelevantMeasuredValue_s', 'initialString'),RelevantAlertStatus = column_ifexists('RelevantAlertStatus_d', 1.1111),LastReportedValue = column_ifexists('LastReportedValue_d', 1.1111),AverageValueOfLastMinute = column_ifexists('AverageValueOfLastMinute_d', 1.1111),AverageValueOfLast5Minutes = column_ifexists('AverageValueOfLast5Minutes_d', 1.1111),AverageValueOfLast15Minutes = column_ifexists('AverageValueOfLast15Minutes_d', 1.1111),TotalValuesOfLastMinute = column_ifexists('TotalValuesOfLastMinute_d', 1.1111),TotalValuesOfLast5Minutes = column_ifexists('TotalValuesOfLast5Minutes_d', 1.1111),TotalValuesOfLast15Minutes = column_ifexists('TotalValuesOfLast15Minutes_d', 1.1111),NumberOfMeasurementsAtLastMinute = column_ifexists('NumberOfMeasurementsAtLastMinute_d', 1.1111),NumberOfMeasurementsAtLast5Minutes = column_ifexists('NumberOfMeasurementsAtLast5Minutes_d', 1.1111),NumberOfMeasurementsAtLast15Minutes = column_ifexists('NumberOfMeasurementsAtLast15Minutes_d', 1.1111),MaxMeasuredValue = column_ifexists('MaxMeasuredValue_d', 1.1111),DateOfMaxMeasuredValue = column_ifexists('DateOfMaxMeasuredValue_s', 'initialString'),TimeOfMaxMeasuredValue = column_ifexists('TimeOfMaxMeasuredValue_s', 'initialString'),MinMeasuredValue = column_ifexists('MinMeasuredValue_d', 1.1111),DateOfMinMeasuredValue = column_ifexists('DateOfMinMeasuredValue_s', 'initialString'),TimeOfMinMeasuredValue = column_ifexists('TimeOfMinMeasuredValue_s', 'initialString'),MTMCNAME = column_ifexists('MTMCNAME_s', 'initialString'),SystemID = column_ifexists('MTSYSID_s', 'initialString'),Type = column_ifexists('Type', 'initialString'));T_XalPerformance_CL | union isfuzzy= true (D_XalPerformance_CL  | where MonitorName != 'initialString')| extend UpdatedOn= iff(DateOfRelevantMeasuredValue startswith(\" \"), TimeGenerated, todatetime(strcat(DateOfRelevantMeasuredValue, TimeOfRelevantMeasuredValue)))| extend Color= Colors[toint(RelevantAlertStatus)]| extend MonitorSetName= substring(MonitorSetName, 4, strlen(MonitorSetName)-6)| summarize arg_max(TimeGenerated, *) by MonitorName, MonitorSetName, MonitoringTypeName, ObjectName, UpdatedOn| sort by MonitorName, MonitorSetName, ObjectName,MonitoringTypeName, UpdatedOn desc| extend MonitoringTypeNObject= strcat(MonitoringTypeName, ObjectName)| extend ReverseOrder= row_number(1, prev(MonitoringTypeNObject) != MonitoringTypeNObject)"
        },
        {
            "searchKey": "SAP_ADCP-Parser",
            "displayName": "SAP_ADCP",
            "functionAlias": "SAP_ADCP",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_ADCPQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_ADR6-Parser",
            "displayName": "SAP_ADR6",
            "functionAlias": "SAP_ADR6",
            "version": "3.1.9",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_ADR6Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_1251-Parser",
            "displayName": "SAP_AGR_1251",
            "functionAlias": "SAP_AGR_1251",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_1251Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_AGRS-Parser",
            "displayName": "SAP_AGR_AGRS",
            "functionAlias": "SAP_AGR_AGRS",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_AGRSQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_DEFINE-Parser",
            "displayName": "SAP_AGR_DEFINE",
            "functionAlias": "SAP_AGR_DEFINE",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_DEFINEQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_FLAGS-Parser",
            "displayName": "SAP_AGR_FLAGS",
            "functionAlias": "SAP_AGR_FLAGS",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_FLAGSQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_PROF-Parser",
            "displayName": "SAP_AGR_PROF",
            "functionAlias": "SAP_AGR_PROF",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_PROFQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_TCODES-Parser",
            "displayName": "SAP_AGR_TCODES",
            "functionAlias": "SAP_AGR_TCODES",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_TCODESQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_AGR_USERS-Parser",
            "displayName": "SAP_AGR_USERS",
            "functionAlias": "SAP_AGR_USERS",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_AGR_USERSQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_DEVACCESS-Parser",
            "displayName": "SAP_DEVACCESS",
            "functionAlias": "SAP_DEVACCESS",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_DEVACCESSQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_PAHI-Parser",
            "displayName": "SAP_PAHI",
            "functionAlias": "SAP_PAHI",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_PAHIQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_USGRP_USER-Parser",
            "displayName": "SAP_USGRP_USER",
            "functionAlias": "SAP_USGRP_USER",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_USGRP_USERQuery'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_USR01-Parser",
            "displayName": "SAP_USR01",
            "functionAlias": "SAP_USR01",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_USR01Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_USR02-Parser",
            "displayName": "SAP_USR02",
            "functionAlias": "SAP_USR02",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_USR02Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_USR05-Parser",
            "displayName": "SAP_USR05",
            "functionAlias": "SAP_USR05",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_USR05Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_USR21-Parser",
            "displayName": "SAP_USR21",
            "functionAlias": "SAP_USR21",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_USR21Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        },
        {
            "searchKey": "SAP_UST04-Parser",
            "displayName": "SAP_UST04",
            "functionAlias": "SAP_UST04",
            "version": "3.0.0",
            "query": "[replace(variables('_Reserved_SAPFunctionsSAP_UST04Query'),'CWSQSAP.', variables('_Reserved_CWSQSAPIdentifier'))]"
        }
    ],
    "logicAppsCustomConnector": [],
    "playbook": [
        {
            "displayName": "SAPLockUser-Advanced",
            "description": "This Playbook provides the automation for the SAP incidents. It allows for automatically pop a Teams message or an email to the user to notify them of the incident. It also allows for the user to be blocked on AAD or SAP, for the incident to be closed. The same functionality is also offered in a standard logic app, which allows enterprise features such as private VNet injection, tenant isolation and more. See SAP automation scenarios on GitHub for more information.",
            "version": "2.0.65",
            "prerequisites": "1. Update your SAP alert rules to the latest version.2. Assign the relevant Teams or email addresses to be used as responders.3. Optional- set your SAP system to allow user locking from Sentinel, See more details at https://aka.ms/sentinel4sapintro.",
            "postDeployment": "1. Once deployment is complete, you will need to authorize each connection.2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save",
            "entities": [
                "ip",
                "1\ue946",
                "Account"
            ],
            "entitiesMultiple": "ip1\ue946Account",
            "tags": "workflowSAPActive directorySAP UserBlock SAP UserBlock AD User"
        },
        {
            "displayName": "SAPLockUser-Basic",
            "description": "This Playbook Provides the automation for the SAP incidents. It allows for automatically pop a Teams message or an email to the user to notify them of the incident. It also allows for the user to be blocked on AAD or SAP, for the incident to be closed. The same functionality is also offered in a standard logic app, which allows enterprise features such as private VNet injection, tenant isolation and more. See SAP automation scenarios on GitHub for more information.",
            "version": "2.0.65",
            "prerequisites": "1. Update your SAP alert rules to the latest version.2. Assign the releavnt Teams or email addresses to be used as responders.3. Optional- set your SAP system to allow user locking from Sentinel, See more details at https://aka.ms/sentinel4sapintro.",
            "postDeployment": "1. Once deployment is complete, you will need to authorize each connection.2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save",
            "entities": [
                "ip",
                "1\ue946",
                "Account"
            ],
            "entitiesMultiple": "ip1\ue946Account",
            "tags": "workflowSAPActive directorySAP UserBlock SAP UserBlock AD User"
        },
        {
            "displayName": "SAPReEnableAuditLog",
            "description": "This playbook provides automatic response to incidents created by the alert rule 'SAP - Deactivation of Security Audit Log' by sending an audit log enable request to the corresponding SAP system.SAP incident response can also be achieved in standard logic app based playbooks. See SAP automation scenarios on GitHub for more information.",
            "version": "2.0.65",
            "prerequisites": "1. Once deployment is complete, you will need to authorize each connection.2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save",
            "postDeployment": "1. Once deployment is complete, you will need to authorize each connection.2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save",
            "entities": [
                "ip",
                "1\ue946",
                "Account"
            ],
            "entitiesMultiple": "ip1\ue946Account",
            "tags": "workflowSAPActive directorySAP UserBlock SAP UserBlock AD User"
        }
    ],
    "watchlist": [
        {
            "displayName": "SAP - Critical Authorizations",
            "description": "Critical Authorizations object which their assignment should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Critical Authorizations",
            "provider": "Microsoft",
            "itemsSearchKey": "AuthorizationObject",
            "rawContent": "AuthorizationObject,AuthorizationField,AuthorizationValue,ActivityField,Activity,Description\nS_DEVELOP,OBJTYPE,DEBUG,ACTVT,02,Debug Change Authorizations\nS_DEVELOP,OBJTYPE,*,ACTVT,02,All development activities - include debug\nS_DEVELOP,OBJTYPE,DEBUG,ACTVT,*,Debug All Activites (Including Change)\nS_DEVELOP,OBJTYPE,*,ACTVT,*,All development activities - include debug\nS_RFC,RFCNAME,*,ACTVT,16,Execution of all RFC Services\nS_RFC,RFCNAME,*,ACTVT,*,Execution of all RFC Services\nS_TCODE,TCD,*,NOT_IN_USE,,All Transaction Codes - Example without Activity\nS_TZONE,ACTVT,*,NOT_IN_USE,,Maintain System Time Zone - Example only with Activity\n"
        },
        {
            "displayName": "SAP - Excluded Networks",
            "description": "Internal and maintenance of excluded networks for ignoring web dispatchers, terminal servers etc.",
            "source": "ContentHub",
            "alias": "SAP - Excluded Networks",
            "provider": "Microsoft",
            "itemsSearchKey": "Network",
            "rawContent": "Network,Description\n255.68.255.0/32,My  Dummy Terminal Server\n255.138.157.0/32,My Dummy Citrix\n"
        },
        {
            "displayName": "SAP - Excluded Users",
            "description": "System users which are logged in the systems need to be ignored. (for example Multiple logons by user alert)",
            "source": "ContentHub",
            "alias": "SAP - Excluded Users",
            "provider": "Microsoft",
            "itemsSearchKey": "User",
            "rawContent": "User,Description\nSYSWF,WF\n"
        },
        {
            "displayName": "SAP - FTP Servers",
            "description": "FTP Servers for identification of unauthorized connections.",
            "source": "ContentHub",
            "alias": "SAP - FTP Servers",
            "provider": "Microsoft",
            "itemsSearchKey": "Client",
            "rawContent": "Client,FTP_Server_Name,FTP_Server_Port,Description\n100,http://ourorgftpserver.com/,22,description\n"
        },
        {
            "displayName": "SAP - Networks",
            "description": "Internal and maintenance networks for identification of unauthorized logins.",
            "source": "ContentHub",
            "alias": "SAP - Networks",
            "provider": "Microsoft",
            "itemsSearchKey": "Network",
            "rawContent": "Network,Description\n111.68.128.0/17,(Dummy) Our internal Network\n5.8.0.0/19,(Dummy) SAP Support Network\n223.255.254.0/24,(Dummy) Our Support Network\n"
        },
        {
            "displayName": "SAP - Obsolete Function Modules",
            "description": "Obsolete Function Modules which their execution should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Obsolete Function Modules",
            "provider": "Microsoft",
            "itemsSearchKey": "FunctionModule",
            "rawContent": "FunctionModule,Description\nTH_SAPREL,Get SAP Release Information\nTH_SAPREL2,Get SAP Release Information\nTH_SAPREL3,Get SAP Release Information\nSUSR_RFC_USER_INTERFACE,Users from External Systems\nRFC_ABAP_INSTALL_AND_RUN,Install ABAP Program\n"
        },
        {
            "displayName": "SAP - Obsolete Programs",
            "description": "Obsolete ABAP programs (reports) which their execution should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Obsolete Programs",
            "provider": "Microsoft",
            "itemsSearchKey": "ABAPProgram",
            "rawContent": "ABAPProgram,Description\nExample_Program,just an example\n"
        },
        {
            "displayName": "SAP - Privileged Users",
            "description": "Privileged users which are under extra restrictions.",
            "source": "ContentHub",
            "alias": "SAP - Privileged Users",
            "provider": "Microsoft",
            "itemsSearchKey": "User",
            "rawContent": "User,Description\nSAP*,SAP*\nALEREMOTE,BW User\nBWREMOTE,BW User\nWF-BATCH,Workflow Batch\nDDIC,\"Dictionary, Internal\"\nSAPSYS,\"SAP System, Internal\"\n"
        },
        {
            "displayName": "SAP - Sensitive ABAP Programs",
            "description": "Sensitive ABAP programs (reports) which their execution should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Sensitive ABAP Programs",
            "provider": "Microsoft",
            "itemsSearchKey": "ABAPProgram",
            "rawContent": "ABAPProgram,Description,UsersExcluded\nRSPFLDOC,Profile Parameter Maintenance,\n/1BCDWB/DBUSR02,Data Browser - USR02,\n/1BCDWB/DBUSH02,Data Browser - USH02,\n/1BCDWB/DBUSRPWDHISTORY,Data Browser - USRPWDHISTORY,\nRSBDCOS0,Execute OS Command (Logged in SYSLOG and Trace Files),\nRSCDOK99,Delete Change Documents,\nRSTBPDEL,Table Log Database Management: Delete Logs,BASIS_ADM\nRSENQRR2,Display and Management of Lock Entries,\n"
        },
        {
            "displayName": "SAP - Sensitive Function Modules",
            "description": "Sensitive Function Modules which their execution should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Sensitive Function Modules",
            "provider": "Microsoft",
            "itemsSearchKey": "FunctionModule",
            "rawContent": "FunctionModule,Description,UsersExcluded\nRSAU_CLEAR_AUDIT_LOG,Delete Audit Log,\nPRGN_INTERFACE_USER,,\nSXPG_COMMAND_EXECUTE,Execute an External Command,\nBAPI_USER_CREATE,Create User,\nRFC_ABAP_INSTALL_AND_RUN,,\nSXPG_COMMAND_EXECUTE_LONG,Execute an External Command,\nBAPI_USER_CREATE1,Create User,\nRFC_GET_TABLE_ENTRIES,Read table entries,\nTABLE_ENTRIES_GET_VIA_RFC,,\nBAPI_USER_DELETE,Delete user,\nRFC_READ_TABLE,External access to R/3 tables via RFC,MySentinelUser\nTH_REMOTE_TRANSACTION,Start Remote Transaction,\nBAPI_USER_GET_DETAIL,Read User Details,MySentinelUser; BATCH_000\nRS_FUNCTIONMODULE_INSERT,,\nTH_SAPREL,,\nBAPI_USER_PROFILES_ASSIGN,Change User-Profile Assignments,\nRZL_READ_DIR_LOCAL,,\nTMS_CI_START_SERVICE,,TMSADM\nEPS_GET_DIRECTORY_LISTING,,\nSUSR_RFC_USER_INTERFACE,,\nSWNC_COLLECTOR_DEL_AGGREGATES,Delete logs,\nPFL_CHECK_OS_FILE_EXISTENCE,,\nSXPG_CALL_SYSTEM,Execute an External Command,\nSUSR_PASSWORD_CHANGE_DIALOG,Change User Password,\n"
        },
        {
            "displayName": "SAP - Sensitive Profiles",
            "description": "Sensitive profiles which their assignment should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Sensitive Profiles",
            "provider": "Microsoft",
            "itemsSearchKey": "Profile",
            "rawContent": "Profile,Description\nSAP_ALL,All SAP Systems Authorizations\nSAP_NEW,New Authorizations Checks\n"
        },
        {
            "displayName": "SAP - Sensitive Roles",
            "description": "Sensitive roles which their assignment should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Sensitive Roles",
            "provider": "Microsoft",
            "itemsSearchKey": "Role",
            "rawContent": "Role,Description\nZ_FIGL_POSTING_ADMIN,Custom example role\nSAP_BC_AUTH_DATA_ADMIN,Authorization Data Administrator\nSAP_BC_AUTH_PROFILE_ADMIN,Authorization Profile Administrator\nSAP_BC_BASIS_ADMIN,System Administrator\n"
        },
        {
            "displayName": "SAP - Sensitive Tables",
            "description": "Sensitive tables which their access should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Sensitive Tables",
            "provider": "Microsoft",
            "itemsSearchKey": "Table",
            "rawContent": "Table,Description\nADR6,E-Mail Addresses \nBP1000,Roles\nKNA1,Customer MD\nSANS1,Addresses\nPA0002,HR Master Record: Infotype 0002 (Personal Data)\nUSR40,Table for illegal passwords\nADRC,Business Addresses\nBUT000,General data I\nKNB1,Customer MD\nTable,Description\nTF644,Fair Value Adjustments: Cons Chart of Accounts-sensitive\nT000,Clients\nBAS tables,Business address services tables\nBUT001,General data II\nKNBK,Bank details\nTIBAN,IBAN data\nTADIR,Directory of Repository Objects\nBC001,Assign vendor \u2013 partner\nBUT020,BP: addresses\nKNVV,Customer MD\nUSH02,Change history for logon data\nTF643,Fair Value Adjustments: Version/Date-sensitive\nBD001,Assign customer \u2013 partner\nBUT021,BP: address usage\nLFA1,Vendor MD\nUSR02,Logon Data\nTBE31,Publish&Subscribe BTE: SAP Enhancement\nBP000,Business partner master (general data)\nBUT0BANK,Bank details\nLFB1,Vendor MD\nUSRPWDHISTORY,Change History for Logon Data: Last Entries from Archive\nT77UA,User Authorizations\nBP001,FS-specific attributes\nBUT0BK,BP: bank details\nLFBK,Vendor MD\nANONYMIZATION,ANONYMIZATION\nCRMT_BSP_IBASE_CS_F4,IBase: Structure for Context-sensitive\u00a0Search\nBP030,Address\nBUT100,BP roles\nPA0008,Basic Pay Infotype\nQ0002,Screen Fields: Infotype 0002 (Personal Data)\nSNODE,Workbench: Object List Node Description\n"
        },
        {
            "displayName": "SAP - Sensitive Transactions",
            "description": "Sensitive transactions which their execution should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Sensitive Transactions",
            "provider": "Microsoft",
            "itemsSearchKey": "TransactionCode",
            "rawContent": "TransactionCode,Description\nRSAU_CONFIG,Audit Log Configuration\nSM49, Execute external OS Commands\nSE38, ABAP Program Editor\nAL08,User Sessions\nRZ11,Profile Parameter Maintenance\nSM69, Execute external OS Commands\nSE80, ABAP Workbench\nRZ10, Profile Maintenance\nSCC1 , Client Import\nSA38, ABAP Program Editor\nRZ12, RFC Server Group Maintenance\nSCC4, Client Overview\nSE37, Execute Function Modules\nSM18, Delete Audit Log\nSCC5, Delete Client\nSLDB\u00a0,Logical Database Builder\nSCU3, Delete Table Log\nSE06, Set Up Transport Organizer\nSM12,Lock Manager\nSLG2, delete application log\nSE03, Transport Organizer Tools\nRSUSR000,Loggedon users\n"
        },
        {
            "displayName": "SAP - Systems",
            "description": "Describes the landscape of SAP systems according to role and usage.",
            "source": "ContentHub",
            "alias": "SAP - Systems",
            "provider": "Microsoft",
            "itemsSearchKey": "SystemID",
            "rawContent": "SystemID,SystemRole,SystemUsage,InterfaceAttributes,AdditionalData\nA4H,Production,ERP,{'BasePath': 'https://api.integration-center.co.in/lock/urn:sap-com:document:sap:rfc:functions:'},SOX controlled\n"
        },
        {
            "displayName": "SAP - Transactions for ABAP Generations",
            "description": "Transactions for ABAP generations which their execution should be governed.",
            "source": "ContentHub",
            "alias": "SAP - Transactions for ABAP Generations",
            "provider": "Microsoft",
            "itemsSearchKey": "TransactionCode",
            "rawContent": "TransactionCode,Description\nSE11, ABAP Dictionary Maintenance\nSM30, Call View Maintenance\nSE12, ABAP Dictionary Display\nSM36, Schedule Background Job\nSE16, Data Browser\nSM37, Overview of job selection\nSE16N, General Table Display\nST03, Workload and Performance Statistics\nPFCG, Role Maintenance\nSU01, User Maintenance\n"
        },
        {
            "displayName": "SAPAlertRulesMetadata",
            "description": "Allows for specifying local properties of the OOTB alert rules, like default responding team,  SOX or NIST control framework associations. These controls are conveniently modifiable from configuration section on the \u2018SAP Audit Controls\u2019 workbook.",
            "source": "ContentHub",
            "alias": "SAPAlertRulesMetadata",
            "provider": "Microsoft",
            "itemsSearchKey": "RuleID",
            "rawContent": "RuleID,AnalyticRuleName,AnalyticsTemplateId,RecommendedConfiguration,NISTControlFamily,NISTControlID,MyOrgControlFamily,MyOrgControlID,SOXControlFamily,SOXControlID,ControlType,Tasks,Tier1,Tier2\nDefaultRule,DefaultRule,DefaultRule,As alert only (low fidelity),N/A,N/A,N/A,N/A,N/A,N/A,,,,\nactivationordeactivationoficfservice,SAP - Activation or Deactivation of ICF Service,e704b794-2f22-417a-b3ac-25e6037e2717,As incident (high fidelity),Configuration Management,03.04.02,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\ncriticalauthorizationsassignment-newuserassignment,SAP - Critical authorizations assignment - New User Assignment,8f9b9576-d0cd-43da-8ea2-d77366d4a70d,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ndynamicanomalybasedauditlogmonitoralerts,SAP - Dynamic Anomaly based Audit Log Monitor Alerts,49fd3399-67c5-47bf-bb61-8b6efa27a5fe,As alert only (low fidelity),Inherited,Inherited,Inherited,Inherited,Inherited,Inherited,Inherited,\"ConfirmDetails, AssignToTier2\",Inherited,SAPSOC\nfiledownloadedfromamaliciousipaddress,SAP - File Downloaded From a Malicious IP Address,5f152aa1-f82c-4789-8dea-d63d7d6bf96b,As incident (high fidelity),Media Protection,03.08.05,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSOC,SAPSOC\ninsecureftpserversconfiguration,SAP - Insecure FTP servers configuration,78fbdc7d-6136-4afc-9cc5-5e5aff1563ae,As alert only (low fidelity),Configuration Management,03.04.02,Security,Network activity,Security,Network activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nmultiplespooloutputexecutions,SAP - Multiple Spool Output Executions,c123a8d7-f72f-4ba0-8b06-ba5e12043432,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nsensitivedatasavedintoausbdrive,SAP - Sensitive data saved into a USB drive,870d9ea0-cd99-4644-9c7a-d7256b0b37e0,As incident (high fidelity),Media Protection,03.08.07,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSOC,SAPSOC\nspnegoattack,SAP - SPNego Attack,d83d4699-7bd5-44f1-826a-3bd3501712a9,As incident (high fidelity),Identification and Authentication,03.05.04,Security,Login activity,Security,Login activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPSOC,SAPSOC\nassignmentofasensitiveprofile,SAP - Assignment of a sensitive profile,4e228f1a-55cc-4abc-8ef4-5e385b60f9c0,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ndatacollectionhealthcheck,SAP - Data collection health check,2af909e9-9c84-4198-b8c7-e80fe9f00ffb,As incident (high fidelity),Audit and Accountability,03.03.04,Change management,Audit logging,Change management,Audit logging,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSOC,SAPSOC\ndynamicdeterministicauditlogmonitor,SAP - Dynamic Deterministic Audit Log Monitor,68a03140-24bc-4985-8b77-ca5cc8aadeda,As alert only (low fidelity),Inherited,Inherited,Inherited,Inherited,Dynamic,Inherited,Inherited,\"ConfirmDetails, AssignToTier2\",Inherited,SAPSOC\nftpfornonauthorizedservers,SAP - FTP for non authorized servers,bd39a2f0-2eaa-41e6-a071-70c42e42dd21,As alert only (low fidelity),Access Control,03.01.20,Security,Network activity,Security,Network activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nlifecycle-sapnoteswereimplementedinsystem,SAP - Lifecycle - SAP Notes were implemented in system,7f364fac-c6a9-4935-a73b-ba215acace31,As incident (medium fidelity),Configuration Management,03.04.01,Change management,Transports,Change management,Transports,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nmultiplesubnetsbyuser,SAP - Multiple Subnets by User,0079fee8-1ebf-4721-92c2-ac1861a79626,As incident (medium fidelity),Identification and Authentication,03.05.04,Security,Network activity,Security,Network activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nsensitiveprivilegeduserloggedin,SAP - Sensitive Privileged User Logged in,97d13311-748b-4016-b095-9100ab00e4db,As alert only (low fidelity),Access Control,03.01.01,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nspooltakeover,SAP - Spool Takeover,27d73c8f-88fd-41b8-a785-231541aa32a0,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nassignmentofasensitiverole,SAP - Assignment of a sensitive role,03b9a2cf-8434-44ad-b42f-9a35701f1c2a,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ndataexportedfromaproductionsystemusingatransport,SAP - Data exported from a production system using a transport,4329c5d1-7062-4ec4-8ab8-29846e0e0d9a,As incident (medium fidelity),Media Protection,03.08.05,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ndynamicrfcdestination,SAP - Dynamic RFC Destination,57e99014-746b-4696-ae6a-447aecc9e800,As alert only (low fidelity),Access Control,03.01.12,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nfunctionmoduletested,SAP - Function Module tested,7e6cb00d-d7cb-4411-837f-6e62c2fab6e7,As alert only (low fidelity),Access Control,03.01.02,Security,User activity,Security,User activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nloginfromunexpectednetwork,SAP - Login from unexpected network,978e1cc8-f891-41c7-83b8-b21762a2ebb7,As alert only (low fidelity),Identification and Authentication,03.05.04,Security,Network activity,Security,Network activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nnewicfservicehandlers,SAP - New ICF Service Handlers,45ae0492-fe7d-4ba8-addd-ca984ea30bc1,As incident (medium fidelity),Configuration Management,03.04.02,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nsensitiveprivilegedusermakesachangeinanotheruser,SAP - Sensitive privileged user makes a change in another user,47848010-7a36-44f7-96be-d988f3de9421,As alert only (low fidelity),Access Control,03.01.04,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nsystemconfigurationchange,SAP - System Configuration Change,f4da8e9d-3515-4a2a-8cf0-43334fa29d91,As incident (high fidelity),Configuration Management,03.04.03,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nbruteforce(rfc),SAP - Brute Force (RFC),c2cc3901-d6bd-4189-bb5f-ab464dcfd079,As incident (medium fidelity),Access Control,03.01.12,Security,Network activity,Security,Network activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\ndatahaschangedduringdebuggingactivity,SAP - Data has Changed during Debugging Activity,9a55136c-fa19-46d4-9376-17c8f96cc2b8,As incident (high fidelity),System and Information Integrity,03.14.06,Security,Database activity,Security,Database activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPDevelopment,SAPSOC\nexecutionofanobsoleteoraninsecurefunctionmodule,SAP - Execution of an Obsolete or an Insecure Function Module,45e784d5-0414-4029-8fc6-5f6722abdb5c,As alert only (low fidelity),Access Control,03.01.03,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nhanadb-assignadminauthorizations,SAP - HANA DB - Assign Admin Authorizations,2d7cbb53-cb18-4c9e-8855-c5393aa91db0,As alert only (low fidelity),Access Control,03.01.06,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nmissingconfigurationinthedynamicsecurityauditlogmonitor,SAP - Missing configuration in the Dynamic Security Audit Log Monitor,b0594a30-5da4-4eca-89af-cb8ad111d697,As alert only (low fidelity),Audit and Accountability,03.03.03,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nnewicfservices,SAP - New ICF Services,263ea651-10c8-48a6-a5ac-2c9fc0655ebc,As incident (medium fidelity),Configuration Management,03.04.02,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nsensitiverolechanges,SAP - Sensitive Role Changes,9fadb366-a7ec-474c-90e1-d1a823176a1e,As alert only (low fidelity),Access Control,03.01.07,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ntransactionisunlocked,SAP - Transaction is unlocked,35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294,As alert only (low fidelity),Configuration Management,03.04.06,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ncapture-replayvulnerabilityinsapnetweaver[cve-2023-0014],SAP - Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014],7c2d366a-1cb8-41f3-9b0b-a5c469ad467e,As alert only (low fidelity),Identification and Authentication,03.05.10,Security,Information Access,Security,Information Access,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\ndeactivationofsecurityauditlog,SAP - Deactivation of Security Audit Log,45fb7bf5-783b-4a87-897d-b26f5574186b,As incident (high fidelity),Audit and Accountability,03.03.04,Change management,Audit logging,Change management,Audit logging,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nexecutionofanobsoleteoraninsecureprogram,SAP - Execution of an Obsolete or an Insecure Program,6a6ff9e7-b167-49a1-bff8-00dadf62b34c,As alert only (low fidelity),Access Control,03.01.03,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nhanadb-audittrailpolicychanges,SAP - HANA DB - Audit Trail Policy Changes,fe14e4b9-8616-4741-bf6c-2936d30afa65,As alert only (low fidelity),Audit and Accountability,03.03.08,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nmultiplefilesdownload,SAP - Multiple Files Download,4285d707-f969-4a8c-801f-e9c6a328d884,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nnewtrustedrfcconnectioncapture-replayvulnerabilityinsapnetweaver[cve-2023-0014],SAP - New trusted RFC connection capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014] ,e35db198-2146-446c-8eb7-a77b6344f1d7,As incident (high fidelity),Identification and Authentication,03.05.04,Security,Information Access,Security,Information Access,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nsensitivestaticparameterhaschanged,SAP - Sensitive Static Parameter Has Changed,bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e,As alert only (low fidelity),Configuration Management,03.04.01,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nusercreatesandusesnewuser,SAP - User Creates and uses new user,12509d03-0206-4b85-84b9-6d2349afa42b,As incident (high fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nchangeinasensitiveprivilegeduser,SAP - Change in a Sensitive Privileged User,3eab4a41-1d7b-453d-8631-a7d74936973b,As incident (medium fidelity),Access Control,03.01.02,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ndebuggingactivities,SAP - Debugging Activities,a7babb63-a466-4ec7-a056-a213555f18df,As incident (high fidelity),Access Control,03.01.02,Security,Database activity,Security,Database activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPDevelopment,SAPSOC\nexecutionofasensitiveabapprogram,SAP - Execution of a Sensitive ABAP Program,e0e53cb9-d3f4-47c3-b953-ad62a8414f4f,As alert only (low fidelity),Access Control,03.01.07,Security,User activity,Security,User activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPDevelopment,SAPSOC\nhanadb-deactivationofaudittrail,SAP - HANA DB - Deactivation of Audit Trail,7e5e321a-f6df-434d-b1be-a8d74f696481,As alert only (low fidelity),Audit and Accountability,03.03.08,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nmultiplelogonsbyip,SAP - Multiple Logons by IP,e5a176ef-dd12-47a3-a5ef-1900997f1b17,As alert only (low fidelity),Access Control,03.05.04,Security,Network activity,Security,Network activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nprintingofpotentiallysensitivedata,SAP - Printing of potentially sensitive data,49f11dc5-03c9-4ea3-83ee-33434b42e699,As incident (high fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nsensitivetablesdirectaccessbydialoglogon,SAP - Sensitive Tables Direct Access By Dialog Logon,940baadd-fe19-4c1a-9680-63a9c5d21e1c,As alert only (low fidelity),Media Protection,03.08.02,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nuserunlocksandusesotherusers,SAP - User Unlocks and uses other users,7224ad22-e2cf-459d-9359-62310555e716,As incident (high fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nclientconfigurationchange,SAP - Client Configuration Change,4258c51d-59db-4502-9b02-fb2ab20e97d4,As incident (high fidelity),Configuration Management,03.04.03,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\ndialoglogonattemptfromaprivilegeduser,SAP - Dialog logon attempt from a privileged user,db123b5e-bcc2-43a5-9e13-8ac1e1a3c530,As incident (high fidelity),Access Control,03.01.06,Security,Login activity,Security,Login activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nexecutionofasensitivetransactioncode,SAP - Execution of a Sensitive Transaction Code,797db008-0a53-4510-9883-b32673f9c3f5,As alert only (low fidelity),Access Control,03.01.07,Security,User activity,Security,User activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nhanadb-useradminactions,SAP - HANA DB - User Admin actions,3ba35622-3071-477e-9af9-5380bce25e1e,As alert only (low fidelity),Access Control,03.04.03,Security,Database activity,Security,Database activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nmultiplepasswordchanges,SAP - Multiple Password Changes,c01c6b88-6323-4a71-b981-4bc0ddca88bf,As incident (medium fidelity),Identification and Authentication,03.05.08,Security,Account activity,Security,Account activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nrfcexecutionofasensitivefunctionmodule,SAP - Unauthorized Remote Execution of a Sensitive Function Module,8e8a95c5-7f78-435e-9e6a-7e29c0b831c1,As alert only (low fidelity),Access Control,03.01.15,Security,User activity,Security,User activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPDevelopment,SAPSOC\nsensitivetablesdirectaccessbyrfclogon,SAP - Sensitive Tables Direct Access By RFC Logon,2521fd74-79f3-4adc-8350-edf4036913b3,As alert only (low fidelity),Access Control,03.01.15,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ncriticalauthorizationsassignment-newauthorizationvalue,SAP - Critical authorizations assignment - New Authorization Value,6e60e742-aef0-47aa-95e5-36a100a4272d,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\ndynamicabapprogram,SAP - Dynamic ABAP Program,fd655ec6-cb11-4e79-a825-0935a66596c8,As alert only (low fidelity),Access Control,03.01.12,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nexecutionofsensitivefunctionmodule,SAP - Execution of Sensitive Function Module,d940bee2-46ff-4bb5-869a-1a54a967977d,As alert only (low fidelity),Access Control,03.01.07,Security,User activity,Security,User activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nhighvolumeofpotentiallysensitivedataexported,SAP - High volume of potentially sensitive data exported,a4dee43c-f06e-4f6f-8735-db6dec4c5aa3,As incident (high fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nmultiplespoolexecutions,SAP - Multiple Spool Executions,dfbcb26d-7b53-41f8-9647-1e158722a80e,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nsecurityauditlogconfigurationchange,SAP - Security Audit Log Configuration Change,ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4,As incident (high fidelity),Audit and Accountability,03.03.08,Change management,Audit logging,Change management,Audit logging,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nsensitiveuserspasswordchangeandlogin,SAP - Sensitive User's Password Change and Log in,4cc23b15-a048-45f1-b1e8-2dfc40013d84,As incident (medium fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\nasjavasensitiveprivilegedusersignedin,SAP - AS JAVA - Sensitive Privileged User Signed In,6898699a-07c5-4cf5-bee5-a588d06df81a,As alert only (low fidelity),Access Control,03.01.01,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nsigninfromunexpectednetwork,SAP - AS JAVA - Sign-In from Unexpected Network,63562246-8abb-4e85-a7ae-0e5074ed161b,As alert only (low fidelity),Identification and Authentication,03.05.04,Security,Network activity,Security,Network activity,Detective,\"ConfirmDetails, AssignToTier2\",SAPBasis,SAPSOC\nasjavausercreatesandusesnewuser,SAP - AS JAVA - User Creates and Uses New User,0713fb84-1ddb-4441-bdc9-127fd979e37e,As incident (high fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,\"ConfirmDetails, AssignToTier2\",SAPSecurity,SAPSOC\n"
        },
        {
            "displayName": "SAPSolutionConfig",
            "description": "A local data base designed to store various configuration options.",
            "source": "ContentHub",
            "alias": "SAPSolutionConfig",
            "provider": "Microsoft",
            "itemsSearchKey": "ConfigType",
            "rawContent": "ConfigType,ConfigKey,TeamsGroup,TeamsChannel,Email\nTeams,SAPSecurity,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:3a8d3cf10784fa47b894d8c6cc46217541@thread.tacv2,Sentinel4SAPSecurity@microsoft.com\nTeams,SAPBasis,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:36ba6517299a4e8aabe014ed1545bf7d@thread.tacv2,Sentinel4SAPBasis@microsoft.com\nTeams,SAPDevelopment,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:3a8d6fdf2df5214395929d44c52afccd09@thread.tacv2,Sentinel4SAPDevelopment@microsoft.com\nTeams,SAPSOC,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:3ae688a5db3c6b4657bc49139f88d24ece@thread.tacv2,Sentinel4SAPSOC@microsoft.com\n"
        },
        {
            "displayName": "SAPSystemParameters",
            "description": "Parameters to watch for. This watch list comes prefilled with best practice, and can be extended by you to include additional parameters. Parameters that you wish not be alerted on can be set with 'EnableAlerts' == 'false'",
            "source": "ContentHub",
            "alias": "SAPSystemParameters",
            "provider": "Microsoft",
            "itemsSearchKey": "ParameterName",
            "rawContent": "ParameterName,Comment,EnableAlerts,Option,ProductionValues,NonProdValues,ProductionSeverity,NonProdSeverity\ngw/accept_remote_trace_level,CPIC and RFC: adopt remote trace level?,true,,0,0,High,High\nauth/rfc_authority_check,Execution option for the RFC authority check,true,GE,1,1,High,High\nlogin/password_change_waittime,Password change possible after # days (since last change),true,GE,1,1,High,Medium\nlogin/multi_login_users,list of exceptional users: multiple logon allowed,true,,,,High,Medium\nauth/object_disabling_active,Value 'N' prohibits disabling of authorization objects,true,,Y,Y,High,High\nlogin/fails_to_user_lock,Number of invalid login attempts until user lock,true,LE,5,5,High,Medium\nsnc/extid_login_rfc,Enable login with external identity (RFC),true,,1,1,High,Medium\nlogin/password_change_for_SSO,Handling of password change enforcements in Single Sign-On situations,true,,1,1,High,Medium\ngw/acl_mode,Mode for non existing ACL file,true,,0,1,High,High\nsnc/accept_insecure_cpic,Accept insecure CPIC-connections to SNC-enabled Server,true,,0,1,High,Medium\nlogin/password_expiration_time,Dates until password must be changed,true,LE,90,180,High,Medium\nlogin/disable_multi_gui_login,disable multiple sapgui logons (for same SAP account),true,,1,1,High,High\nlogin/password_compliance_to_current_policy,current password needs to comply with current password policy,true,,0,0,High,Medium\nlogin/min_password_lowercase,minimum number of lower-case characters in passwords,true,GE,1,0,High,Medium\nicm/accept_remote_trace_level,Accept external switch of trace level,true,,0,0,High,High\ngw/logging,settings for gateway logging,true,AlertOnAnyChange,,,High,Medium\nsnc/accept_insecure_r3int_rfc,Accept insecure internal RFCs on SNC-enabled Server,true,,0,1,High,Medium\nlogin/password_max_idle_initial,maximum #days a password (set by the admin) can be unused (idle),true,LE,7,7,High,Medium\nlogin/min_password_lng,Minimum Password Length,true,GE,8,6,High,Medium\nrfc/ext_debugging,Remote Function call debugging. See SAP KB 2909642 - Deletion of parameter rfc/ext_debugging,true,LE,2,2,High,Medium\nlogin/password_downwards_compatibility,\"password downwards compatibility (8 / 40 characters, case-sensitivity)\",true,,0,0,High,Medium\nrdisp/gui_auto_logout,Maximum idle time for SAP GUI connections,true,LE,3600,5400,High,Medium\nlogin/fails_to_session_end,Number of invalid login attempts until session end,true,LE,3,3,High,Medium\nsnc/accept_insecure_rfc,Accept insecure RFC-connections to SNC-enabled Server,true,,0,1,High,Medium\nlogin/password_history_size,Number of records to be stored in the password history,true,GE,5,5,High,Medium\nrfc/reject_expired_passwd,Prevents logon with initial or expired Password via RFC,true,,1,1,High,Medium\ngw/monitor,Enables or disables monitor commands,true,,1,1,High,Medium\nsnc/data_protection/min,Min. required data protection for incoming connections,true,,3,3,High,Medium\nrsau/enable,Enable Security Audit,true,,1,1,High,High\nwdisp/ssl_encrypt,SSL reencryption mode,true,,1,1,High,High\nsnc/data_protection/max,Limit for data protection of Secure Network Comm.,true,,3,3,High,Medium\nsnc/data_protection/use,Level of data protection for R/3 initiated connections,true,,3,3,High,Medium\nrsau/max_diskspace/per_file,Maximum size of one single security audit file,true,GE,1500000000,1000000000,High,Medium\nlogin/create_sso2_ticket,Create SSO tickets on  this  system,true,,3,3,High,High\nDIR_AUDIT,Directory for Security Audit Files,true,AlertOnAnyChange,,,High,Medium\nlogin/min_password_diff,min. number of chars which differ between old and new password,true,LE,2,1,High,Medium\nlogin/no_automatic_user_sapstar,Control of the automatic login user SAP*,true,,1,1,High,Medium\nrspo/auth/pagelimit,Activation of page limit check for spool devices,true,,0,0,High,High\nrsau/max_diskspace/per_day,Maximum size of all security audit files per day,true,GE,1500000000,1000000000,High,Medium\nlogin/min_password_letters,min. number of letters in passwords,true,GE,2,0,High,Medium\nlogin/failed_user_auto_unlock,Enable automatic unlock off locked user at midnight,true,,0,0,High,Medium\nlogin/min_password_digits,min. number of digits in passwords,true,GE,2,0,High,Medium\nrsau/max_diskspace/local,Maximum space for security audit file,true,GE,1500000000,1000000000,High,Medium\nsnc/accept_insecure_gui,Accept insecure SAPGUI logins to SNC-enabled Server,true,,0,1,High,Medium\nsnc/enable,Enable SNC-Module (Secure Network Communications),true,,1,1,High,Medium\nrsau/selection_slots,Number of selection slots for security audit,true,,10,10,High,High\nlogin/min_password_uppercase,minimum number of upper-case characters in passwords,true,GE,1,0,High,Medium\nlogin/ticket_only_by_https,generate ticket that will only be sent via https,true,,1,0,High,Medium\nsnc/extid_login_diag,Enable login with external identity (DIAG),true,,1,1,High,Medium\nlogin/accept_sso2_ticket,Accept SSO tickets for this (component) system,true,,1,1,High,High\nauth/no_check_in_some_cases,Activation of the Profile Generator,true,,Y,Y,High,High\ngw/sim_mode,start simulation mode for reg_info and sec_info,true,,0,0,High,Medium\nlogin/min_password_specials,min. number of special characters in passwords,true,,0,0,High,Medium\n"
        },
        {
            "displayName": "SAP_Dynamic_Audit_Log_Monitor_Configuration",
            "description": "Configure the SAP audit log alerts by assigning each message ID a severity level as required by you, per system role (production, non-production). This watchlist also allows for configuring a designated team to handle each of the messages. Configure the SAP audit log alerts by assigning each message ID a severity level as required by you, per system role (production, non-production). This watchlist also allows for configuring a designated team to handle each of the messages, and excluding users by SAP roles or by tags from the SAPVIPUsers watchlist.",
            "source": "ContentHub",
            "alias": "SAP_Dynamic_Audit_Log_Monitor_Configuration",
            "provider": "Microsoft",
            "itemsSearchKey": "MessageID",
            "rawContent": "MessageID,MessageText,DetailedDescription,CategoryName,StandardEventWeighting,ProductionSeverity,NonProdSeverity,ProductionThreshold,NonProdThreshold,RuleType,Tactics,TeamsChannelID,DestinationEmail,RolesTagsToExclude\nAU0,Audit - Test. Text: &A,Audit - Test. Text: &A,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAUI,Audit: Slot &A Inactive,Audit: Slot &A Inactive,System,Critical,High,High,0,0,AnomaliesOnly,Impact,,BasisTeam@MyOrg.COM,\nBU0,RAL configuration access: Action: &A  type: &B  name &C,RAL configuration access: Action: &A; type: &B; name &C,Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Resource Development,,SOCTeam@MyOrg.COM,\nBUI,SPNego replay attack detected (UPN=&A),SPNego replay attack detected (UPN=&A),Logon,Critical,High,High,0,0,Deterministic,Initial Access,,,\nCU0,RAL Log Access: Action: &A,RAL Log Access: Action: &A,Other,Critical,High,High,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUI,Application &A started,Application &A started,Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nDU0,Invalid SAP GUI data,Invalid SAP GUI data,Logon,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nDUI,RFC callback executed (destination &A  called &B  callback &C),RFC callback executed (destination &A; called &B; callback &C),RFC Start,Non-Critical,Medium,Medium,100,1000,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nEU0,Test Message for Class EU,Test Message for Class EU,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEUM,Trusted site list &A for HTTP security header was changed,Trusted site list &A for HTTP security header was changed,RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nFUD,Successful read on output document &A for object &B ( &C ),Successful read on output document &A for object &B ( &C ),Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAU1,Logon successful (type=&A  method=&C),Logon successful (type=&A; method=&C),Logon,Severe,Low,Low,30,60,AnomaliesOnly,,TeamChannelID,,MassiveLogonsOK; ZZZ_ALL_TRUSTED_RFC\nAUJ,Audit: Active status set to &1,Audit: Active status set to &1,System,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Impact,,BasisTeam@MyOrg.COM,\nBU1,Password check failed for user &B in client &A,Password check failed for user &B in client &A,Other,Critical with Monitor Alert,High,Medium,6,30,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nBUJ,Non-encrypted &A communication (&B),Non-encrypted &A communication (&B),Other,Severe,Disabled,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU1,CU Test Message,CU Test Message,Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUJ,Failed to start application &A (reason =&B),Failed to start application &A (reason =&B),Transaction Start,Critical,High,High,0,0,AnomaliesOnly,Initial Access,,BasisTeam@MyOrg.COM,\nDU1,FTP server allowlist is empty,FTP server allowlist is empty,RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUJ,RFC callback rejected (destination &A  called &B  callback &C),RFC callback rejected (destination &A; called &B; callback &C),RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nEU1,System change options changed ( &A to &B ),System change options changed ( &A to &B ),System,Critical,Low,High,0,0,Deterministic,Defense Evasion,,BasisTeam@MyOrg.COM,\nEUN,Content security policy for service &A was violated,Content security policy for service &A was violated,RFC Start,Critical,High,High,0,0,Deterministic,Credential Access,,SOCTeam@MyOrg.COM,\nFUE,Failed read on output document &A for object &B ( &C ),Failed read on output document &A for object &B ( &C ),Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAUK,Successful RFC call &C (function group = &A),Successful RFC call &C (function group = &A),RFC Start,Non-Critical,Medium,Disabled,1000,1000,Disabled,,,SOCTeam@MyOrg.COM,MassiveRFCOK\nAU2,Logon failed (reason=&B  type=&A  method=&C),Logon failed (reason=&B; type=&A; method=&C),Logon,Critical,High,High,6,30,AnomaliesOnly,Initial Access,,,\nBU2,Password changed for user &B in client &A,Password changed for user &B in client &A,User Master Record Change,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBUK,&A assertion used,&A assertion used,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,,\nCU2,OAuth 2.0: Invalid access token received (reason=&A),OAuth 2.0: Invalid access token received (reason=&A),Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCUK,C debugging activated,C debugging activated,Other,Critical,High,Low,0,0,Deterministic,,,BasisTeam@MyOrg.COM,\nDU2,FTP server allowlist is non-secure due to use of placeholders,FTP server allowlist is non-secure due to use of placeholders,RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUK,RFC callback in simulation mode (destination &A  called &B  callback &C),RFC callback in simulation mode (destination &A; called &B; callback &C),RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nEU2,Client &A settings changed ( &B ),Client &A settings changed ( &B ),System,Critical,High,High,0,0,Deterministic,Defense Evasion,,BasisTeam@MyOrg.COM,\nEUO,UCON HTTP allowlist of context type &A was changed,UCON HTTP allowlist of context type &A was changed,RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nNU0,Audit - Test. Text: &A,Audit - Test. Text: &A,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAUL,Failed RFC call &C (function group = &A),Failed RFC call &C (function group = &A),RFC Start,Critical,Medium,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAU3,Transaction &A started.,Transaction &A started.,Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBU3,Security check changed in export: Old value &A  new value &B,Security check changed in export: Old value &A; new value &B,Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Resource Development,,SOCTeam@MyOrg.COM,\nBUL,&A: &B,&A: &B,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,,\nCU3,OAuth 2.0: Insufficient OAuth 2.0 scope for requested resource (user=&A),OAuth 2.0: Insufficient OAuth 2.0 scope for requested resource (user=&A),Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCUL,Field content in debugger changed by user &A: &B (&C),Field content in debugger changed by user &A: &B (&C),Other,Critical,High,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDU3,Server &A is not contained in the allowlist,Server &A is not contained in the allowlist,RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUL,Check for &A in allowlist &B was successful,Check for &A in allowlist &B was successful,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEU3,&A change documents deleted without archiving (&B),&A change documents deleted without archiving (&B),Other,Critical,High,High,0,0,Deterministic,Impact,,BasisTeam@MyOrg.COM,\nEUP,Virtual user client=&A type=&B action=&C &D,Virtual user client=&A type=&B action=&C &D,Logon,Critical,High,High,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nWEBDYNPRO_RT 007,Web Dynpro ABAP,Web Dynpro ABAP,Web Dynpro ABAP,Low,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAUM,User &B locked in client &A after errors in password checks,User &B locked in client &A after errors in password checks,Logon,Critical with Monitor Alert,High,High,0,6,Deterministic,Reconnaissance,,,\nAU4,Start of transaction &A failed (Reason=&B),<strong>The user attempted to start the transaction specified in the message. However; starting the transaction failed; that is; the transaction was not executed.</strong> <p>Possible Reasons</p><oul><li>0 - Cause unknown</li><li>1 - Error in call parameters when calling the kernel function</li><li>2 - Transaction does not exist</li><li>3 - Transaktion & is locked (in transaction SM01)</li><li>4 - Transaction is an area menu and therefore cannot be executed</li><li>5 - Parameter transaction is an area menu and therefore cannot be executed</li><li>6 - User is not authorized for this transaction</li></ul>,Transaction Start,Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBU4,Dynamic ABAP code: Event &A  event type &B  check total &C,Dynamic ABAP code: Event &A; event type &B; check total &C,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUM,Name ID of a subject,Name ID of a subject,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,,\nCU4,OAuth 2.0: Logged-on client user &A not same as parameter client ID &B,OAuth 2.0: Logged-on client user &A not same as parameter client ID &B,Logon,Critical,High,High,0,0,Deterministic,Reconnaissance,,AuthTeam@MyOrg.COM,\nCUM,Jump to ABAP Debugger by user &A: &B (&C),<strong>In the ABAP Debugger; the user set the instruction pointer to anotherline or statement. </strong>    </br>This changed the program flow. </br>During the continued execution of the program you may pass through parts of the program thatwould usually not have been executed; or at least not under theseconditions.,Other,Critical,High,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDU4,Connection to server &A failed,Connection to server &A failed,RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUM,Check for &A in allowlist &B failed,Check for &A in allowlist &B failed,Other,Severe with Monitor Alert,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEU4,Validation successful for logical file name &A (physical: &B),Validation successful for logical file name &A (physical: &B),Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nEUV,CDS view &A (field &B) was published,CDS view &A (field &B) was published,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAUN,User &B unlocked in client &A after entering wrong password,User &B unlocked in client &A after entering wrong password,Logon,Critical,High,High,0,0,Deterministic,Reconnaissance,,,\nAU5,RFC/CPIC logon successful (type=&A  method=&C),RFC/CPIC logon successful (type=&A; method=&C),RFC Login,Non-Critical,Medium,Disabled,300,1000,Disabled,,,SOCTeam@MyOrg.COM,\nBU5,ICF recorder entry executed for user &A (activity &B),ICF recorder entry executed for user &A (activity &B),Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUN,Attribute,Attribute,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU5,OAuth 2.0: Client &A requested invalid access grant type &B,OAuth 2.0: Client &A requested invalid access grant type &B,Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCUN,A process was stopped from the debugger by user &A (&C),A process was stopped from the debugger by user &A (&C),Other,Critical,High,Low,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nDU5,There is no logical file name for path &A,There is no logical file name for path &A,RFC Start,Critical,High,High,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nDUN,Active allowlist &A changed ( &B ),Active allowlist &A changed ( &B ),Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEU5,Audit log data of &A was deleted (&B data records),Audit log data of &A was deleted (&B data records),System,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nEUW,blocklisting is activated (connection/table/field: &A &B &C),blocklisting is activated (connection/table/field: &A &B &C),Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nAUO,Logon failed (reason = &B  type = &A),Logon failed (reason = &B; type = &A),Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,,\nAU6,RFC/CPIC logon failed  reason=&B  type=&A  method=&C,RFC/CPIC logon failed; reason=&B; type=&A; method=&C,RFC Login,Critical,Disabled,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,MassiveRFCOK\nBU6,ICF recorder entry executed by user &A (&B  &C) (activity &D).,ICF recorder entry executed by user &A (&B; &C) (activity &D).,Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUO,Authentication assertion,Authentication assertion,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nCU6,OAuth 2.0: Client ID &A in SAML assertion not same as client ID &B in request,OAuth 2.0: Client ID &A in SAML assertion not same as client ID &B in request,Logon,Critical,High,High,0,0,Deterministic,Reconnaissance,,AuthTeam@MyOrg.COM,\nCUO,Explicit database operation in debugger by user &A: &B (&C),Explicit database operation in debugger by user &A: &B (&C),Other,Critical,High,Medium,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nDU6,Validation for &A successful,Validation for &A successful,RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUP,Authorization check for object &A in scenario &B failed,Authorization check for object &A in scenario &B failed,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nEUA,S/2 Cloud SDK ABAP component called,S/2 Cloud SDK ABAP component called,Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nEUX,blocklisting is deactivated (connection/table/field: &A &B &C),blocklisting is deactivated (connection/table/field: &A &B &C),Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nAUP,Transaction &A locked,Transaction &A locked,Transaction Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,AuthTeam@MyOrg.COM,\nAU7,User &A created.,User &A created.,User Master Record Change,Critical,High,Low,10,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBU7,Administration setting was changed for ICF Recorder (Activity: &A),Administration setting was changed for ICF Recorder (Activity: &A),Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Resource Development,,SOCTeam@MyOrg.COM,\nBUP,&A,&A,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU7,OAuth 2.0: Scope &B not permitted for client &C  user &D (cause=&A),OAuth 2.0: Scope &B not permitted for client &C; user &D (cause=&A),Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCUP,Non-exclusive debugging session started by user &A (&C),Non-exclusive debugging session started by user &A (&C),Other,Critical,High,Low,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nDU7,Validation for &A failed,Validation for &A failed,RFC Start,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUO,Authorization check for object &A in scenario &B successful,Authorization check for object &A in scenario &B successful,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nEUB,Could not verify the digital signature: &A,Could not verify the digital signature: &A,Other,Critical,High,High,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nEUY,Data blocking activated for &A,Data blocking activated for &A,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nAUQ,Transaction &A unlocked,Transaction &A unlocked,Transaction Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Resource Development,,AuthTeam@MyOrg.COM,\nAU8,User &A deleted.,User &A deleted.,User Master Record Change,Severe,Medium,Medium,10,0,AnomaliesOnly,Impact,,AuthTeam@MyOrg.COM,\nBU8,Virus Scan Interface: Virus &C found by profile &A (step &B),Virus Scan Interface: Virus &C found by profile &A (step &B),Other,Critical,High,High,0,0,Deterministic,Exfiltration,,SOCTeam@MyOrg.COM,\nBUQ,Signed LogoutRequest accepted,Signed LogoutRequest accepted,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU8,OAuth 2.0: Access token issued (client=&A  user=&B  grant type=&C),OAuth 2.0: Access token issued (client=&A; user=&B; grant type=&C),Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nCUQ,Logical file name &A not configured. Physical file name &B not checked.,Logical file name &A not configured. Physical file name &B not checked.,Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nDU8,FTP connection request for server &A successful,FTP connection request for server &A successful,RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUV,Authorization check for user &C on object &A in scenario &B failed,Authorization check for user &C on object &A in scenario &B failed,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nEUC,OAuth scope &A not assigned to the user,OAuth scope &A not assigned to the user,Logon,Critical,High,High,0,0,Deterministic,Initial Access,,AuthTeam@MyOrg.COM,\nEUZ,Data blocking deactivated for &A,Data blocking deactivated for &A,Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nAUR,&A &B created,&A &B created,User Master Record Change,Severe,Medium,Medium,10,10,AnomaliesOnly,Privilege Escalation,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nAU9,User &A locked.,User &A locked.,User Master Record Change,Severe,Medium,Medium,10,0,AnomaliesOnly,Impact; Privilege Escalation,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nBU9,Virus Scan Interface: Error &C occurred in profile &A (step &B),Virus Scan Interface: Error &C occurred in profile &A (step &B),Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nBUR,Unsigned LogoutRequest accepted,Unsigned LogoutRequest accepted,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU9,OAuth 2.0: Valid access token received for user &A,OAuth 2.0: Valid access token received for user &A,Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nCUR,Physical file name &B does not fulfill requirements from logical file name &A,Physical file name &B does not fulfill requirements from logical file name &A,Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\n"
        },
        {
            "displayName": "SAP_User_Config",
            "description": "SAP VIP Users allows for fine tunning alerts by excluding users and including users in specific contexts.",
            "source": "ContentHub",
            "alias": "SAP_User_Config",
            "provider": "Microsoft",
            "itemsSearchKey": "SAPUser",
            "rawContent": "SAPUser,User Identifier,User AAD Object Id,User On-Prem Sid,User Principal Name,Tags\nALEREMOTE,-,-,-,SAP batch user,Sensitive; Super; Batch; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nBWREMOTE,,,,,Sensitive; Super; Batch; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nDDIC,-,-,-,SAP dictionary user,Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nSAP_SYSTEM,,,,,Automation; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nOSS,,,,,SpecialAttention\nSENTINEL,,,,,Automation; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nEmployeeSoonToLeave,,,,,SoonToLeave\n"
        }
    ]
}