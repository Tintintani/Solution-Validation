{
    "Metadata": {
        "searchKey": "Amazon Web Services",
        "solutionName": "Amazon Web Services",
        "displayName": "Amazon Web Services",
        "contentSource": "Solution",
        "sourceName": "Amazon Web Services",
        "provider": "Amazon Web Services",
        "author": "Microsoft",
        "bladeSupportName": "Microsoft",
        "supportName": "Microsoft Corporation",
        "category": "Security - Cloud Security",
        "version": "3.0.4",
        "bladeDescription": "Note: Please refer to the following before installing the solution:\u2022 Review the solution Release Notes\u2022 There may be known issues pertaining to this Solution, please refer to them before installing.The Amazon Web Services solution for Microsoft Sentinel allows you to enable Security monitoring of AWS services by allowing ingestion of logs from the AWS CloudTrail platform, VPC Flow Logs, AWS GuardDuty and AWS CloudWatch.Data Connectors: 3, Workbooks: 2, Analytic Rules: 57, Hunting Queries: 36Learn more about Microsoft Sentinel | Learn more about Solutions",
        "contentPageDescription": "Note:Please refer to the following before installing the solution:\u2022 Review the solution Release Notes \u2022 There may be known issues pertaining to this Solution, please refer to them before installing.The Amazon Web Services solution for Microsoft Sentinel allows you to enable Security monitoring of AWS services by allowing ingestion of logs from the AWS CloudTrail platform, VPC Flow Logs, AWS GuardDuty and AWS CloudWatch.Data Connectors:3, Workbooks:2, Analytic Rules:57, Hunting Queries:36Learn more about Microsoft Sentinel | Learn more about Solutions",
        "contentType": "57Analytics rule3Data connector36Hunting query2Workbook",
        "contentCount": 98,
        "solutionIcon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Aws.svg\" width=\"75px\" height=\"75px\">",
        "versionIcon": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTAgMi42NTYyNUgxMS45ODc1VjkuNjA1NzRDMTEuOTg3NSA5LjcxNjI4IDExLjk0NTMgOS44MjIyOSAxMS44NzAxIDkuOTAwNDRDMTEuNzk1IDkuOTc4NiAxMS42OTMgMTAuMDIyNSAxMS41ODY4IDEwLjAyMjVIMC40MDA3NUMwLjI5NDQ2NCAxMC4wMjI1IDAuMTkyNTMyIDkuOTc4NiAwLjExNzM3NyA5LjkwMDQ0QzAuMDQyMjIxOCA5LjgyMjI5IDAgOS43MTYyOCAwIDkuNjA1NzRWMi42NTYyNVoiIGZpbGw9InVybCgjcGFpbnQwX2xpbmVhcikiLz4KPHBhdGggZD0iTTAuNDAyNSAzLjk3NDAzZS0wNkgxMS41ODI0QzExLjY4ODcgMy45NzQwM2UtMDYgMTEuNzkwNiAwLjA0MzkxMzUgMTEuODY1NyAwLjEyMjA3M0MxMS45NDA5IDAuMjAwMjMyIDExLjk4MzEgMC4zMDYyMzkgMTEuOTgzMSAwLjQxNjc3NFYyLjY1NjIzSDBWMC40MTY3NzRDLTUuMDMxNjdlLTA3IDAuMzYxODg5IDAuMDEwNDIyOSAwLjMwNzU0NSAwLjAzMDY3MTggMC4yNTY4NjFDMC4wNTA5MjA3IDAuMjA2MTc3IDAuMDgwNTk2NCAwLjE2MDE1MiAwLjExNzk5NSAwLjEyMTQyOEMwLjE1NTM5NCAwLjA4MjcwMzEgMC4xOTk3NzkgMC4wNTIwNDIyIDAuMjQ4NjAyIDAuMDMxMjA0OUMwLjI5NzQyNiAwLjAxMDM2NzYgMC4zNDk3MjYgLTAuMDAwMjM1Njk2IDAuNDAyNSAzLjk3NDAzZS0wNloiIGZpbGw9IiMwMDc4RDQiLz4KPHBhdGggZD0iTTIuMDEyNyA2LjYzMzc5SDE0LjAwMDJWMTMuNTgzM0MxNC4wMDAyIDEzLjY5MzggMTMuOTU4IDEzLjc5OTggMTMuODgyOCAxMy44NzhDMTMuODA3NyAxMy45NTYxIDEzLjcwNTcgMTQuMDAwMSAxMy41OTk0IDE0LjAwMDFIMi40MTUyQzIuMzA4OTEgMTQuMDAwMSAyLjIwNjk4IDEzLjk1NjEgMi4xMzE4MiAxMy44NzhDMi4wNTY2NyAxMy43OTk4IDIuMDE0NDUgMTMuNjkzOCAyLjAxNDQ1IDEzLjU4MzNWNi42MzM3OUgyLjAxMjdaIiBmaWxsPSJ1cmwoI3BhaW50MV9saW5lYXIpIi8+CjxwYXRoIGQ9Ik0yLjQxNzgyIDMuOTczNjZIMTMuNTk3N0MxMy42NTA0IDMuOTczNDIgMTMuNzAyNiAzLjk4Mzk5IDEzLjc1MTQgNC4wMDQ3N0MxMy44MDAyIDQuMDI1NTUgMTMuODQ0NSA0LjA1NjEzIDEzLjg4MTkgNC4wOTQ3NkMxMy45MTkzIDQuMTMzMzkgMTMuOTQ5IDQuMTc5MzEgMTMuOTY5MyA0LjIyOTg4QzEzLjk4OTYgNC4yODA0NiAxNC4wMDAxIDQuMzM0NzEgMTQuMDAwMiA0LjM4OTUyVjYuNjMzNTJIMi4wMTI3VjQuMzg5NTJDMi4wMTI4MSA0LjMzNDQ4IDIuMDIzNCA0LjI4MDAxIDIuMDQzODcgNC4yMjkyNUMyLjA2NDMzIDQuMTc4NDkgMi4wOTQyNiA0LjEzMjQ1IDIuMTMxOTMgNC4wOTM3OUMyLjE2OTU5IDQuMDU1MTIgMi4yMTQyNSA0LjAyNDYgMi4yNjMzMiA0LjAwMzk4QzIuMzEyMzkgMy45ODMzNiAyLjM2NDkgMy45NzMwNiAyLjQxNzgyIDMuOTczNjZaIiBmaWxsPSIjMTk4QUIzIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9InBhaW50MF9saW5lYXIiIHgxPSI1Ljk5Mjg4IiB5MT0iMTAuMDIxNiIgeDI9IjUuOTkyODgiIHkyPSIyLjY1NjI1IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiMwMDc4RDQiLz4KPHN0b3Agb2Zmc2V0PSIwLjUwMiIgc3RvcC1jb2xvcj0iIzQwOTNFNiIvPgo8c3RvcCBvZmZzZXQ9IjAuNzc1IiBzdG9wLWNvbG9yPSIjNUVBMEVGIi8+CjwvbGluZWFyR3JhZGllbnQ+CjxsaW5lYXJHcmFkaWVudCBpZD0icGFpbnQxX2xpbmVhciIgeDE9IjguMDA3MzIiIHkxPSIxMy45OTU1IiB4Mj0iOC4wMDczMiIgeTI9IjYuNjI5MjQiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzMyQkVERCIvPgo8c3RvcCBvZmZzZXQ9IjAuMTc1IiBzdG9wLWNvbG9yPSIjMzJDQUVBIi8+CjxzdG9wIG9mZnNldD0iMC40MSIgc3RvcC1jb2xvcj0iIzMyRDJGMiIvPgo8c3RvcCBvZmZzZXQ9IjAuNzc1IiBzdG9wLWNvbG9yPSIjMzJENEY1Ii8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+Cg=="
    },
    "dataConnector": [
        {
            "searchKey": "AwsS3WafCcpDefinition",
            "displayName": "Amazon Web Services S3 WAF",
            "description": "This connector allows you to ingest AWS WAF logs, collected in AWS S3 buckets, to Microsoft Sentinel. AWS WAF logs are detailed records of traffic that web access control lists (ACLs) analyze, which are essential for maintaining the security and performance of web applications. These logs contain information such as the time AWS WAF received the request, the specifics of the request, and the action taken by the rule that the request matched.",
            "kind": "DataConnector",
            "dataTypes": "AWSWAF --",
            "provider": "Microsoft",
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "AwsS3",
            "displayName": "Amazon Web Services S3",
            "description": "This connector allows you to ingest AWS service logs, collected in AWS S3 buckets, to Microsoft Sentinel. The currently supported data types are:AWS CloudTrailVPC Flow LogsAWS GuardDutyAWSCloudWatchFor more information, see the Microsoft Sentinel documentation.",
            "kind": "DataConnector",
            "dataTypes": "AWSGuardDuty --AWSVPCFlow --AWSCloudTrail --AWSCloudWatch --",
            "provider": "Amazon",
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "AWS",
            "displayName": "Amazon Web Services",
            "description": "Follow these instructions to connect to AWS and stream your CloudTrail logs into Microsoft Sentinel. For more information, see the Microsoft Sentinel documentation.",
            "kind": "DataConnector",
            "dataTypes": "AWSCloudTrail --",
            "provider": "Amazon",
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        }
    ],
    "analyticsRule": [
        {
            "searchKey": "6f675c17-7a61-440c-abd1-c73ef4d748ec",
            "displayName": "Creation of CRUD DynamoDB policy and then privilege escalation.",
            "description": "Detected creation of new CRUD DynamoDB policy and usage of one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and ((Action contains \"dynamodb:Create\" or Action contains \"dynamodb:Put\") and (Action contains \"dynamodb:Describe\" or Action contains \"dynamodb:Get\" or Action contains \"dynamodb:Scan\")  and Action contains \"dynamodb:Update\" and Action contains \"dynamodb:Delete\") and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, SourceIpAddress, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, AttachEventCount, RecipientAccountId, AccountName, AccountUPNSuffix);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "454133a7-5427-4a7c-bdc4-0adfa84dda16",
            "displayName": "Creating keys with encrypt policy without MFA",
            "description": "Detection of KMS keys where action kms:Encrypt is accessible for everyone (also outside of your organization). This is an idicator that your account is compromised and the attacker uses the encryption key to compromise another company.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let check_actions = AWSCloudTrail| where (EventName == \"CreateKey\" or EventName == \"PutKeyPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend state=parse_json(parse_json(replace_string(tostring(parse_json(RequestParameters)['policy']),'\\\\\"','\"')).['Statement'])| mv-expand state| extend Action= tostring(parse_json(state.['Action'][0])), Effect=tostring(parse_json(state.['Effect'])),         Principal=tostring(parse_json(state.['Principal']))| where (Action == \"kms:Encrypt\" or Action == \"kms:*\") and (Effect == 'Allow') and (Principal has \"*\")| distinct AwsEventId;AWSCloudTrail| where (EventName == \"CreateKey\" or EventName == \"PutKeyPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| join kind=inner (check_actions) on AwsEventId| extend timestamp = TimeGenerated| project-away AwsEventId1",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Impact"
            ],
            "tacticsMultiple": "Impact",
            "techniques": [
                "T1485"
            ],
            "techniquesMultiple": "T1485",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "a694e977-740c-4578-9f8f-5e39029f1d23",
            "displayName": "Creation of EC2 policy and then privilege escalation",
            "description": "Detected creation of new EC2 policy and afterwards used one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and ((((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"ec2:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"ec2:RunInstances\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"ec2:Run*\")) or (Action contains \"ec2:*\") or (Action contains \"ec2:ListInstances\" and Action contains \"ec2:StartInstance\" and Action contains \"ec2:ModifyInstanceAttribute\") or (Action contains \"ec2:List*\" and Action contains \"ec2:Start*\" and Action contains \"ec2:Modify*\")) and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType,  \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn, \"SourceIpAddress\", SourceIpAddress)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "826bb2f8-7894-4785-9a6b-a8a855d8366f",
            "displayName": "Full Admin policy created and then attached to Roles, Users or Groups",
            "description": "Identity and Access Management (IAM) securely manages access to AWS services and resources.Identifies when a policy is created with Full Administrators Access (Allow-Action:,Resource:).This policy can be attached to role,user or group and may be used by an adversary to escalate a normal user privileges to an adminsitrative level.AWS IAM Policy Grammar: https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_grammar.htmland AWS IAM API at https://docs.aws.amazon.com/IAM/latest/APIReference/API_Operations.html",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy = dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource)| mvexpand Action| extend Action = tostring(Action)| where Effect =~ \"Allow\" and Action == \"*\" and Resource == \"*\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, UserIdentityUserName, RecipientAccountId, AccountName, AccountUPNSuffix| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn, \"SourceIpAddress\", SourceIpAddress)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "14 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation",
                "Defense Evasion"
            ],
            "tacticsMultiple": "Privilege Escalation1\ue946Defense Evasion",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.4",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "d0953d50-3dc1-4fa3-80fa-4d3e973a0959",
            "displayName": "Privilege escalation via CRUD Lambda policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy by CRUD Lambda policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"lambda:Create\" and Action contains \"lambda:Get\" and Action contains \"lambda:Update\" and Action contains \"kms:Delete\") and Resource == \"*\" and Condition == \"\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "8f1630c2-2e45-4df2-be43-50fba90f601d",
            "displayName": "RDS instance publicly exposed",
            "description": "Detected publicly exposed RDS instance, which could lead to a leakage of sensitive data.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where  EventName in (\"CreateDBInstance\", \"ModifyDBInstance\") and isempty(ErrorCode) and isempty(ErrorMessage)| where tostring(parse_json(RequestParameters).publiclyAccessible) == \"true\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Exfiltration"
            ],
            "tacticsMultiple": "Exfiltration",
            "techniques": [
                "T1537"
            ],
            "techniquesMultiple": "T1537",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "9da99021-d318-4711-a78a-6dea76129b3a",
            "displayName": "GuardDuty detector disabled or suspended",
            "description": "GuardDuty Detector was disabled or suspended, possibly by an attacker trying to avoid detection of its malicious activities. Verify with the user identity that this activity is legitimate.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "AWSCloudTrail| where (EventName == \"DeleteDetector\" and isempty(ErrorCode) and isempty( ErrorMessage)) or (EventName == \"UpdateDetector\" and tostring(parse_json(RequestParameters).enable) == \"false\" and isempty(ErrorCode) and isempty( ErrorMessage))| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1562"
            ],
            "techniquesMultiple": "T1562",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "719d5204-10ab-4b1f-aee1-da7326750260",
            "displayName": "Privilege escalation via CloudFormation policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on CloudFormation policy. Attackers could use these events for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and (((Action has \"iam:*\" or Action has \"iam:PassRole\") and Action has \"cloudformation:*\") or ((Action has \"iam:*\" or Action has \"iam:PassRole\") and Action contains \"cloudformation:DescribeStacks\" and Action contains \"cloudformation:CreateStack\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"cloudformation:Describe*\" and Action contains \"cloudformation:Create*\")) and Resource == \"*\" and Condition == \"\"  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "796a45ee-220b-42be-8415-c8c933cf3b6d",
            "displayName": "Creation of Lambda policy and then privilege escalation",
            "description": "Detected creation of new Lambda policy and usage of one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);  let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and ((((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:CreateFunction\" and Action contains \"lambda:InvokeFunction\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:Create*\" and Action contains \"lambda:Invoke*\")) or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:*\" and Action contains \"dynamodb:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:CreateFunction\" and Action contains \"lambda:CreateEventSourceMapping\" and Action contains \"dynamodb:PutItem\" and Action contains \"dynamodb:CreateTable\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:Create*\" and Action contains \"dynamodb:Put*\" and Action contains \"dynamodb:Create*\")) and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix,  PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "d7c39e15-997f-49e5-a782-73bf07db8aa5",
            "displayName": "Privilege escalation via CRUD KMS policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy by CRUD KMS policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"kms:Create\" and (Action contains \"kms:Get\" or Action contains \"kms:Describe\")  and (Action contains \"kms:Disable\" or Action contains \"kms:Enable\") and Action contains \"kms:Delete\") and Resource == \"*\" and Condition == \"\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "b9be2aa6-911d-4131-8658-d2a537ed49f4",
            "displayName": "Privilege escalation via CRUD DynamoDB policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy by CRUD DynamoDB Policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and ((Action contains \"dynamodb:Create\" or Action contains \"dynamodb:Put\") and (Action contains \"dynamodb:Describe\" or Action contains \"dynamodb:Get\" or Action contains \"dynamodb:Scan\")  and Action contains \"dynamodb:Update\" and Action contains \"dynamodb:Delete\") and Resource == \"*\" and Condition == \"\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "6b9b4ee6-f4c1-4b86-8c8c-beb0bb59ae44",
            "displayName": "S3 bucket exposed via ACL",
            "description": "Detected S3 bucket publicly exposed via ACL, which could lead for sensitive information leakage to the public. Verify the S3 object configurations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName == \"PutBucketAcl\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend Grant = parse_json(tostring((parse_json(RequestParameters).AccessControlPolicy))).AccessControlList.Grant| mvexpand Grant| extend cannedacl = parse_json(tostring((parse_json(RequestParameters))))| extend URI = parse_json(Grant).Grantee.URI, type = parse_json(Grant).Grantee.[\"xsi:type\"], xamzacl = parse_json(cannedacl).[\"x-amz-acl\"]| where (type == \"Group\" and (URI endswith \"AllUsers\" or URI endswith \"AuthenticatedUsers\"))  or xamzacl in (\"authenticated-read\",\"public-read\",\"public-read-write\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Exfiltration"
            ],
            "tacticsMultiple": "Exfiltration",
            "techniques": [
                "T1537"
            ],
            "techniquesMultiple": "T1537",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "8e01c41d-bd4c-4bbe-aed5-18592735052d",
            "displayName": "Privilege escalation via Lambda policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on Lambda policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and ((((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:CreateFunction\" and Action contains \"lambda:InvokeFunction\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:Create*\" and Action contains \"lambda:Invoke*\")) or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:*\" and Action contains \"dynamodb:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:CreateFunction\" and Action contains \"lambda:CreateEventSourceMapping\" and Action contains \"dynamodb:PutItem\" and Action contains \"dynamodb:CreateTable\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"lambda:Create*\" and Action contains \"dynamodb:Put*\" and Action contains \"dynamodb:Create*\")) and Resource == \"*\" and Condition == \"\"  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "c7bfadd4-34a6-4fa5-82f8-3691a32261e8",
            "displayName": "Changes to AWS Elastic Load Balancer security groups",
            "description": "Elastic Load Balancer distributes incoming traffic across multiple instances in multiple availability Zones. This increases the fault tolerance of your applications. Unwanted changes to Elastic Load Balancer specific security groups could open your environment to attack and  hence needs monitoring. More information: https://medium.com/@GorillaStack/the-most-important-aws-cloudtrail-security-events-to-track-a5b9873f8255 and https://aws.amazon.com/elasticloadbalancing/. ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "let EventNameList = dynamic([\"ApplySecurityGroupsToLoadBalancer\", \"SetSecurityGroups\"]);AWSCloudTrail| where EventName in~ (EventNameList)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize EventCount=count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated)by EventSource, EventName, UserIdentityType,  SourceIpAddress, UserAgent, SessionMfaAuthenticated, AWSRegion,AdditionalEventData, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid, ResponseElements| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Persistence"
            ],
            "tacticsMultiple": "Persistence",
            "techniques": [
                "T1098"
            ],
            "techniquesMultiple": "T1098",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "6009c632-94e9-4ffb-a11a-b4b99f457f88",
            "displayName": "Creation of DataPipeline policy and then privilege escalation.",
            "description": "Detected creation of new Datapipeline policy and usage of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"datapipeline:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"datapipeline:CreatePipeline\" and Action contains \"datapipeline:PutPipelineDefinition\" and Action contains \"datapipeline:ActivatePipeline\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"datapipeline:Create*\" and Action contains \"datapipeline:Put*\" and Action contains \"datapipeline:Activate*\")) and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn,  RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "8a607285-d95c-473d-8aab-59920de63af6",
            "displayName": "Creation of new CRUD IAM policy and then privilege escalation.",
            "description": "Detected creation of new CRUD IAM policy and usage of one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"iam:Create\" and (Action contains \"iam:Get\" or Action contains \"iam:List\")  and Action contains \"iam:Update\" and Action contains \"iam:Delete\") and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityType , UserIdentityArn, SourceIpAddress, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress,\"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, AttachEventCount, RecipientAccountId, AccountName, AccountUPNSuffix);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "65360bb0-8986-4ade-a89d-af3cf44d28aa",
            "displayName": "Changes to Amazon VPC settings",
            "description": "Amazon Virtual Private Cloud (Amazon VPC) lets you provision a logically isolated section of the AWS Cloud where you can launch AWS resources in a virtual network that you define.This identifies changes to Amazon VPC (Virtual Private Cloud) settings such as new ACL entries,routes, routetable or Gateways.More information: https://medium.com/@GorillaStack/the-most-important-aws-cloudtrail-security-events-to-track-a5b9873f8255and AWS VPC API Docs: https://docs.aws.amazon.com/AWSEC2/latest/APIReference/OperationList-query-vpc.html",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "let EventNameList = dynamic([\"CreateNetworkAclEntry\",\"CreateRoute\",\"CreateRouteTable\",\"CreateInternetGateway\",\"CreateNatGateway\"]);AWSCloudTrail| where EventName in~ (EventNameList)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation",
                "Lateral Movement"
            ],
            "tacticsMultiple": "Privilege Escalation1\ue946Lateral Movement",
            "techniques": [
                "T1078",
                "T1563"
            ],
            "techniquesMultiple": "T10781\ue946T1563",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.5",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "4f19d4e3-ec5f-4abc-9e61-819eb131758c",
            "displayName": "Changes to AWS Security Group ingress and egress settings",
            "description": "A Security Group acts as a virtual firewall of an instance to control inbound and outbound traffic. Hence, ingress and egress settings changes to AWS Security Group should be monitored as these can expose the enviornment to new attack vectors.More information: https://medium.com/@GorillaStack/the-most-important-aws-cloudtrail-security-events-to-track-a5b9873f8255. ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "let EventNameList = dynamic([ \"AuthorizeSecurityGroupEgress\", \"AuthorizeSecurityGroupIngress\", \"RevokeSecurityGroupEgress\", \"RevokeSecurityGroupIngress\"]);AWSCloudTrail| where EventName in~ (EventNameList)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize EventCount=count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated)by EventSource, EventName, UserIdentityType, RecipientAccountId, AccountName, AccountUPNSuffix, SourceIpAddress, UserAgent, SessionMfaAuthenticated, AWSRegion,AdditionalEventData, UserIdentityAccountId, UserIdentityPrincipalid, ResponseElements| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Persistence"
            ],
            "tacticsMultiple": "Persistence",
            "techniques": [
                "T1098"
            ],
            "techniquesMultiple": "T1098",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "9e457dc4-81f0-4d25-bc37-a5fa4a17946a",
            "displayName": "Suspicious AWS EC2 Compute Resource Deployments",
            "description": "This detection focused on Suspicious deployment of AWS EC2 resource (virtual machine) scale sets was detected. This behavior might indicate that the threat actor is deploying computing resources for cryptocurrency mining activities.This detection centers around identifying suspicious instances of AWS EC2 resource deployment, particularly scale sets. Such behavior raises concerns of potential threat actor involvement, potentially indicative of efforts to deploy computing resources for the purpose of cryptocurrency mining activities",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// Retrieve AWS CloudTrail events generated within the last dayAWSCloudTrail// Filter events related to instance creation| where EventName =~ \"RunInstances\"// Exclude events with error messages| where isempty(ErrorMessage)// Extract the event source type| extend EventSourceSplit = split(EventSource, \".\")| extend Type = tostring(EventSourceSplit[0])// Extract instance-related details from the event data| extend instance = tostring(parse_json(RequestParameters).instanceType),platform = tostring(parse_json(ResponseElements).instancesSet.items[0].platform)// Determine the operating system platform| extend OSplatform = iff(isempty(platform), tostring(\"Linux\"), platform),CPU = tostring(parse_json(ResponseElements).instancesSet.items[0].cpuOptions),core = toint(parse_json(ResponseElements).instancesSet.items[0].cpuOptions.coreCount),corThread = toint(parse_json(ResponseElements).instancesSet.items[0].cpuOptions.threadsPerCore),InstanceId = tostring(parse_json(ResponseElements).instancesSet.items[0].instanceId)// Filter out instances with empty core values| where isnotempty(core)// Calculate the total compute based on core and thread counts| extend totalCorecompute = core * corThread| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")// Summarize relevant information for analysis| summarize Start= min(TimeGenerated),  end=   max(TimeGenerated),  totalgpu= sum(totalCorecompute)  by SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserAgent// Filter results based on total GPU compute and time duration| where totalgpu > 800| where datetime_diff('hour', end, Start) < 8",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Impact"
            ],
            "tacticsMultiple": "Impact",
            "techniques": [
                "T1496"
            ],
            "techniquesMultiple": "T1496",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "49ce5322-60d7-4b02-ad79-99f650aa5790",
            "displayName": "Privilege escalation with admin managed policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on admin managed policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where  EventName in (\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| where tostring(parse_json(RequestParameters).policyArn) contains \"Admin\" and tostring(parse_json(RequestParameters).policyArn) !contains \"FullAccess\" and tostring(parse_json(RequestParameters).policyArn) !startswith \"arn:aws:iam::aws:policy/AdministratorAccess\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, RequestParameters, ResponseElements, UserIdentityArn| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "467cbe7e-e6d4-4f4e-8e44-84dd01932c32",
            "displayName": "Created CRUD S3 policy and then privilege escalation",
            "description": "Detected creation of new CRUD S3 policy and afterwards used one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"s3:Create\" and Action contains \"s3:Get\" and Action contains \"s3:Put\" and Action contains \"s3:Delete\") and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName, UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, AttachEventCount, RecipientAccountId, AccountName, AccountUPNSuffix);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "75647b58-bcc8-4eb5-9658-46698d3fa153",
            "displayName": "SSM document is publicly exposed",
            "description": "Detected a SSM document that is publicly exposed, which could lead to sensitive information leakage to the public. Verify the object configurations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where  EventName == \"ModifyDocumentPermission\" and isempty(ErrorCode) and isempty(ErrorMessage)| where todynamic(parse_json(RequestParameters).[\"accountIdsToAdd\"]) == '[\"all\"]'| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,UserIdentityUserName, SessionMfaAuthenticated, RecipientAccountId, AccountName, AccountUPNSuffix, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, RequestParameters, ResponseElements, UserIdentityArn| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Discovery"
            ],
            "tacticsMultiple": "Discovery",
            "techniques": [
                "T1526"
            ],
            "techniquesMultiple": "T1526",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "19602494-94af-43c8-90ba-eb0e14999612",
            "displayName": "Automatic image scanning disabled for ECR",
            "description": "Image Scanning for ECR was disabled, which could lead to missing vulnerable container images in your environment. Attackers could disable the Image Scanning for defense evasion purposes.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName == \"PutImageScanningConfiguration\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend scanOnPush = parse_json(tostring((parse_json(RequestParameters).imageScanningConfiguration))).scanOnPush| where scanOnPush == false| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, SourceIpAddress, UserIdentityArn, UserIdentityUserName, RecipientAccountId, AccountName, AccountUPNSuffix| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1562"
            ],
            "techniquesMultiple": "T1562",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "093fe75e-44f1-4d3e-94dc-6d258a6dd2d2",
            "displayName": "AWS Config Service Resource Deletion Attempts",
            "description": "Detects attempts to remove a part of the AWS Config Service.The Threat Actor may manipulate the Config services decrease the visibility into the security posture of an account and / or its workload instances.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "let EventNameList = dynamic([\"UpdateTrail\",\"DeleteTrail\",\"StopLogging\",\"DeleteFlowLogs\",\"DeleteEventBus\"]);AWSCloudTrail| where EventName in~ (EventNameList)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1562",
                "T1562"
            ],
            "techniquesMultiple": "T15621\ue946T1562",
            "subTechniques": [
                "T1562.001"
            ],
            "subTechniquesMultiple": "T1562.001",
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "e20d35a3-4fec-4c8b-81b1-fc33b41990b0",
            "displayName": "Privilege escalation via CRUD IAM policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy by CRUD IAM policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and (Action contains \"iam:Create\" and (Action contains \"iam:Get\" or Action contains \"iam:List\")  and Action contains \"iam:Update\" and Action contains \"iam:Delete\") and Resource == \"*\" and Condition == \"\"  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "32555639-b639-4c2b-afda-c0ae0abefa55",
            "displayName": "Monitor AWS Credential abuse or hijacking",
            "description": "Looking for GetCallerIdentity Events where the UserID Type is AssumedRoleAn attacker who has assumed the role of a legitimate account can call the GetCallerIdentity function to determine what account they are using.A legitimate user using legitimate credentials would not need to call GetCallerIdentity since they should already know what account they are using.More Information: https://duo.com/decipher/trailblazer-hunts-compromised-credentials-in-awsAWS STS GetCallerIdentity API: https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "AWSCloudTrail| where EventName =~ \"GetCallerIdentity\" and UserIdentityType =~ \"AssumedRole\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by SourceIpAddress, EventName, EventTypeName, UserIdentityType, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid,UserAgent, UserIdentityUserName, SessionMfaAuthenticated,AWSRegion, EventSource, AdditionalEventData, ResponseElements| extend timestamp = StartTime| sort by EndTime desc nulls last",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Discovery"
            ],
            "tacticsMultiple": "Discovery",
            "techniques": [
                "T1087"
            ],
            "techniquesMultiple": "T1087",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "139e7116-3884-4246-9978-c8f740770bdf",
            "displayName": "Privilege escalation with AdministratorAccess managed policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on AdministratorAccess managed policy. Attackers could use these events for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where  EventName in (\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| where tostring(parse_json(RequestParameters).policyArn) startswith \"arn:aws:iam::aws:policy/AdministratorAccess\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, RequestParameters, UserIdentityArn, ResponseElements, RecipientAccountId, AccountName, AccountUPNSuffix| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "370f0e5e-da1d-4a14-8ced-d1d7ab66a8d7",
            "displayName": "Privilege escalation via Glue policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on Glue policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and ((((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"glue:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"glue:CreateDevEndpoint\" and Action contains \"glue:GetDevEndpoints\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"glue:Create*\" and Action contains \"glue:Get*\")) or (Action contains \"glue:*\") or (Action contains \"glue:GetDevEndpoints\" and Action contains \"glue:UpdateDevEndpoint\") or (Action contains \"glue:Get*\" and Action contains \"glue:Update*\")) and Resource == \"*\" and Condition == \"\"  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "efdc3cff-f006-426f-97fd-4657862f7b9a",
            "displayName": "CloudFormation policy created then used for privilege escalation",
            "description": "Detected creation of new Cloudformation policy and usage of one of the attach policy events (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (((Action has \"iam:*\" or Action has \"iam:PassRole\") and Action has \"cloudformation:*\") or ((Action has \"iam:*\" or Action has \"iam:PassRole\") and Action contains \"cloudformation:DescribeStacks\" and Action contains \"cloudformation:CreateStack\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"cloudformation:Describe*\" and Action contains \"cloudformation:Create*\")) and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn,  RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityType , UserIdentityArn, SourceIpAddress, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, AttachEventCount, RecipientAccountId, AccountName, AccountUPNSuffix);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "48896551-1c28-4a09-8388-e51e5a927d23",
            "displayName": "Privilege escalation via DataPipeline policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on Datapipeline policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and (((Action has \"iam:*\" or Action has \"iam:PassRole\") and Action has \"datapipeline:*\") or ((Action has \"iam:*\" or Action has \"iam:PassRole\") and Action has \"datapipeline:CreatePipeline\" and Action has \"datapipeline:PutPipelineDefinition\" and Action has \"datapipeline:ActivatePipeline\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"datapipeline:Create*\" and Action contains \"datapipeline:Put*\" and Action contains \"datapipeline:Activate*\")) and Resource == \"*\" and isempty(Condition)  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "8e15998e-1e32-4b6d-abd1-e8482e8f3def",
            "displayName": "Creation of CRUD KMS policy and then privilege escalation",
            "description": "Detected creation of new CRUD KMS policy and usage of one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"kms:Create\" and (Action contains \"kms:Get\" or Action contains \"kms:Describe\")  and (Action contains \"kms:Disable\" or Action contains \"kms:Enable\") and Action contains \"kms:Delete\") and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn,  RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "8c2ef238-67a0-497d-b1dd-5c8a0f533e25",
            "displayName": "Changes to internet facing AWS RDS Database instances",
            "description": "Amazon Relational Database Service (RDS) is scalable relational database in the cloud.If your organization have one or more AWS RDS Databases running, monitoring changes to especially internet facing AWS RDS (Relational Database Service)Once alerts triggered, validate if changes observed are authorized and adhere to change control policy.More information: https://medium.com/@GorillaStack/the-most-important-aws-cloudtrail-security-events-to-track-a5b9873f8255and RDS API Reference Docs: https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_Operations.html",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "let EventNameList = dynamic([\"AuthorizeDBSecurityGroupIngress\",\"CreateDBSecurityGroup\",\"DeleteDBSecurityGroup\",\"RevokeDBSecurityGroupIngress\"]);AWSCloudTrail| where EventName in~ (EventNameList)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Persistence"
            ],
            "tacticsMultiple": "Persistence",
            "techniques": [
                "T1098"
            ],
            "techniquesMultiple": "T1098",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "aaa2c05e-fdd4-4fa0-9072-6cffe3641b34",
            "displayName": "Creation of SSM policy and then privilege escalation",
            "description": "Detected creation of new SSM policy and afterwards used one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);  let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"ssm:*\" or Action contains \"ssm:Create*\" or Action contains \"ssm:CreateAssociation\") and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn, \"SourceIpAddress\", SourceIpAddress)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "09f2a28b-3286-4268-9e2f-33805f104e5d",
            "displayName": "S3 object publicly exposed",
            "description": "Detected S3 bucket that's publicly exposed, which could lead to sensitive information leakage to the public. Verify the S3 object configurations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName == \"PutObjectAcl\" and isempty(ErrorCode) and isempty(ErrorMessage)  | extend Grant = parse_json(tostring((parse_json(RequestParameters).AccessControlPolicy))).AccessControlList.Grant  | mvexpand Grant  | extend cannedacl = parse_json(tostring((parse_json(RequestParameters))))  | extend URI = parse_json(Grant).Grantee.URI, type = parse_json(Grant).Grantee.[\"xsi:type\"], xamzacl = parse_json(cannedacl).[\"x-amz-acl\"]  | where (type == \"Group\" and (URI endswith \"AllUsers\" or URI endswith \"AuthenticatedUsers\"))    or xamzacl in (\"authenticated-read\",\"public-read\",\"public-read-write\")  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Exfiltration"
            ],
            "tacticsMultiple": "Exfiltration",
            "techniques": [
                "T1537"
            ],
            "techniquesMultiple": "T1537",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "bce1dcba-4948-414d-8838-6385afb9d496",
            "displayName": "SAML update identity provider",
            "description": "Attackers could update the SAML provider in order to create unauthorized but valid tokens and represent them to services that trust SAML tokens from the environment. These tokens can then be used to access resources. More about this API at https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateSAMLProvider.html ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "AWSCloudTrail| where EventName == \"UpdateSAMLProvider\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Persistence"
            ],
            "tacticsMultiple": "Persistence",
            "techniques": [
                "T1078"
            ],
            "techniquesMultiple": "T1078",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "56626956-304f-4408-8ea6-7ba5746ce09e",
            "displayName": "Creation of Glue policy and then privilege escalation",
            "description": "Detected creation of new Glue policy and usage one of the attach policy operations (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and ((((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"glue:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"glue:CreateDevEndpoint\" and Action contains \"glue:GetDevEndpoints\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"glue:Create*\" and Action contains \"glue:Get*\")) or (Action contains \"glue:*\") or (Action contains \"glue:GetDevEndpoints\" and Action contains \"glue:UpdateDevEndpoint\") or (Action contains \"glue:Get*\" and Action contains \"glue:Update*\")) and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName,   UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType,\"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "bf0cde21-0c41-48f6-a40c-6b5bd71fa106",
            "displayName": "AWS Guard Duty Alert",
            "description": "Amazon GuardDuty is a threat detection service that continuously monitors your AWS accounts and workloads for malicious activity and delivers detailed security findings for visibility and remediation. This templates create an alert for each Amazon GuardDuty finding.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "// https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_findings.html AWSGuardDuty // Parse the finding// https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-format.html // Example: \"ThreatPurpose:ResourceTypeAffected/ThreatFamilyName.DetectionMechanism!Artifact\"| extend findingTokens = split(ActivityType, \":\")| extend ThreatPurpose=findingTokens[0], findingTokens=split(findingTokens[1], \"/\")| extend ResourceTypeAffected=findingTokens[0], findingTokens= split(findingTokens[1], \".\")| extend ThreatFamilyName=findingTokens[0], findingTokens=split(findingTokens[1], \"!\")| extend DetectionMechanism=findingTokens[0], Artifact=findingTokens[1]// Assign severity level// https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_findings.html#guardduty_findings-severity| extend Severity =     case (      Severity >= 7.0, \"High\",      Severity between (4.0 .. 6.9), \"Medium\",      Severity between (1.0 .. 3.9), \"Low\",      \"Unknown\"    )// Pull out any available resource details we can extract entities from. These may not exist in the alert.// https://docs.aws.amazon.com/guardduty/latest/APIReference/API_Resource.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_AccessKeyDetails.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_RdsDbUserDetails.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_KubernetesDetails.html | extend AccessKeyDetails=ResourceDetails.accessKeyDetails| extend RdsDbUserDetails=ResourceDetails.rdsDbUserDetails| extend KubernetesDetails=ResourceDetails.kubernetesDetails// Pull out any available action details we can extract entities from. These may not exist in the alert.// https://docs.aws.amazon.com/guardduty/latest/APIReference/API_Action.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_AwsApiCallAction.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_KubernetesApiCallAction.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_NetworkConnectionAction.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_RdsLoginAttemptAction.html | extend ServiceAction =     case(      isnotempty(ServiceDetails.action.awsApiCallAction), ServiceDetails.action.awsApiCallAction,      isnotempty(ServiceDetails.action.kubernetesApiCallAction), ServiceDetails.action.kubernetesApiCallAction,      isnotempty(ServiceDetails.action.networkConnectionAction), ServiceDetails.action.networkConnectionAction,      isnotempty(ServiceDetails.action.rdsLoginAttemptAction), ServiceDetails.action.rdsLoginAttemptAction,      dynamic(null)    )// The IPv4 remote address of the connection// https://docs.aws.amazon.com/guardduty/latest/APIReference/API_RemoteIpDetails.html // or// The IP of the Kubernetes API caller and the IPs of any proxies or load balancers between the caller and the API endpoint // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_KubernetesApiCallAction.html | extend RemoteIpAddress =     coalesce(      tostring(ServiceAction.remoteIpDetails.ipAddressV4),      tostring(parse_json(ServiceAction.sourceIPs)[0])    )// The IPv4 local address of the connection// https://docs.aws.amazon.com/guardduty/latest/APIReference/API_LocalIpDetails.html | extend LocalIpAddress = ServiceAction.localIpDetails.ipAddressV4// The AWS account ID of the remote API caller.// https://docs.aws.amazon.com/guardduty/latest/APIReference/API_AwsApiCallAction.html // https://docs.aws.amazon.com/guardduty/latest/APIReference/API_RemoteAccountDetails.html | extend RemoteAWSAccountId = ServiceAction.remoteAccountDetails.accountId// The IAM access key details (user information) of a user that engaged in the activity that prompted GuardDuty to generate a finding// https://docs.aws.amazon.com/guardduty/latest/APIReference/API_AccessKeyDetails.html | extend AccountUpn =     case(      AccessKeyDetails.userType == \"IAMUser\", AccessKeyDetails.userName,      AccessKeyDetails.userType == \"AssumedRole\", split(AccessKeyDetails.principalId, \":\", 1)[0],      isnotempty(RdsDbUserDetails.user), RdsDbUserDetails.user,      isnotempty(KubernetesDetails.kubernetesUserDetails.username), KubernetesDetails.kubernetesUserDetails.username,      \"\"    )| extend AccountName = split(AccountUpn, \"@\", 0)[0]| extend UPNSuffix = split(AccountUpn, \"@\", 1)[0]// Clean up the output| extend GuardDutyDetails =    bag_pack(       \"DetectorId\", ServiceDetails.detectorId,      \"Partition\", Partition,      \"Region\", Region    )| extend FindingLink =     iff(      isnotempty(Region) and isnotempty(Id),      strcat(\"https://\", Region, \".console.aws.amazon.com/guardduty/home?region=\", Region, \"#/findings?fId=\", Id),      \"\"    )| extend FindingLinkDescription =     iff(      isnotempty(FindingLink),      strcat(\"Link to GuardDuty finding (AWS): \", FindingLink),      \"\"    )| project-rename     FindingArn=Arn,    FindingId=Id,    AWSAccountId=AccountId| project-away     ActivityType,     findingTokens,    Partition,    Region,     SchemaVersion,    TimeGenerated,    Type",
            "ruleFrequency": "5 hours",
            "rulePeriod": "5 hours",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [],
            "tacticsMultiple": [],
            "techniques": [],
            "techniquesMultiple": [],
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "UPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RemoteAWSAccountId",
                            "identifier": "ObjectGuid"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "RemoteIpAddress",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "LocalIpAddress",
                            "identifier": "Address"
                        }
                    ]
                },
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "FindingLink",
                            "identifier": "Url"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWSS3",
            "dataConnectorName": "Amazon Web Services S3",
            "dataTypes": "AWSGuardDuty --",
            "version": "1.0.6",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "b442b9e2-5cc4-4129-a85b-a5ef38a9e5f0",
            "displayName": "S3 bucket suspicious ransomware activity",
            "description": "Suspicious S3 bucket activity indicating ransomware was detected.An attacker might download all the objects in a compromised S3 bucket, encrypt them with his own key, then upload them back to the same bucket, overwriting the existing ones.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let timeframe = 1h;let lookback = 2h;// The attacker downloads the object(s) from the compromised bucketlet GetObject = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName == \"GetObject\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend bucketName = tostring(parse_json(RequestParameters).bucketName), keyName = tostring(parse_json(RequestParameters).key)| project-rename StartTime = TimeGenerated;// Then, the attacker overwrites the same object(s) but encrypted with his own keylet PutObject = AWSCloudTrail| where TimeGenerated >= ago(timeframe)| where EventName == \"PutObject\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend bucketName = tostring(parse_json(RequestParameters).bucketName), keyName = tostring(parse_json(RequestParameters).key)| extend kmsId = tostring(parse_json(RequestParameters).[\"x-amz-server-side-encryption-aws-kms-key-id\"])| where tostring(kmsId) !has tostring(RecipientAccountId) and kmsId <> \"\";PutObject| join kind=inner (   GetObject)on $left.bucketName == $right.bucketName, $left.keyName == $right.keyName| where TimeGenerated > StartTime| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = StartTime",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Impact"
            ],
            "tacticsMultiple": "Impact",
            "techniques": [
                "T1486"
            ],
            "techniquesMultiple": "T1486",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "610d3850-c26f-4f20-8d86-f10fdf2425f5",
            "displayName": "Changes made to AWS CloudTrail logs",
            "description": "Attackers often try to hide their steps by deleting or stopping the collection of logs that could show their activity.This alert identifies any manipulation of AWS CloudTrail, Cloudwatch/EventBridge or VPC Flow logs.More Information: AWS CloudTrail API: https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_Operations.htmlAWS Cloudwatch/Eventbridge API: https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_Operations.htmlAWS DelteteFlowLogs API : https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteFlowLogs.html ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "let EventNameList = dynamic([\"UpdateTrail\",\"DeleteTrail\",\"StopLogging\",\"DeleteFlowLogs\",\"DeleteEventBus\"]);AWSCloudTrail| where EventName in~ (EventNameList)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1070"
            ],
            "techniquesMultiple": "T1070",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.4",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "0ee2aafb-4500-4e36-bcb1-e90eec2f0b9b",
            "displayName": "NRT Login to AWS Management Console without MFA",
            "description": "Multi-Factor Authentication (MFA) helps you to prevent credential compromise. This alert identifies logins to the AWS Management Console without MFA.You can limit this detection to trigger for administrative accounts if you do not have MFA enabled on all accounts.This is done by looking at the eventName ConsoleLogin and if the AdditionalEventData field indicates MFA was NOT used and the ResponseElements field indicates NOT a Failure. Thereby indicating that a non-MFA login was successful.",
            "kind": "AnalyticsRule",
            "ruleType": "NRT",
            "severity": "Low",
            "query": "AWSCloudTrail| where EventName =~ \"ConsoleLogin\"| extend MFAUsed = tostring(parse_json(AdditionalEventData).MFAUsed), LoginResult = tostring(parse_json(ResponseElements).ConsoleLogin)| where MFAUsed !~ \"Yes\" and LoginResult !~ \"Failure\"| where SessionIssuerUserName !contains \"AWSReservedSSO\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, LoginResult, MFAUsed, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId,  UserIdentityPrincipalid, UserAgent,  UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion",
            "ruleFrequency": "",
            "rulePeriod": "",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "",
            "tactics": [
                "Defense Evasion",
                "Privilege Escalation",
                "Persistence",
                "Initial Access"
            ],
            "tacticsMultiple": "Defense Evasion3\ue946Privilege EscalationPersistenceInitial Access",
            "techniques": [
                "T1078"
            ],
            "techniquesMultiple": "T1078",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "874a1762-3fd7-4489-b411-6d4a9e9e8a59",
            "displayName": "Policy version set to default",
            "description": "An attacker with SetDefaultPolicyVersion permissions could escalate privileges through existing policy versions that are not currently in use. More about this API at https://docs.aws.amazon.com/IAM/latest/APIReference/API_SetDefaultPolicyVersion.html ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName == \"SetDefaultPolicyVersion\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Initial Access"
            ],
            "tacticsMultiple": "Initial Access",
            "techniques": [
                "T1078"
            ],
            "techniquesMultiple": "T1078",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "22115d3c-e87c-485a-9130-33797d619124",
            "displayName": "Creation of CRUD Lambda policy and then privilege escalation",
            "description": "Detected creation of new CRUD Lambda policy and usage of the attach policy events (AttachUserPolicy/AttachRolePolicy/AttachGroupPolicy). This might indicate a privilege escalation technique that attackers could use.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let createPolicy =  dynamic([\"CreatePolicy\", \"CreatePolicyVersion\"]);let timeframe = 1d;let lookback = 14d;// Creating Master table with all the events to use with materialize for better performancelet EventInfo = AWSCloudTrail| where TimeGenerated >= ago(lookback)| where EventName in (EventNameList) or EventName in (createPolicy)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\");//Checking for Policy creation event with Full Admin Privileges since lookback period.let FullAdminPolicyEvents =  materialize(  EventInfo| where TimeGenerated >= ago(lookback)| where EventName in (createPolicy)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"lambda:Create\" and Action contains \"lambda:Get\" and Action contains \"lambda:Update\" and Action contains \"kms:Delete\") and Resource == \"*\" and Condition == \"\"| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, RecipientAccountId, AccountName, AccountUPNSuffix| project-rename StartTime = TimeGenerated  );let PolicyAttach = materialize(  EventInfo| where TimeGenerated >= ago(timeframe)| where EventName in (EventNameList) and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(split(tostring(parse_json(RequestParameters).policyArn),\"/\")[1])| summarize AttachEventCount=count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by EventSource, EventName, UserIdentityType , UserIdentityArn, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, PolicyName| extend AttachEvent = pack(\"StartTime\", StartTime, \"EndTime\", EndTime, \"EventName\", EventName, \"UserIdentityType\",   UserIdentityType, \"SourceIpAddress\", SourceIpAddress, \"AccountName\", AccountName, \"AccountUPNSuffix\", AccountUPNSuffix, \"RecipientAccountId\", RecipientAccountId, \"UserIdentityArn\", UserIdentityArn)| project EventSource, PolicyName, AttachEvent, RecipientAccountId, AccountName, AccountUPNSuffix, AttachEventCount);// Joining the list of PolicyNames and checking if it has been attached to any Roles/Users/Groups.// These Roles/Users/Groups will be Privileged and can be used by adversaries as pivot point for privilege escalation via multiple ways.FullAdminPolicyEvents| join kind=leftouter(    PolicyAttach)on PolicyName| project-away PolicyName1| extend timestamp = StartTime",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.3",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "c668c09f-5a49-43f9-b249-6b89a31ec8fb",
            "displayName": "Privilege escalation via SSM policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on SSM Policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and (Action contains \"ssm:*\" or Action contains \"ssm:Create*\" or Action contains \"ssm:CreateAssociation\") and Resource == \"*\" and isempty(Condition)  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "60dfc193-0f73-4279-b43c-110ade02b201",
            "displayName": "Suspicious overly permissive KMS key policy created",
            "description": "An overly permissive key policy was created, resulting in KMS keys where the kms:Encrypt action is accessible to everyone (even outside of the organization). This could mean that your account is compromised and that the attacker is using the encryption key to compromise other organizations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let kmsActions = dynamic([\"kms:Encrypt\", \"kms:*\"]); //Add other overly permissive APIs to this list.AWSCloudTrail| where EventName in (\"CreateKey\",\"PutKeyPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policy))).Statement| mvexpand Statement| extend Action = tostring(parse_json(Statement).Action), Effect = tostring(parse_json(Statement).Effect), Principal = iff(isnotempty(tostring(parse_json(Statement).Principal.AWS)),tostring(parse_json(Statement).Principal.AWS), tostring(parse_json(Statement).Principal))| where Effect =~ \"Allow\" and Action has_any (kmsActions) and Principal == \"*\" | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Impact"
            ],
            "tacticsMultiple": "Impact",
            "techniques": [
                "T1486"
            ],
            "techniquesMultiple": "T1486",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.4",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "0adab960-5565-4978-ba6d-044553e4acc4",
            "displayName": "Successful API executed from a Tor exit node",
            "description": "A successful API execution was detected from an IP address categorized as a TOR exit node by Threat Intelligence.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let TorNodes = (externaldata (TorIP:string)[h@'https://firewalliplists.gypthecat.com/lists/kusto/kusto-tor-exit.csv.zip']with (ignoreFirstRecord=true));AWSCloudTrail| where SourceIpAddress in (TorNodes) and isempty(ErrorCode) and isempty(ErrorMessage)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Execution"
            ],
            "tacticsMultiple": "Execution",
            "techniques": [
                "T1204"
            ],
            "techniquesMultiple": "T1204",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "a2b2a984-c820-4d93-830e-139bffd81fa3",
            "displayName": "Privilege escalation via EC2 policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on EC2 policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail  | where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)  | extend PolicyName = tostring(parse_json(RequestParameters).policyName)  | extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement  | mvexpand Statement  | extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)  | extend Action = tostring(Action)  | where Effect =~ \"Allow\" and ((((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"ec2:*\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"ec2:RunInstances\") or ((Action contains \"iam:*\" or Action contains \"iam:PassRole\") and Action contains \"ec2:Run*\")) or (Action contains \"ec2:*\") or (Action contains \"ec2:ListInstances\" and Action contains \"ec2:StartInstance\" and Action contains \"ec2:ModifyInstanceAttribute\") or (Action contains \"ec2:List*\" and Action contains \"ec2:Start*\" and Action contains \"ec2:Modify*\")) and Resource == \"*\" and Condition == \"\"  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)  | extend UserName = tostring(split(UserIdentityArn, '/')[-1])  | extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)  | extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),    AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")  | distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, UserIdentityArn, UserIdentityUserName, RecipientAccountId, AccountName, AccountUPNSuffix  | extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "f6928301-56da-4d2c-aabe-e1a552bc8892",
            "displayName": "ECR image scan findings high or critical",
            "description": "AWS ECR Image scan detected critical or high-severity vulnerabilities in your container image.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "AWSCloudTrail| where EventName == \"DescribeImageScanFindings\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend repoName = tostring(parse_json(ResponseElements).repositoryName)| extend imageId = tostring(parse_json(ResponseElements).imageId.imageDigest)| extend Critical = toint(parse_json(ResponseElements).imageScanFindings.findingSeverityCounts.CRITICAL)| extend High = toint(parse_json(ResponseElements).imageScanFindings.findingSeverityCounts.HIGH)| where Critical > 0 or High > 0| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Execution"
            ],
            "tacticsMultiple": "Execution",
            "techniques": [
                "T1204"
            ],
            "techniquesMultiple": "T1204",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "fc3061bb-319c-4fe9-abe2-f59899a6d907",
            "displayName": "Privilege escalation via CRUD S3 policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy by CRUD S3 Policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName in (\"PutUserPolicy\",\"PutRolePolicy\",\"PutGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend PolicyName = tostring(parse_json(RequestParameters).policyName)| extend Statement = parse_json(tostring((parse_json(RequestParameters).policyDocument))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Action contains \"s3:Create\" and Action contains \"s3:Get\" and Action contains \"s3:Put\" and Action contains \"s3:Delete\") and Resource == \"*\" and Condition == \"\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, PolicyName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "afb4191b-a142-4065-a0da-f721ee3d006c",
            "displayName": "Privilege escalation with FullAccess managed policy",
            "description": "Detected usage of AttachUserPolicy/AttachGroupPolicy/AttachRolePolicy on FullAccess managed policy. Attackers could use these operations for privilege escalation. Verify these actions with the user.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where  EventName in (\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\") and isempty(ErrorCode) and isempty(ErrorMessage)| where tostring(parse_json(RequestParameters).policyArn) has \"FullAccess\" and tostring(parse_json(RequestParameters).policyArn) !has \"Admin\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, RequestParameters, UserIdentityArn, ResponseElements| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Privilege Escalation"
            ],
            "tacticsMultiple": "Privilege Escalation",
            "techniques": [
                "T1484"
            ],
            "techniquesMultiple": "T1484",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "8c2dc344-9352-4ca1-8863-b1b7a5e09e59",
            "displayName": "Suspicious AWS CLI Command Execution",
            "description": "This detection focuses on identifying potentially suspicious activities involving the execution of AWS Command Line Interface (CLI) commands, particularly focusing on reconnaissance operations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let SuspiciousCommands= pack_array('iam.list-users', 'iam.list-groups', 'ec2.describe-vpcs', 'ec2.describe-subnets', 'route53.list-hosted-zones', 'kms.list-keys', 'kms.list-aliases', 'ecs.list-clusters', 'ecs.list-services', 'iam.list-roles', 'iam.get-user''iam.list-access-keys', 'ec2.describe-security-groups', 'ec2.describe-network-acls', 'ec2.describe-network-interfaces', 'ec2.describe-route-tables', 'ec2.describe-internet-gateways', 'ec2.describe-vpc-peering-connections', 'ec2.describe-network-interfaces', 'ec2.describe-network-interfaces', 'ec2.describe-transit-gateway-vpc-attachment', 'ec2.describe-vpc');// Retrieve AWS CloudTrail eventsAWSCloudTrail // Filter events with UserAgent starting with \"aws-cli\"| where UserAgent startswith \"aws-cli\" // Extract the command from the UserAgent using string splitting| extend command = tostring(split(UserAgent, \"off command/\", 1)[0])  // Filter events based on predefined suspicious command list| where command has_any (SuspiciousCommands)  | extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")// Summarize relevant information for further analysis| summarize     CommadCount = dcount(command),     EventCount = dcount(EventName),     commands = make_list(command),     Events = make_list(EventName)     by     bin(TimeGenerated, 1min),     RecipientAccountId, AccountName, AccountUPNSuffix,     UserIdentityUserName,     SourceIpAddress,     SessionMfaAuthenticated // Filter out results with a sufficient count of unique suspicious commands in 1 min time window| where CommadCount >= 8",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Reconnaissance"
            ],
            "tacticsMultiple": "Reconnaissance",
            "techniques": [
                "T1595",
                "T1592",
                "T1589",
                "T1589",
                "T1590",
                "T1591",
                "T1596"
            ],
            "techniquesMultiple": "T15956\ue946T1592T1589T1589T1590T1591T1596",
            "subTechniques": [
                "T1592.004",
                "T1589.002",
                "T1589.003"
            ],
            "subTechniquesMultiple": "T1592.0042\ue946T1589.002T1589.003",
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "21702832-aff3-4bd6-a8e1-663b6818503d",
            "displayName": "Suspicious command sent to EC2",
            "description": "An attacker with the necessary permissions could be executing code remotely on a machine and saving the output to his own S3 bucket. Verify this action with the user identity.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let command_executed = AWSCloudTrail| where EventName in (\"SendCommand\",\"CreateAssociation\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend params = tostring(parse_json(RequestParameters).parameters)| extend s3bucketCommand = tostring(parse_json(RequestParameters).outputS3BucketName)| extend s3bucketAssociation = tostring(parse_json(RequestParameters).outputLocation.s3Location.outputS3BucketName)| where isnotempty(params)| extend commandId = tostring(parse_json(ResponseElements).command.commandId)| extend associationId = tostring(parse_json(ResponseElements).associationDescription.associationId)| extend executionId = iff(isnotempty(commandId), commandId, associationId)| extend s3bucket = iff(isnotempty(s3bucketCommand), s3bucketCommand, s3bucketAssociation)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated;AWSCloudTrail| where EventName == \"PutObject\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend s3bucket = tostring(parse_json(RequestParameters).bucketName)| mv-expand todynamic(Resources)| extend accountId=tostring(todynamic(Resources.['accountId']))| where Resources contains \"accountId\" and accountId <> RecipientAccountId| join command_executed on s3bucket| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Execution"
            ],
            "tacticsMultiple": "Execution",
            "techniques": [
                "T1204"
            ],
            "techniquesMultiple": "T1204",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "633a91df-d031-4b6e-a413-607a61540559",
            "displayName": "Tampering to AWS CloudTrail logs",
            "description": "Attackers often try to hide their steps by deleting or stopping the collection of logs that could show their activity.This alert identifies any manipulation of AWS CloudTrail, Cloudwatch/EventBridge or VPC Flow logs.More Information: AWS CloudTrail API: https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_Operations.htmlAWS Cloudwatch/Eventbridge API: https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_Operations.htmlAWS DelteteFlowLogs API : https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteFlowLogs.html ",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let EventNameList = dynamic([\"UpdateTrail\",\"DeleteTrail\",\"StopLogging\",\"DeleteFlowLogs\",\"DeleteEventBus\",\"DeleteLogGroup\"]);AWSCloudTrail| where (EventName in~ (EventNameList) or (EventName == \"UpdateTrail\" and (parse_json(RequestParameters).enableLogFileValidation) == false) or (EventName == \"UpdateTrail\" and (parse_json(RequestParameters).isMultiRegionTrail) == false)) and isempty(ErrorMessage) and isempty(ErrorCode)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName), AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1070"
            ],
            "techniquesMultiple": "T1070",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.4",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "d25b1998-a592-4bc5-8a3a-92b39eedb1bc",
            "displayName": "Login to AWS Management Console without MFA",
            "description": "Multi-Factor Authentication (MFA) helps you to prevent credential compromise. This alert identifies logins to the AWS Management Console without MFA.You can limit this detection to trigger for adminsitrative accounts if you do not have MFA enabled on all accounts.This is done by looking at the eventName ConsoleLogin and if the AdditionalEventData field indicates MFA was NOT used and the ResponseElements field indicates NOT a Failure. Thereby indicating that a non-MFA login was successful.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Low",
            "query": "AWSCloudTrail| where EventName =~ \"ConsoleLogin\"| extend MFAUsed = tostring(parse_json(AdditionalEventData).MFAUsed), LoginResult = tostring(parse_json(ResponseElements).ConsoleLogin), indexId = indexof(tostring(UserIdentityPrincipalid),\":\")| where MFAUsed !~ \"Yes\" and LoginResult !~ \"Failure\"| where SessionIssuerUserName !contains \"AWSReservedSSO\"| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventName, EventTypeName, LoginResult, MFAUsed, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId,  UserIdentityPrincipalid, UserAgent,UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, indexId| extend timestamp = StartTimeUtc",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion",
                "Privilege Escalation",
                "Persistence",
                "Initial Access"
            ],
            "tacticsMultiple": "Defense Evasion3\ue946Privilege EscalationPersistenceInitial Access",
            "techniques": [
                "T1078"
            ],
            "techniquesMultiple": "T1078",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.5",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "31b9e94b-0df6-4a3d-a297-3457b53c5d86",
            "displayName": "Successful brute force attack on S3 Bucket.",
            "description": "A successful brute force attack on an S3 bucket was detected. Verify these actions, and if needed, remediate the compromise.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "let timeframe = 1h;let failed_attempts = AWSCloudTrail| where TimeGenerated >= ago(timeframe)| where EventName == \"GetObject\" and isnotempty(ErrorMessage) and isnotempty(ErrorCode)| where UserIdentityAccountId == \"ANONYMOUS_PRINCIPAL\" or UserIdentityAccessKeyId <> RecipientAccountId| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend bucketName = tostring(parse_json(RequestParameters).bucketName), keyName = tostring(parse_json(RequestParameters).key)| summarize time_min_failed=arg_min(TimeGenerated, *), failed_keys = dcount(keyName) by RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, SourceIpAddress, bucketName| where failed_keys > 20;let success_attempts = AWSCloudTrail| where TimeGenerated >= ago(timeframe)| where EventName == \"GetObject\" and isempty(ErrorMessage) and isempty(ErrorCode)| where UserIdentityAccountId == \"ANONYMOUS_PRINCIPAL\" or UserIdentityAccessKeyId <> RecipientAccountId| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend bucketName = tostring(parse_json(RequestParameters).bucketName), keyName = tostring(parse_json(RequestParameters).key)| summarize time_min_success=arg_min(TimeGenerated, *), success_keys = dcount(keyName) by RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, SourceIpAddress, bucketName| where success_keys >= 1;failed_attempts| join kind=inner success_attempts on SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityAccountId, bucketName| where time_min_success > time_min_failed| project-away keyName| extend timestamp = time_min_success",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1562"
            ],
            "techniquesMultiple": "T1562",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "f8ea7d50-e33b-4b9d-9c3e-a59fcbcee281",
            "displayName": "Network ACL with all the open ports to a specified CIDR",
            "description": "Detected network ACL with all the ports open to a specified CIDR. This could lead to potential lateral movements or initial access attacks. Make sure to mitigate this risk.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "High",
            "query": "AWSCloudTrail| where EventName in ('CreateNetworkAclEntry', 'ReplaceNetworkAclEntry') and isempty(ErrorMessage) and isempty(ErrorCode)| extend ruleAction = tostring(parse_json(RequestParameters)['ruleAction']),         egress=parse_json(RequestParameters)['egress'],         total_ports=(toint(parse_json(parse_json(RequestParameters)['portRange'])['to']) - toint(parse_json(parse_json(RequestParameters)['portRange'])['from'])),         aclProtocol=parse_json(RequestParameters)['aclProtocol']| where isnotempty(total_ports)| where ruleAction == 'allow' and egress == false and (aclProtocol == '-1' or (total_ports > 1024))| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 day",
            "rulePeriod": "1 day",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Defense Evasion"
            ],
            "tacticsMultiple": "Defense Evasion",
            "techniques": [
                "T1562"
            ],
            "techniquesMultiple": "T1562",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.2",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "44a5b65e-b0a9-4591-aabc-388fd92a28c4",
            "displayName": "S3 bucket exposed via policy",
            "description": "Detected S3 bucket publicly exposed via policy, this could lead for sensitive information leakage to the public. Verify the S3 object configurations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName == \"PutBucketPolicy\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend Statement = parse_json(tostring((parse_json(RequestParameters).bucketPolicy))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition), Principal_aws = tostring(parse_json(Statement).Principal.AWS), Principal = tostring(parse_json(Statement).Principal)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Principal_aws == \"*\" or Principal == \"*\") and isempty(Condition)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Exfiltration"
            ],
            "tacticsMultiple": "Exfiltration",
            "techniques": [
                "T1537"
            ],
            "techniquesMultiple": "T1537",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "b7a44e0d-ae4c-4fb2-be1b-aa0e45f2327b",
            "displayName": "S3 bucket access point publicly exposed",
            "description": "Detected S3 bucket publicly exposed via access point, which could lead to sensitive information leakage to the public. Verify the S3 object configurations.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "AWSCloudTrail| where EventName == \"PutAccessPointPolicy\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend Statement = parse_json(tostring((parse_json(RequestParameters).PutAccessPointPolicyRequest.Policy))).Statement| mvexpand Statement| extend Action = parse_json(Statement).Action , Effect = tostring(parse_json(Statement).Effect), Resource = tostring(parse_json(Statement).Resource), Condition = tostring(parse_json(Statement).Condition), Principal_aws = tostring(parse_json(Statement).Principal.AWS), Principal = tostring(parse_json(Statement).Principal)| extend Action = tostring(Action)| where Effect =~ \"Allow\" and (Principal_aws == \"*\" or Principal == \"*\") and isempty(Condition)| extend UserIdentityArn = iif(isempty(UserIdentityArn), tostring(parse_json(Resources)[0].ARN), UserIdentityArn)| extend UserName = tostring(split(UserIdentityArn, '/')[-1])| extend AccountName = case( UserIdentityPrincipalid == \"Anonymous\", \"Anonymous\", isempty(UserIdentityUserName), UserName, UserIdentityUserName)| extend AccountName = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 0)[0]), AccountName),  AccountUPNSuffix = iif(AccountName contains \"@\", tostring(split(AccountName, '@', 1)[0]), \"\")| distinct TimeGenerated, EventName, SourceIpAddress, RecipientAccountId, AccountName, AccountUPNSuffix, UserIdentityArn, UserIdentityUserName| extend timestamp = TimeGenerated",
            "ruleFrequency": "1 hour",
            "rulePeriod": "1 hour",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Exfiltration"
            ],
            "tacticsMultiple": "Exfiltration",
            "techniques": [
                "T1537"
            ],
            "techniquesMultiple": "T1537",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "columnName": "AccountName",
                            "identifier": "Name"
                        },
                        {
                            "columnName": "AccountUPNSuffix",
                            "identifier": "UPNSuffix"
                        },
                        {
                            "columnName": "RecipientAccountId",
                            "identifier": "CloudAppAccountId"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SourceIpAddress",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "AWS",
            "dataConnectorName": "Amazon Web Services",
            "dataTypes": "AWSCloudTrail --",
            "version": "1.0.1",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        }
    ],
    "huntingQuery": [
        {
            "searchKey": "46685737-676a-4084-8e98-31b2998062db",
            "displayName": "Suspicious activity of STS Token related to Kubernetes worker node",
            "description": "Suspicious activity of the STS token of an EC2 machine hosted by EKS (for example, by SSRF) indicates a possible token hijacking. An attacker may have stolen the token and could abuse its permissions to escalate privileges and move laterally in the cloud account.",
            "kind": "HuntingQuery",
            "query": "let aws_public_ips = externaldata(prefixes: string)[    h@'https://aka.ms/awspublicipaddresse/aws-public-ip-addresses/ip-ranges.json']with(format='multijson');let timeframe = 30m;let lookback = 12h;//Get the AccessKey in the STS token (IMDS) when EC2 service assumes the Role periodicallylet sts_token = AWSCloudTrail| where TimeGenerated >= ago (lookback)| where EventSource == \"sts.amazonaws.com\" and SourceIpAddress == \"ec2.amazonaws.com\"| extend instanceId = tostring(parse_json(RequestParameters).roleSessionName)| extend token = tostring(parse_json(ResponseElements).credentials.accessKeyId);//Identify if the EC2 belongs to ECS/EKSlet typeOfEC2 = AWSCloudTrail| where TimeGenerated >= ago (lookback)| extend instanceId = tostring(split(UserIdentityPrincipalid, \":\")[1])| join sts_token on instanceId| where UserAgent startswith \"kubernetes\"| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Get the identities who used that STS token - this can be the EC2 which assumed it (legit),//but it can also be an external identity (attacker) which abuses the token permissions let tokenUsage = AWSCloudTrail| where TimeGenerated >= ago (timeframe)| join kind=inner typeOfEC2 on $left.UserIdentityAccessKeyId == $right.token| extend region = AWSRegion| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Check whether the called identity is legitaws_public_ips| mv-expand todynamic(prefixes)| extend ip_prefix=tostring(todynamic(prefixes.['ip_prefix']))| extend region=tostring(todynamic(prefixes.['region']))| extend service=tostring(todynamic(prefixes.['service']))| project-away prefixes| where service == \"EC2\" | join kind=inner tokenUsage on region| where SourceIpAddress !contains \"amazonaws.com\"| where ipv4_is_private(SourceIpAddress) == false| extend IsInRange = ipv4_is_in_range(SourceIpAddress, ip_prefix)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName, AssumedRoleArn = UserIdentityArn| summarize timestamp=arg_max(timestamp,*), r = make_set(IsInRange) by SourceIpAddress, UserIdentityUserName, UserIdentityArn| where not (set_has_element(r, true))| project-away ip_prefix, IsInRange",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1528"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "81a8880f-cc20-40ce-98d6-2fc6a1c5b9a4",
            "displayName": "Suspicious EC2 launched without a key pair",
            "description": "An attacker with limited permissions, or a sophisticated attacker disguising his activity, may have launched an EC2 instance without a key pair, allowing him to execute code on the machine using the UserData attribute (for example, by executing a reverse shell).",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"RunInstances\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend items = tostring(parse_json(RequestParameters).instancesSet.items)| mv-expand todynamic(items)| extend keyName=tostring(todynamic(items.['keyName']))| where isempty(keyName) and RequestParameters contains \"userData\" and SourceIpAddress !contains \"amazonaws.com\"| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Execution"
            ],
            "techniques": [
                "T1204"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "82ecf967-d6e9-4757-8f5d-42c562a8f05f",
            "displayName": "Suspicious activity of STS token related to EC2",
            "description": "Suspicious activity of the STS token of an EC2 machine hosted by ECS (for example, by SSRF) indicates a possible token hijacking. An attacker may have stolen the token and could abuse its permissions to escalate privileges and move laterally in the cloud account.",
            "kind": "HuntingQuery",
            "query": "let aws_public_ips = externaldata(prefixes: string)[    h@'https://aka.ms/awspublicipaddresse/aws-public-ip-addresses/ip-ranges.json']with(format='multijson');let timeframe = 30m;let lookback = 12h;//Get the AccessKey in the STS token (IMDS) when EC2 service assumes the Role periodicallylet sts_token = AWSCloudTrail| where TimeGenerated >= ago (lookback)| where EventSource == \"sts.amazonaws.com\" and SourceIpAddress == \"ec2.amazonaws.com\"| extend instanceId = tostring(parse_json(RequestParameters).roleSessionName)| extend token = tostring(parse_json(ResponseElements).credentials.accessKeyId);//Identify if the EC2 belongs to ECS/EKSlet typeOfEC2 = AWSCloudTrail| where TimeGenerated >= ago (lookback)| extend instanceId = tostring(split(UserIdentityPrincipalid, \":\")[1])| join sts_token on instanceId| where UserAgent !startswith \"kubernetes\" or UserAgent !startswith \"Amazon ECS Agent\"| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Get the identities who used that STS token - this can be the EC2 which assumed it (legit),//but it can also be an external identity (attacker) which abuses the token permissions let tokenUsage = AWSCloudTrail| where TimeGenerated >= ago (timeframe)| join kind=inner typeOfEC2 on $left.UserIdentityAccessKeyId == $right.token| extend region = AWSRegion| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Check whether the called identity is legitaws_public_ips| mv-expand todynamic(prefixes)| extend ip_prefix=tostring(todynamic(prefixes.['ip_prefix']))| extend region=tostring(todynamic(prefixes.['region']))| extend service=tostring(todynamic(prefixes.['service']))| project-away prefixes| where service == \"EC2\" | join kind=inner tokenUsage on region| where SourceIpAddress !contains \"amazonaws.com\"| where ipv4_is_private(SourceIpAddress) == false| extend IsInRange = ipv4_is_in_range(SourceIpAddress, ip_prefix)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName, AssumedRoleArn = UserIdentityArn| summarize timestamp=arg_max(timestamp,*), r = make_set(IsInRange) by SourceIpAddress, UserIdentityUserName, UserIdentityArn| where not (set_has_element(r, true))| project-away ip_prefix, IsInRange",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1528"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "b9b0fd12-d72d-4f66-a013-c1acdeea2670",
            "displayName": "RDS instance master password changed",
            "description": "Detected change of the RDS Master password. Verify if this was intentional, or if it was caused by a malicious actor.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName == \"ModifyDBCluster\" and isempty(ErrorCode) and isempty(ErrorMessage)| where isnotempty(tostring(parse_json(RequestParameters).masterUserPassword))| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Privilege Escalation"
            ],
            "techniques": [
                "T1484"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "bf130d1d-702b-4af6-9528-8bc4229e59f4",
            "displayName": "Multiple failed login attempts to an existing user without MFA",
            "description": "Failed brute force attempt detected on an existing user without MFA configurations.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"ConsoleLogin\"| where tostring(parse_json(ResponseElements).ConsoleLogin) == \"Failure\" and tostring(parse_json(AdditionalEventData).MFAUsed) == \"No\"| summarize arg_min(TimeGenerated, *), failed_attempts=count() by UserIdentityUserName, SourceIpAddress| where failed_attempts > 4| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1110"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "77d0aadc-aaea-4346-b61a-bf7ac6b71bba",
            "displayName": "Lambda layer imported from external account",
            "description": "Detected an external account adding lambda layer, which attackers could use to inject a backdoor inside the lambda function. If this is the case, make sure to remove the layer from the function.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where (EventName startswith \"UpdateFunctionConfiguration\" or EventName startswith \"CreateFunction\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend layers = parse_json(tostring((parse_json(RequestParameters)))).layers| extend accId = split(parse_json(tostring((parse_json(RequestParameters)))).layers,\":\",4)| mv-expand accId| where layers <> \"\" and layers !has RecipientAccountId// Exclude AWS Owned AccIds (built-in layers)| where accId !in (\"249908578461\",\"668099181075\",\"468957933125\",\"399891621064\",\"325793726646\",\"118857876118\",\"296580773974\",\"961244031340\",\"631267018583\",\"817496625479\",\"778625758767\",\"292169987271\",\"642425348156\",\"142628438157\",\"959311844005\",\"640010853179\",\"259788987135\",\"420165488524\",\"683298794825\",\"382066503313\",\"556739011827\",\"138526772879\",\"027255383542\",\"728743619870\",\"958113053741\",\"359756378197\",\"039592058896\",\"066940009817\",\"434848589818\",\"282860088358\",\"493207061005\",\"646970417810\",\"203683718741\",\"615057806174\",\"615084187847\",\"630222743974\",\"980059726660\",\"706869817123\",\"826293736237\",\"421114256042\",\"080788657173\",\"418787028745\",\"554480029851\",\"000010852771\",\"574348263942\",\"559955524753\",\"946561847325\",\"946746059096\",\"580247275435\",\"012438385374\",\"519774774795\",\"488211338238\",\"339249233099\",\"285320876703\")| distinct TimeGenerated, EventName, SourceIpAddress, UserIdentityArn, UserIdentityUserName, tostring(layers)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Persistence"
            ],
            "techniques": [
                "T1525"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "e73ebd34-4f04-4684-a5f0-dba820127ce8",
            "displayName": "CreatePolicyVersion with excessive permissions",
            "description": "A policy with excessive permissions detected. Attacker could use that policy to escalate privileges and for malicious activities. Verify the policy creation with the entity.",
            "kind": "HuntingQuery",
            "query": "let check_actions = AWSCloudTrail| where EventName == \"CreatePolicyVersion\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend state=parse_json(parse_json(replace_string(tostring(parse_json(RequestParameters)['policyDocument']),'\\\\\"','\"')).['Statement'])| mv-expand state| extend Action= tostring(parse_json(state.['Action'][0])), Effect=tostring(parse_json(state.['Effect']))| where Action has \"*\" and Effect == 'Allow'| distinct AwsEventId;AWSCloudTrail| where EventName == \"CreatePolicyVersion\" and isempty(ErrorCode) and isempty(ErrorMessage)| join kind=inner (check_actions) on AwsEventId| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| project-away AwsEventId1",
            "tactics": [
                "Privilege Escalation"
            ],
            "techniques": [
                "T1484"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "2dd2143b-6667-4a7a-b04f-98d22caeffac",
            "displayName": "Lambda UpdateFunctionCode",
            "description": "This analytic is designed to detect an IAM user updating AWS lambda code via AWS CLI to gain persistent, further access into your AWS environment and to facilitate panting backdoors. An attacker may upload malicious code/binary to a lambda function which will be executed automatically when the function is triggered.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName startswith 'UpdateFunctionCode' and EventSource == \"lambda.amazonaws.com\" and UserIdentityType =='IAMUser' and isempty(ErrorCode) and isempty(ErrorMessage)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Execution"
            ],
            "techniques": [
                "T1204"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "70a6e84f-6f3b-4ce1-83d6-ea6df9e7a9dd",
            "displayName": "Suspicious activity of STS token related to Lambda",
            "description": "Suspicious activity of the STS token of a Lambda function (for example, by SSRF) indicates a possible token hijacking. An attacker may have stolen the token and could abuse its permissions to escalate privileges and move laterally in the cloud account.",
            "kind": "HuntingQuery",
            "query": "let aws_public_ips = externaldata(prefixes: string)[    h@'https://aka.ms/awspublicipaddresse/aws-public-ip-addresses/ip-ranges.json']with(format='multijson');let timeframe = 30m;let lookback = 12h;//Get the AccessKey in the STS token when Lambda service assumes the Role periodically (max assumed session can be 12h)let sts_token = AWSCloudTrail| where TimeGenerated >= ago (lookback)| where EventSource == \"sts.amazonaws.com\" and SourceIpAddress == \"lambda.amazonaws.com\"| extend instanceId = tostring(parse_json(RequestParameters).roleSessionName)| extend token = tostring(parse_json(ResponseElements).credentials.accessKeyId);//Get the identities who used that STS token - this can be the Lambda function itself which assumed it (legit),//but it can also be an external identity which abuses the token permissionslet tokenUsage = AWSCloudTrail| where TimeGenerated >= ago (timeframe)| join kind=inner sts_token on $left.UserIdentityAccessKeyId == $right.token| extend region = AWSRegion1| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Check whether the called identity is legitaws_public_ips| mv-expand todynamic(prefixes)| extend ip_prefix=tostring(todynamic(prefixes.['ip_prefix']))| extend region=tostring(todynamic(prefixes.['region']))| extend service=tostring(todynamic(prefixes.['service']))| project-away prefixes| where service == \"AMAZON\" | join kind=inner tokenUsage on region| where SourceIpAddress !contains \"amazonaws.com\"| where ipv4_is_private(SourceIpAddress) == false| extend IsInRange = ipv4_is_in_range(SourceIpAddress, ip_prefix)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName, AssumedRoleArn = UserIdentityArn| summarize timestamp=arg_max(timestamp,*), r = make_set(IsInRange) by SourceIpAddress, UserIdentityUserName, UserIdentityArn| where not (set_has_element(r, true))| project-away ip_prefix, IsInRange",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1528"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "d82ea1db-f600-4c9e-8ba8-d271e9c12eb8",
            "displayName": "Lambda function throttled",
            "description": "Detected Lambda function throttled. Attacker could use this technique to result in Denial of Service. More about this API at https://docs.aws.amazon.com/lambda/latest/dg/API_PutFunctionConcurrency.html ",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName startswith \"PutFunctionConcurrency\" and isempty(ErrorCode) and isempty(ErrorMessage)| where tostring(parse_json(RequestParameters).reservedConcurrentExecutions) == \"0\"| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData,UserIdentityArn, ResponseElements, FunctionName = tostring(parse_json(RequestParameters).functionName)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = FunctionName",
            "tactics": [
                "Impact"
            ],
            "techniques": [
                "T1498"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "5b6ee21d-da53-46eb-827c-eab2a9ba3d2f",
            "displayName": "Suspicious credential token access of valid IAM Roles",
            "description": "Adversaries may generate temporary credentials of existing privileged IAM roles to access AWS resources that were not previously accessible to perform malicious actions. The credentials may be generated by trusted IAM user or via AWS Cloud Instance Metadata API.This query will look for AWS STS API Assume Role operations for RoleArn (Role Amazon Resource Names) which was not historically seen.You can also limit the query to only sensitive IAM Roles which needs to be monitored.Read more about ingest custom logs using Logstash at https://github.com/Azure/Azure-Sentinel/wiki/Ingest-Custom-Logs-LogStashAWS API AssumeRole at https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html and AWS Instance Metadata API at https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html ",
            "kind": "HuntingQuery",
            "query": "let starttime = todatetime('{{StartTimeISO}}');let endtime = todatetime('{{EndTimeISO}}');let lookback = starttime - 14d;// Generating historical table of AssumeRole operations for IAM Roles to be compared with last 24 hourAWSCloudTrail| where TimeGenerated between (starttime..endtime)| where EventName == \"AssumeRole\" | extend RoleArn = tostring(parse_json(RequestParameters).roleArn)| project TimeGenerated, EventSource, EventName, UserIdentityType, UserIdentityInvokedBy , SourceIpAddress, RoleArn// Doing Leftanti join to find new AssumeRole operation for IAM role which was not seen historically generated from previous table.| join kind= leftanti(  AWSCloudTrail  | where TimeGenerated  between (lookback..starttime)  | where EventName == \"AssumeRole\" | extend RoleArn = tostring(parse_json(RequestParameters).roleArn)  | project TimeGenerated, EventSource, EventName, UserIdentityType, UserIdentityInvokedBy , SourceIpAddress, RoleArn) on RoleArn, UserIdentityInvokedBy| summarize EventCount = count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by RoleArn, EventSource, EventName, UserIdentityType, UserIdentityInvokedBy, SourceIpAddress| extend timestamp = StartTimeUtc, IPCustomEntity = SourceIpAddress, AccountCustomEntity = tostring(split(RoleArn, \"/\")[1])",
            "tactics": [
                "Initial Access,Defense Evasion"
            ],
            "techniques": [
                "T1078"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "7e258a45-b356-44f6-9a62-2643cef7b869",
            "displayName": "IAM AccessDenied discovery events",
            "description": "The following detection identifies excessive AccessDenied events within an hour timeframe. It is possible that an access key to AWS may have been stolen and is being misused to perform discovery events.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where ErrorMessage in (\"Access Denied\",\"AccessDenied\") and UserIdentityType == 'IAMUser' and UserAgent !endswith \".amazonaws.com\"| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| summarize failures = count(), Source_IP_Addresses=make_set(SourceIpAddress) by bin(TimeGenerated, 1h), UserIdentityUserName, UserIdentityArn| where failures >= 5",
            "tactics": [
                "Discovery"
            ],
            "techniques": [
                "T1087"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "13afb771-5d55-4d69-a745-83d2fc69a923",
            "displayName": "Failed brute force on S3 bucket",
            "description": "Detected failed brute attempt on S3 bucket. If it is not an anonymous principle, verify with the user.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"GetObject\" and not(isempty(ErrorCode) and isempty(ErrorMessage))| where UserIdentityAccountId == \"ANONYMOUS_PRINCIPAL\" or UserIdentityAccessKeyId <> RecipientAccountId| extend bucketName = tostring(parse_json(RequestParameters).bucketName), keyName = tostring(parse_json(RequestParameters).key)| summarize arg_max(TimeGenerated, *), failed_attempts = dcount(keyName) by UserIdentityAccountId, SourceIpAddress, bucketName| where failed_attempts > 20| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName, bucketName",
            "tactics": [
                "Discovery"
            ],
            "techniques": [
                "T1619"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "4055466c-8a84-44c6-91d0-46469f3ba0b9",
            "displayName": "New AccessKey created for Root user",
            "description": "Attackers with the CreateAccessKey permissions for other users can create an access Key ID and secret access key belonging to another user in the AWS environment for privilege escalation.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail  | where  EventName == \"CreateAccessKey\" and tostring(parse_json(RequestParameters).userName) == \"Root\" and isempty(ErrorCode) and isempty(ErrorMessage)  | project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,   UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource,UserIdentityArn, AdditionalEventData, ResponseElements, RequestParameters  | extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))  | extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Persistence"
            ],
            "techniques": [
                "T1078"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "e1a91db8-f2b3-4531-bff6-da133d4f4f1a",
            "displayName": "IAM Privilege Escalation by Instance Profile attachment",
            "description": "An instance profile is a container for an IAM role that you can use to pass role information to an EC2 instance when the instance start.Identifies when existing role is removed and new/existing high privileged role is added to instance profile.Any instance with this instance profile attached is able to perform privileged operations.AWS Instance Profile: https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.htmland CloudGoat - IAM PrivilegeEscalation by Attachment: https://github.com/RhinoSecurityLabs/cloudgoat/tree/master/scenarios/iam_privesc_by_attachment ",
            "kind": "HuntingQuery",
            "query": "// Creating separate table for RemoveRoleToInstanceProfilelet RemoveRole=AWSCloudTrail| where  EventName in~ (\"RemoveRoleFromInstanceProfile\") and isempty(ErrorMessage)| extend RoleRemoved = tostring(parse_json(RequestParameters).roleName), InstanceProfileName = tostring(parse_json(RequestParameters).instanceProfileName), TimeRemoved=TimeGenerated| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| summarize RoleRemovedCount= dcount(TimeRemoved) by TimeRemoved, EventName, EventTypeName, UserIdentityArn, UserIdentityUserName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, SourceIpAddress, AWSRegion, EventSource, RoleRemoved, InstanceProfileName;// Creating separate table for AddRoleToInstanceProfilelet AddRole=AWSCloudTrail| where  EventName in~ (\"AddRoleToInstanceProfile\") and isempty(ErrorMessage)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend RoleAdded = tostring(parse_json(RequestParameters).roleName), InstanceProfileName = tostring(parse_json(RequestParameters).instanceProfileName), TimeAdded=TimeGenerated| summarize RoleAddedCount= dcount(TimeAdded) by TimeAdded, EventName, EventTypeName, UserIdentityArn, UserIdentityUserName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, SourceIpAddress, AWSRegion, EventSource, RoleAdded, InstanceProfileName;//Joining both operations from the same source IP, user and instance profile nameRemoveRole| join kind= inner (   AddRole ) on AWSRegion,SourceIpAddress, InstanceProfileName, UserIdentityUserName| where TimeAdded  > TimeRemoved // Checking if RoleAdd operation was performed after removal| summarize TotalCount=count() by TimeAdded, TimeRemoved, RoleAdded, RoleRemoved, UserIdentityUserName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,SourceIpAddress, AWSRegion, EventSource, RoleRemovedCount, RoleAddedCount| extend timestamp = iff(TimeAdded > TimeRemoved,TimeAdded, TimeRemoved), IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Privilege Escalation"
            ],
            "techniques": [
                "T1098"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "05167149-4670-4a9f-b34e-5a0a92243194",
            "displayName": "Modification of subnet attributes",
            "description": "An attacker could modify subnet attributes in order to access resources he couldn't access before.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName == \"ModifySubnetAttribute\" and isempty(ErrorCode) and isempty(ErrorMessage)| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, UserIdentityArn, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Defense Evasion"
            ],
            "techniques": [
                "T1562"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "3b7df29e-a798-4b6b-9ef7-73b9a3cf56a2",
            "displayName": "Modification of route-table attributes",
            "description": "An attacker could modify route-table attributes in order to access resources he couldn't access before.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName in (\"CreateRoute\",\"DeleteRoute\",\"ReplaceRoute\") and isempty(ErrorCode) and isempty(ErrorMessage)| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated,UserIdentityArn, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Defense Evasion"
            ],
            "techniques": [
                "T1562"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "2b8cecfe-f705-432d-9f38-08207b9473e1",
            "displayName": "IAM assume role policy brute force",
            "description": "Several failed \"assume role\" attempts occurred on existing roles in the account. This could be an attacker trying to escalate privileges and move laterally by assuming roles in a compromised account. Verify with the user identity that the activity is legitimate.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"AssumeRole\" and ErrorMessage == \"AccessDenied\"| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName| summarize timestamp=arg_max(timestamp,*), failed_roles=dcount(ErrorMessage) by IPCustomEntity, AccountCustomEntity| where failed_roles > 2",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1110"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "b5b172b1-d976-4113-af1f-02f7bf7d2092",
            "displayName": "ECR image scan findings low",
            "description": "AWS ECR Image scan detected low severity vulnerabilities in your container image.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"DescribeImageScanFindings\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend repoName = tostring(parse_json(ResponseElements).repositoryName)| extend imageId = tostring(parse_json(ResponseElements).imageId.imageDigest)| extend Low = toint(parse_json(ResponseElements).imageScanFindings.findingSeverityCounts.LOW)| where Low > 0| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Execution"
            ],
            "techniques": [
                "T1204"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "4e3c81bf-61a4-47f4-b20d-a5a414ea08aa",
            "displayName": "CreateLoginProfile detected",
            "description": "An attacker could use CreateLoginProfile permissions on other users for privilege escalation by creating a password to a victim user without a login profile to use to login to the AWS Console.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail  | where  EventName == \"CreateLoginProfile\" and isempty(ErrorCode) and isempty(ErrorMessage)  | project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityArn,   UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements, RequestParameters  | extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))  | extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Persistence"
            ],
            "techniques": [
                "T1098"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "e0a67cd7-b4e5-4468-aae0-26cb16a1bbd2",
            "displayName": "Changes made to AWS IAM policy",
            "description": "This query looks for when an API call is made to change an IAM, particularly those related to new policies beingattached to users and roles, as well as changes to access methods and changes to account level policies.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName in~ (\"AttachGroupPolicy\", \"AttachRolePolicy\", \"AttachUserPolicy\", \"CreatePolicy\",\"DeleteGroupPolicy\", \"DeletePolicy\", \"DeleteRolePolicy\", \"DeleteUserPolicy\", \"DetachGroupPolicy\",\"PutUserPolicy\", \"PutGroupPolicy\", \"CreatePolicyVersion\", \"DeletePolicyVersion\", \"DetachRolePolicy\", \"CreatePolicy\")| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityAccountId",
            "tactics": [
                "Privilege Escalation,Defense Evasion"
            ],
            "techniques": [
                "T1078,T1484"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "c9ccaebf-314c-446d-b3f6-314560ccb0e1",
            "displayName": "Excessive execution of discovery events",
            "description": "Several enumeration API calls were executed by the same identity. This could be an attacker trying to enumerate the compromised user/token permissions. Verify with the user identity that this activity is legitimate.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where (EventName startswith \"List\" or EventName startswith \"Describe\" or EventName startswith \"Get\")| where SourceIpAddress !has \"amazonaws.com\" and UserAgent has \"aws-cli\"| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName| summarize timestamp=arg_max(timestamp,*), enum_events=dcount(EventName), num_regions=dcount(AWSRegion) by bin(TimeGenerated,24h), IPCustomEntity, AccountCustomEntity| where enum_events > 3",
            "tactics": [
                "Discovery"
            ],
            "techniques": [
                "T1526"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "70c36558-e6d8-48b4-98b3-185d555cd5af",
            "displayName": "Risky role name created",
            "description": "Detections of risky role names could indicate that a malicious framework was executed in your environment.",
            "kind": "HuntingQuery",
            "query": "let PacuRoleNames = (externaldata (RoleName:string)[h@'https://raw.githubusercontent.com/RhinoSecurityLabs/pacu/master/pacu/modules/iam__enum_roles/default-word-list.txt']);AWSCloudTrail| where EventName == \"CreateRole\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend roleName = parse_json(tostring((parse_json(RequestParameters)))).roleName| where roleName in (PacuRoleNames)| distinct TimeGenerated, EventName, SourceIpAddress, UserIdentityArn, UserIdentityUserName, tostring(roleName), UserIdentityAccountId, AWSRegion| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| summarize EventCount = count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), EventNameList=make_set(EventName), IPList=make_set(SourceIpAddress) by UserIdentityAccountId, AWSRegion, UserIdentityUserName, TimeGenerated, SourceIpAddress| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Persistence"
            ],
            "techniques": [
                "T1098"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "d022a62c-643b-4e8a-b583-0230e32a96e4",
            "displayName": "Changes made to AWS IAM objects",
            "description": "Identity and Access Management (IAM) securely manages access to AWS services and resources.This query looks for when an API call is made to change an IAM, particularly those related to new objects being created or deleted. If these turn out to be noisy, filter out the most common for your environment.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail | where  EventName in~ (\"DeleteUser\", \"DeleteGroup\", \"CreateUser\") and isempty(ErrorMessage) and isempty(ErrorCode) | project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent,    UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements | extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityAccountId",
            "tactics": [
                "Privilege Escalation,Defense Evasion"
            ],
            "techniques": [
                "T1078,T1484"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "4fbbae0a-ce5b-4b2a-b5e6-700920561680",
            "displayName": "ECR image scan findings medium",
            "description": "AWS ECR image scan detected medium severity vulnerabilities in your container image.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"DescribeImageScanFindings\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend repoName = tostring(parse_json(ResponseElements).repositoryName)| extend imageId = tostring(parse_json(ResponseElements).imageId.imageDigest)| extend Medium = toint(parse_json(ResponseElements).imageScanFindings.findingSeverityCounts.MEDIUM)| where Medium > 0| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName ",
            "tactics": [
                "Execution"
            ],
            "techniques": [
                "T1204"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "67af1633-311f-4a94-bc8f-f904a54637b2",
            "displayName": "Suspicious activity of STS token related to ECS",
            "description": "Suspicious activity of the STS token of an EC2 machine hosted by ECS (for example, by SSRF) indicates a possible token hijacking. An attacker may have stolen the token and could abuse its permissions to escalate privileges and move laterally in the cloud account.",
            "kind": "HuntingQuery",
            "query": "let aws_public_ips = externaldata(prefixes: string)[     h@'https://aka.ms/awspublicipaddresse/aws-public-ip-addresses/ip-ranges.json']with(format='multijson');let timeframe = 30m;let lookback = 12h;//Get the AccessKey in the STS token (IMDS) when EC2 service assumes the Role periodicallylet sts_token = AWSCloudTrail| where TimeGenerated >= ago (lookback)| where EventSource == \"sts.amazonaws.com\" and SourceIpAddress == \"ec2.amazonaws.com\"| extend instanceId = tostring(parse_json(RequestParameters).roleSessionName)| extend token = tostring(parse_json(ResponseElements).credentials.accessKeyId);//Identify if the EC2 belongs to ECS/EKSlet typeOfEC2 = AWSCloudTrail| where TimeGenerated >= ago (lookback)| extend instanceId = tostring(split(UserIdentityPrincipalid, \":\")[1])| join sts_token on instanceId| where UserAgent startswith \"Amazon ECS Agent\"| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Get the identities who used that STS token - this can be the EC2 which assumed it (legit),//but it can also be an external identity (attacker) which abuses the token permissions let tokenUsage = AWSCloudTrail| where TimeGenerated >= ago (timeframe)| join kind=inner typeOfEC2 on $left.UserIdentityAccessKeyId == $right.token| extend region = AWSRegion| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Check whether the called identity is legitaws_public_ips| mv-expand todynamic(prefixes)| extend ip_prefix=tostring(todynamic(prefixes.['ip_prefix']))| extend region=tostring(todynamic(prefixes.['region']))| extend service=tostring(todynamic(prefixes.['service']))| project-away prefixes| where service == \"EC2\" | join kind=inner tokenUsage on region| where SourceIpAddress !contains \"amazonaws.com\"| where ipv4_is_private(SourceIpAddress) == false| extend IsInRange = ipv4_is_in_range(SourceIpAddress, ip_prefix)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName, AssumedRoleArn = UserIdentityArn| summarize timestamp=arg_max(timestamp,*), r = make_set(IsInRange) by SourceIpAddress, UserIdentityUserName, UserIdentityArn| where not (set_has_element(r, true))| project-away ip_prefix, IsInRange",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1528"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "6eb59239-78c5-401d-acfa-5cb9b3d31cd4",
            "displayName": "S3 bucket encryption modified",
            "description": "Detected modification of bucket encryption. An attacker could modify encryption of existing buckets for denial of service attacks.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName in (\"PutBucketEncryption\",\"DeleteBucketEncryption\") and isempty(ErrorCode) and isempty(ErrorMessage)| extend encryptionConfig = tostring(parse_json(RequestParameters).ServerSideEncryptionConfiguration.Rule)| where encryptionConfig contains RecipientAccountId| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Impact"
            ],
            "techniques": [
                "T1486"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "e0d57543-acbd-428b-bb96-24a67506f84d",
            "displayName": "Unused or Unsupported Cloud Regions",
            "description": "Adversaries may create cloud instances in unused geographic service regions in order to evade detection.Access is usually obtained through compromising accounts used to manage cloud infrastructure.Refer: https://attack.mitre.org/techniques/T1535/",
            "kind": "HuntingQuery",
            "query": "let starttime = todatetime('{{StartTimeISO}}');let endtime = todatetime('{{EndTimeISO}}');let lookback = starttime - 14d;// Generating historical table of all events per AccountId and Regionlet EventInfo_CurrentDay =  materialize (AWSCloudTrail | where TimeGenerated between(starttime..endtime));let EventInfo_historical = AWSCloudTrail  | where TimeGenerated  between (lookback..starttime) | summarize max(TimeGenerated) by AWSRegion, UserIdentityAccountId;// Doing Leftanti join to find new regions historically not seen for the same account.let EventInfo_Unseen = materialize (EventInfo_CurrentDay| summarize max(TimeGenerated) by AWSRegion, UserIdentityAccountId| join kind= leftanti(  EventInfo_historical) on AWSRegion, UserIdentityAccountId);EventInfo_Unseen// Join Ununsed region seen with current data to gather context about API events seen| join kind= inner (   EventInfo_CurrentDay) on AWSRegion, UserIdentityAccountId| extend UnusedRegion = AWSRegion| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| summarize EventCount = count(), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), EventNameList=make_set(EventName), IPList=make_set(SourceIpAddress) by UserIdentityAccountId, UnusedRegion, UserIdentityUserName| extend timestamp = StartTime , AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Defense Evasion"
            ],
            "techniques": [
                "T1535"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "0cd3eb95-6c8e-4eeb-8338-a0decdc0a328",
            "displayName": "Suspicious activity of STS token related to Glue",
            "description": "Suspicious activity of the STS token of a Glue endpoint machine hosted by ECS (for example, by SSRF) indicates a possible token hijacking. An attacker may have stolen the token and could abuse its permissions to escalate privileges and move laterally in the cloud account.",
            "kind": "HuntingQuery",
            "query": "let aws_public_ips = externaldata(prefixes: string)[      h@'https://aka.ms/awspublicipaddresse/aws-public-ip-addresses/ip-ranges.json']with(format='multijson');let timeframe = 30m;let lookback = 12h;//Get the AccessKey in the STS token when Lambda service assumes the Role periodically (max assumed session can be 12h)let sts_token = AWSCloudTrail| where TimeGenerated >= ago (lookback)| where EventSource == \"sts.amazonaws.com\" and SourceIpAddress == \"glue.amazonaws.com\"| extend instanceId = tostring(parse_json(RequestParameters).roleSessionName)| extend token = tostring(parse_json(ResponseElements).credentials.accessKeyId);//Get the identities who used that STS token - this can be the Lambda function itself which assumed it (legit),//but it can also be an external identity which abuses the token permissionslet tokenUsage = AWSCloudTrail| where TimeGenerated >= ago (timeframe)| join kind=inner sts_token on $left.UserIdentityAccessKeyId == $right.token| extend region = AWSRegion1| project-away SourceIpAddress1, UserIdentityUserName1, UserIdentityArn1, TimeGenerated1;//Check whether the called identity is legitaws_public_ips| mv-expand todynamic(prefixes)| extend ip_prefix=tostring(todynamic(prefixes.['ip_prefix']))| extend region=tostring(todynamic(prefixes.['region']))| extend service=tostring(todynamic(prefixes.['service']))| project-away prefixes| where service == \"AMAZON\" | join kind=inner tokenUsage on region| where SourceIpAddress !contains \"amazonaws.com\"| where ipv4_is_private(SourceIpAddress) == false| extend IsInRange = ipv4_is_in_range(SourceIpAddress, ip_prefix)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName, AssumedRoleArn = UserIdentityArn| summarize timestamp=arg_max(timestamp,*), r = make_set(IsInRange) by SourceIpAddress, UserIdentityUserName, UserIdentityArn| where not (set_has_element(r, true))| project-away ip_prefix, IsInRange",
            "tactics": [
                "Credential Access"
            ],
            "techniques": [
                "T1528"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "356aa5a8-fa6f-4eb9-baa9-ffcf725e3e82",
            "displayName": "S3 bucket has been deleted",
            "description": "Detected deletion of a S3 bucket. An attacker could delete S3 objects for impact and Denail of service purposes.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName == \"DeleteBucket\" and isempty(ErrorCode) and isempty(ErrorMessage)| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, UserIdentityArn, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData, ResponseElements, BucketName=tostring(parse_json(RequestParameters).bucketName)| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = BucketName",
            "tactics": [
                "Impact"
            ],
            "techniques": [
                "T1485"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "0db42a94-e7c8-4bf1-99a7-1a2fb4158212",
            "displayName": "Privileged role attached to Instance",
            "description": "Identity and Access Management (IAM) securely manages access to AWS services and resources.Identifies when a Privileged role is attached to an existing instance or new instance at deployment. This instance may be used by an adversary to escalate a normal user privileges to an adminsitrative level.and AWS API AddRoleToInstanceProfile at https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddRoleToInstanceProfile.html ",
            "kind": "HuntingQuery",
            "query": "let EventNameList = dynamic([\"AttachUserPolicy\",\"AttachRolePolicy\",\"AttachGroupPolicy\"]);let PolicyArnList = dynamic([\"arn:aws:iam::aws:policy/AdministratorAccess\",\"arn:aws:iam::aws:policy/DatabaseAdministrator\",\"arn:aws:iam::aws:policy/NetworkAdministrator\",\"arn:aws:iam::aws:policy/SystemAdministrator\",\"arn:aws:iam::aws:policy/AmazonS3FullAccess\"]);let starttime = todatetime('{{StartTimeISO}}');let endtime = todatetime('{{EndTimeISO}}');let lookback = starttime - 14d;//Creating a temp table of events creating privileged role or users which can later be correlated with suspicious operations.let PrivilegedRoleorUsers = AWSCloudTrail| where TimeGenerated >= lookback | where EventName in (EventNameList)| extend PolicyArn = tostring(parse_json(RequestParameters).policyArn), RoleName = tostring(parse_json(RequestParameters).roleName)| where PolicyArn in (PolicyArnList)| distinct PolicyArn, UserIdentityType, UserIdentityUserName,RoleName;// Joining the list of identities having Privileged roles with the API call AddRoleToInstanceProfile to indentify the instances which may be used by adversaries as pivot point for privilege escalation.PrivilegedRoleorUsers| join (AWSCloudTrail| where TimeGenerated between (starttime..endtime)| where EventName in (\"AddRoleToInstanceProfile\") | extend InstanceProfileName = tostring(parse_json(RequestParameters).InstanceProfileName), RoleName = tostring(parse_json(RequestParameters).roleName)| summarize EventCount=count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by EventSource, EventName, UserIdentityType , UserIdentityArn , UserIdentityUserName, SourceIpAddress, RoleName) on RoleName | extend timestamp = StartTimeUtc, IPCustomEntity = SourceIpAddress, AccountCustomEntity = RoleName",
            "tactics": [
                "Privilege Escalation"
            ],
            "techniques": [
                "T1098"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "48c49b1d-2aa0-442b-96e3-cae6ad1251cd",
            "displayName": "Bucket versioning suspended",
            "description": "Detected Bucket versioning suspended event. Attackers could use this technique to be able to ransom buckets without the option for the victim to have a backup.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == \"PutBucketVersioning\" and isempty(ErrorCode) and isempty(ErrorMessage)| extend status = tostring(parse_json(RequestParameters).VersioningConfiguration.Status)| where status == \"Suspended\"| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Impact"
            ],
            "techniques": [
                "T1485"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "a2772445-9bb1-4176-9481-b262cb59118a",
            "displayName": "New access key created to user",
            "description": "An attacker with the CreateAccessKey permissions on other users can create an access Key ID and secret access key belonging to another user in the AWS environment for privilege escalation.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName == \"CreateAccessKey\" and isempty(ErrorCode) and isempty(ErrorMessage)| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, AdditionalEventData,UserIdentityArn, ResponseElements, RequestParameters| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Persistence"
            ],
            "techniques": [
                "T1098"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "a3a19731-9e82-49b6-9142-2dd570feefd5",
            "displayName": "Modification of vpc attributes",
            "description": "An attacker could modify vpc attributesin order to access resources he couldn't access before.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName == \"ModifyVpcAttribute\" and isempty(ErrorCode) and isempty(ErrorMessage)| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource, UserIdentityArn, AdditionalEventData, ResponseElements| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Defense Evasion"
            ],
            "techniques": [
                "T1562"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "49bae199-ea04-4a2e-95a6-e3a1f68ab259",
            "displayName": "Network ACL deleted",
            "description": "An attacker could delete a network ACL and gain access to an instance from anywhere. Verify this action with the entity.",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where EventName == 'DeleteNetworkAclEntry' and isempty(ErrorMessage) and isempty(ErrorCode)| extend egress=parse_json(RequestParameters)['egress']| where egress == false| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Defense Evasion"
            ],
            "techniques": [
                "T1562"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "838f59d4-fe47-422b-819d-1be502940547",
            "displayName": "Login profile updated",
            "description": "An attacker could use UpdateLoginProfile permissions for privilege escalation by changing the victim user password. More about this API at https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateLoginProfile.html ",
            "kind": "HuntingQuery",
            "query": "AWSCloudTrail| where  EventName == \"UpdateLoginProfile\" and isempty(ErrorCode) and isempty(ErrorMessage)| project TimeGenerated, EventName, EventTypeName, UserIdentityAccountId, UserIdentityPrincipalid, UserAgent, UserIdentityUserName, SessionMfaAuthenticated, SourceIpAddress, AWSRegion, EventSource,UserIdentityArn, AdditionalEventData, ResponseElements, RequestParameters| extend UserIdentityUserName = iff(isnotempty(UserIdentityUserName), UserIdentityUserName, tostring(split(UserIdentityArn,'/')[-1]))| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName",
            "tactics": [
                "Persistence"
            ],
            "techniques": [
                "T1098"
            ],
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        }
    ],
    "workbook": [
        {
            "searchKey": "AmazonWebServicesUserActivitiesWorkbook",
            "displayName": "AWS User Activities",
            "description": "Gain insights into AWS user activities, including failed sign-in attempts, IP addresses, regions, user agents, and identity types, as well as potential malicious user activities with assumed roles.",
            "kind": "Workbook",
            "dataTypes": "AWSCloudTrail --",
            "dataConnectorId": "AWS",
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        },
        {
            "searchKey": "AmazonWebServicesNetworkActivitiesWorkbook",
            "displayName": "AWS Network Activities",
            "description": "Gain insights into AWS network related resource activities, including the creation, update, and deletions of security groups, network ACLs and routes, gateways, elastic load balancers, VPCs, subnets, and network interfaces.",
            "kind": "Workbook",
            "dataTypes": "AWSCloudTrail --",
            "dataConnectorId": "AWS",
            "version": "1.0.0",
            "source": "Amazon Web Services",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Amazon Web Services"
        }
    ],
    "parser": [],
    "playbook": [],
    "logicAppsCustomConnector": [],
    "watchlist": [],
    "contentPackage": {
        "properties": {
            "contentKind": "Solution",
            "dependencies": {
                "operator": "AND",
                "criteria": [
                    {
                        "contentId": "AWS",
                        "kind": "DataConnector",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "AwsS3",
                        "kind": "DataConnector",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "AwsS3WafCcpDefinitionConnections",
                        "kind": "DataConnector",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "AmazonWebServicesNetworkActivitiesWorkbook",
                        "kind": "Workbook",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "AmazonWebServicesUserActivitiesWorkbook",
                        "kind": "Workbook",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "8c2ef238-67a0-497d-b1dd-5c8a0f533e25",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "65360bb0-8986-4ade-a89d-af3cf44d28aa",
                        "kind": "AnalyticsRule",
                        "version": "1.0.5"
                    },
                    {
                        "contentId": "610d3850-c26f-4f20-8d86-f10fdf2425f5",
                        "kind": "AnalyticsRule",
                        "version": "1.0.4"
                    },
                    {
                        "contentId": "093fe75e-44f1-4d3e-94dc-6d258a6dd2d2",
                        "kind": "AnalyticsRule",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "d25b1998-a592-4bc5-8a3a-92b39eedb1bc",
                        "kind": "AnalyticsRule",
                        "version": "1.0.5"
                    },
                    {
                        "contentId": "32555639-b639-4c2b-afda-c0ae0abefa55",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "826bb2f8-7894-4785-9a6b-a8a855d8366f",
                        "kind": "AnalyticsRule",
                        "version": "1.0.4"
                    },
                    {
                        "contentId": "4f19d4e3-ec5f-4abc-9e61-819eb131758c",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "c7bfadd4-34a6-4fa5-82f8-3691a32261e8",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "0ee2aafb-4500-4e36-bcb1-e90eec2f0b9b",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "bf0cde21-0c41-48f6-a40c-6b5bd71fa106",
                        "kind": "AnalyticsRule",
                        "version": "1.0.6"
                    },
                    {
                        "contentId": "f6928301-56da-4d2c-aabe-e1a552bc8892",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "21702832-aff3-4bd6-a8e1-663b6818503d",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "0adab960-5565-4978-ba6d-044553e4acc4",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "9da99021-d318-4711-a78a-6dea76129b3a",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "efdc3cff-f006-426f-97fd-4657862f7b9a",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "6f675c17-7a61-440c-abd1-c73ef4d748ec",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "8a607285-d95c-473d-8aab-59920de63af6",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "8e15998e-1e32-4b6d-abd1-e8482e8f3def",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "467cbe7e-e6d4-4f4e-8e44-84dd01932c32",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "22115d3c-e87c-485a-9130-33797d619124",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "6009c632-94e9-4ffb-a11a-b4b99f457f88",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "a694e977-740c-4578-9f8f-5e39029f1d23",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "56626956-304f-4408-8ea6-7ba5746ce09e",
                        "kind": "AnalyticsRule",
                        "version": "1.0.3"
                    },
                    {
                        "contentId": "796a45ee-220b-42be-8415-c8c933cf3b6d",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "aaa2c05e-fdd4-4fa0-9072-6cffe3641b34",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "454133a7-5427-4a7c-bdc4-0adfa84dda16",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "19602494-94af-43c8-90ba-eb0e14999612",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "633a91df-d031-4b6e-a413-607a61540559",
                        "kind": "AnalyticsRule",
                        "version": "1.0.4"
                    },
                    {
                        "contentId": "f8ea7d50-e33b-4b9d-9c3e-a59fcbcee281",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "60dfc193-0f73-4279-b43c-110ade02b201",
                        "kind": "AnalyticsRule",
                        "version": "1.0.4"
                    },
                    {
                        "contentId": "139e7116-3884-4246-9978-c8f740770bdf",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "49ce5322-60d7-4b02-ad79-99f650aa5790",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "afb4191b-a142-4065-a0da-f721ee3d006c",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "719d5204-10ab-4b1f-aee1-da7326750260",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "b9be2aa6-911d-4131-8658-d2a537ed49f4",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "e20d35a3-4fec-4c8b-81b1-fc33b41990b0",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "d7c39e15-997f-49e5-a782-73bf07db8aa5",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "d0953d50-3dc1-4fa3-80fa-4d3e973a0959",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "fc3061bb-319c-4fe9-abe2-f59899a6d907",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "48896551-1c28-4a09-8388-e51e5a927d23",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "a2b2a984-c820-4d93-830e-139bffd81fa3",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "370f0e5e-da1d-4a14-8ced-d1d7ab66a8d7",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "8e01c41d-bd4c-4bbe-aed5-18592735052d",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "c668c09f-5a49-43f9-b249-6b89a31ec8fb",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "8f1630c2-2e45-4df2-be43-50fba90f601d",
                        "kind": "AnalyticsRule",
                        "version": "1.0.2"
                    },
                    {
                        "contentId": "31b9e94b-0df6-4a3d-a297-3457b53c5d86",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "b7a44e0d-ae4c-4fb2-be1b-aa0e45f2327b",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "6b9b4ee6-f4c1-4b86-8c8c-beb0bb59ae44",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "44a5b65e-b0a9-4591-aabc-388fd92a28c4",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "09f2a28b-3286-4268-9e2f-33805f104e5d",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "b442b9e2-5cc4-4129-a85b-a5ef38a9e5f0",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "bce1dcba-4948-414d-8838-6385afb9d496",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "874a1762-3fd7-4489-b411-6d4a9e9e8a59",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "75647b58-bcc8-4eb5-9658-46698d3fa153",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "8c2dc344-9352-4ca1-8863-b1b7a5e09e59",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "9e457dc4-81f0-4d25-bc37-a5fa4a17946a",
                        "kind": "AnalyticsRule",
                        "version": "1.0.1"
                    },
                    {
                        "contentId": "e0a67cd7-b4e5-4468-aae0-26cb16a1bbd2",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "e1a91db8-f2b3-4531-bff6-da133d4f4f1a",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "0db42a94-e7c8-4bf1-99a7-1a2fb4158212",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "5b6ee21d-da53-46eb-827c-eab2a9ba3d2f",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "e0d57543-acbd-428b-bb96-24a67506f84d",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "81a8880f-cc20-40ce-98d6-2fc6a1c5b9a4",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "2b8cecfe-f705-432d-9f38-08207b9473e1",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "48c49b1d-2aa0-442b-96e3-cae6ad1251cd",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "a2772445-9bb1-4176-9481-b262cb59118a",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "4e3c81bf-61a4-47f4-b20d-a5a414ea08aa",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "b5b172b1-d976-4113-af1f-02f7bf7d2092",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "4fbbae0a-ce5b-4b2a-b5e6-700920561680",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "c9ccaebf-314c-446d-b3f6-314560ccb0e1",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "13afb771-5d55-4d69-a745-83d2fc69a923",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "bf130d1d-702b-4af6-9528-8bc4229e59f4",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "7e258a45-b356-44f6-9a62-2643cef7b869",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "d022a62c-643b-4e8a-b583-0230e32a96e4",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "d82ea1db-f600-4c9e-8ba8-d271e9c12eb8",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "77d0aadc-aaea-4346-b61a-bf7ac6b71bba",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "2dd2143b-6667-4a7a-b04f-98d22caeffac",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "838f59d4-fe47-422b-819d-1be502940547",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "3b7df29e-a798-4b6b-9ef7-73b9a3cf56a2",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "05167149-4670-4a9f-b34e-5a0a92243194",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "a3a19731-9e82-49b6-9142-2dd570feefd5",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "49bae199-ea04-4a2e-95a6-e3a1f68ab259",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "4055466c-8a84-44c6-91d0-46469f3ba0b9",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "e73ebd34-4f04-4684-a5f0-dba820127ce8",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "b9b0fd12-d72d-4f66-a013-c1acdeea2670",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "70c36558-e6d8-48b4-98b3-185d555cd5af",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "356aa5a8-fa6f-4eb9-baa9-ffcf725e3e82",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "6eb59239-78c5-401d-acfa-5cb9b3d31cd4",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "82ecf967-d6e9-4757-8f5d-42c562a8f05f",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "67af1633-311f-4a94-bc8f-f904a54637b2",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "0cd3eb95-6c8e-4eeb-8338-a0decdc0a328",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "46685737-676a-4084-8e98-31b2998062db",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    },
                    {
                        "contentId": "70a6e84f-6f3b-4ce1-83d6-ea6df9e7a9dd",
                        "kind": "HuntingQuery",
                        "version": "1.0.0"
                    }
                ]
            },
            "id": "azuresentinel.azure-sentinel-solution-amazonwebservices",
            "contentProductId": "azuresentinel.azure-sentinel-solution-amazonwebser-sl-mzg2uheoh6vp2",
            "contentId": "azuresentinel.azure-sentinel-solution-amazonwebservices",
            "displayName": "Amazon Web Services",
            "version": "3.0.4",
            "contentSchemaVersion": "3.0.0",
            "source": {
                "kind": "Solution",
                "name": "Amazon Web Services",
                "sourceId": "azuresentinel.azure-sentinel-solution-amazonwebservices"
            },
            "author": {
                "name": "Microsoft"
            },
            "support": {
                "tier": "Microsoft",
                "name": "Microsoft Corporation",
                "email": "support@microsoft.com",
                "link": "https://support.microsoft.com"
            },
            "providers": [
                "Amazon Web Services"
            ],
            "categories": {
                "domains": [
                    "Security - Cloud Security"
                ]
            },
            "firstPublishDate": "2022-05-26",
            "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Aws.svg\" width=\"75px\" height=\"75px\">"
        }
    }
}