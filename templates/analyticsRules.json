{
    "analyticsRule": [
        {
            "searchKey": "ee1818ec-5f65-4991-b711-bcf2ab7e36c3",
            "displayName": "Cisco Umbrella - URI contains IP address",
            "description": "Malware can use IP address to communicate with C2.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "Cisco_Umbrella| where EventType == 'proxylogs'| where DvcAction =~ 'Allowed'| where UrlOriginal matches regex @'\\Ahttp:\\/\\/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*'| project TimeGenerated, SrcIpAddr, DstIpAddr, UrlOriginal, Identities",
            "ruleFrequency": "10 minutes",
            "rulePeriod": "10 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Command And Control1\ue946Exfiltration",
            "techniques": [
                "T1071",
                "T1567"
            ],
            "techniquesMultiple": "T10711\ue946T1567",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.1",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "8d537f3c-094f-430c-a588-8a87da36ee3a",
            "displayName": "Cisco Umbrella - Hack Tool User-Agent Detected",
            "description": "Detects suspicious user agent strings used by known hack tools",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let user_agents=dynamic([                          '(hydra)',                          ' arachni/',                          ' BFAC ',                          ' brutus ',                          ' cgichk ',                          'core-project/1.0',                          ' crimscanner/',                          'datacha0s',                          'dirbuster',                          'domino hunter',                          'dotdotpwn',                          'FHScan Core',                          'floodgate',                          'get-minimal',                          'gootkit auto-rooter scanner',                          'grendel-scan',                          ' inspath ',                          'internet ninja',                          'jaascois',                          ' zmeu ',                          'masscan',                          ' metis ',                          'morfeus fucking scanner',                          'n-stealth',                          'nsauditor',                          'pmafind',                          'security scan',                          'springenwerk',                          'teh forest lobster',                          'toata dragostea',                          ' vega/',                          'voideye',                          'webshag',                          'webvulnscan',                          ' whcc/',                          ' Havij',                          'absinthe',                          'bsqlbf',                          'mysqloit',                          'pangolin',                          'sql power injector',                          'sqlmap',                          'sqlninja',                          'uil2pn',                          'ruler',                          'Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-PT; rv:1.9.1.2) Gecko/20090729 Firefox/3.5.2 (.NET CLR 3.5.30729)'                          ]);Cisco_Umbrella| where EventType == \"proxylogs\"| where HttpUserAgentOriginal has_any (user_agents)| extend Message = \"Hack Tool User Agent\"| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal",
            "ruleFrequency": "15 minutes",
            "rulePeriod": "15 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Execution",
                "Discovery",
                "Lateral Movement",
                "Collection",
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Execution5\ue946DiscoveryLateral MovementCollectionCommand And ControlExfiltration",
            "techniques": [
                "T1059",
                "T1046",
                "T1021",
                "T1557",
                "T1102",
                "T1020"
            ],
            "techniquesMultiple": "T10595\ue946T1046T1021T1557T1102T1020",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "75297f62-10a8-4fc1-9b2a-12f25c6f05a7",
            "displayName": "Cisco Umbrella - Connection to Unpopular Website Detected",
            "description": "Detects first connection to an unpopular website (possible malicious payload delivery).",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let top_million_list = Cisco_Umbrella| where EventType == \"proxylogs\"| extend Hostname = parse_url(UrlOriginal)[\"Host\"]| summarize count() by tostring(Hostname)| top 1000000 by count_| summarize make_list(Hostname);Cisco_Umbrella| where EventType == \"proxylogs\"| extend Hostname = parse_url(UrlOriginal)[\"Host\"]| where Hostname !in (top_million_list)| extend Message = \"Connect to unpopular website (possible malicious payload delivery)\"| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal ",
            "ruleFrequency": "1 day",
            "rulePeriod": "14 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Command And Control1\ue946Exfiltration",
            "techniques": [
                "T1071",
                "T1041"
            ],
            "techniquesMultiple": "T10711\ue946T1041",
            "subTechniques": [
                "T1071.001"
            ],
            "subTechniquesMultiple": "T1071.001",
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "b12b3dab-d973-45af-b07e-e29bb34d8db9",
            "displayName": "Cisco Umbrella - Windows PowerShell User-Agent Detected",
            "description": "Rule helps to detect Powershell user-agent activity by an unusual process other than a web browser.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "Cisco_Umbrella| where EventType == \"proxylogs\"| where HttpUserAgentOriginal contains \"WindowsPowerShell\"| extend Message = \"Windows PowerShell User Agent\"| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal",
            "ruleFrequency": "15 minutes",
            "rulePeriod": "15 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control",
                "Defense Evasion",
                "Execution"
            ],
            "tacticsMultiple": "Command And Control2\ue946Defense EvasionExecution",
            "techniques": [
                "T1132",
                "T1027",
                "T1059"
            ],
            "techniquesMultiple": "T11322\ue946T1027T1059",
            "subTechniques": [
                "T1059.001"
            ],
            "subTechniquesMultiple": "T1059.001",
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "b619d1f1-7f39-4c7e-bf9e-afbb46457997",
            "displayName": "Cisco Umbrella - Crypto Miner User-Agent Detected",
            "description": "Detects suspicious user agent strings used by crypto miners in proxy logs.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "Cisco_Umbrella| where EventType == \"proxylogs\"| where HttpUserAgentOriginal contains \"XMRig\" or HttpUserAgentOriginal contains \"ccminer\"| extend Message = \"Crypto Miner User Agent\"| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal",
            "ruleFrequency": "15 minutes",
            "rulePeriod": "15 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Impact",
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Impact2\ue946Command And ControlExfiltration",
            "techniques": [
                "T1496",
                "T1071",
                "T1041"
            ],
            "techniquesMultiple": "T14962\ue946T1071T1041",
            "subTechniques": [
                "T1071.001"
            ],
            "subTechniquesMultiple": "T1071.001",
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "c9b6d281-b96b-4763-b728-9a04b9fe1246",
            "displayName": "Cisco Umbrella - Connection to non-corporate private network",
            "description": "IP addresses of broadband links that usually indicates users attempting to access their home network, for example for a remote session to a home computer.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "Cisco_Umbrella| where EventType == 'proxylogs'| where DvcAction =~ 'Allowed'| where UrlCategory has_any ('Dynamic and Residential', 'Personal VPN')| project TimeGenerated, SrcIpAddr, DstIpAddr, Identities ",
            "ruleFrequency": "10 minutes",
            "rulePeriod": "10 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Command And Control1\ue946Exfiltration",
            "techniques": [
                "T1573",
                "T1041"
            ],
            "techniquesMultiple": "T15731\ue946T1041",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.0.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "de58ee9e-b229-4252-8537-41a4c2f4045e",
            "displayName": "Cisco Umbrella - Request to blocklisted file type",
            "description": "Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let file_ext_blocklist = dynamic(['.ps1', '.vbs', '.bat', '.scr']);Cisco_Umbrella| where EventType == 'proxylogs'| where DvcAction =~ 'Allowed'| extend file_ext = extract(@'.*(\\.\\w+)$', 1, UrlOriginal)| extend Filename = extract(@'.*\\/*\\/(.*\\.\\w+)$', 1, UrlOriginal)| where file_ext in (file_ext_blocklist)| project TimeGenerated, SrcIpAddr, DstIpAddr, Identities, Filename, UrlOriginal ",
            "ruleFrequency": "10 minutes",
            "rulePeriod": "10 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Initial Access",
                "Command And Control"
            ],
            "tacticsMultiple": "Initial Access1\ue946Command And Control",
            "techniques": [
                "T1189",
                "T1105"
            ],
            "techniquesMultiple": "T11891\ue946T1105",
            "subTechniques": [],
            "subTechniquesMultiple": [],
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.0.1",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "d6bf1931-b1eb-448d-90b2-de118559c7ce",
            "displayName": "Cisco Umbrella - Request Allowed to harmful/malicious URI category",
            "description": "It is reccomended that these Categories shoud be blocked by policies because they provide harmful/malicious content..",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "Cisco_Umbrella| where EventType == 'proxylogs'| where DvcAction =~ 'Allowed'| where UrlCategory contains 'Adult Themes' or      UrlCategory contains 'Adware' or      UrlCategory contains 'Alcohol' or      UrlCategory contains 'Illegal Downloads' or      UrlCategory contains 'Drugs' or      UrlCategory contains 'Child Abuse Content' or      UrlCategory contains 'Hate/Discrimination' or      UrlCategory contains 'Nudity' or      UrlCategory contains 'Pornography' or      UrlCategory contains 'Proxy/Anonymizer' or      UrlCategory contains 'Sexuality' or      UrlCategory contains 'Tasteless' or      UrlCategory contains 'Terrorism' or      UrlCategory contains 'Web Spam' or      UrlCategory contains 'German Youth Protection' or      UrlCategory contains 'Illegal Activities' or      UrlCategory contains 'Lingerie/Bikini' or      UrlCategory contains 'Weapons'| project TimeGenerated, SrcIpAddr, DstIpAddr, UrlOriginal, Identities",
            "ruleFrequency": "10 minutes",
            "rulePeriod": "10 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Command And Control1\ue946Exfiltration",
            "techniques": [
                "T1071",
                "T1041"
            ],
            "techniquesMultiple": "T10711\ue946T1041",
            "subTechniques": [
                "T1071.001"
            ],
            "subTechniquesMultiple": "T1071.001",
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.1",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "2b328487-162d-4034-b472-59f1d53684a1",
            "displayName": "Cisco Umbrella - Empty User Agent Detected",
            "description": "Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "Cisco_Umbrella| where EventType == \"proxylogs\"| where HttpUserAgentOriginal == ''| extend Message = \"Empty User Agent\"| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal ",
            "ruleFrequency": "15 minutes",
            "rulePeriod": "15 minutes",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control"
            ],
            "tacticsMultiple": "Command And Control",
            "techniques": [
                "T1001"
            ],
            "techniquesMultiple": "T1001",
            "subTechniques": [
                "T1001.003"
            ],
            "subTechniquesMultiple": "T1001.003",
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        },
        {
            "searchKey": "8c8de3fa-6425-4623-9cd9-45de1dd0569a",
            "displayName": "Cisco Umbrella - Rare User Agent Detected",
            "description": "Rule helps to detect a rare user-agents indicating web browsing activity by an unusual process other than a web browser.",
            "kind": "AnalyticsRule",
            "ruleType": "Scheduled",
            "severity": "Medium",
            "query": "let user_agents_list = Cisco_Umbrella| where EventType == \"proxylogs\"| summarize count() by HttpUserAgentOriginal| summarize make_list(HttpUserAgentOriginal);Cisco_Umbrella| where EventType == \"proxylogs\"| where HttpUserAgentOriginal !in (user_agents_list)| extend Message = \"Rare User Agent\"| project TimeGenerated, Message, SrcIpAddr, DstIpAddr, UrlOriginal, HttpUserAgentOriginal",
            "ruleFrequency": "1 day",
            "rulePeriod": "14 days",
            "suppressionDuration": "1 hour",
            "thresholdTrigger": "more than 0",
            "tactics": [
                "Command And Control",
                "Exfiltration"
            ],
            "tacticsMultiple": "Command And Control1\ue946Exfiltration",
            "techniques": [
                "T1071",
                "T1041"
            ],
            "techniquesMultiple": "T10711\ue946T1041",
            "subTechniques": [
                "T1071.001"
            ],
            "subTechniquesMultiple": "T1071.001",
            "entityMapping": [
                {
                    "entityType": "URL",
                    "fieldMappings": [
                        {
                            "columnName": "UrlOriginal",
                            "identifier": "Url"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "columnName": "SrcIpAddr",
                            "identifier": "Address"
                        }
                    ]
                }
            ],
            "dataConnectorId": "CiscoUmbrellaDataConnector",
            "dataConnectorName": "Cisco Umbrella (using Azure Functions)",
            "dataTypes": "Cisco_Umbrella_proxy_CL --",
            "version": "1.1.2",
            "source": "CiscoUmbrella",
            "author": "Microsoft",
            "support": "Microsoft Corporation",
            "solutionSearchName": "Cisco Umbrella"
        }
    ]
}